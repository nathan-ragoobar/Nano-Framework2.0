cmake_minimum_required(VERSION 3.16)
project(GPT2Training)

# Set the C++ standard
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# Add the Abseil library
add_subdirectory(abseil-cpp)

# Include directories
include_directories(
    ${CMAKE_SOURCE_DIR}/include
    ${CMAKE_SOURCE_DIR}/abseil-cpp
)

# Source files
set(SOURCES
    train_gpt2.cpp
    gpt2.cpp
    llmc/dataloader.cpp
    llmc/tokenizer.cpp
    optim.cpp
    tensor_util.cpp
    nn.cpp
)

# Add executable
add_executable(train_gpt2_cpu train_gpt2.cpp)
target_link_libraries(train_gpt2_cpu
    gpt2
    optim
    profiler
    absl::base
    absl::synchronization
    absl::strings
    absl::algorithm
    absl::log
    absl::span
    pthread
)
target_compile_options(train_gpt2_cpu PRIVATE -Ofast -march=native)

# Enable testing
#option(BUILD_TESTING "Build the testing tree." ON)
#if(BUILD_TESTING)
#    enable_testing()
#    add_subdirectory(tests)
#endif()

# Set runtime output directory
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin)