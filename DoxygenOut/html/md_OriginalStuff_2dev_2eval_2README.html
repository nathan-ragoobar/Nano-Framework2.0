<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>My Project: eleuther eval readme</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">My Project
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',false);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){ initResizable(false); });
/* @license-end */
</script>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">eleuther eval readme</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md95"></a></p>
<p>The goal here is to run the Eleuther Eval harness exactly in the same way as that used in the <a href="https://huggingface.co/spaces/open-llm-leaderboard/open_llm_leaderboard">huggingface LLM Leaderboard</a>.</p>
<p>The starting point is a <code>.bin</code> file trained by llm.c. We now have to export it to a huggingface model and then evaluate it.</p>
<p>To export the model, use <a href="export_hf.py">export_hf.py</a>. See its documentation up top. Eample usage, from this directory:</p>
<div class="fragment"><div class="line">cd dev/eval</div>
<div class="line">python export_hf.py --input model.bin --output output_dir</div>
</div><!-- fragment --><p>Where you point to your model .bin file, and huggingface files get written to output_dir. The script can optionally also upload to huggingface hub. One more post-processing that is advisable is to go into the <code>output_dir</code>, open up the <code>config.json</code> there and add one more entry into the json object:</p>
<div class="fragment"><div class="line">&quot;_attn_implementation&quot;: &quot;flash_attention_2&quot;</div>
</div><!-- fragment --><p>To use FlashAttention 2. We had trouble evaluating in bfloat16 without using FlashAttention 2 (the scores are much lower, and this was never fully resolved). This is a temporary hack/workaround.</p>
<p>Now that we have the model in huggingface format, we download the Eleuther Eval Harness repo and run it. Head over to the parent/root directory of the llm.c repo and:</p>
<div class="fragment"><div class="line">git clone https://github.com/EleutherAI/lm-evaluation-harness/</div>
<div class="line">cd lm-evaluation-harness</div>
<div class="line">git checkout b281b0921b636bc36ad05c0b0b0763bd6dd43463</div>
<div class="line">pip install -e .</div>
</div><!-- fragment --><p>And then run the run_eval.sh script:</p>
<div class="fragment"><div class="line">./dev/eval/run_eval.sh output_dir result_dir</div>
</div><!-- fragment --><p>Where output_dir can either be local output dir (above), or a huggingface repo name.This will write eval json objects to <code>./lm-evaluation-harness/results/results_dir</code>. It will print the results into console, e.g. for a 774M model we see:</p>
<div class="fragment"><div class="line">----------------------------------------</div>
<div class="line">arc_challenge_25shot.json      : 30.4608</div>
<div class="line">gsm8k_5shot.json               : 0.1516</div>
<div class="line">hellaswag_10shot.json          : 57.8072</div>
<div class="line">mmlu_5shot.json                : 25.8682</div>
<div class="line">truthfulqa_0shot.json          : 35.7830</div>
<div class="line">winogrande_5shot.json          : 59.3528</div>
<div class="line">----------------------------------------</div>
<div class="line">Average Score                  : 34.9039</div>
</div><!-- fragment --><p>But you can additionally get these results later by running <code>summarize_eval.py</code>:</p>
<div class="fragment"><div class="line">python dev/eval/summarize_eval.py lm-evaluation-harness/results/results_dir</div>
</div><!-- fragment --><p>The same information will be printed again.</p>
<p>For some reason, the evaluation is quite expensive and runs for somewhere around 1-3 hours, even though it should be a few minutes at most. This has not been satisfyingly resolved so far. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0
</small></address>
</div><!-- doc-content -->
</body>
</html>
