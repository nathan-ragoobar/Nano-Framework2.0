\doxysection{Loss.\+hpp}
\hypertarget{Loss_8hpp_source}{}\label{Loss_8hpp_source}\index{nn/Loss.hpp@{nn/Loss.hpp}}
\mbox{\hyperlink{Loss_8hpp}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{preprocessor}{\#ifndef\ LLM\_CPP\_\_LOSS\_HPP\_}}
\DoxyCodeLine{00002\ \textcolor{preprocessor}{\#define\ LLM\_CPP\_\_LOSS\_HPP\_}}
\DoxyCodeLine{00003\ }
\DoxyCodeLine{00004\ \textcolor{preprocessor}{\#include\ <cmath>}}
\DoxyCodeLine{00005\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{Parameter_8hpp}{Parameter.hpp}}"{}}\ \ \textcolor{comment}{//\ Includes\ necessary\ headers\ for\ nn::Parameter,\ etc.}}
\DoxyCodeLine{00006\ \textcolor{preprocessor}{\#include\ "{}absl/types/span.h"{}}}
\DoxyCodeLine{00007\ \textcolor{preprocessor}{\#include\ "{}absl/log/check.h"{}}}
\DoxyCodeLine{00008\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{tensor_2tensor__util_8hpp}{tensor/tensor\_util.hpp}}"{}}}
\DoxyCodeLine{00009\ }
\DoxyCodeLine{00010\ \textcolor{keyword}{namespace\ }\mbox{\hyperlink{namespacenn}{nn}}\ \{}
\DoxyCodeLine{00011\ }
\DoxyCodeLine{00012\ \textcolor{keyword}{struct\ }CrossEntropy\ \{}
\DoxyCodeLine{00013\ \ \ \textcolor{keyword}{using\ }\mbox{\hyperlink{structnn_1_1CrossEntropy_ac2c82ea85793511ae3c7a6e58961ba52}{T}}\ =\ \mbox{\hyperlink{dev_2cuda_2common_8h_a73bc90d2e378d172e206b528b3756c5a}{floatX}};}
\DoxyCodeLine{00014\ \ \ \textcolor{keyword}{enum}\ \mbox{\hyperlink{structnn_1_1CrossEntropy_a66479cf14574903516fdc5fd59b4b8b3}{Reduction}}\ \{\ \mbox{\hyperlink{structnn_1_1CrossEntropy_a66479cf14574903516fdc5fd59b4b8b3a61bc49dd30d67bb2e67230b59719e56d}{MEAN}},\ \mbox{\hyperlink{structnn_1_1CrossEntropy_a66479cf14574903516fdc5fd59b4b8b3ae3282ef2d73939de84601a2aabc567ad}{SUM}}\ \};}
\DoxyCodeLine{00015\ }
\DoxyCodeLine{00016\ \ \ \mbox{\hyperlink{structnn_1_1CrossEntropy_a317c3ff9babc59fb78b4301edf3893e4}{CrossEntropy}}(\mbox{\hyperlink{structnn_1_1CrossEntropy_a66479cf14574903516fdc5fd59b4b8b3}{Reduction}}\ reduction\ =\ Reduction::MEAN)\ :\ \mbox{\hyperlink{structnn_1_1CrossEntropy_a8df82dc1e730e73cb3636d0d584158dc}{reduction\_}}(reduction)\ \{\}}
\DoxyCodeLine{00017\ }
\DoxyCodeLine{00018\ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{structnn_1_1CrossEntropy_a0a71ab9cf2092f7cfebe57f783285bb0}{Forward}}(\textcolor{keyword}{typename}\ \mbox{\hyperlink{classEigen_1_1TensorMap}{TTypes<T>::ConstMatrix}}\ probs,}
\DoxyCodeLine{00019\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classabsl_1_1Span}{absl::Span<const\ int>}}\ targets,\ \textcolor{keywordtype}{float}*\ loss)\ \{}
\DoxyCodeLine{00020\ \ \ \ \ \textcolor{comment}{//\ probs:[B,\ C],\ targets:\ [B,]\ loss:\ scalar}}
\DoxyCodeLine{00021\ \ \ \ \ \textcolor{keywordtype}{int}\ B\ =\ probs.\mbox{\hyperlink{classEigen_1_1TensorMap_adfb930b8289836aad40d64171bde46a1}{dimension}}(0),\ \mbox{\hyperlink{abseil-cpp_2absl_2hash_2internal_2city__test_8cc_ac54ae397901fe700628cafadea3c5208}{C}}\ =\ probs.\mbox{\hyperlink{classEigen_1_1TensorMap_adfb930b8289836aad40d64171bde46a1}{dimension}}(1);}
\DoxyCodeLine{00022\ \ \ \ \ \mbox{\hyperlink{abseil-cpp_2absl_2log_2check_8h_a7c0ce053b28d53aa4eaf3eb7fb71663b}{CHECK\_EQ}}(B,\ targets.\mbox{\hyperlink{classabsl_1_1Span_a92186c247036e10dd12603c09f8b8797}{size}}());}
\DoxyCodeLine{00023\ }
\DoxyCodeLine{00024\ \ \ \ \ \textcolor{comment}{//\ targets:\ [B,]}}
\DoxyCodeLine{00025\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ =\ 0;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ <\ targets.\mbox{\hyperlink{classabsl_1_1Span_a92186c247036e10dd12603c09f8b8797}{size}}();\ ++\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}})\ \{}
\DoxyCodeLine{00026\ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ ix\ =\ targets[\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}];}
\DoxyCodeLine{00027\ \ \ \ \ \ \ *loss\ +=\ -\/std::log(probs(\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}},\ ix));}
\DoxyCodeLine{00028\ \ \ \ \ \}}
\DoxyCodeLine{00029\ }
\DoxyCodeLine{00030\ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{structnn_1_1CrossEntropy_a8df82dc1e730e73cb3636d0d584158dc}{reduction\_}}\ ==\ Reduction::MEAN)\ \{}
\DoxyCodeLine{00031\ \ \ \ \ \ \ *loss\ /=\ \textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{float}\textcolor{keyword}{>}(B);}
\DoxyCodeLine{00032\ \ \ \ \ \}}
\DoxyCodeLine{00033\ \ \ \}}
\DoxyCodeLine{00034\ }
\DoxyCodeLine{00035\ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{structnn_1_1CrossEntropy_a1fd65ea7f1a8f32574363455434ce234}{Backward}}(\textcolor{keyword}{typename}\ \mbox{\hyperlink{classEigen_1_1TensorMap}{TTypes<T>::ConstMatrix}}\ probs,}
\DoxyCodeLine{00036\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classabsl_1_1Span}{absl::Span<const\ int>}}\ targets,}
\DoxyCodeLine{00037\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{typename}\ \mbox{\hyperlink{classEigen_1_1TensorMap}{TTypes<T>::Matrix}}\ probs\_grad)\ \{}
\DoxyCodeLine{00038\ \ \ \ \ \textcolor{comment}{//\ probs:\ [B,\ C],\ targets:\ [B,]}}
\DoxyCodeLine{00039\ \ \ \ \ \textcolor{comment}{//\ probs\_grad:\ [B,\ C]}}
\DoxyCodeLine{00040\ \ \ \ \ \textcolor{keywordtype}{int}\ B\ =\ probs.\mbox{\hyperlink{classEigen_1_1TensorMap_adfb930b8289836aad40d64171bde46a1}{dimension}}(0),\ \mbox{\hyperlink{abseil-cpp_2absl_2hash_2internal_2city__test_8cc_ac54ae397901fe700628cafadea3c5208}{C}}\ =\ probs.\mbox{\hyperlink{classEigen_1_1TensorMap_adfb930b8289836aad40d64171bde46a1}{dimension}}(1);}
\DoxyCodeLine{00041\ \ \ \ \ \mbox{\hyperlink{abseil-cpp_2absl_2log_2check_8h_a3e1cfef60e774a81f30eaddf26a3a274}{CHECK}}(B\ ==\ targets.\mbox{\hyperlink{classabsl_1_1Span_a92186c247036e10dd12603c09f8b8797}{size}}()\ \&\&\ B\ ==\ probs\_grad.\mbox{\hyperlink{classEigen_1_1TensorMap_adfb930b8289836aad40d64171bde46a1}{dimension}}(0));}
\DoxyCodeLine{00042\ \ \ \ \ \mbox{\hyperlink{abseil-cpp_2absl_2log_2check_8h_a7c0ce053b28d53aa4eaf3eb7fb71663b}{CHECK\_EQ}}(\mbox{\hyperlink{abseil-cpp_2absl_2hash_2internal_2city__test_8cc_ac54ae397901fe700628cafadea3c5208}{C}},\ probs\_grad.\mbox{\hyperlink{classEigen_1_1TensorMap_adfb930b8289836aad40d64171bde46a1}{dimension}}(1));}
\DoxyCodeLine{00043\ }
\DoxyCodeLine{00044\ \ \ \ \ \textcolor{keywordtype}{float}\ factor\ =}
\DoxyCodeLine{00045\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structnn_1_1CrossEntropy_a8df82dc1e730e73cb3636d0d584158dc}{reduction\_}}\ ==\ Reduction::MEAN\ ?\ 1.0f\ /\ \textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{float}\textcolor{keyword}{>}(B)\ :\ 1.0f;}
\DoxyCodeLine{00046\ }
\DoxyCodeLine{00047\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2layout__test_8cc_ad66453096871179e6c6effe0df4b483b}{b}}\ =\ 0;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2layout__test_8cc_ad66453096871179e6c6effe0df4b483b}{b}}\ <\ B;\ ++\mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2layout__test_8cc_ad66453096871179e6c6effe0df4b483b}{b}})\ \{}
\DoxyCodeLine{00048\ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ ix\ =\ targets[\mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2layout__test_8cc_ad66453096871179e6c6effe0df4b483b}{b}}];}
\DoxyCodeLine{00049\ \ \ \ \ \ \ probs\_grad(\mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2layout__test_8cc_ad66453096871179e6c6effe0df4b483b}{b}},\ ix)\ +=\ -\/1.0f\ /\ probs(\mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2layout__test_8cc_ad66453096871179e6c6effe0df4b483b}{b}},\ ix)\ *\ factor;}
\DoxyCodeLine{00050\ \ \ \ \ \}}
\DoxyCodeLine{00051\ \ \ \}}
\DoxyCodeLine{00052\ }
\DoxyCodeLine{00053\ \ \ \mbox{\hyperlink{structnn_1_1CrossEntropy_a66479cf14574903516fdc5fd59b4b8b3}{Reduction}}\ \mbox{\hyperlink{structnn_1_1CrossEntropy_a8df82dc1e730e73cb3636d0d584158dc}{reduction\_}};}
\DoxyCodeLine{00054\ \};}
\DoxyCodeLine{00055\ }
\DoxyCodeLine{00056\ }
\DoxyCodeLine{00057\ \}\ \ \textcolor{comment}{//\ namespace\ nn}}
\DoxyCodeLine{00058\ }
\DoxyCodeLine{00059\ \textcolor{preprocessor}{\#endif\ \ }\textcolor{comment}{//\ LLM\_CPP\_\_NN\_HPP\_}}

\end{DoxyCode}
