\doxysection{Non\+Blocking\+Thread\+Pool.\+h}
\hypertarget{NonBlockingThreadPool_8h_source}{}\label{NonBlockingThreadPool_8h_source}\index{eigen/unsupported/Eigen/CXX11/src/ThreadPool/NonBlockingThreadPool.h@{eigen/unsupported/Eigen/CXX11/src/ThreadPool/NonBlockingThreadPool.h}}
\mbox{\hyperlink{NonBlockingThreadPool_8h}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{comment}{//\ This\ file\ is\ part\ of\ Eigen,\ a\ lightweight\ C++\ template\ library}}
\DoxyCodeLine{00002\ \textcolor{comment}{//\ for\ linear\ algebra.}}
\DoxyCodeLine{00003\ \textcolor{comment}{//}}
\DoxyCodeLine{00004\ \textcolor{comment}{//\ Copyright\ (C)\ 2016\ Dmitry\ Vyukov\ <dvyukov@google.com>}}
\DoxyCodeLine{00005\ \textcolor{comment}{//}}
\DoxyCodeLine{00006\ \textcolor{comment}{//\ This\ Source\ Code\ Form\ is\ subject\ to\ the\ terms\ of\ the\ Mozilla}}
\DoxyCodeLine{00007\ \textcolor{comment}{//\ Public\ License\ v.\ 2.0.\ If\ a\ copy\ of\ the\ MPL\ was\ not\ distributed}}
\DoxyCodeLine{00008\ \textcolor{comment}{//\ with\ this\ file,\ You\ can\ obtain\ one\ at\ http://mozilla.org/MPL/2.0/.}}
\DoxyCodeLine{00009\ }
\DoxyCodeLine{00010\ \textcolor{preprocessor}{\#ifndef\ EIGEN\_CXX11\_THREADPOOL\_NONBLOCKING\_THREAD\_POOL\_H}}
\DoxyCodeLine{00011\ \textcolor{preprocessor}{\#define\ EIGEN\_CXX11\_THREADPOOL\_NONBLOCKING\_THREAD\_POOL\_H}}
\DoxyCodeLine{00012\ }
\DoxyCodeLine{00013\ \textcolor{keyword}{namespace\ }\mbox{\hyperlink{namespaceEigen}{Eigen}}\ \{}
\DoxyCodeLine{00014\ }
\DoxyCodeLine{00015\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ Environment>}
\DoxyCodeLine{00016\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classEigen_1_1ThreadPoolTempl}{ThreadPoolTempl}}\ :\ \textcolor{keyword}{public}\ \mbox{\hyperlink{classEigen_1_1ThreadPoolInterface}{Eigen::ThreadPoolInterface}}\ \{}
\DoxyCodeLine{00017\ \ \textcolor{keyword}{public}:}
\DoxyCodeLine{00018\ \ \ \textcolor{keyword}{typedef}\ \textcolor{keyword}{typename}\ Environment::Task\ \mbox{\hyperlink{classEigen_1_1ThreadPoolTempl_adf196760672014b96bb76fd0b8191d95}{Task}};}
\DoxyCodeLine{00019\ \ \ \textcolor{keyword}{typedef}\ \mbox{\hyperlink{classEigen_1_1RunQueue}{RunQueue<Task,\ 1024>}}\ \mbox{\hyperlink{classEigen_1_1ThreadPoolTempl_aeafcd23636275484cfc61a214f592513}{Queue}};}
\DoxyCodeLine{00020\ }
\DoxyCodeLine{00021\ \ \ \mbox{\hyperlink{classEigen_1_1ThreadPoolTempl_a9ac475e6b3df752a34c42a7d7cd5934a}{ThreadPoolTempl}}(\textcolor{keywordtype}{int}\ num\_threads,\ Environment\ env\ =\ Environment())}
\DoxyCodeLine{00022\ \ \ \ \ \ \ :\ \mbox{\hyperlink{classEigen_1_1ThreadPoolTempl}{ThreadPoolTempl}}(num\_threads,\ true,\ env)\ \{\}}
\DoxyCodeLine{00023\ }
\DoxyCodeLine{00024\ \ \ \mbox{\hyperlink{classEigen_1_1ThreadPoolTempl_a260a9bd9c0b4766c67d8c92f13539faf}{ThreadPoolTempl}}(\textcolor{keywordtype}{int}\ num\_threads,\ \textcolor{keywordtype}{bool}\ allow\_spinning,}
\DoxyCodeLine{00025\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ Environment\ env\ =\ Environment())}
\DoxyCodeLine{00026\ \ \ \ \ \ \ :\ env\_(env),}
\DoxyCodeLine{00027\ \ \ \ \ \ \ \ \ num\_threads\_(num\_threads),}
\DoxyCodeLine{00028\ \ \ \ \ \ \ \ \ allow\_spinning\_(allow\_spinning),}
\DoxyCodeLine{00029\ \ \ \ \ \ \ \ \ thread\_data\_(num\_threads),}
\DoxyCodeLine{00030\ \ \ \ \ \ \ \ \ all\_coprimes\_(num\_threads),}
\DoxyCodeLine{00031\ \ \ \ \ \ \ \ \ waiters\_(num\_threads),}
\DoxyCodeLine{00032\ \ \ \ \ \ \ \ \ global\_steal\_partition\_(EncodePartition(0,\ num\_threads\_)),}
\DoxyCodeLine{00033\ \ \ \ \ \ \ \ \ blocked\_(0),}
\DoxyCodeLine{00034\ \ \ \ \ \ \ \ \ spinning\_(0),}
\DoxyCodeLine{00035\ \ \ \ \ \ \ \ \ done\_(false),}
\DoxyCodeLine{00036\ \ \ \ \ \ \ \ \ cancelled\_(false),}
\DoxyCodeLine{00037\ \ \ \ \ \ \ \ \ ec\_(waiters\_)\ \{}
\DoxyCodeLine{00038\ \ \ \ \ waiters\_.resize(num\_threads\_);}
\DoxyCodeLine{00039\ \ \ \ \ \textcolor{comment}{//\ Calculate\ coprimes\ of\ all\ numbers\ [1,\ num\_threads].}}
\DoxyCodeLine{00040\ \ \ \ \ \textcolor{comment}{//\ Coprimes\ are\ used\ for\ random\ walks\ over\ all\ threads\ in\ Steal}}
\DoxyCodeLine{00041\ \ \ \ \ \textcolor{comment}{//\ and\ NonEmptyQueueIndex.\ Iteration\ is\ based\ on\ the\ fact\ that\ if\ we\ take}}
\DoxyCodeLine{00042\ \ \ \ \ \textcolor{comment}{//\ a\ random\ starting\ thread\ index\ t\ and\ calculate\ num\_threads\ -\/\ 1\ subsequent}}
\DoxyCodeLine{00043\ \ \ \ \ \textcolor{comment}{//\ indices\ as\ (t\ +\ coprime)\ \%\ num\_threads,\ we\ will\ cover\ all\ threads\ without}}
\DoxyCodeLine{00044\ \ \ \ \ \textcolor{comment}{//\ repetitions\ (effectively\ getting\ a\ presudo-\/random\ permutation\ of\ thread}}
\DoxyCodeLine{00045\ \ \ \ \ \textcolor{comment}{//\ indices).}}
\DoxyCodeLine{00046\ \ \ \ \ \mbox{\hyperlink{Macros_8h_a000d296c3fca8ba6e784bdcc7d01d91d}{eigen\_plain\_assert}}(num\_threads\_\ <\ kMaxThreads);}
\DoxyCodeLine{00047\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ =\ 1;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ <=\ num\_threads\_;\ ++\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}})\ \{}
\DoxyCodeLine{00048\ \ \ \ \ \ \ all\_coprimes\_.emplace\_back(\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}});}
\DoxyCodeLine{00049\ \ \ \ \ \ \ ComputeCoprimes(\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}},\ \&all\_coprimes\_.back());}
\DoxyCodeLine{00050\ \ \ \ \ \}}
\DoxyCodeLine{00051\ \textcolor{preprocessor}{\#ifndef\ EIGEN\_THREAD\_LOCAL}}
\DoxyCodeLine{00052\ \ \ \ \ init\_barrier\_.reset(\textcolor{keyword}{new}\ \mbox{\hyperlink{classEigen_1_1Barrier}{Barrier}}(num\_threads\_));}
\DoxyCodeLine{00053\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00054\ \ \ \ \ thread\_data\_.\mbox{\hyperlink{classEigen_1_1MaxSizeVector_aa438323b34ae0f12ae27db22d70891d8}{resize}}(num\_threads\_);}
\DoxyCodeLine{00055\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ =\ 0;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ <\ num\_threads\_;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}++)\ \{}
\DoxyCodeLine{00056\ \ \ \ \ \ \ SetStealPartition(\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}},\ EncodePartition(0,\ num\_threads\_));}
\DoxyCodeLine{00057\ \ \ \ \ \ \ thread\_data\_[\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}].thread.reset(}
\DoxyCodeLine{00058\ \ \ \ \ \ \ \ \ \ \ env\_.CreateThread([\textcolor{keyword}{this},\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}]()\ \{\ WorkerLoop(i);\ \}));}
\DoxyCodeLine{00059\ \ \ \ \ \}}
\DoxyCodeLine{00060\ \textcolor{preprocessor}{\#ifndef\ EIGEN\_THREAD\_LOCAL}}
\DoxyCodeLine{00061\ \ \ \ \ \textcolor{comment}{//\ Wait\ for\ workers\ to\ initialize\ per\_thread\_map\_.\ Otherwise\ we\ might\ race}}
\DoxyCodeLine{00062\ \ \ \ \ \textcolor{comment}{//\ with\ them\ in\ Schedule\ or\ CurrentThreadId.}}
\DoxyCodeLine{00063\ \ \ \ \ init\_barrier\_-\/>Wait();}
\DoxyCodeLine{00064\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00065\ \ \ \}}
\DoxyCodeLine{00066\ }
\DoxyCodeLine{00067\ \ \ \mbox{\hyperlink{classEigen_1_1ThreadPoolTempl_a23e588780519fa22fa46d316c154ce9b}{\string~ThreadPoolTempl}}()\ \{}
\DoxyCodeLine{00068\ \ \ \ \ done\_\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00069\ }
\DoxyCodeLine{00070\ \ \ \ \ \textcolor{comment}{//\ Now\ if\ all\ threads\ block\ without\ work,\ they\ will\ start\ exiting.}}
\DoxyCodeLine{00071\ \ \ \ \ \textcolor{comment}{//\ But\ note\ that\ threads\ can\ continue\ to\ work\ arbitrary\ long,}}
\DoxyCodeLine{00072\ \ \ \ \ \textcolor{comment}{//\ block,\ submit\ new\ work,\ unblock\ and\ otherwise\ live\ full\ life.}}
\DoxyCodeLine{00073\ \ \ \ \ \textcolor{keywordflow}{if}\ (!cancelled\_)\ \{}
\DoxyCodeLine{00074\ \ \ \ \ \ \ ec\_.\mbox{\hyperlink{classEigen_1_1EventCount_a4e0c3f15c54ef7baa9ff1963f549f73d}{Notify}}(\textcolor{keyword}{true});}
\DoxyCodeLine{00075\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00076\ \ \ \ \ \ \ \textcolor{comment}{//\ Since\ we\ were\ cancelled,\ there\ might\ be\ entries\ in\ the\ queues.}}
\DoxyCodeLine{00077\ \ \ \ \ \ \ \textcolor{comment}{//\ Empty\ them\ to\ prevent\ their\ destructor\ from\ asserting.}}
\DoxyCodeLine{00078\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ =\ 0;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ <\ thread\_data\_.\mbox{\hyperlink{classEigen_1_1MaxSizeVector_a126c2ea17157a14348222e5cb6a276ca}{size}}();\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}++)\ \{}
\DoxyCodeLine{00079\ \ \ \ \ \ \ \ \ thread\_data\_[\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}].queue.Flush();}
\DoxyCodeLine{00080\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00081\ \ \ \ \ \}}
\DoxyCodeLine{00082\ \ \ \ \ \textcolor{comment}{//\ Join\ threads\ explicitly\ (by\ destroying)\ to\ avoid\ destruction\ order\ within}}
\DoxyCodeLine{00083\ \ \ \ \ \textcolor{comment}{//\ this\ class.}}
\DoxyCodeLine{00084\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ =\ 0;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ <\ thread\_data\_.\mbox{\hyperlink{classEigen_1_1MaxSizeVector_a126c2ea17157a14348222e5cb6a276ca}{size}}();\ ++\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}})}
\DoxyCodeLine{00085\ \ \ \ \ \ \ thread\_data\_[\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}].thread.reset();}
\DoxyCodeLine{00086\ \ \ \}}
\DoxyCodeLine{00087\ }
\DoxyCodeLine{00088\ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classEigen_1_1ThreadPoolTempl_a0eb8ef5a4669ca6180c4514b4ce599b8}{SetStealPartitions}}(\textcolor{keyword}{const}\ std::vector<std::pair<unsigned,\ unsigned>>\&\ partitions)\ \{}
\DoxyCodeLine{00089\ \ \ \ \ \mbox{\hyperlink{Macros_8h_a000d296c3fca8ba6e784bdcc7d01d91d}{eigen\_plain\_assert}}(partitions.size()\ ==\ \textcolor{keyword}{static\_cast<}std::size\_t\textcolor{keyword}{>}(num\_threads\_));}
\DoxyCodeLine{00090\ }
\DoxyCodeLine{00091\ \ \ \ \ \textcolor{comment}{//\ Pass\ this\ information\ to\ each\ thread\ queue.}}
\DoxyCodeLine{00092\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ =\ 0;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ <\ num\_threads\_;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}++)\ \{}
\DoxyCodeLine{00093\ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keyword}{auto}\&\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2raw__hash__set__benchmark_8cc_ab43c7a62bb76edb17a7deacc3400de7c}{pair}}\ =\ partitions[\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}];}
\DoxyCodeLine{00094\ \ \ \ \ \ \ \textcolor{keywordtype}{unsigned}\ start\ =\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2raw__hash__set__benchmark_8cc_ab43c7a62bb76edb17a7deacc3400de7c}{pair}}.first,\ end\ =\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2raw__hash__set__benchmark_8cc_ab43c7a62bb76edb17a7deacc3400de7c}{pair}}.second;}
\DoxyCodeLine{00095\ \ \ \ \ \ \ AssertBounds(start,\ end);}
\DoxyCodeLine{00096\ \ \ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2raw__hash__set__test_8cc_aa0ccb5ee6d882ee3605ff47745c6467b}{val}}\ =\ EncodePartition(start,\ end);}
\DoxyCodeLine{00097\ \ \ \ \ \ \ SetStealPartition(\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}},\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2raw__hash__set__test_8cc_aa0ccb5ee6d882ee3605ff47745c6467b}{val}});}
\DoxyCodeLine{00098\ \ \ \ \ \}}
\DoxyCodeLine{00099\ \ \ \}}
\DoxyCodeLine{00100\ }
\DoxyCodeLine{00101\ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classEigen_1_1ThreadPoolTempl_a173a9316c1c44bfa16ea684d40d082e7}{Schedule}}(std::function<\textcolor{keywordtype}{void}()>\ fn)\ \mbox{\hyperlink{Macros_8h_a19dff117eed64678a59331cdeda6d8fc}{EIGEN\_OVERRIDE}}\ \{}
\DoxyCodeLine{00102\ \ \ \ \ \mbox{\hyperlink{classEigen_1_1ThreadPoolTempl_a307298c025beb275281e24828822581c}{ScheduleWithHint}}(std::move(fn),\ 0,\ num\_threads\_);}
\DoxyCodeLine{00103\ \ \ \}}
\DoxyCodeLine{00104\ }
\DoxyCodeLine{00105\ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classEigen_1_1ThreadPoolTempl_a307298c025beb275281e24828822581c}{ScheduleWithHint}}(std::function<\textcolor{keywordtype}{void}()>\ fn,\ \textcolor{keywordtype}{int}\ start,}
\DoxyCodeLine{00106\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ limit)\textcolor{keyword}{\ override\ }\{}
\DoxyCodeLine{00107\ \ \ \ \ \mbox{\hyperlink{classEigen_1_1ThreadPoolTempl_adf196760672014b96bb76fd0b8191d95}{Task}}\ t\ =\ env\_.CreateTask(std::move(fn));}
\DoxyCodeLine{00108\ \ \ \ \ PerThread*\ pt\ =\ GetPerThread();}
\DoxyCodeLine{00109\ \ \ \ \ \textcolor{keywordflow}{if}\ (pt-\/>pool\ ==\ \textcolor{keyword}{this})\ \{}
\DoxyCodeLine{00110\ \ \ \ \ \ \ \textcolor{comment}{//\ Worker\ thread\ of\ this\ pool,\ push\ onto\ the\ thread's\ queue.}}
\DoxyCodeLine{00111\ \ \ \ \ \ \ \mbox{\hyperlink{classEigen_1_1RunQueue}{Queue}}\&\ q\ =\ thread\_data\_[pt-\/>thread\_id].queue;}
\DoxyCodeLine{00112\ \ \ \ \ \ \ t\ =\ q.PushFront(std::move(t));}
\DoxyCodeLine{00113\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00114\ \ \ \ \ \ \ \textcolor{comment}{//\ A\ free-\/standing\ thread\ (or\ worker\ of\ another\ pool),\ push\ onto\ a\ random}}
\DoxyCodeLine{00115\ \ \ \ \ \ \ \textcolor{comment}{//\ queue.}}
\DoxyCodeLine{00116\ \ \ \ \ \ \ \mbox{\hyperlink{Macros_8h_a000d296c3fca8ba6e784bdcc7d01d91d}{eigen\_plain\_assert}}(start\ <\ limit);}
\DoxyCodeLine{00117\ \ \ \ \ \ \ \mbox{\hyperlink{Macros_8h_a000d296c3fca8ba6e784bdcc7d01d91d}{eigen\_plain\_assert}}(limit\ <=\ num\_threads\_);}
\DoxyCodeLine{00118\ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ num\_queues\ =\ limit\ -\/\ start;}
\DoxyCodeLine{00119\ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ rnd\ =\ Rand(\&pt-\/>rand)\ \%\ num\_queues;}
\DoxyCodeLine{00120\ \ \ \ \ \ \ \mbox{\hyperlink{Macros_8h_a000d296c3fca8ba6e784bdcc7d01d91d}{eigen\_plain\_assert}}(start\ +\ rnd\ <\ limit);}
\DoxyCodeLine{00121\ \ \ \ \ \ \ \mbox{\hyperlink{classEigen_1_1RunQueue}{Queue}}\&\ q\ =\ thread\_data\_[start\ +\ rnd].queue;}
\DoxyCodeLine{00122\ \ \ \ \ \ \ t\ =\ q.PushBack(std::move(t));}
\DoxyCodeLine{00123\ \ \ \ \ \}}
\DoxyCodeLine{00124\ \ \ \ \ \textcolor{comment}{//\ Note:\ below\ we\ touch\ this\ after\ making\ w\ available\ to\ worker\ threads.}}
\DoxyCodeLine{00125\ \ \ \ \ \textcolor{comment}{//\ Strictly\ speaking,\ this\ can\ lead\ to\ a\ racy-\/use-\/after-\/free.\ Consider\ that}}
\DoxyCodeLine{00126\ \ \ \ \ \textcolor{comment}{//\ Schedule\ is\ called\ from\ a\ thread\ that\ is\ neither\ main\ thread\ nor\ a\ worker}}
\DoxyCodeLine{00127\ \ \ \ \ \textcolor{comment}{//\ thread\ of\ this\ pool.\ Then,\ execution\ of\ w\ directly\ or\ indirectly}}
\DoxyCodeLine{00128\ \ \ \ \ \textcolor{comment}{//\ completes\ overall\ computations,\ which\ in\ turn\ leads\ to\ destruction\ of}}
\DoxyCodeLine{00129\ \ \ \ \ \textcolor{comment}{//\ this.\ We\ expect\ that\ such\ scenario\ is\ prevented\ by\ program,\ that\ is,}}
\DoxyCodeLine{00130\ \ \ \ \ \textcolor{comment}{//\ this\ is\ kept\ alive\ while\ any\ threads\ can\ potentially\ be\ in\ Schedule.}}
\DoxyCodeLine{00131\ \ \ \ \ \textcolor{keywordflow}{if}\ (!t.f)\ \{}
\DoxyCodeLine{00132\ \ \ \ \ \ \ ec\_.\mbox{\hyperlink{classEigen_1_1EventCount_a4e0c3f15c54ef7baa9ff1963f549f73d}{Notify}}(\textcolor{keyword}{false});}
\DoxyCodeLine{00133\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00134\ \ \ \ \ \ \ env\_.ExecuteTask(t);\ \ \textcolor{comment}{//\ Push\ failed,\ execute\ directly.}}
\DoxyCodeLine{00135\ \ \ \ \ \}}
\DoxyCodeLine{00136\ \ \ \}}
\DoxyCodeLine{00137\ }
\DoxyCodeLine{00138\ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classEigen_1_1ThreadPoolTempl_a0ad2d7bc31ee21c0d44cffd4934901c2}{Cancel}}()\ \mbox{\hyperlink{Macros_8h_a19dff117eed64678a59331cdeda6d8fc}{EIGEN\_OVERRIDE}}\ \{}
\DoxyCodeLine{00139\ \ \ \ \ cancelled\_\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00140\ \ \ \ \ done\_\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00141\ }
\DoxyCodeLine{00142\ \ \ \ \ \textcolor{comment}{//\ Let\ each\ thread\ know\ it's\ been\ cancelled.}}
\DoxyCodeLine{00143\ \textcolor{preprocessor}{\#ifdef\ EIGEN\_THREAD\_ENV\_SUPPORTS\_CANCELLATION}}
\DoxyCodeLine{00144\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ =\ 0;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ <\ thread\_data\_.\mbox{\hyperlink{classEigen_1_1MaxSizeVector_a126c2ea17157a14348222e5cb6a276ca}{size}}();\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}++)\ \{}
\DoxyCodeLine{00145\ \ \ \ \ \ \ thread\_data\_[\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}].thread-\/>OnCancel();}
\DoxyCodeLine{00146\ \ \ \ \ \}}
\DoxyCodeLine{00147\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00148\ }
\DoxyCodeLine{00149\ \ \ \ \ \textcolor{comment}{//\ Wake\ up\ the\ threads\ without\ work\ to\ let\ them\ exit\ on\ their\ own.}}
\DoxyCodeLine{00150\ \ \ \ \ ec\_.\mbox{\hyperlink{classEigen_1_1EventCount_a4e0c3f15c54ef7baa9ff1963f549f73d}{Notify}}(\textcolor{keyword}{true});}
\DoxyCodeLine{00151\ \ \ \}}
\DoxyCodeLine{00152\ }
\DoxyCodeLine{00153\ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classEigen_1_1ThreadPoolTempl_a834d2d2c52d326c78a04daa9e6c64ae4}{NumThreads}}()\ const\ \mbox{\hyperlink{Macros_8h_a77fd405b2a61a9ff14bc36e54ae70b2e}{EIGEN\_FINAL}}\ \{\ \textcolor{keywordflow}{return}\ num\_threads\_;\ \}}
\DoxyCodeLine{00154\ }
\DoxyCodeLine{00155\ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classEigen_1_1ThreadPoolTempl_a10e5996daf4278d48e419e19f8af2569}{CurrentThreadId}}()\ const\ \mbox{\hyperlink{Macros_8h_a77fd405b2a61a9ff14bc36e54ae70b2e}{EIGEN\_FINAL}}\ \{}
\DoxyCodeLine{00156\ \ \ \ \ \textcolor{keyword}{const}\ PerThread*\ pt\ =\ \textcolor{keyword}{const\_cast<}\mbox{\hyperlink{classEigen_1_1ThreadPoolTempl}{ThreadPoolTempl}}*\textcolor{keyword}{>}(\textcolor{keyword}{this})-\/>GetPerThread();}
\DoxyCodeLine{00157\ \ \ \ \ \textcolor{keywordflow}{if}\ (pt-\/>pool\ ==\ \textcolor{keyword}{this})\ \{}
\DoxyCodeLine{00158\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ pt-\/>thread\_id;}
\DoxyCodeLine{00159\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00160\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ -\/1;}
\DoxyCodeLine{00161\ \ \ \ \ \}}
\DoxyCodeLine{00162\ \ \ \}}
\DoxyCodeLine{00163\ }
\DoxyCodeLine{00164\ \ \textcolor{keyword}{private}:}
\DoxyCodeLine{00165\ \ \ \textcolor{comment}{//\ Create\ a\ single\ atomic<int>\ that\ encodes\ start\ and\ limit\ information\ for}}
\DoxyCodeLine{00166\ \ \ \textcolor{comment}{//\ each\ thread.}}
\DoxyCodeLine{00167\ \ \ \textcolor{comment}{//\ We\ expect\ num\_threads\_\ <\ 65536,\ so\ we\ can\ store\ them\ in\ a\ single}}
\DoxyCodeLine{00168\ \ \ \textcolor{comment}{//\ std::atomic<unsigned>.}}
\DoxyCodeLine{00169\ \ \ \textcolor{comment}{//\ Exposed\ publicly\ as\ static\ functions\ so\ that\ external\ callers\ can\ reuse}}
\DoxyCodeLine{00170\ \ \ \textcolor{comment}{//\ this\ encode/decode\ logic\ for\ maintaining\ their\ own\ thread-\/safe\ copies\ of}}
\DoxyCodeLine{00171\ \ \ \textcolor{comment}{//\ scheduling\ and\ steal\ domain(s).}}
\DoxyCodeLine{00172\ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ kMaxPartitionBits\ =\ 16;}
\DoxyCodeLine{00173\ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ kMaxThreads\ =\ 1\ <<\ kMaxPartitionBits;}
\DoxyCodeLine{00174\ }
\DoxyCodeLine{00175\ \ \ \textcolor{keyword}{inline}\ \textcolor{keywordtype}{unsigned}\ EncodePartition(\textcolor{keywordtype}{unsigned}\ start,\ \textcolor{keywordtype}{unsigned}\ limit)\ \{}
\DoxyCodeLine{00176\ \ \ \ \ \textcolor{keywordflow}{return}\ (start\ <<\ kMaxPartitionBits)\ |\ limit;}
\DoxyCodeLine{00177\ \ \ \}}
\DoxyCodeLine{00178\ }
\DoxyCodeLine{00179\ \ \ \textcolor{keyword}{inline}\ \textcolor{keywordtype}{void}\ DecodePartition(\textcolor{keywordtype}{unsigned}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2raw__hash__set__test_8cc_aa0ccb5ee6d882ee3605ff47745c6467b}{val}},\ \textcolor{keywordtype}{unsigned}*\ start,\ \textcolor{keywordtype}{unsigned}*\ limit)\ \{}
\DoxyCodeLine{00180\ \ \ \ \ *limit\ =\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2raw__hash__set__test_8cc_aa0ccb5ee6d882ee3605ff47745c6467b}{val}}\ \&\ (kMaxThreads\ -\/\ 1);}
\DoxyCodeLine{00181\ \ \ \ \ \mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2raw__hash__set__test_8cc_aa0ccb5ee6d882ee3605ff47745c6467b}{val}}\ >>=\ kMaxPartitionBits;}
\DoxyCodeLine{00182\ \ \ \ \ *start\ =\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2raw__hash__set__test_8cc_aa0ccb5ee6d882ee3605ff47745c6467b}{val}};}
\DoxyCodeLine{00183\ \ \ \}}
\DoxyCodeLine{00184\ }
\DoxyCodeLine{00185\ \ \ \textcolor{keywordtype}{void}\ AssertBounds(\textcolor{keywordtype}{int}\ start,\ \textcolor{keywordtype}{int}\ end)\ \{}
\DoxyCodeLine{00186\ \ \ \ \ \mbox{\hyperlink{Macros_8h_a000d296c3fca8ba6e784bdcc7d01d91d}{eigen\_plain\_assert}}(start\ >=\ 0);}
\DoxyCodeLine{00187\ \ \ \ \ \mbox{\hyperlink{Macros_8h_a000d296c3fca8ba6e784bdcc7d01d91d}{eigen\_plain\_assert}}(start\ <\ end);\ \ \textcolor{comment}{//\ non-\/zero\ sized\ partition}}
\DoxyCodeLine{00188\ \ \ \ \ \mbox{\hyperlink{Macros_8h_a000d296c3fca8ba6e784bdcc7d01d91d}{eigen\_plain\_assert}}(end\ <=\ num\_threads\_);}
\DoxyCodeLine{00189\ \ \ \}}
\DoxyCodeLine{00190\ }
\DoxyCodeLine{00191\ \ \ \textcolor{keyword}{inline}\ \textcolor{keywordtype}{void}\ SetStealPartition(\textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}},\ \textcolor{keywordtype}{unsigned}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2raw__hash__set__test_8cc_aa0ccb5ee6d882ee3605ff47745c6467b}{val}})\ \{}
\DoxyCodeLine{00192\ \ \ \ \ thread\_data\_[\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}].steal\_partition.store(\mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2raw__hash__set__test_8cc_aa0ccb5ee6d882ee3605ff47745c6467b}{val}},\ std::memory\_order\_relaxed);}
\DoxyCodeLine{00193\ \ \ \}}
\DoxyCodeLine{00194\ }
\DoxyCodeLine{00195\ \ \ \textcolor{keyword}{inline}\ \textcolor{keywordtype}{unsigned}\ GetStealPartition(\textcolor{keywordtype}{int}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}})\ \{}
\DoxyCodeLine{00196\ \ \ \ \ \textcolor{keywordflow}{return}\ thread\_data\_[\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}].steal\_partition.load(std::memory\_order\_relaxed);}
\DoxyCodeLine{00197\ \ \ \}}
\DoxyCodeLine{00198\ }
\DoxyCodeLine{00199\ \ \ \textcolor{keywordtype}{void}\ ComputeCoprimes(\textcolor{keywordtype}{int}\ \mbox{\hyperlink{TensorIntDiv_8h_ab2b6b0c222cd1ce70d6a831f57241e59}{N}},\ MaxSizeVector<unsigned>*\ coprimes)\ \{}
\DoxyCodeLine{00200\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ =\ 1;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ <=\ \mbox{\hyperlink{TensorIntDiv_8h_ab2b6b0c222cd1ce70d6a831f57241e59}{N}};\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}++)\ \{}
\DoxyCodeLine{00201\ \ \ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2common__policy__traits__test_8cc_aa4c2a5552e9bc49b1816ff532f558c74}{a}}\ =\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}};}
\DoxyCodeLine{00202\ \ \ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2layout__test_8cc_ad66453096871179e6c6effe0df4b483b}{b}}\ =\ \mbox{\hyperlink{TensorIntDiv_8h_ab2b6b0c222cd1ce70d6a831f57241e59}{N}};}
\DoxyCodeLine{00203\ \ \ \ \ \ \ \textcolor{comment}{//\ If\ GCD(a,\ b)\ ==\ 1,\ then\ a\ and\ b\ are\ coprimes.}}
\DoxyCodeLine{00204\ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ (\mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2layout__test_8cc_ad66453096871179e6c6effe0df4b483b}{b}}\ !=\ 0)\ \{}
\DoxyCodeLine{00205\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{unsigned}\ tmp\ =\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2common__policy__traits__test_8cc_aa4c2a5552e9bc49b1816ff532f558c74}{a}};}
\DoxyCodeLine{00206\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2common__policy__traits__test_8cc_aa4c2a5552e9bc49b1816ff532f558c74}{a}}\ =\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2layout__test_8cc_ad66453096871179e6c6effe0df4b483b}{b}};}
\DoxyCodeLine{00207\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2layout__test_8cc_ad66453096871179e6c6effe0df4b483b}{b}}\ =\ tmp\ \%\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2layout__test_8cc_ad66453096871179e6c6effe0df4b483b}{b}};}
\DoxyCodeLine{00208\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00209\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2common__policy__traits__test_8cc_aa4c2a5552e9bc49b1816ff532f558c74}{a}}\ ==\ 1)\ \{}
\DoxyCodeLine{00210\ \ \ \ \ \ \ \ \ coprimes-\/>push\_back(\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}});}
\DoxyCodeLine{00211\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00212\ \ \ \ \ \}}
\DoxyCodeLine{00213\ \ \ \}}
\DoxyCodeLine{00214\ }
\DoxyCodeLine{00215\ \ \ \textcolor{keyword}{typedef}\ \textcolor{keyword}{typename}\ Environment::EnvThread\ Thread;}
\DoxyCodeLine{00216\ }
\DoxyCodeLine{00217\ \ \ \textcolor{keyword}{struct\ }PerThread\ \{}
\DoxyCodeLine{00218\ \ \ \ \ \textcolor{keyword}{constexpr}\ PerThread()\ :\ pool(NULL),\ rand(0),\ thread\_id(-\/1)\ \{\}}
\DoxyCodeLine{00219\ \ \ \ \ \mbox{\hyperlink{classEigen_1_1ThreadPoolTempl_a9ac475e6b3df752a34c42a7d7cd5934a}{ThreadPoolTempl}}*\ pool;\ \ \textcolor{comment}{//\ Parent\ pool,\ or\ null\ for\ normal\ threads.}}
\DoxyCodeLine{00220\ \ \ \ \ \mbox{\hyperlink{namespaceEigen_1_1numext_a0259c31cd34e096be5056e9d88ae0500}{uint64\_t}}\ rand;\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Random\ generator\ state.}}
\DoxyCodeLine{00221\ \ \ \ \ \textcolor{keywordtype}{int}\ thread\_id;\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Worker\ thread\ index\ in\ pool.}}
\DoxyCodeLine{00222\ \textcolor{preprocessor}{\#ifndef\ EIGEN\_THREAD\_LOCAL}}
\DoxyCodeLine{00223\ \ \ \ \ \textcolor{comment}{//\ Prevent\ false\ sharing.}}
\DoxyCodeLine{00224\ \ \ \ \ \textcolor{keywordtype}{char}\ pad\_[128];}
\DoxyCodeLine{00225\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00226\ \ \ \};}
\DoxyCodeLine{00227\ }
\DoxyCodeLine{00228\ \ \ \textcolor{keyword}{struct\ }ThreadData\ \{}
\DoxyCodeLine{00229\ \ \ \ \ \textcolor{keyword}{constexpr}\ ThreadData()\ :\ thread(),\ steal\_partition(0),\ queue()\ \{\}}
\DoxyCodeLine{00230\ \ \ \ \ std::unique\_ptr<Thread>\ thread;}
\DoxyCodeLine{00231\ \ \ \ \ std::atomic<unsigned>\ steal\_partition;}
\DoxyCodeLine{00232\ \ \ \ \ \mbox{\hyperlink{classEigen_1_1ThreadPoolTempl_aeafcd23636275484cfc61a214f592513}{Queue}}\ queue;}
\DoxyCodeLine{00233\ \ \ \};}
\DoxyCodeLine{00234\ }
\DoxyCodeLine{00235\ \ \ Environment\ env\_;}
\DoxyCodeLine{00236\ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ num\_threads\_;}
\DoxyCodeLine{00237\ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{bool}\ allow\_spinning\_;}
\DoxyCodeLine{00238\ \ \ MaxSizeVector<ThreadData>\ thread\_data\_;}
\DoxyCodeLine{00239\ \ \ MaxSizeVector<MaxSizeVector<unsigned>>\ all\_coprimes\_;}
\DoxyCodeLine{00240\ \ \ MaxSizeVector<EventCount::Waiter>\ waiters\_;}
\DoxyCodeLine{00241\ \ \ \textcolor{keywordtype}{unsigned}\ global\_steal\_partition\_;}
\DoxyCodeLine{00242\ \ \ std::atomic<unsigned>\ blocked\_;}
\DoxyCodeLine{00243\ \ \ std::atomic<bool>\ spinning\_;}
\DoxyCodeLine{00244\ \ \ std::atomic<bool>\ done\_;}
\DoxyCodeLine{00245\ \ \ std::atomic<bool>\ cancelled\_;}
\DoxyCodeLine{00246\ \ \ EventCount\ ec\_;}
\DoxyCodeLine{00247\ \textcolor{preprocessor}{\#ifndef\ EIGEN\_THREAD\_LOCAL}}
\DoxyCodeLine{00248\ \ \ std::unique\_ptr<Barrier>\ init\_barrier\_;}
\DoxyCodeLine{00249\ \ \ std::mutex\ per\_thread\_map\_mutex\_;\ \ \textcolor{comment}{//\ Protects\ per\_thread\_map\_.}}
\DoxyCodeLine{00250\ \ \ std::unordered\_map<uint64\_t,\ std::unique\_ptr<PerThread>>\ per\_thread\_map\_;}
\DoxyCodeLine{00251\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00252\ }
\DoxyCodeLine{00253\ \ \ \textcolor{comment}{//\ Main\ worker\ thread\ loop.}}
\DoxyCodeLine{00254\ \ \ \textcolor{keywordtype}{void}\ WorkerLoop(\textcolor{keywordtype}{int}\ thread\_id)\ \{}
\DoxyCodeLine{00255\ \textcolor{preprocessor}{\#ifndef\ EIGEN\_THREAD\_LOCAL}}
\DoxyCodeLine{00256\ \ \ \ \ std::unique\_ptr<PerThread>\ new\_pt(\textcolor{keyword}{new}\ PerThread());}
\DoxyCodeLine{00257\ \ \ \ \ per\_thread\_map\_mutex\_.lock();}
\DoxyCodeLine{00258\ \ \ \ \ \textcolor{keywordtype}{bool}\ insertOK\ =\ per\_thread\_map\_.emplace(GlobalThreadIdHash(),\ std::move(new\_pt)).second;}
\DoxyCodeLine{00259\ \ \ \ \ \mbox{\hyperlink{Macros_8h_a000d296c3fca8ba6e784bdcc7d01d91d}{eigen\_plain\_assert}}(insertOK);}
\DoxyCodeLine{00260\ \ \ \ \ \mbox{\hyperlink{Macros_8h_a7cf6d5b460def34dc4e6acf42889b6a9}{EIGEN\_UNUSED\_VARIABLE}}(insertOK);}
\DoxyCodeLine{00261\ \ \ \ \ per\_thread\_map\_mutex\_.unlock();}
\DoxyCodeLine{00262\ \ \ \ \ init\_barrier\_-\/>Notify();}
\DoxyCodeLine{00263\ \ \ \ \ init\_barrier\_-\/>Wait();}
\DoxyCodeLine{00264\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00265\ \ \ \ \ PerThread*\ pt\ =\ GetPerThread();}
\DoxyCodeLine{00266\ \ \ \ \ pt-\/>pool\ =\ \textcolor{keyword}{this};}
\DoxyCodeLine{00267\ \ \ \ \ pt-\/>rand\ =\ GlobalThreadIdHash();}
\DoxyCodeLine{00268\ \ \ \ \ pt-\/>thread\_id\ =\ thread\_id;}
\DoxyCodeLine{00269\ \ \ \ \ \mbox{\hyperlink{classEigen_1_1ThreadPoolTempl_aeafcd23636275484cfc61a214f592513}{Queue}}\&\ \mbox{\hyperlink{namespaceEigen_1_1numext_a623167b6704db8a5e32853e535235458}{q}}\ =\ thread\_data\_[thread\_id].queue;}
\DoxyCodeLine{00270\ \ \ \ \ EventCount::Waiter*\ waiter\ =\ \&waiters\_[thread\_id];}
\DoxyCodeLine{00271\ \ \ \ \ \textcolor{comment}{//\ TODO(dvyukov,rmlarsen):\ The\ time\ spent\ in\ NonEmptyQueueIndex()\ is}}
\DoxyCodeLine{00272\ \ \ \ \ \textcolor{comment}{//\ proportional\ to\ num\_threads\_\ and\ we\ assume\ that\ new\ work\ is\ scheduled\ at}}
\DoxyCodeLine{00273\ \ \ \ \ \textcolor{comment}{//\ a\ constant\ rate,\ so\ we\ set\ spin\_count\ to\ 5000\ /\ num\_threads\_.\ The}}
\DoxyCodeLine{00274\ \ \ \ \ \textcolor{comment}{//\ constant\ was\ picked\ based\ on\ a\ fair\ dice\ roll,\ tune\ it.}}
\DoxyCodeLine{00275\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ spin\_count\ =}
\DoxyCodeLine{00276\ \ \ \ \ \ \ \ \ allow\_spinning\_\ \&\&\ num\_threads\_\ >\ 0\ ?\ 5000\ /\ num\_threads\_\ :\ 0;}
\DoxyCodeLine{00277\ \ \ \ \ \textcolor{keywordflow}{if}\ (num\_threads\_\ ==\ 1)\ \{}
\DoxyCodeLine{00278\ \ \ \ \ \ \ \textcolor{comment}{//\ For\ num\_threads\_\ ==\ 1\ there\ is\ no\ point\ in\ going\ through\ the\ expensive}}
\DoxyCodeLine{00279\ \ \ \ \ \ \ \textcolor{comment}{//\ steal\ loop.\ Moreover,\ since\ NonEmptyQueueIndex()\ calls\ PopBack()\ on\ the}}
\DoxyCodeLine{00280\ \ \ \ \ \ \ \textcolor{comment}{//\ victim\ queues\ it\ might\ reverse\ the\ order\ in\ which\ ops\ are\ executed}}
\DoxyCodeLine{00281\ \ \ \ \ \ \ \textcolor{comment}{//\ compared\ to\ the\ order\ in\ which\ they\ are\ scheduled,\ which\ tends\ to\ be}}
\DoxyCodeLine{00282\ \ \ \ \ \ \ \textcolor{comment}{//\ counter-\/productive\ for\ the\ types\ of\ I/O\ workloads\ the\ single\ thread}}
\DoxyCodeLine{00283\ \ \ \ \ \ \ \textcolor{comment}{//\ pools\ tend\ to\ be\ used\ for.}}
\DoxyCodeLine{00284\ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ (!cancelled\_)\ \{}
\DoxyCodeLine{00285\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classEigen_1_1ThreadPoolTempl_adf196760672014b96bb76fd0b8191d95}{Task}}\ \mbox{\hyperlink{namespaceabsl_adb6bd4a9012b471ac01613aff8d4d81bae358efa489f58062f10dd7316b65649e}{t}}\ =\ \mbox{\hyperlink{namespaceEigen_1_1numext_a623167b6704db8a5e32853e535235458}{q}}.PopFront();}
\DoxyCodeLine{00286\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ =\ 0;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ <\ spin\_count\ \&\&\ !\mbox{\hyperlink{namespaceabsl_adb6bd4a9012b471ac01613aff8d4d81bae358efa489f58062f10dd7316b65649e}{t}}.f;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}++)\ \{}
\DoxyCodeLine{00287\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!cancelled\_.load(std::memory\_order\_relaxed))\ \{}
\DoxyCodeLine{00288\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespaceabsl_adb6bd4a9012b471ac01613aff8d4d81bae358efa489f58062f10dd7316b65649e}{t}}\ =\ \mbox{\hyperlink{namespaceEigen_1_1numext_a623167b6704db8a5e32853e535235458}{q}}.PopFront();}
\DoxyCodeLine{00289\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00290\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00291\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!\mbox{\hyperlink{namespaceabsl_adb6bd4a9012b471ac01613aff8d4d81bae358efa489f58062f10dd7316b65649e}{t}}.f)\ \{}
\DoxyCodeLine{00292\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!WaitForWork(waiter,\ \&t))\ \{}
\DoxyCodeLine{00293\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00294\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00295\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00296\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{namespaceabsl_adb6bd4a9012b471ac01613aff8d4d81bae358efa489f58062f10dd7316b65649e}{t}}.f)\ \{}
\DoxyCodeLine{00297\ \ \ \ \ \ \ \ \ \ \ env\_.ExecuteTask(t);}
\DoxyCodeLine{00298\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00299\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00300\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00301\ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ (!cancelled\_)\ \{}
\DoxyCodeLine{00302\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classEigen_1_1ThreadPoolTempl_adf196760672014b96bb76fd0b8191d95}{Task}}\ \mbox{\hyperlink{namespaceabsl_adb6bd4a9012b471ac01613aff8d4d81bae358efa489f58062f10dd7316b65649e}{t}}\ =\ \mbox{\hyperlink{namespaceEigen_1_1numext_a623167b6704db8a5e32853e535235458}{q}}.PopFront();}
\DoxyCodeLine{00303\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!\mbox{\hyperlink{namespaceabsl_adb6bd4a9012b471ac01613aff8d4d81bae358efa489f58062f10dd7316b65649e}{t}}.f)\ \{}
\DoxyCodeLine{00304\ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespaceabsl_adb6bd4a9012b471ac01613aff8d4d81bae358efa489f58062f10dd7316b65649e}{t}}\ =\ LocalSteal();}
\DoxyCodeLine{00305\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!\mbox{\hyperlink{namespaceabsl_adb6bd4a9012b471ac01613aff8d4d81bae358efa489f58062f10dd7316b65649e}{t}}.f)\ \{}
\DoxyCodeLine{00306\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespaceabsl_adb6bd4a9012b471ac01613aff8d4d81bae358efa489f58062f10dd7316b65649e}{t}}\ =\ GlobalSteal();}
\DoxyCodeLine{00307\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!\mbox{\hyperlink{namespaceabsl_adb6bd4a9012b471ac01613aff8d4d81bae358efa489f58062f10dd7316b65649e}{t}}.f)\ \{}
\DoxyCodeLine{00308\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Leave\ one\ thread\ spinning.\ This\ reduces\ latency.}}
\DoxyCodeLine{00309\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (allow\_spinning\_\ \&\&\ !spinning\_\ \&\&\ !spinning\_.exchange(\textcolor{keyword}{true}))\ \{}
\DoxyCodeLine{00310\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ =\ 0;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ <\ spin\_count\ \&\&\ !\mbox{\hyperlink{namespaceabsl_adb6bd4a9012b471ac01613aff8d4d81bae358efa489f58062f10dd7316b65649e}{t}}.f;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}++)\ \{}
\DoxyCodeLine{00311\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!cancelled\_.load(std::memory\_order\_relaxed))\ \{}
\DoxyCodeLine{00312\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespaceabsl_adb6bd4a9012b471ac01613aff8d4d81bae358efa489f58062f10dd7316b65649e}{t}}\ =\ GlobalSteal();}
\DoxyCodeLine{00313\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00314\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00315\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00316\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00317\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ spinning\_\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00318\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00319\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!\mbox{\hyperlink{namespaceabsl_adb6bd4a9012b471ac01613aff8d4d81bae358efa489f58062f10dd7316b65649e}{t}}.f)\ \{}
\DoxyCodeLine{00320\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!WaitForWork(waiter,\ \&t))\ \{}
\DoxyCodeLine{00321\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00322\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00323\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00324\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00325\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00326\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00327\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{namespaceabsl_adb6bd4a9012b471ac01613aff8d4d81bae358efa489f58062f10dd7316b65649e}{t}}.f)\ \{}
\DoxyCodeLine{00328\ \ \ \ \ \ \ \ \ \ \ env\_.ExecuteTask(t);}
\DoxyCodeLine{00329\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00330\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00331\ \ \ \ \ \}}
\DoxyCodeLine{00332\ \ \ \}}
\DoxyCodeLine{00333\ }
\DoxyCodeLine{00334\ \ \ \textcolor{comment}{//\ Steal\ tries\ to\ steal\ work\ from\ other\ worker\ threads\ in\ the\ range\ [start,}}
\DoxyCodeLine{00335\ \ \ \textcolor{comment}{//\ limit)\ in\ best-\/effort\ manner.}}
\DoxyCodeLine{00336\ \ \ \mbox{\hyperlink{classEigen_1_1ThreadPoolTempl_adf196760672014b96bb76fd0b8191d95}{Task}}\ Steal(\textcolor{keywordtype}{unsigned}\ start,\ \textcolor{keywordtype}{unsigned}\ limit)\ \{}
\DoxyCodeLine{00337\ \ \ \ \ PerThread*\ pt\ =\ GetPerThread();}
\DoxyCodeLine{00338\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{abseil-cpp_2absl_2base_2internal_2low__level__alloc_8cc_aad9b71a31372d5c0ab9c23163efe9544}{size}}\ =\ limit\ -\/\ start;}
\DoxyCodeLine{00339\ \ \ \ \ \textcolor{keywordtype}{unsigned}\ r\ =\ Rand(\&pt-\/>rand);}
\DoxyCodeLine{00340\ \ \ \ \ \textcolor{comment}{//\ Reduce\ r\ into\ [0,\ size)\ range,\ this\ utilizes\ trick\ from}}
\DoxyCodeLine{00341\ \ \ \ \ \textcolor{comment}{//\ https://lemire.me/blog/2016/06/27/a-\/fast-\/alternative-\/to-\/the-\/modulo-\/reduction/}}
\DoxyCodeLine{00342\ \ \ \ \ \mbox{\hyperlink{Macros_8h_a000d296c3fca8ba6e784bdcc7d01d91d}{eigen\_plain\_assert}}(all\_coprimes\_[\mbox{\hyperlink{abseil-cpp_2absl_2base_2internal_2low__level__alloc_8cc_aad9b71a31372d5c0ab9c23163efe9544}{size}}\ -\/\ 1].\mbox{\hyperlink{abseil-cpp_2absl_2base_2internal_2low__level__alloc_8cc_aad9b71a31372d5c0ab9c23163efe9544}{size}}()\ <\ (1<<30));}
\DoxyCodeLine{00343\ \ \ \ \ \textcolor{keywordtype}{unsigned}\ victim\ =\ ((\mbox{\hyperlink{namespaceEigen_1_1numext_a0259c31cd34e096be5056e9d88ae0500}{uint64\_t}})r\ *\ (\mbox{\hyperlink{namespaceEigen_1_1numext_a0259c31cd34e096be5056e9d88ae0500}{uint64\_t}})\mbox{\hyperlink{abseil-cpp_2absl_2base_2internal_2low__level__alloc_8cc_aad9b71a31372d5c0ab9c23163efe9544}{size}})\ >>\ 32;}
\DoxyCodeLine{00344\ \ \ \ \ \textcolor{keywordtype}{unsigned}\ index\ =\ ((\mbox{\hyperlink{namespaceEigen_1_1numext_a0259c31cd34e096be5056e9d88ae0500}{uint64\_t}})\ all\_coprimes\_[\mbox{\hyperlink{abseil-cpp_2absl_2base_2internal_2low__level__alloc_8cc_aad9b71a31372d5c0ab9c23163efe9544}{size}}\ -\/\ 1].size()\ *\ (uint64\_t)r)\ >>\ 32;}
\DoxyCodeLine{00345\ \ \ \ \ \textcolor{keywordtype}{unsigned}\ inc\ =\ all\_coprimes\_[\mbox{\hyperlink{abseil-cpp_2absl_2base_2internal_2low__level__alloc_8cc_aad9b71a31372d5c0ab9c23163efe9544}{size}}\ -\/\ 1][index];}
\DoxyCodeLine{00346\ }
\DoxyCodeLine{00347\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{unsigned}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ =\ 0;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ <\ \mbox{\hyperlink{abseil-cpp_2absl_2base_2internal_2low__level__alloc_8cc_aad9b71a31372d5c0ab9c23163efe9544}{size}};\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}++)\ \{}
\DoxyCodeLine{00348\ \ \ \ \ \ \ \mbox{\hyperlink{Macros_8h_a000d296c3fca8ba6e784bdcc7d01d91d}{eigen\_plain\_assert}}(start\ +\ victim\ <\ limit);}
\DoxyCodeLine{00349\ \ \ \ \ \ \ \mbox{\hyperlink{classEigen_1_1ThreadPoolTempl_adf196760672014b96bb76fd0b8191d95}{Task}}\ \mbox{\hyperlink{namespaceabsl_adb6bd4a9012b471ac01613aff8d4d81bae358efa489f58062f10dd7316b65649e}{t}}\ =\ thread\_data\_[start\ +\ victim].queue.PopBack();}
\DoxyCodeLine{00350\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{namespaceabsl_adb6bd4a9012b471ac01613aff8d4d81bae358efa489f58062f10dd7316b65649e}{t}}.f)\ \{}
\DoxyCodeLine{00351\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{namespaceabsl_adb6bd4a9012b471ac01613aff8d4d81bae358efa489f58062f10dd7316b65649e}{t}};}
\DoxyCodeLine{00352\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00353\ \ \ \ \ \ \ victim\ +=\ inc;}
\DoxyCodeLine{00354\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (victim\ >=\ \mbox{\hyperlink{abseil-cpp_2absl_2base_2internal_2low__level__alloc_8cc_aad9b71a31372d5c0ab9c23163efe9544}{size}})\ \{}
\DoxyCodeLine{00355\ \ \ \ \ \ \ \ \ victim\ -\/=\ \mbox{\hyperlink{abseil-cpp_2absl_2base_2internal_2low__level__alloc_8cc_aad9b71a31372d5c0ab9c23163efe9544}{size}};}
\DoxyCodeLine{00356\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00357\ \ \ \ \ \}}
\DoxyCodeLine{00358\ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classEigen_1_1ThreadPoolTempl_adf196760672014b96bb76fd0b8191d95}{Task}}();}
\DoxyCodeLine{00359\ \ \ \}}
\DoxyCodeLine{00360\ }
\DoxyCodeLine{00361\ \ \ \textcolor{comment}{//\ Steals\ work\ within\ threads\ belonging\ to\ the\ partition.}}
\DoxyCodeLine{00362\ \ \ \mbox{\hyperlink{classEigen_1_1ThreadPoolTempl_adf196760672014b96bb76fd0b8191d95}{Task}}\ LocalSteal()\ \{}
\DoxyCodeLine{00363\ \ \ \ \ PerThread*\ pt\ =\ GetPerThread();}
\DoxyCodeLine{00364\ \ \ \ \ \textcolor{keywordtype}{unsigned}\ partition\ =\ GetStealPartition(pt-\/>thread\_id);}
\DoxyCodeLine{00365\ \ \ \ \ \textcolor{comment}{//\ If\ thread\ steal\ partition\ is\ the\ same\ as\ global\ partition,\ there\ is\ no}}
\DoxyCodeLine{00366\ \ \ \ \ \textcolor{comment}{//\ need\ to\ go\ through\ the\ steal\ loop\ twice.}}
\DoxyCodeLine{00367\ \ \ \ \ \textcolor{keywordflow}{if}\ (global\_steal\_partition\_\ ==\ partition)\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{classEigen_1_1ThreadPoolTempl_adf196760672014b96bb76fd0b8191d95}{Task}}();}
\DoxyCodeLine{00368\ \ \ \ \ \textcolor{keywordtype}{unsigned}\ start,\ limit;}
\DoxyCodeLine{00369\ \ \ \ \ DecodePartition(partition,\ \&start,\ \&limit);}
\DoxyCodeLine{00370\ \ \ \ \ AssertBounds(start,\ limit);}
\DoxyCodeLine{00371\ }
\DoxyCodeLine{00372\ \ \ \ \ \textcolor{keywordflow}{return}\ Steal(start,\ limit);}
\DoxyCodeLine{00373\ \ \ \}}
\DoxyCodeLine{00374\ }
\DoxyCodeLine{00375\ \ \ \textcolor{comment}{//\ Steals\ work\ from\ any\ other\ thread\ in\ the\ pool.}}
\DoxyCodeLine{00376\ \ \ \mbox{\hyperlink{classEigen_1_1ThreadPoolTempl_adf196760672014b96bb76fd0b8191d95}{Task}}\ GlobalSteal()\ \{}
\DoxyCodeLine{00377\ \ \ \ \ \textcolor{keywordflow}{return}\ Steal(0,\ num\_threads\_);}
\DoxyCodeLine{00378\ \ \ \}}
\DoxyCodeLine{00379\ }
\DoxyCodeLine{00380\ }
\DoxyCodeLine{00381\ \ \ \textcolor{comment}{//\ WaitForWork\ blocks\ until\ new\ work\ is\ available\ (returns\ true),\ or\ if\ it\ is}}
\DoxyCodeLine{00382\ \ \ \textcolor{comment}{//\ time\ to\ exit\ (returns\ false).\ Can\ optionally\ return\ a\ task\ to\ execute\ in\ t}}
\DoxyCodeLine{00383\ \ \ \textcolor{comment}{//\ (in\ such\ case\ t.f\ !=\ nullptr\ on\ return).}}
\DoxyCodeLine{00384\ \ \ \textcolor{keywordtype}{bool}\ WaitForWork(EventCount::Waiter*\ waiter,\ \mbox{\hyperlink{classEigen_1_1ThreadPoolTempl_adf196760672014b96bb76fd0b8191d95}{Task}}*\ t)\ \{}
\DoxyCodeLine{00385\ \ \ \ \ \mbox{\hyperlink{Macros_8h_a000d296c3fca8ba6e784bdcc7d01d91d}{eigen\_plain\_assert}}(!\mbox{\hyperlink{namespaceabsl_adb6bd4a9012b471ac01613aff8d4d81bae358efa489f58062f10dd7316b65649e}{t}}-\/>f);}
\DoxyCodeLine{00386\ \ \ \ \ \textcolor{comment}{//\ We\ already\ did\ best-\/effort\ emptiness\ check\ in\ Steal,\ so\ prepare\ for}}
\DoxyCodeLine{00387\ \ \ \ \ \textcolor{comment}{//\ blocking.}}
\DoxyCodeLine{00388\ \ \ \ \ ec\_.Prewait();}
\DoxyCodeLine{00389\ \ \ \ \ \textcolor{comment}{//\ Now\ do\ a\ reliable\ emptiness\ check.}}
\DoxyCodeLine{00390\ \ \ \ \ \textcolor{keywordtype}{int}\ victim\ =\ NonEmptyQueueIndex();}
\DoxyCodeLine{00391\ \ \ \ \ \textcolor{keywordflow}{if}\ (victim\ !=\ -\/1)\ \{}
\DoxyCodeLine{00392\ \ \ \ \ \ \ ec\_.CancelWait();}
\DoxyCodeLine{00393\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (cancelled\_)\ \{}
\DoxyCodeLine{00394\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00395\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00396\ \ \ \ \ \ \ \ \ *\mbox{\hyperlink{namespaceabsl_adb6bd4a9012b471ac01613aff8d4d81bae358efa489f58062f10dd7316b65649e}{t}}\ =\ thread\_data\_[victim].queue.PopBack();}
\DoxyCodeLine{00397\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00398\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00399\ \ \ \ \ \}}
\DoxyCodeLine{00400\ \ \ \ \ \textcolor{comment}{//\ Number\ of\ blocked\ threads\ is\ used\ as\ termination\ condition.}}
\DoxyCodeLine{00401\ \ \ \ \ \textcolor{comment}{//\ If\ we\ are\ shutting\ down\ and\ all\ worker\ threads\ blocked\ without\ work,}}
\DoxyCodeLine{00402\ \ \ \ \ \textcolor{comment}{//\ that's\ we\ are\ done.}}
\DoxyCodeLine{00403\ \ \ \ \ blocked\_++;}
\DoxyCodeLine{00404\ \ \ \ \ \textcolor{comment}{//\ TODO\ is\ blocked\_\ required\ to\ be\ unsigned?}}
\DoxyCodeLine{00405\ \ \ \ \ \textcolor{keywordflow}{if}\ (done\_\ \&\&\ blocked\_\ ==\ \textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{unsigned}\textcolor{keyword}{>}(num\_threads\_))\ \{}
\DoxyCodeLine{00406\ \ \ \ \ \ \ ec\_.CancelWait();}
\DoxyCodeLine{00407\ \ \ \ \ \ \ \textcolor{comment}{//\ Almost\ done,\ but\ need\ to\ re-\/check\ queues.}}
\DoxyCodeLine{00408\ \ \ \ \ \ \ \textcolor{comment}{//\ Consider\ that\ all\ queues\ are\ empty\ and\ all\ worker\ threads\ are\ preempted}}
\DoxyCodeLine{00409\ \ \ \ \ \ \ \textcolor{comment}{//\ right\ after\ incrementing\ blocked\_\ above.\ Now\ a\ free-\/standing\ thread}}
\DoxyCodeLine{00410\ \ \ \ \ \ \ \textcolor{comment}{//\ submits\ work\ and\ calls\ destructor\ (which\ sets\ done\_).\ If\ we\ don't}}
\DoxyCodeLine{00411\ \ \ \ \ \ \ \textcolor{comment}{//\ re-\/check\ queues,\ we\ will\ exit\ leaving\ the\ work\ unexecuted.}}
\DoxyCodeLine{00412\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (NonEmptyQueueIndex()\ !=\ -\/1)\ \{}
\DoxyCodeLine{00413\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Note:\ we\ must\ not\ pop\ from\ queues\ before\ we\ decrement\ blocked\_,}}
\DoxyCodeLine{00414\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ otherwise\ the\ following\ scenario\ is\ possible.\ Consider\ that\ instead}}
\DoxyCodeLine{00415\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ of\ checking\ for\ emptiness\ we\ popped\ the\ only\ element\ from\ queues.}}
\DoxyCodeLine{00416\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Now\ other\ worker\ threads\ can\ start\ exiting,\ which\ is\ bad\ if\ the}}
\DoxyCodeLine{00417\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ work\ item\ submits\ other\ work.\ So\ we\ just\ check\ emptiness\ here,}}
\DoxyCodeLine{00418\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ which\ ensures\ that\ all\ worker\ threads\ exit\ at\ the\ same\ time.}}
\DoxyCodeLine{00419\ \ \ \ \ \ \ \ \ blocked\_-\/-\/;}
\DoxyCodeLine{00420\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00421\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00422\ \ \ \ \ \ \ \textcolor{comment}{//\ Reached\ stable\ termination\ state.}}
\DoxyCodeLine{00423\ \ \ \ \ \ \ ec\_.Notify(\textcolor{keyword}{true});}
\DoxyCodeLine{00424\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00425\ \ \ \ \ \}}
\DoxyCodeLine{00426\ \ \ \ \ ec\_.CommitWait(waiter);}
\DoxyCodeLine{00427\ \ \ \ \ blocked\_-\/-\/;}
\DoxyCodeLine{00428\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00429\ \ \ \}}
\DoxyCodeLine{00430\ }
\DoxyCodeLine{00431\ \ \ \textcolor{keywordtype}{int}\ NonEmptyQueueIndex()\ \{}
\DoxyCodeLine{00432\ \ \ \ \ PerThread*\ pt\ =\ GetPerThread();}
\DoxyCodeLine{00433\ \ \ \ \ \textcolor{comment}{//\ We\ intentionally\ design\ NonEmptyQueueIndex\ to\ steal\ work\ from}}
\DoxyCodeLine{00434\ \ \ \ \ \textcolor{comment}{//\ anywhere\ in\ the\ queue\ so\ threads\ don't\ block\ in\ WaitForWork()\ forever}}
\DoxyCodeLine{00435\ \ \ \ \ \textcolor{comment}{//\ when\ all\ threads\ in\ their\ partition\ go\ to\ sleep.\ Steal\ is\ still\ local.}}
\DoxyCodeLine{00436\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{abseil-cpp_2absl_2base_2internal_2low__level__alloc_8cc_aad9b71a31372d5c0ab9c23163efe9544}{size}}\ =\ thread\_data\_.size();}
\DoxyCodeLine{00437\ \ \ \ \ \textcolor{keywordtype}{unsigned}\ r\ =\ Rand(\&pt-\/>rand);}
\DoxyCodeLine{00438\ \ \ \ \ \textcolor{keywordtype}{unsigned}\ inc\ =\ all\_coprimes\_[\mbox{\hyperlink{abseil-cpp_2absl_2base_2internal_2low__level__alloc_8cc_aad9b71a31372d5c0ab9c23163efe9544}{size}}\ -\/\ 1][r\ \%\ all\_coprimes\_[\mbox{\hyperlink{abseil-cpp_2absl_2base_2internal_2low__level__alloc_8cc_aad9b71a31372d5c0ab9c23163efe9544}{size}}\ -\/\ 1].size()];}
\DoxyCodeLine{00439\ \ \ \ \ \textcolor{keywordtype}{unsigned}\ victim\ =\ r\ \%\ \mbox{\hyperlink{abseil-cpp_2absl_2base_2internal_2low__level__alloc_8cc_aad9b71a31372d5c0ab9c23163efe9544}{size}};}
\DoxyCodeLine{00440\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{unsigned}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ =\ 0;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ <\ \mbox{\hyperlink{abseil-cpp_2absl_2base_2internal_2low__level__alloc_8cc_aad9b71a31372d5c0ab9c23163efe9544}{size}};\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}++)\ \{}
\DoxyCodeLine{00441\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!thread\_data\_[victim].queue.Empty())\ \{}
\DoxyCodeLine{00442\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ victim;}
\DoxyCodeLine{00443\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00444\ \ \ \ \ \ \ victim\ +=\ inc;}
\DoxyCodeLine{00445\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (victim\ >=\ \mbox{\hyperlink{abseil-cpp_2absl_2base_2internal_2low__level__alloc_8cc_aad9b71a31372d5c0ab9c23163efe9544}{size}})\ \{}
\DoxyCodeLine{00446\ \ \ \ \ \ \ \ \ victim\ -\/=\ \mbox{\hyperlink{abseil-cpp_2absl_2base_2internal_2low__level__alloc_8cc_aad9b71a31372d5c0ab9c23163efe9544}{size}};}
\DoxyCodeLine{00447\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00448\ \ \ \ \ \}}
\DoxyCodeLine{00449\ \ \ \ \ \textcolor{keywordflow}{return}\ -\/1;}
\DoxyCodeLine{00450\ \ \ \}}
\DoxyCodeLine{00451\ }
\DoxyCodeLine{00452\ \ \ \textcolor{keyword}{static}\ \mbox{\hyperlink{Macros_8h_af2b60117c00a6e75812de43bfe7db3b1}{EIGEN\_STRONG\_INLINE}}\ \mbox{\hyperlink{namespaceEigen_1_1numext_a0259c31cd34e096be5056e9d88ae0500}{uint64\_t}}\ GlobalThreadIdHash()\ \{}
\DoxyCodeLine{00453\ \ \ \ \ \textcolor{keywordflow}{return}\ std::hash<std::thread::id>()(std::this\_thread::get\_id());}
\DoxyCodeLine{00454\ \ \ \}}
\DoxyCodeLine{00455\ }
\DoxyCodeLine{00456\ \ \ \mbox{\hyperlink{Macros_8h_af2b60117c00a6e75812de43bfe7db3b1}{EIGEN\_STRONG\_INLINE}}\ PerThread*\ GetPerThread()\ \{}
\DoxyCodeLine{00457\ \textcolor{preprocessor}{\#ifndef\ EIGEN\_THREAD\_LOCAL}}
\DoxyCodeLine{00458\ \ \ \ \ \textcolor{keyword}{static}\ PerThread\ \mbox{\hyperlink{namespaceabsl_1_1ABSL__NAMESPACE__BEGIN_a7561820e8f8e4b1e781485afeb47b8dd}{dummy}};}
\DoxyCodeLine{00459\ \ \ \ \ \textcolor{keyword}{auto}\ it\ =\ per\_thread\_map\_.find(GlobalThreadIdHash());}
\DoxyCodeLine{00460\ \ \ \ \ \textcolor{keywordflow}{if}\ (it\ ==\ per\_thread\_map\_.end())\ \{}
\DoxyCodeLine{00461\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \&\mbox{\hyperlink{namespaceabsl_1_1ABSL__NAMESPACE__BEGIN_a7561820e8f8e4b1e781485afeb47b8dd}{dummy}};}
\DoxyCodeLine{00462\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00463\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ it-\/>second.get();}
\DoxyCodeLine{00464\ \ \ \ \ \}}
\DoxyCodeLine{00465\ \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{00466\ \ \ \ \ EIGEN\_THREAD\_LOCAL\ PerThread\ per\_thread\_;}
\DoxyCodeLine{00467\ \ \ \ \ PerThread*\ pt\ =\ \&per\_thread\_;}
\DoxyCodeLine{00468\ \ \ \ \ \textcolor{keywordflow}{return}\ pt;}
\DoxyCodeLine{00469\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00470\ \ \ \}}
\DoxyCodeLine{00471\ }
\DoxyCodeLine{00472\ \ \ \textcolor{keyword}{static}\ \mbox{\hyperlink{Macros_8h_af2b60117c00a6e75812de43bfe7db3b1}{EIGEN\_STRONG\_INLINE}}\ \textcolor{keywordtype}{unsigned}\ Rand(uint64\_t*\ state)\ \{}
\DoxyCodeLine{00473\ \ \ \ \ \mbox{\hyperlink{namespaceEigen_1_1numext_a0259c31cd34e096be5056e9d88ae0500}{uint64\_t}}\ current\ =\ *state;}
\DoxyCodeLine{00474\ \ \ \ \ \textcolor{comment}{//\ Update\ the\ internal\ state}}
\DoxyCodeLine{00475\ \ \ \ \ *state\ =\ current\ *\ 6364136223846793005ULL\ +\ 0xda3e39cb94b95bdbULL;}
\DoxyCodeLine{00476\ \ \ \ \ \textcolor{comment}{//\ Generate\ the\ random\ output\ (using\ the\ PCG-\/XSH-\/RS\ scheme)}}
\DoxyCodeLine{00477\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{unsigned}\textcolor{keyword}{>}((current\ \string^\ (current\ >>\ 22))\ >>}
\DoxyCodeLine{00478\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ (22\ +\ (current\ >>\ 61)));}
\DoxyCodeLine{00479\ \ \ \}}
\DoxyCodeLine{00480\ \};}
\DoxyCodeLine{00481\ }
\DoxyCodeLine{00482\ \textcolor{keyword}{typedef}\ \mbox{\hyperlink{classEigen_1_1ThreadPoolTempl}{ThreadPoolTempl<StlThreadEnvironment>}}\ \mbox{\hyperlink{namespaceEigen_af7c6b7a6f48f574147fb206d7f63c41b}{ThreadPool}};}
\DoxyCodeLine{00483\ }
\DoxyCodeLine{00484\ \}\ \ \textcolor{comment}{//\ namespace\ Eigen}}
\DoxyCodeLine{00485\ }
\DoxyCodeLine{00486\ \textcolor{preprocessor}{\#endif\ \ }\textcolor{comment}{//\ EIGEN\_CXX11\_THREADPOOL\_NONBLOCKING\_THREAD\_POOL\_H}}

\end{DoxyCode}
