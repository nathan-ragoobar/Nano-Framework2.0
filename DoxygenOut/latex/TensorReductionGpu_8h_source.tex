\doxysection{Tensor\+Reduction\+Gpu.\+h}
\hypertarget{TensorReductionGpu_8h_source}{}\label{TensorReductionGpu_8h_source}\index{eigen/unsupported/Eigen/CXX11/src/Tensor/TensorReductionGpu.h@{eigen/unsupported/Eigen/CXX11/src/Tensor/TensorReductionGpu.h}}
\mbox{\hyperlink{TensorReductionGpu_8h}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{comment}{//\ This\ file\ is\ part\ of\ Eigen,\ a\ lightweight\ C++\ template\ library}}
\DoxyCodeLine{00002\ \textcolor{comment}{//\ for\ linear\ algebra.}}
\DoxyCodeLine{00003\ \textcolor{comment}{//}}
\DoxyCodeLine{00004\ \textcolor{comment}{//\ Copyright\ (C)\ 2014\ Benoit\ Steiner\ <benoit.steiner.goog@gmail.com>}}
\DoxyCodeLine{00005\ \textcolor{comment}{//}}
\DoxyCodeLine{00006\ \textcolor{comment}{//\ This\ Source\ Code\ Form\ is\ subject\ to\ the\ terms\ of\ the\ Mozilla}}
\DoxyCodeLine{00007\ \textcolor{comment}{//\ Public\ License\ v.\ 2.0.\ If\ a\ copy\ of\ the\ MPL\ was\ not\ distributed}}
\DoxyCodeLine{00008\ \textcolor{comment}{//\ with\ this\ file,\ You\ can\ obtain\ one\ at\ http://mozilla.org/MPL/2.0/.}}
\DoxyCodeLine{00009\ }
\DoxyCodeLine{00010\ \textcolor{preprocessor}{\#ifndef\ EIGEN\_CXX11\_TENSOR\_TENSOR\_REDUCTION\_GPU\_H}}
\DoxyCodeLine{00011\ \textcolor{preprocessor}{\#define\ EIGEN\_CXX11\_TENSOR\_TENSOR\_REDUCTION\_GPU\_H}}
\DoxyCodeLine{00012\ }
\DoxyCodeLine{00013\ \textcolor{keyword}{namespace\ }\mbox{\hyperlink{namespaceEigen}{Eigen}}\ \{}
\DoxyCodeLine{00014\ \textcolor{keyword}{namespace\ }\mbox{\hyperlink{namespaceinternal}{internal}}\ \{}
\DoxyCodeLine{00015\ }
\DoxyCodeLine{00016\ }
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#if\ defined(EIGEN\_USE\_GPU)\ \&\&\ defined(EIGEN\_GPUCC)}}
\DoxyCodeLine{00018\ \textcolor{comment}{//\ Full\ reducers\ for\ GPU,\ don't\ vectorize\ for\ now}}
\DoxyCodeLine{00019\ }
\DoxyCodeLine{00020\ \textcolor{comment}{//\ Reducer\ function\ that\ enables\ multiple\ gpu\ thread\ to\ safely\ accumulate\ at\ the\ same}}
\DoxyCodeLine{00021\ \textcolor{comment}{//\ output\ address.\ It\ basically\ reads\ the\ current\ value\ of\ the\ output\ variable,\ and}}
\DoxyCodeLine{00022\ \textcolor{comment}{//\ attempts\ to\ update\ it\ with\ the\ new\ value.\ If\ in\ the\ meantime\ another\ gpu\ thread}}
\DoxyCodeLine{00023\ \textcolor{comment}{//\ updated\ the\ content\ of\ the\ output\ address\ it\ will\ try\ again.}}
\DoxyCodeLine{00024\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ T,\ \textcolor{keyword}{typename}\ R>}
\DoxyCodeLine{00025\ \_\_device\_\_\ \mbox{\hyperlink{Macros_8h_a1fdc6f94f20527c7275768d82b2eb9ce}{EIGEN\_ALWAYS\_INLINE}}\ \textcolor{keywordtype}{void}\ atomicReduce(T*\ output,\ T\ accum,\ R\&\ reducer)\ \{}
\DoxyCodeLine{00026\ \textcolor{preprocessor}{\#if\ (defined(EIGEN\_HIP\_DEVICE\_COMPILE)\ \&\&\ defined(\_\_HIP\_ARCH\_HAS\_WARP\_SHUFFLE\_\_))\ ||\ (EIGEN\_CUDA\_ARCH\ >=\ 300)}}
\DoxyCodeLine{00027\ \ \ \textcolor{keywordflow}{if}\ (\textcolor{keyword}{sizeof}(T)\ ==\ 4)}
\DoxyCodeLine{00028\ \ \ \{}
\DoxyCodeLine{00029\ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ oldval\ =\ *\textcolor{keyword}{reinterpret\_cast<}\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}*\textcolor{keyword}{>}(output);}
\DoxyCodeLine{00030\ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ newval\ =\ oldval;}
\DoxyCodeLine{00031\ \ \ \ \ reducer.reduce(accum,\ \textcolor{keyword}{reinterpret\_cast<}T*\textcolor{keyword}{>}(\&newval));}
\DoxyCodeLine{00032\ \ \ \ \ \textcolor{keywordflow}{if}\ (newval\ ==\ oldval)\ \{}
\DoxyCodeLine{00033\ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00034\ \ \ \ \ \}}
\DoxyCodeLine{00035\ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ readback;}
\DoxyCodeLine{00036\ \ \ \ \ \textcolor{keywordflow}{while}\ ((readback\ =\ atomicCAS((\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}*)output,\ oldval,\ newval))\ !=\ oldval)\ \{}
\DoxyCodeLine{00037\ \ \ \ \ \ \ oldval\ =\ readback;}
\DoxyCodeLine{00038\ \ \ \ \ \ \ newval\ =\ oldval;}
\DoxyCodeLine{00039\ \ \ \ \ \ \ reducer.reduce(accum,\ \textcolor{keyword}{reinterpret\_cast<}T*\textcolor{keyword}{>}(\&newval));}
\DoxyCodeLine{00040\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (newval\ ==\ oldval)\ \{}
\DoxyCodeLine{00041\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00042\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00043\ \ \ \ \ \}}
\DoxyCodeLine{00044\ \ \ \}}
\DoxyCodeLine{00045\ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (\textcolor{keyword}{sizeof}(T)\ ==\ 8)\ \{}
\DoxyCodeLine{00046\ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{long}\ \textcolor{keywordtype}{long}\ oldval\ =\ *\textcolor{keyword}{reinterpret\_cast<}\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{long}\ \textcolor{keywordtype}{long}*\textcolor{keyword}{>}(output);}
\DoxyCodeLine{00047\ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{long}\ \textcolor{keywordtype}{long}\ newval\ =\ oldval;}
\DoxyCodeLine{00048\ \ \ \ \ reducer.reduce(accum,\ \textcolor{keyword}{reinterpret\_cast<}T*\textcolor{keyword}{>}(\&newval));}
\DoxyCodeLine{00049\ \ \ \ \ \textcolor{keywordflow}{if}\ (newval\ ==\ oldval)\ \{}
\DoxyCodeLine{00050\ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00051\ \ \ \ \ \}}
\DoxyCodeLine{00052\ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{long}\ \textcolor{keywordtype}{long}\ readback;}
\DoxyCodeLine{00053\ \ \ \ \ \textcolor{keywordflow}{while}\ ((readback\ =\ atomicCAS((\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{long}\ \textcolor{keywordtype}{long}*)output,\ oldval,\ newval))\ !=\ oldval)\ \{}
\DoxyCodeLine{00054\ \ \ \ \ \ \ oldval\ =\ readback;}
\DoxyCodeLine{00055\ \ \ \ \ \ \ newval\ =\ oldval;}
\DoxyCodeLine{00056\ \ \ \ \ \ \ reducer.reduce(accum,\ \textcolor{keyword}{reinterpret\_cast<}T*\textcolor{keyword}{>}(\&newval));}
\DoxyCodeLine{00057\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (newval\ ==\ oldval)\ \{}
\DoxyCodeLine{00058\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00059\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00060\ \ \ \ \ \}}
\DoxyCodeLine{00061\ \ \ \}}
\DoxyCodeLine{00062\ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00063\ \ \ \ \ gpu\_assert(0\ \&\&\ \textcolor{stringliteral}{"{}Wordsize\ not\ supported"{}});}
\DoxyCodeLine{00064\ \ \ \}}
\DoxyCodeLine{00065\ \textcolor{preprocessor}{\#else\ }\textcolor{comment}{//\ EIGEN\_CUDA\_ARCH\ >=\ 300}}
\DoxyCodeLine{00066\ \ \ gpu\_assert(0\ \&\&\ \textcolor{stringliteral}{"{}Shouldn't\ be\ called\ on\ unsupported\ device"{}});}
\DoxyCodeLine{00067\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ EIGEN\_CUDA\_ARCH\ >=\ 300}}
\DoxyCodeLine{00068\ \}}
\DoxyCodeLine{00069\ }
\DoxyCodeLine{00070\ \textcolor{comment}{//\ We\ extend\ atomicExch\ to\ support\ extra\ data\ types}}
\DoxyCodeLine{00071\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ Type>}
\DoxyCodeLine{00072\ \_\_device\_\_\ \textcolor{keyword}{inline}\ \mbox{\hyperlink{namespaceEigen_1_1Architecture_ae54c092bdb3a978b9aa8cc50dcafc13c}{Type}}\ atomicExchCustom(Type*\ address,\ Type\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2raw__hash__set__test_8cc_aa0ccb5ee6d882ee3605ff47745c6467b}{val}})\ \{}
\DoxyCodeLine{00073\ \ \ \textcolor{keywordflow}{return}\ atomicExch(address,\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2raw__hash__set__test_8cc_aa0ccb5ee6d882ee3605ff47745c6467b}{val}});}
\DoxyCodeLine{00074\ \}}
\DoxyCodeLine{00075\ }
\DoxyCodeLine{00076\ \textcolor{keyword}{template}\ <>}
\DoxyCodeLine{00077\ \_\_device\_\_\ \textcolor{keyword}{inline}\ \textcolor{keywordtype}{double}\ atomicExchCustom(\textcolor{keywordtype}{double}*\ address,\ \textcolor{keywordtype}{double}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2raw__hash__set__test_8cc_aa0ccb5ee6d882ee3605ff47745c6467b}{val}})\ \{}
\DoxyCodeLine{00078\ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{long}\ \textcolor{keywordtype}{long}\ \textcolor{keywordtype}{int}*\ address\_as\_ull\ =\ \textcolor{keyword}{reinterpret\_cast<}\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{long}\ \textcolor{keywordtype}{long}\ \textcolor{keywordtype}{int}*\textcolor{keyword}{>}(address);}
\DoxyCodeLine{00079\ \ \ \textcolor{keywordflow}{return}\ \_\_longlong\_as\_double(atomicExch(address\_as\_ull,\ \_\_double\_as\_longlong(\mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2raw__hash__set__test_8cc_aa0ccb5ee6d882ee3605ff47745c6467b}{val}})));}
\DoxyCodeLine{00080\ \}}
\DoxyCodeLine{00081\ }
\DoxyCodeLine{00082\ \textcolor{preprocessor}{\#ifdef\ EIGEN\_HAS\_GPU\_FP16}}
\DoxyCodeLine{00083\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ R>}
\DoxyCodeLine{00084\ \_\_device\_\_\ \textcolor{keyword}{inline}\ \textcolor{keywordtype}{void}\ atomicReduce(half2*\ output,\ half2\ accum,\ R\&\ reducer)\ \{}
\DoxyCodeLine{00085\ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ oldval\ =\ *\textcolor{keyword}{reinterpret\_cast<}\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}*\textcolor{keyword}{>}(output);}
\DoxyCodeLine{00086\ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ newval\ =\ oldval;}
\DoxyCodeLine{00087\ \ \ reducer.reducePacket(accum,\ \textcolor{keyword}{reinterpret\_cast<}half2*\textcolor{keyword}{>}(\&newval));}
\DoxyCodeLine{00088\ \ \ \textcolor{keywordflow}{if}\ (newval\ ==\ oldval)\ \{}
\DoxyCodeLine{00089\ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00090\ \ \ \}}
\DoxyCodeLine{00091\ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ readback;}
\DoxyCodeLine{00092\ \ \ \textcolor{keywordflow}{while}\ ((readback\ =\ atomicCAS((\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}*)output,\ oldval,\ newval))\ !=\ oldval)\ \{}
\DoxyCodeLine{00093\ \ \ \ \ oldval\ =\ readback;}
\DoxyCodeLine{00094\ \ \ \ \ newval\ =\ oldval;}
\DoxyCodeLine{00095\ \ \ \ \ reducer.reducePacket(accum,\ \textcolor{keyword}{reinterpret\_cast<}half2*\textcolor{keyword}{>}(\&newval));}
\DoxyCodeLine{00096\ \ \ \ \ \textcolor{keywordflow}{if}\ (newval\ ==\ oldval)\ \{}
\DoxyCodeLine{00097\ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00098\ \ \ \ \ \}}
\DoxyCodeLine{00099\ \ \ \}}
\DoxyCodeLine{00100\ \}}
\DoxyCodeLine{00101\ \textcolor{comment}{//\ reduction\ should\ be\ associative\ since\ reduction\ is\ not\ atomic\ in\ wide\ vector\ but\ atomic\ in\ half2\ operations}}
\DoxyCodeLine{00102\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ R>}
\DoxyCodeLine{00103\ \_\_device\_\_\ \textcolor{keyword}{inline}\ \textcolor{keywordtype}{void}\ atomicReduce(Packet4h2*\ output,\ Packet4h2\ accum,\ R\&\ reducer)\ \{}
\DoxyCodeLine{00104\ \ \ half2*\ houtput=\textcolor{keyword}{reinterpret\_cast<}half2*\textcolor{keyword}{>}(output);}
\DoxyCodeLine{00105\ \ \ half2*\ haccum=\textcolor{keyword}{reinterpret\_cast<}half2*\textcolor{keyword}{>}(\&accum);}
\DoxyCodeLine{00106\ \ \ \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}=0;\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}<4;++\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}})\{}
\DoxyCodeLine{00107\ \ \ \ \ atomicReduce(houtput+\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}},*(haccum+\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}),reducer);}
\DoxyCodeLine{00108\ \ \ \}}
\DoxyCodeLine{00109\ \}}
\DoxyCodeLine{00110\ \textcolor{preprocessor}{\#endif\ \ }\textcolor{comment}{//\ EIGEN\_HAS\_GPU\_FP16}}
\DoxyCodeLine{00111\ }
\DoxyCodeLine{00112\ \textcolor{keyword}{template}\ <>}
\DoxyCodeLine{00113\ \_\_device\_\_\ \textcolor{keyword}{inline}\ \textcolor{keywordtype}{void}\ atomicReduce(\textcolor{keywordtype}{float}*\ output,\ \textcolor{keywordtype}{float}\ accum,\ SumReducer<float>\&)\ \{}
\DoxyCodeLine{00114\ \textcolor{preprocessor}{\#if\ (defined(EIGEN\_HIP\_DEVICE\_COMPILE)\ \&\&\ defined(\_\_HIP\_ARCH\_HAS\_WARP\_SHUFFLE\_\_))\ ||\ (EIGEN\_CUDA\_ARCH\ >=\ 300)}}
\DoxyCodeLine{00115\ \ \ atomicAdd(output,\ accum);}
\DoxyCodeLine{00116\ \textcolor{preprocessor}{\#else\ }\textcolor{comment}{//\ EIGEN\_CUDA\_ARCH\ >=\ 300}}
\DoxyCodeLine{00117\ \ \ gpu\_assert(0\ \&\&\ \textcolor{stringliteral}{"{}Shouldn't\ be\ called\ on\ unsupported\ device"{}});}
\DoxyCodeLine{00118\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ EIGEN\_CUDA\_ARCH\ >=\ 300}}
\DoxyCodeLine{00119\ \}}
\DoxyCodeLine{00120\ }
\DoxyCodeLine{00121\ }
\DoxyCodeLine{00122\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ CoeffType,\ \textcolor{keyword}{typename}\ Index>}
\DoxyCodeLine{00123\ \_\_global\_\_\ \mbox{\hyperlink{Macros_8h_ab7c87492b7a80ed45d2e0377b40cdee5}{EIGEN\_HIP\_LAUNCH\_BOUNDS\_1024}}\ \textcolor{keywordtype}{void}\ ReductionInitKernel(\textcolor{keyword}{const}\ CoeffType\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2raw__hash__set__test_8cc_aa0ccb5ee6d882ee3605ff47745c6467b}{val}},\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ num\_preserved\_coeffs,\ CoeffType*\ output)\ \{}
\DoxyCodeLine{00124\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ thread\_id\ =\ blockIdx.x\ *\ blockDim.x\ +\ threadIdx.x;}
\DoxyCodeLine{00125\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ num\_threads\ =\ blockDim.x\ *\ gridDim.x;}
\DoxyCodeLine{00126\ \ \ \textcolor{keywordflow}{for}\ (\mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ =\ thread\_id;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ <\ num\_preserved\_coeffs;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ +=\ num\_threads)\ \{}
\DoxyCodeLine{00127\ \ \ \ \ output[\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}]\ =\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2raw__hash__set__test_8cc_aa0ccb5ee6d882ee3605ff47745c6467b}{val}};}
\DoxyCodeLine{00128\ \ \ \}}
\DoxyCodeLine{00129\ \}}
\DoxyCodeLine{00130\ }
\DoxyCodeLine{00131\ }
\DoxyCodeLine{00132\ \textcolor{keyword}{template}\ <\textcolor{keywordtype}{int}\ BlockSize,\ \textcolor{keywordtype}{int}\ NumPerThread,\ \textcolor{keyword}{typename}\ Self,}
\DoxyCodeLine{00133\ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{typename}\ Reducer,\ \textcolor{keyword}{typename}\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}>}
\DoxyCodeLine{00134\ \_\_global\_\_\ \mbox{\hyperlink{Macros_8h_ab7c87492b7a80ed45d2e0377b40cdee5}{EIGEN\_HIP\_LAUNCH\_BOUNDS\_1024}}\ \textcolor{keywordtype}{void}\ FullReductionKernel(Reducer\ reducer,\ \textcolor{keyword}{const}\ Self\ input,\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ num\_coeffs,}
\DoxyCodeLine{00135\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{typename}\ Self::CoeffReturnType*\ output,\ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}*\ semaphore)\ \{}
\DoxyCodeLine{00136\ \textcolor{preprocessor}{\#if\ (defined(EIGEN\_HIP\_DEVICE\_COMPILE)\ \&\&\ defined(\_\_HIP\_ARCH\_HAS\_WARP\_SHUFFLE\_\_))\ ||\ (EIGEN\_CUDA\_ARCH\ >=\ 300)}}
\DoxyCodeLine{00137\ \ \ \textcolor{comment}{//\ Initialize\ the\ output\ value}}
\DoxyCodeLine{00138\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ first\_index\ =\ blockIdx.x\ *\ BlockSize\ *\ NumPerThread\ +\ threadIdx.x;}
\DoxyCodeLine{00139\ \ \ \textcolor{keywordflow}{if}\ (gridDim.x\ ==\ 1)\ \{}
\DoxyCodeLine{00140\ \ \ \ \ \textcolor{keywordflow}{if}\ (first\_index\ ==\ 0)\ \{}
\DoxyCodeLine{00141\ \ \ \ \ \ \ *output\ =\ reducer.initialize();}
\DoxyCodeLine{00142\ \ \ \ \ \}}
\DoxyCodeLine{00143\ \ \ \}}
\DoxyCodeLine{00144\ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00145\ \ \ \ \ \textcolor{keywordflow}{if}\ (threadIdx.x\ ==\ 0)\ \{}
\DoxyCodeLine{00146\ \ \ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{BlockMethods_8h_ad90ae68615512ea2a9c7056ef1b34f13}{block}}\ =\ atomicCAS(semaphore,\ 0u,\ 1u);}
\DoxyCodeLine{00147\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{BlockMethods_8h_ad90ae68615512ea2a9c7056ef1b34f13}{block}}\ ==\ 0)\ \{}
\DoxyCodeLine{00148\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ We're\ the\ first\ block\ to\ run,\ initialize\ the\ output\ value}}
\DoxyCodeLine{00149\ \ \ \ \ \ \ \ \ atomicExchCustom(output,\ reducer.initialize());}
\DoxyCodeLine{00150\ \ \ \ \ \ \ \ \ \_\_threadfence();}
\DoxyCodeLine{00151\ \ \ \ \ \ \ \ \ atomicExch(semaphore,\ 2u);}
\DoxyCodeLine{00152\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00153\ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00154\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Wait\ for\ the\ first\ block\ to\ initialize\ the\ output\ value.}}
\DoxyCodeLine{00155\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Use\ atomicCAS\ here\ to\ ensure\ that\ the\ reads\ aren't\ cached}}
\DoxyCodeLine{00156\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2raw__hash__set__test_8cc_aa0ccb5ee6d882ee3605ff47745c6467b}{val}};}
\DoxyCodeLine{00157\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{do}\ \{}
\DoxyCodeLine{00158\ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2raw__hash__set__test_8cc_aa0ccb5ee6d882ee3605ff47745c6467b}{val}}\ =\ atomicCAS(semaphore,\ 2u,\ 2u);}
\DoxyCodeLine{00159\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00160\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ (\mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2raw__hash__set__test_8cc_aa0ccb5ee6d882ee3605ff47745c6467b}{val}}\ <\ 2u);}
\DoxyCodeLine{00161\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00162\ \ \ \ \ \}}
\DoxyCodeLine{00163\ \ \ \}}
\DoxyCodeLine{00164\ }
\DoxyCodeLine{00165\ \ \ \_\_syncthreads();}
\DoxyCodeLine{00166\ }
\DoxyCodeLine{00167\ \ \ \mbox{\hyperlink{Macros_8h_acaa7ba89800cfe18d5fd6eed620aea9c}{eigen\_assert}}(gridDim.x\ ==\ 1\ ||\ *semaphore\ >=\ 2u);}
\DoxyCodeLine{00168\ }
\DoxyCodeLine{00169\ \ \ \textcolor{keyword}{typename}\ Self::CoeffReturnType\ accum\ =\ reducer.initialize();}
\DoxyCodeLine{00170\ \ \ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ max\_iter\ =\ \mbox{\hyperlink{namespaceEigen_1_1numext_ab3b30bf0bcfa1ad91dbec75fabb3bea0}{numext::mini<Index>}}(num\_coeffs\ -\/\ first\_index,\ NumPerThread*BlockSize);}
\DoxyCodeLine{00171\ \ \ \textcolor{keywordflow}{for}\ (\mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ =\ 0;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ <\ max\_iter;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}+=BlockSize)\ \{}
\DoxyCodeLine{00172\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ index\ =\ first\_index\ +\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}};}
\DoxyCodeLine{00173\ \ \ \ \ \mbox{\hyperlink{Macros_8h_acaa7ba89800cfe18d5fd6eed620aea9c}{eigen\_assert}}(index\ <\ num\_coeffs);}
\DoxyCodeLine{00174\ \ \ \ \ \textcolor{keyword}{typename}\ Self::CoeffReturnType\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2raw__hash__set__test_8cc_aa0ccb5ee6d882ee3605ff47745c6467b}{val}}\ =\ input.m\_impl.coeff(index);}
\DoxyCodeLine{00175\ \ \ \ \ reducer.reduce(\mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2raw__hash__set__test_8cc_aa0ccb5ee6d882ee3605ff47745c6467b}{val}},\ \&accum);}
\DoxyCodeLine{00176\ \ \ \}}
\DoxyCodeLine{00177\ }
\DoxyCodeLine{00178\ \textcolor{preprocessor}{\#pragma\ unroll}}
\DoxyCodeLine{00179\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ offset\ =\ warpSize/2;\ offset\ >\ 0;\ offset\ /=\ 2)\ \{}
\DoxyCodeLine{00180\ \textcolor{preprocessor}{\ \ \#if\ defined(EIGEN\_HIPCC)}}
\DoxyCodeLine{00181\ \ \ \ \ \textcolor{comment}{//\ use\ std::is\_floating\_point\ to\ determine\ the\ type\ of\ reduced\_val\ }}
\DoxyCodeLine{00182\ \ \ \ \ \textcolor{comment}{//\ This\ is\ needed\ because\ when\ Type\ ==\ double,\ hipcc\ will\ give\ a\ "{}call\ to\ \_\_shfl\_down\ is\ ambguous"{}\ error\ }}
\DoxyCodeLine{00183\ \ \ \ \ \textcolor{comment}{//\ and\ list\ the\ float\ and\ int\ versions\ of\ \_\_shfl\_down\ as\ the\ candidate\ functions.\ }}
\DoxyCodeLine{00184\ \ \ \ \ \textcolor{keywordflow}{if}\ (std::is\_floating\_point<typename\ Self::CoeffReturnType>::value)\ \{}
\DoxyCodeLine{00185\ \ \ \ \ \ \ reducer.reduce(\_\_shfl\_down(\textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{float}\textcolor{keyword}{>}(accum),\ offset,\ warpSize),\ \&accum);}
\DoxyCodeLine{00186\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00187\ \ \ \ \ \ \ reducer.reduce(\_\_shfl\_down(\textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{int}\textcolor{keyword}{>}(accum),\ offset,\ warpSize),\ \&accum);}
\DoxyCodeLine{00188\ \ \ \ \ \}}
\DoxyCodeLine{00189\ \textcolor{preprocessor}{\ \ \#elif\ defined(EIGEN\_CUDA\_SDK\_VER)\ \&\&\ EIGEN\_CUDA\_SDK\_VER\ <\ 90000}}
\DoxyCodeLine{00190\ \ \ \ \ reducer.reduce(\_\_shfl\_down(accum,\ offset,\ warpSize),\ \&accum);}
\DoxyCodeLine{00191\ \textcolor{preprocessor}{\ \ \#else}}
\DoxyCodeLine{00192\ \ \ \ \ reducer.reduce(\_\_shfl\_down\_sync(0xFFFFFFFF,\ accum,\ offset,\ warpSize),\ \&accum);}
\DoxyCodeLine{00193\ \textcolor{preprocessor}{\ \ \#endif}}
\DoxyCodeLine{00194\ \ \ \}}
\DoxyCodeLine{00195\ }
\DoxyCodeLine{00196\ \ \ \textcolor{keywordflow}{if}\ ((threadIdx.x\ \&\ (warpSize\ -\/\ 1))\ ==\ 0)\ \{}
\DoxyCodeLine{00197\ \ \ \ \ atomicReduce(output,\ accum,\ reducer);}
\DoxyCodeLine{00198\ \ \ \}}
\DoxyCodeLine{00199\ }
\DoxyCodeLine{00200\ \ \ \textcolor{keywordflow}{if}\ (gridDim.x\ >\ 1\ \&\&\ threadIdx.x\ ==\ 0)\ \{}
\DoxyCodeLine{00201\ \ \ \ \ \textcolor{comment}{//\ Let\ the\ last\ block\ reset\ the\ semaphore}}
\DoxyCodeLine{00202\ \ \ \ \ atomicInc(semaphore,\ gridDim.x\ +\ 1);}
\DoxyCodeLine{00203\ \textcolor{preprocessor}{\#if\ defined(EIGEN\_HIPCC)}}
\DoxyCodeLine{00204\ \ \ \ \ \_\_threadfence\_system();}
\DoxyCodeLine{00205\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00206\ \ \ \}}
\DoxyCodeLine{00207\ \textcolor{preprocessor}{\#else\ }\textcolor{comment}{//\ EIGEN\_CUDA\_ARCH\ >=\ 300}}
\DoxyCodeLine{00208\ \ \ gpu\_assert(0\ \&\&\ \textcolor{stringliteral}{"{}Shouldn't\ be\ called\ on\ unsupported\ device"{}});}
\DoxyCodeLine{00209\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ EIGEN\_CUDA\_ARCH\ >=\ 300}}
\DoxyCodeLine{00210\ \}}
\DoxyCodeLine{00211\ }
\DoxyCodeLine{00212\ }
\DoxyCodeLine{00213\ \textcolor{preprocessor}{\#ifdef\ EIGEN\_HAS\_GPU\_FP16}}
\DoxyCodeLine{00214\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ Self,}
\DoxyCodeLine{00215\ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{typename}\ Reducer,\ \textcolor{keyword}{typename}\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}>}
\DoxyCodeLine{00216\ \_\_global\_\_\ \mbox{\hyperlink{Macros_8h_ab7c87492b7a80ed45d2e0377b40cdee5}{EIGEN\_HIP\_LAUNCH\_BOUNDS\_1024}}\ \textcolor{keywordtype}{void}\ ReductionInitFullReduxKernelHalfFloat(Reducer\ reducer,\ \textcolor{keyword}{const}\ Self\ input,\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ num\_coeffs,}
\DoxyCodeLine{00217\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structEigen_1_1internal_1_1packet__traits_3_01Eigen_1_1half_01_4_a07d518ab7e1e56a34612ebd95c3f5c5f}{packet\_traits<Eigen::half>::type}}*\ scratch)\ \{}
\DoxyCodeLine{00218\ \ \ \mbox{\hyperlink{Macros_8h_acaa7ba89800cfe18d5fd6eed620aea9c}{eigen\_assert}}(blockDim.x\ ==\ 1);}
\DoxyCodeLine{00219\ \ \ \mbox{\hyperlink{Macros_8h_acaa7ba89800cfe18d5fd6eed620aea9c}{eigen\_assert}}(gridDim.x\ ==\ 1);}
\DoxyCodeLine{00220\ \ \ \textcolor{keyword}{typedef}\ \mbox{\hyperlink{structEigen_1_1internal_1_1packet__traits_3_01Eigen_1_1half_01_4_a07d518ab7e1e56a34612ebd95c3f5c5f}{packet\_traits<Eigen::half>::type}}\ packet\_type;}
\DoxyCodeLine{00221\ \ \ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ packet\_remainder\ =}
\DoxyCodeLine{00222\ \ \ \ \ \ \ num\_coeffs\ \%\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}(\mbox{\hyperlink{structEigen_1_1internal_1_1unpacket__traits_aa3c8daa4597ef6c42efb377d14f87dcba63cc10676eb13001d700f7bc4336f6ee}{unpacket\_traits<packet\_type>::size}});}
\DoxyCodeLine{00223\ \ \ \textcolor{keywordflow}{if}\ (packet\_remainder\ !=\ 0)\ \{}
\DoxyCodeLine{00224\ \ \ \ \ half2*\ h2scratch\ =\ \textcolor{keyword}{reinterpret\_cast<}half2*\textcolor{keyword}{>}(scratch);}
\DoxyCodeLine{00225\ \ \ \ \ \textcolor{keywordflow}{for}\ (\mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ =\ num\_coeffs\ -\/\ packet\_remainder;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ +\ 2\ <=\ num\_coeffs;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ +=\ 2)\ \{}
\DoxyCodeLine{00226\ \ \ \ \ \ \ *h2scratch\ =}
\DoxyCodeLine{00227\ \ \ \ \ \ \ \ \ \ \ \_\_halves2half2(input.m\_impl.coeff(\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}),\ input.m\_impl.coeff(\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ +\ 1));}
\DoxyCodeLine{00228\ \ \ \ \ \ \ h2scratch++;}
\DoxyCodeLine{00229\ \ \ \ \ \}}
\DoxyCodeLine{00230\ \ \ \ \ \textcolor{keywordflow}{if}\ ((num\_coeffs\ \&\ 1)\ !=\ 0)\ \{}
\DoxyCodeLine{00231\ \ \ \ \ \ \ half\ lastCoeff\ =\ input.m\_impl.coeff(num\_coeffs\ -\/\ 1);}
\DoxyCodeLine{00232\ \ \ \ \ \ \ *h2scratch\ =\ \_\_halves2half2(lastCoeff,\ reducer.initialize());}
\DoxyCodeLine{00233\ \ \ \ \ \}}
\DoxyCodeLine{00234\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00235\ \ \ \ \ *scratch\ =\ reducer.template\ initializePacket<packet\_type>();}
\DoxyCodeLine{00236\ \ \ \}}
\DoxyCodeLine{00237\ \}}
\DoxyCodeLine{00238\ }
\DoxyCodeLine{00239\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ Self,}
\DoxyCodeLine{00240\ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{typename}\ Reducer,\ \textcolor{keyword}{typename}\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}>}
\DoxyCodeLine{00241\ \_\_global\_\_\ \mbox{\hyperlink{Macros_8h_ab7c87492b7a80ed45d2e0377b40cdee5}{EIGEN\_HIP\_LAUNCH\_BOUNDS\_1024}}\ \textcolor{keywordtype}{void}\ ReductionInitKernelHalfFloat(Reducer\ reducer,\ \textcolor{keyword}{const}\ Self\ input,\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ num\_coeffs,\ half*\ output)\ \{}
\DoxyCodeLine{00242\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ thread\_id\ =\ blockIdx.x\ *\ blockDim.x\ +\ threadIdx.x;}
\DoxyCodeLine{00243\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ num\_threads\ =\ blockDim.x\ *\ gridDim.x;}
\DoxyCodeLine{00244\ \ \ \textcolor{keyword}{typedef}\ \textcolor{keyword}{typename}\ \mbox{\hyperlink{structEigen_1_1internal_1_1packet__traits_3_01Eigen_1_1half_01_4_a07d518ab7e1e56a34612ebd95c3f5c5f}{packet\_traits<Eigen::half>::type}}\ PacketType;}
\DoxyCodeLine{00245\ }
\DoxyCodeLine{00246\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ num\_packets\ =}
\DoxyCodeLine{00247\ \ \ \ \ \ \ num\_coeffs\ /\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}(\mbox{\hyperlink{structEigen_1_1internal_1_1unpacket__traits_aa3c8daa4597ef6c42efb377d14f87dcba63cc10676eb13001d700f7bc4336f6ee}{unpacket\_traits<PacketType>::size}});}
\DoxyCodeLine{00248\ \ \ PacketType*\ p\_output\ =\ \textcolor{keyword}{reinterpret\_cast<}PacketType*\textcolor{keyword}{>}(output);}
\DoxyCodeLine{00249\ \ \ \textcolor{keywordflow}{for}\ (\mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ =\ thread\_id;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ <\ num\_packets;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ +=\ num\_threads)\ \{}
\DoxyCodeLine{00250\ \ \ \ \ p\_output[\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}]\ =\ reducer.template\ initializePacket<PacketType>();}
\DoxyCodeLine{00251\ \ \ \}}
\DoxyCodeLine{00252\ \ \ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ packet\_remainder\ =}
\DoxyCodeLine{00253\ \ \ \ \ \ \ num\_coeffs\ \%\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}(\mbox{\hyperlink{structEigen_1_1internal_1_1unpacket__traits_aa3c8daa4597ef6c42efb377d14f87dcba63cc10676eb13001d700f7bc4336f6ee}{unpacket\_traits<PacketType>::size}});}
\DoxyCodeLine{00254\ \ \ \textcolor{keywordflow}{if}\ (thread\_id\ <\ packet\_remainder)\ \{}
\DoxyCodeLine{00255\ \ \ \ \ output[num\_coeffs\ -\/\ packet\_remainder\ +\ thread\_id]\ =\ reducer.initialize();}
\DoxyCodeLine{00256\ \ \ \}}
\DoxyCodeLine{00257\ \}}
\DoxyCodeLine{00258\ }
\DoxyCodeLine{00259\ \textcolor{keyword}{template}\ <\textcolor{keywordtype}{int}\ BlockSize,\ \textcolor{keywordtype}{int}\ NumPerThread,\ \textcolor{keyword}{typename}\ Self,}
\DoxyCodeLine{00260\ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{typename}\ Reducer,\ \textcolor{keyword}{typename}\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}>}
\DoxyCodeLine{00261\ \_\_global\_\_\ \mbox{\hyperlink{Macros_8h_ab7c87492b7a80ed45d2e0377b40cdee5}{EIGEN\_HIP\_LAUNCH\_BOUNDS\_1024}}\ \textcolor{keywordtype}{void}\ FullReductionKernelHalfFloat(Reducer\ reducer,\ \textcolor{keyword}{const}\ Self\ input,\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ num\_coeffs,}
\DoxyCodeLine{00262\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ half*\ output,\ \mbox{\hyperlink{structEigen_1_1internal_1_1packet__traits_3_01Eigen_1_1half_01_4_a07d518ab7e1e56a34612ebd95c3f5c5f}{packet\_traits<Eigen::half>::type}}*\ scratch)\ \{}
\DoxyCodeLine{00263\ \ \ \textcolor{keyword}{typedef}\ \textcolor{keyword}{typename}\ \mbox{\hyperlink{structEigen_1_1internal_1_1packet__traits_3_01Eigen_1_1half_01_4_a07d518ab7e1e56a34612ebd95c3f5c5f}{packet\_traits<Eigen::half>::type}}\ PacketType;}
\DoxyCodeLine{00264\ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ packet\_width\ =\ \mbox{\hyperlink{structEigen_1_1internal_1_1unpacket__traits_aa3c8daa4597ef6c42efb377d14f87dcba63cc10676eb13001d700f7bc4336f6ee}{unpacket\_traits<PacketType>::size}};}
\DoxyCodeLine{00265\ \ \ \mbox{\hyperlink{Macros_8h_acaa7ba89800cfe18d5fd6eed620aea9c}{eigen\_assert}}(NumPerThread\ \%\ packet\_width\ ==\ 0);}
\DoxyCodeLine{00266\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ first\_index\ =}
\DoxyCodeLine{00267\ \ \ \ \ \ \ blockIdx.x\ *\ BlockSize\ *\ NumPerThread\ +\ packet\_width\ *\ threadIdx.x;}
\DoxyCodeLine{00268\ }
\DoxyCodeLine{00269\ \ \ \textcolor{comment}{//\ Initialize\ the\ output\ value\ if\ it\ wasn't\ initialized\ by\ the\ ReductionInitKernel}}
\DoxyCodeLine{00270\ }
\DoxyCodeLine{00271\ \ \ \textcolor{keywordflow}{if}\ (gridDim.x\ ==\ 1)\ \{}
\DoxyCodeLine{00272\ \ \ \ \ \textcolor{keywordflow}{if}\ (first\_index\ ==\ 0)\ \{}
\DoxyCodeLine{00273\ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ rem\ =\ num\_coeffs\ \%\ packet\_width;}
\DoxyCodeLine{00274\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (rem\ !=\ 0)\ \{}
\DoxyCodeLine{00275\ \ \ \ \ \ \ \ \ half2*\ p\_scratch\ =\ \textcolor{keyword}{reinterpret\_cast<}half2*\textcolor{keyword}{>}(scratch);}
\DoxyCodeLine{00276\ \ \ \ \ \ \ \ \ *scratch\ =\ reducer.template\ initializePacket<PacketType>();}
\DoxyCodeLine{00277\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ =\ 0;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ <\ rem\ /\ 2;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}++)\ \{}
\DoxyCodeLine{00278\ \ \ \ \ \ \ \ \ \ \ *p\_scratch\ =\ \_\_halves2half2(}
\DoxyCodeLine{00279\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ input.m\_impl.coeff(num\_coeffs\ -\/\ packet\_width\ +\ 2\ *\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}),}
\DoxyCodeLine{00280\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ input.m\_impl.coeff(num\_coeffs\ -\/\ packet\_width\ +\ 2\ *\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ +\ 1));}
\DoxyCodeLine{00281\ \ \ \ \ \ \ \ \ \ \ p\_scratch++;}
\DoxyCodeLine{00282\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00283\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ ((num\_coeffs\ \&\ 1)\ !=\ 0)\ \{}
\DoxyCodeLine{00284\ \ \ \ \ \ \ \ \ \ \ half\ last\ =\ input.m\_impl.coeff(num\_coeffs\ -\/\ 1);}
\DoxyCodeLine{00285\ \ \ \ \ \ \ \ \ \ \ *p\_scratch\ =\ \_\_halves2half2(last,\ reducer.initialize());}
\DoxyCodeLine{00286\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00287\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00288\ \ \ \ \ \ \ \ \ *scratch\ =\ reducer.template\ initializePacket<PacketType>();}
\DoxyCodeLine{00289\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00290\ \ \ \ \ \}}
\DoxyCodeLine{00291\ \ \ \ \ \_\_syncthreads();}
\DoxyCodeLine{00292\ \ \ \}}
\DoxyCodeLine{00293\ }
\DoxyCodeLine{00294\ \ \ PacketType\ accum\ =\ reducer.template\ initializePacket<PacketType>();}
\DoxyCodeLine{00295\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ max\_iter\ =}
\DoxyCodeLine{00296\ \ \ \ \ \ \ \mbox{\hyperlink{namespaceEigen_1_1numext_ab3b30bf0bcfa1ad91dbec75fabb3bea0}{numext::mini<Index>}}((num\_coeffs\ -\/\ first\_index)\ /\ packet\_width,}
\DoxyCodeLine{00297\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ NumPerThread\ *\ BlockSize\ /\ packet\_width);}
\DoxyCodeLine{00298\ \ \ \textcolor{keywordflow}{for}\ (\mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ =\ 0;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ <\ max\_iter;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ +=\ BlockSize)\ \{}
\DoxyCodeLine{00299\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ index\ =\ first\_index\ +\ packet\_width\ *\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}};}
\DoxyCodeLine{00300\ \ \ \ \ \mbox{\hyperlink{Macros_8h_acaa7ba89800cfe18d5fd6eed620aea9c}{eigen\_assert}}(index\ +\ packet\_width\ <\ num\_coeffs);}
\DoxyCodeLine{00301\ \ \ \ \ PacketType\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2raw__hash__set__test_8cc_aa0ccb5ee6d882ee3605ff47745c6467b}{val}}\ =\ input.m\_impl.template\ packet<Unaligned>(index);}
\DoxyCodeLine{00302\ \ \ \ \ reducer.reducePacket(\mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2raw__hash__set__test_8cc_aa0ccb5ee6d882ee3605ff47745c6467b}{val}},\ \&accum);}
\DoxyCodeLine{00303\ \ \ \}}
\DoxyCodeLine{00304\ }
\DoxyCodeLine{00305\ \textcolor{preprocessor}{\#pragma\ unroll}}
\DoxyCodeLine{00306\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ offset\ =\ warpSize/2;\ offset\ >\ 0;\ offset\ /=\ 2)\ \{}
\DoxyCodeLine{00307\ \textcolor{preprocessor}{\ \ \#if\ defined(EIGEN\_HIPCC)}}
\DoxyCodeLine{00308\ \ \ \ \ PacketType\ r1;}
\DoxyCodeLine{00309\ \ \ \ \ half2*\ hr\ =\ \textcolor{keyword}{reinterpret\_cast<}half2*\textcolor{keyword}{>}(\&r1);}
\DoxyCodeLine{00310\ \ \ \ \ half2*\ hacc\ =\ \textcolor{keyword}{reinterpret\_cast<}half2*\textcolor{keyword}{>}(\&accum);}
\DoxyCodeLine{00311\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ =\ 0;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ <\ packet\_width\ /\ 2;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}++)\ \{}
\DoxyCodeLine{00312\ \ \ \ \ \ \ \textcolor{comment}{//\ FIXME\ :\ remove\ this\ workaround\ once\ we\ have\ native\ half/half2\ support\ for\ \_\_shfl\_down}}
\DoxyCodeLine{00313\ \ \ \ \ \ \ \textcolor{keyword}{union\ }\{\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}};\ half2\ \mbox{\hyperlink{namespaceabsl_adb6bd4a9012b471ac01613aff8d4d81ba2510c39011c5be704182423e3a695e91}{h}};\ \}\ wka\_in,\ wka\_out;}
\DoxyCodeLine{00314\ \ \ \ \ \ \ wka\_in.h\ =\ hacc[\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}];}
\DoxyCodeLine{00315\ \ \ \ \ \ \ wka\_out.i\ =\ \_\_shfl\_down(wka\_in.i,\ offset,\ warpSize);}
\DoxyCodeLine{00316\ \ \ \ \ \ \ hr[\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}]\ =\ wka\_out.h;}
\DoxyCodeLine{00317\ \ \ \ \ \}}
\DoxyCodeLine{00318\ \ \ \ \ reducer.reducePacket(r1,\ \&accum);}
\DoxyCodeLine{00319\ \textcolor{preprocessor}{\ \ \#elif\ defined(EIGEN\_CUDA\_SDK\_VER)\ \&\&\ EIGEN\_CUDA\_SDK\_VER\ <\ 90000}}
\DoxyCodeLine{00320\ \ \ \ \ PacketType\ r1;}
\DoxyCodeLine{00321\ \ \ \ \ half2*\ hr\ =\ \textcolor{keyword}{reinterpret\_cast<}half2*\textcolor{keyword}{>}(\&r1);}
\DoxyCodeLine{00322\ \ \ \ \ half2*\ hacc\ =\ \textcolor{keyword}{reinterpret\_cast<}half2*\textcolor{keyword}{>}(\&accum);}
\DoxyCodeLine{00323\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ =\ 0;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ <\ packet\_width\ /\ 2;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}++)\ \{}
\DoxyCodeLine{00324\ \ \ \ \ \ \ hr[\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}]\ =\ \_\_shfl\_down(hacc[\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}],\ offset,\ warpSize);}
\DoxyCodeLine{00325\ \ \ \ \ \}}
\DoxyCodeLine{00326\ \ \ \ \ reducer.reducePacket(r1,\ \&accum);}
\DoxyCodeLine{00327\ \textcolor{preprocessor}{\ \ \#else}}
\DoxyCodeLine{00328\ \ \ \ \ PacketType\ r1;}
\DoxyCodeLine{00329\ \ \ \ \ half2*\ hr\ =\ \textcolor{keyword}{reinterpret\_cast<}half2*\textcolor{keyword}{>}(\&r1);}
\DoxyCodeLine{00330\ \ \ \ \ half2*\ hacc\ =\ \textcolor{keyword}{reinterpret\_cast<}half2*\textcolor{keyword}{>}(\&accum);}
\DoxyCodeLine{00331\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ =\ 0;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ <\ packet\_width\ /\ 2;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}++)\ \{}
\DoxyCodeLine{00332\ \ \ \ \ \ \ hr[\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}]\ =\ \_\_shfl\_down\_sync(0xFFFFFFFF,\ hacc[\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}],\ (\textcolor{keywordtype}{unsigned})offset,\ warpSize);}
\DoxyCodeLine{00333\ \ \ \ \ \}}
\DoxyCodeLine{00334\ \ \ \ \ reducer.reducePacket(r1,\ \&accum);}
\DoxyCodeLine{00335\ }
\DoxyCodeLine{00336\ \textcolor{preprocessor}{\ \ \#endif}}
\DoxyCodeLine{00337\ \ \ \}}
\DoxyCodeLine{00338\ }
\DoxyCodeLine{00339\ \ \ \textcolor{keywordflow}{if}\ ((threadIdx.x\ \&\ (warpSize\ -\/\ 1))\ ==\ 0)\ \{}
\DoxyCodeLine{00340\ \ \ \ \ atomicReduce(scratch,\ accum,\ reducer);}
\DoxyCodeLine{00341\ \ \ \}}
\DoxyCodeLine{00342\ }
\DoxyCodeLine{00343\ \ \ \_\_syncthreads();}
\DoxyCodeLine{00344\ \ \ half2*\ rv1\ =\ \textcolor{keyword}{reinterpret\_cast<}half2*\textcolor{keyword}{>}(scratch);}
\DoxyCodeLine{00345\ \ \ \textcolor{keywordflow}{if}\ (packet\_width\ >\ 2)\ \{}
\DoxyCodeLine{00346\ \ \ \ \ reducer.reducePacket(rv1[2],\ rv1);}
\DoxyCodeLine{00347\ \ \ \ \ reducer.reducePacket(rv1[3],\ rv1\ +\ 1);}
\DoxyCodeLine{00348\ \ \ \ \ reducer.reducePacket(rv1[1],\ rv1);}
\DoxyCodeLine{00349\ \ \ \}}
\DoxyCodeLine{00350\ \ \ \textcolor{keywordflow}{if}\ (gridDim.x\ ==\ 1)\ \{}
\DoxyCodeLine{00351\ \ \ \ \ \textcolor{keywordflow}{if}\ (first\_index\ ==\ 0)\ \{}
\DoxyCodeLine{00352\ \ \ \ \ \ \ half\ tmp\ =\ \_\_low2half(*rv1);}
\DoxyCodeLine{00353\ \ \ \ \ \ \ reducer.reduce(\_\_high2half(*rv1),\ \&tmp);}
\DoxyCodeLine{00354\ \ \ \ \ \ \ *output\ =\ tmp;}
\DoxyCodeLine{00355\ \ \ \ \ \}}
\DoxyCodeLine{00356\ \ \ \}}
\DoxyCodeLine{00357\ \}}
\DoxyCodeLine{00358\ }
\DoxyCodeLine{00359\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ Op>}
\DoxyCodeLine{00360\ \_\_global\_\_\ \mbox{\hyperlink{Macros_8h_ab7c87492b7a80ed45d2e0377b40cdee5}{EIGEN\_HIP\_LAUNCH\_BOUNDS\_1024}}\ \textcolor{keywordtype}{void}\ ReductionCleanupKernelHalfFloat(Op\ reducer,\ half*\ output,\ \mbox{\hyperlink{structEigen_1_1internal_1_1packet__traits_3_01Eigen_1_1half_01_4_a07d518ab7e1e56a34612ebd95c3f5c5f}{packet\_traits<Eigen::half>::type}}*\ scratch)\ \{}
\DoxyCodeLine{00361\ \ \ \mbox{\hyperlink{Macros_8h_acaa7ba89800cfe18d5fd6eed620aea9c}{eigen\_assert}}(threadIdx.x\ ==\ 1);}
\DoxyCodeLine{00362\ \ \ half2*\ pscratch\ =\ \textcolor{keyword}{reinterpret\_cast<}half2*\textcolor{keyword}{>}(scratch);}
\DoxyCodeLine{00363\ \ \ half\ tmp\ =\ \_\_float2half(0.f);}
\DoxyCodeLine{00364\ \ \ \textcolor{keyword}{typedef}\ \mbox{\hyperlink{structEigen_1_1internal_1_1packet__traits_3_01Eigen_1_1half_01_4_a07d518ab7e1e56a34612ebd95c3f5c5f}{packet\_traits<Eigen::half>::type}}\ packet\_type;}
\DoxyCodeLine{00365\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ =\ 0;\ i\ <\ unpacket\_traits<packet\_type>::size;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ +=\ 2)\ \{}
\DoxyCodeLine{00366\ \ \ \ \ reducer.reduce(\_\_low2half(*pscratch),\ \&tmp);}
\DoxyCodeLine{00367\ \ \ \ \ reducer.reduce(\_\_high2half(*pscratch),\ \&tmp);}
\DoxyCodeLine{00368\ \ \ \ \ pscratch++;}
\DoxyCodeLine{00369\ \ \ \}}
\DoxyCodeLine{00370\ \ \ *output\ =\ tmp;}
\DoxyCodeLine{00371\ \}}
\DoxyCodeLine{00372\ }
\DoxyCodeLine{00373\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ EIGEN\_HAS\_GPU\_FP16}}
\DoxyCodeLine{00374\ }
\DoxyCodeLine{00375\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ Self,\ \textcolor{keyword}{typename}\ Op,\ \textcolor{keyword}{typename}\ OutputType,\ \textcolor{keywordtype}{bool}\ PacketAccess,\ \textcolor{keyword}{typename}\ Enabled\ =\ \textcolor{keywordtype}{void}>}
\DoxyCodeLine{00376\ \textcolor{keyword}{struct\ }FullReductionLauncher\ \{}
\DoxyCodeLine{00377\ \ \ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ run(\textcolor{keyword}{const}\ Self\&,\ Op\&,\ \textcolor{keyword}{const}\ GpuDevice\&,\ OutputType*,\ \textcolor{keyword}{typename}\ Self::Index)\ \{}
\DoxyCodeLine{00378\ \ \ \ \ gpu\_assert(\textcolor{keyword}{false}\ \&\&\ \textcolor{stringliteral}{"{}Should\ only\ be\ called\ on\ doubles,\ floats\ and\ half\ floats"{}});}
\DoxyCodeLine{00379\ \ \ \}}
\DoxyCodeLine{00380\ \};}
\DoxyCodeLine{00381\ }
\DoxyCodeLine{00382\ \textcolor{comment}{//\ Specialization\ for\ float\ and\ double}}
\DoxyCodeLine{00383\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ Self,\ \textcolor{keyword}{typename}\ Op,\ \textcolor{keyword}{typename}\ OutputType,\ \textcolor{keywordtype}{bool}\ PacketAccess>}
\DoxyCodeLine{00384\ \textcolor{keyword}{struct\ }FullReductionLauncher<}
\DoxyCodeLine{00385\ \ \ \ \ Self,\ Op,\ OutputType,\ PacketAccess,}
\DoxyCodeLine{00386\ \ \ \ \ typename\ \mbox{\hyperlink{namespaceinternal}{internal}}::enable\_if<}
\DoxyCodeLine{00387\ \ \ \ \ \ \ internal::is\_same<float,\ OutputType>::value\ ||}
\DoxyCodeLine{00388\ \ \ \ \ \ \ internal::is\_same<double,\ OutputType>::value,}
\DoxyCodeLine{00389\ \ \ \ \ void>::type>\ \{}
\DoxyCodeLine{00390\ \ \ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ run(\textcolor{keyword}{const}\ Self\&\ self,\ Op\&\ reducer,\ \textcolor{keyword}{const}\ GpuDevice\&\ device,\ OutputType*\ output,\ \textcolor{keyword}{typename}\ Self::Index\ num\_coeffs)\ \{}
\DoxyCodeLine{00391\ }
\DoxyCodeLine{00392\ \ \ \ \ \textcolor{keyword}{typedef}\ \textcolor{keyword}{typename}\ Self::Index\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}};}
\DoxyCodeLine{00393\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ block\_size\ =\ 256;}
\DoxyCodeLine{00394\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ num\_per\_thread\ =\ 128;}
\DoxyCodeLine{00395\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ num\_blocks\ =\ divup<int>(num\_coeffs,\ block\_size\ *\ num\_per\_thread);}
\DoxyCodeLine{00396\ }
\DoxyCodeLine{00397\ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}*\ semaphore\ =\ NULL;}
\DoxyCodeLine{00398\ \ \ \ \ \textcolor{keywordflow}{if}\ (num\_blocks\ >\ 1)\ \{}
\DoxyCodeLine{00399\ \ \ \ \ \ \ semaphore\ =\ device.semaphore();}
\DoxyCodeLine{00400\ \ \ \ \ \}}
\DoxyCodeLine{00401\ }
\DoxyCodeLine{00402\ \ \ \ \ LAUNCH\_GPU\_KERNEL((FullReductionKernel<block\_size,\ num\_per\_thread,\ Self,\ Op,\ Index>),}
\DoxyCodeLine{00403\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ num\_blocks,\ block\_size,\ 0,\ device,\ reducer,\ self,\ num\_coeffs,\ output,\ semaphore);}
\DoxyCodeLine{00404\ \ \ \}}
\DoxyCodeLine{00405\ \};}
\DoxyCodeLine{00406\ }
\DoxyCodeLine{00407\ \textcolor{preprocessor}{\#ifdef\ EIGEN\_HAS\_GPU\_FP16}}
\DoxyCodeLine{00408\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ Self,\ \textcolor{keyword}{typename}\ Op>}
\DoxyCodeLine{00409\ \textcolor{keyword}{struct\ }FullReductionLauncher<Self,\ Op,\ \mbox{\hyperlink{namespaceEigen}{Eigen}}::half,\ false>\ \{}
\DoxyCodeLine{00410\ \ \ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ run(\textcolor{keyword}{const}\ Self\&,\ Op\&,\ \textcolor{keyword}{const}\ GpuDevice\&,\ half*,\ \textcolor{keyword}{typename}\ Self::Index)\ \{}
\DoxyCodeLine{00411\ \ \ \ \ gpu\_assert(\textcolor{keyword}{false}\ \&\&\ \textcolor{stringliteral}{"{}Should\ not\ be\ called\ since\ there\ is\ no\ packet\ accessor"{}});}
\DoxyCodeLine{00412\ \ \ \}}
\DoxyCodeLine{00413\ \};}
\DoxyCodeLine{00414\ }
\DoxyCodeLine{00415\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ Self,\ \textcolor{keyword}{typename}\ Op>}
\DoxyCodeLine{00416\ \textcolor{keyword}{struct\ }FullReductionLauncher<Self,\ Op,\ \mbox{\hyperlink{namespaceEigen}{Eigen}}::half,\ true>\ \{}
\DoxyCodeLine{00417\ \ \ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ run(\textcolor{keyword}{const}\ Self\&\ self,\ Op\&\ reducer,\ \textcolor{keyword}{const}\ GpuDevice\&\ device,\ half*\ output,\ \textcolor{keyword}{typename}\ Self::Index\ num\_coeffs)\ \{}
\DoxyCodeLine{00418\ \ \ \ \ \textcolor{keyword}{typedef}\ \textcolor{keyword}{typename}\ Self::Index\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}};}
\DoxyCodeLine{00419\ \ \ \ \ \textcolor{keyword}{typedef}\ \textcolor{keyword}{typename}\ packet\_traits<Eigen::half>::type\ PacketType;}
\DoxyCodeLine{00420\ }
\DoxyCodeLine{00421\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ block\_size\ =\ 256;}
\DoxyCodeLine{00422\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ num\_per\_thread\ =\ 128;}
\DoxyCodeLine{00423\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ num\_blocks\ =\ divup<int>(num\_coeffs,\ block\_size\ *\ num\_per\_thread);}
\DoxyCodeLine{00424\ \ \ \ \ PacketType*\ scratch\ =\ \textcolor{keyword}{static\_cast<}PacketType*\textcolor{keyword}{>}(device.scratchpad());}
\DoxyCodeLine{00425\ \ \ \ \ \textcolor{comment}{//\ half2*\ scratch\ =\ static\_cast<half2*>(device.scratchpad());}}
\DoxyCodeLine{00426\ }
\DoxyCodeLine{00427\ \ \ \ \ \textcolor{keywordflow}{if}\ (num\_blocks\ >\ 1)\ \{}
\DoxyCodeLine{00428\ \ \ \ \ \ \ \textcolor{comment}{//\ We\ initialize\ the\ output\ and\ the\ scrathpad\ outside\ the\ reduction\ kernel\ when\ we\ can't\ be\ sure\ that\ there}}
\DoxyCodeLine{00429\ \ \ \ \ \ \ \textcolor{comment}{//\ won't\ be\ a\ race\ conditions\ between\ multiple\ thread\ blocks.}}
\DoxyCodeLine{00430\ \ \ \ \ \ \ LAUNCH\_GPU\_KERNEL((ReductionInitFullReduxKernelHalfFloat<Self,\ Op,\ Index>),}
\DoxyCodeLine{00431\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 1,\ 1,\ 0,\ device,\ reducer,\ self,\ num\_coeffs,\ scratch);}
\DoxyCodeLine{00432\ \ \ \ \ \}}
\DoxyCodeLine{00433\ }
\DoxyCodeLine{00434\ \ \ \ \ LAUNCH\_GPU\_KERNEL((FullReductionKernelHalfFloat<block\_size,\ num\_per\_thread,\ Self,\ Op,\ Index>),}
\DoxyCodeLine{00435\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ num\_blocks,\ block\_size,\ 0,\ device,\ reducer,\ self,\ num\_coeffs,\ output,\ scratch);}
\DoxyCodeLine{00436\ }
\DoxyCodeLine{00437\ \ \ \ \ \textcolor{keywordflow}{if}\ (num\_blocks\ >\ 1)\ \{}
\DoxyCodeLine{00438\ \ \ \ \ \ \ LAUNCH\_GPU\_KERNEL((ReductionCleanupKernelHalfFloat<Op>),}
\DoxyCodeLine{00439\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 1,\ 1,\ 0,\ device,\ reducer,\ output,\ scratch);}
\DoxyCodeLine{00440\ \ \ \ \ \}}
\DoxyCodeLine{00441\ \ \ \}}
\DoxyCodeLine{00442\ \};}
\DoxyCodeLine{00443\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ EIGEN\_HAS\_GPU\_FP16}}
\DoxyCodeLine{00444\ }
\DoxyCodeLine{00445\ }
\DoxyCodeLine{00446\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ Self,\ \textcolor{keyword}{typename}\ Op,\ \textcolor{keywordtype}{bool}\ Vectorizable>}
\DoxyCodeLine{00447\ \textcolor{keyword}{struct\ }FullReducer<Self,\ Op,\ GpuDevice,\ Vectorizable>\ \{}
\DoxyCodeLine{00448\ \ \ \textcolor{comment}{//\ Unfortunately\ nvidia\ doesn't\ support\ well\ exotic\ types\ such\ as\ complex,}}
\DoxyCodeLine{00449\ \ \ \textcolor{comment}{//\ so\ reduce\ the\ scope\ of\ the\ optimized\ version\ of\ the\ code\ to\ the\ simple\ cases}}
\DoxyCodeLine{00450\ \ \ \textcolor{comment}{//\ of\ doubles,\ floats\ and\ half\ floats}}
\DoxyCodeLine{00451\ \textcolor{preprocessor}{\#ifdef\ EIGEN\_HAS\_GPU\_FP16}}
\DoxyCodeLine{00452\ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{structEigen_1_1internal_1_1FullReducer_afdb7b8d8326a460adec840d3f38b097e}{HasOptimizedImplementation}}\ =\ !Self::ReducerTraits::IsStateful\ \&\&}
\DoxyCodeLine{00453\ \ \ \ \ \ \ (\mbox{\hyperlink{structEigen_1_1internal_1_1is__same_a8fa0f921d1ad770160fe91916e363aaca5989163e8cfc8db2aa0f60d16e735921}{internal::is\_same<typename\ Self::CoeffReturnType,\ float>::value}}\ ||}
\DoxyCodeLine{00454\ \ \ \ \ \ \ \ \mbox{\hyperlink{structEigen_1_1internal_1_1is__same_a8fa0f921d1ad770160fe91916e363aaca5989163e8cfc8db2aa0f60d16e735921}{internal::is\_same<typename\ Self::CoeffReturnType,\ double>::value}}\ ||}
\DoxyCodeLine{00455\ \ \ \ \ \ \ \ (\mbox{\hyperlink{structEigen_1_1internal_1_1is__same_a8fa0f921d1ad770160fe91916e363aaca5989163e8cfc8db2aa0f60d16e735921}{internal::is\_same<typename\ Self::CoeffReturnType,\ Eigen::half>::value}}\ \&\&\ \mbox{\hyperlink{structEigen_1_1internal_1_1reducer__traits_abea8163d6b25b5f6470c936ea213dc43a182285e009d3b4550f2f97bdd19261d6}{reducer\_traits<Op,\ GpuDevice>::PacketAccess}}));}
\DoxyCodeLine{00456\ \textcolor{preprocessor}{\#else\ }\textcolor{comment}{//\ EIGEN\_HAS\_GPU\_FP16}}
\DoxyCodeLine{00457\ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{structEigen_1_1internal_1_1FullReducer_afdb7b8d8326a460adec840d3f38b097e}{HasOptimizedImplementation}}\ =\ !Self::ReducerTraits::IsStateful\ \&\&}
\DoxyCodeLine{00458\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ (\mbox{\hyperlink{structEigen_1_1internal_1_1is__same_a8fa0f921d1ad770160fe91916e363aaca5989163e8cfc8db2aa0f60d16e735921}{internal::is\_same<typename\ Self::CoeffReturnType,\ float>::value}}\ ||}
\DoxyCodeLine{00459\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structEigen_1_1internal_1_1is__same_a8fa0f921d1ad770160fe91916e363aaca5989163e8cfc8db2aa0f60d16e735921}{internal::is\_same<typename\ Self::CoeffReturnType,\ double>::value}});}
\DoxyCodeLine{00460\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ EIGEN\_HAS\_GPU\_FP16}}
\DoxyCodeLine{00461\ }
\DoxyCodeLine{00462\ \ \ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ OutputType>}
\DoxyCodeLine{00463\ \ \ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{structEigen_1_1internal_1_1FullReducer_abe84006cbf584c7789e2f630adf38e4c}{run}}(\textcolor{keyword}{const}\ Self\&\ self,\ Op\&\ reducer,\ \textcolor{keyword}{const}\ GpuDevice\&\ device,\ OutputType*\ output)\ \{}
\DoxyCodeLine{00464\ \ \ \ \ gpu\_assert(\mbox{\hyperlink{structEigen_1_1internal_1_1FullReducer_afdb7b8d8326a460adec840d3f38b097e}{HasOptimizedImplementation}}\ \&\&\ \textcolor{stringliteral}{"{}Should\ only\ be\ called\ on\ doubles,\ floats\ or\ half\ floats"{}});}
\DoxyCodeLine{00465\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ num\_coeffs\ =\ \mbox{\hyperlink{namespaceEigen_1_1internal_a3b99e338d92a91c8b3f89d32d0ca2c39}{array\_prod}}(self.m\_impl.dimensions());}
\DoxyCodeLine{00466\ \ \ \ \ \textcolor{comment}{//\ Don't\ crash\ when\ we're\ called\ with\ an\ input\ tensor\ of\ size\ 0.}}
\DoxyCodeLine{00467\ \ \ \ \ \textcolor{keywordflow}{if}\ (num\_coeffs\ ==\ 0)\ \{}
\DoxyCodeLine{00468\ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00469\ \ \ \ \ \}}
\DoxyCodeLine{00470\ }
\DoxyCodeLine{00471\ \ \ \ \ FullReductionLauncher<Self,\ Op,\ OutputType,\ reducer\_traits<Op,\ GpuDevice>::PacketAccess>\mbox{\hyperlink{structEigen_1_1internal_1_1FullReducer_abe84006cbf584c7789e2f630adf38e4c}{::run}}(self,\ reducer,\ device,\ output,\ num\_coeffs);}
\DoxyCodeLine{00472\ \ \ \}}
\DoxyCodeLine{00473\ \};}
\DoxyCodeLine{00474\ }
\DoxyCodeLine{00475\ }
\DoxyCodeLine{00476\ \textcolor{keyword}{template}\ <\textcolor{keywordtype}{int}\ NumPerThread,\ \textcolor{keyword}{typename}\ Self,}
\DoxyCodeLine{00477\ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{typename}\ Reducer,\ \textcolor{keyword}{typename}\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}>}
\DoxyCodeLine{00478\ \_\_global\_\_\ \mbox{\hyperlink{Macros_8h_ab7c87492b7a80ed45d2e0377b40cdee5}{EIGEN\_HIP\_LAUNCH\_BOUNDS\_1024}}\ \textcolor{keywordtype}{void}\ InnerReductionKernel(Reducer\ reducer,\ \textcolor{keyword}{const}\ Self\ input,\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ num\_coeffs\_to\_reduce,\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ num\_preserved\_coeffs,}
\DoxyCodeLine{00479\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{typename}\ Self::CoeffReturnType*\ output)\ \{}
\DoxyCodeLine{00480\ \textcolor{preprocessor}{\#if\ (defined(EIGEN\_HIP\_DEVICE\_COMPILE)\ \&\&\ defined(\_\_HIP\_ARCH\_HAS\_WARP\_SHUFFLE\_\_))\ ||\ (EIGEN\_CUDA\_ARCH\ >=\ 300)}}
\DoxyCodeLine{00481\ \ \ \textcolor{keyword}{typedef}\ \textcolor{keyword}{typename}\ Self::CoeffReturnType\ \mbox{\hyperlink{namespaceEigen_1_1Architecture_ae54c092bdb3a978b9aa8cc50dcafc13c}{Type}};}
\DoxyCodeLine{00482\ \ \ \mbox{\hyperlink{Macros_8h_acaa7ba89800cfe18d5fd6eed620aea9c}{eigen\_assert}}(blockDim.y\ ==\ 1);}
\DoxyCodeLine{00483\ \ \ \mbox{\hyperlink{Macros_8h_acaa7ba89800cfe18d5fd6eed620aea9c}{eigen\_assert}}(blockDim.z\ ==\ 1);}
\DoxyCodeLine{00484\ \ \ \mbox{\hyperlink{Macros_8h_acaa7ba89800cfe18d5fd6eed620aea9c}{eigen\_assert}}(gridDim.y\ ==\ 1);}
\DoxyCodeLine{00485\ \ \ \mbox{\hyperlink{Macros_8h_acaa7ba89800cfe18d5fd6eed620aea9c}{eigen\_assert}}(gridDim.z\ ==\ 1);}
\DoxyCodeLine{00486\ }
\DoxyCodeLine{00487\ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ unroll\_times\ =\ 16;}
\DoxyCodeLine{00488\ \ \ \mbox{\hyperlink{Macros_8h_acaa7ba89800cfe18d5fd6eed620aea9c}{eigen\_assert}}(NumPerThread\ \%\ unroll\_times\ ==\ 0);}
\DoxyCodeLine{00489\ }
\DoxyCodeLine{00490\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ input\_col\_blocks\ =\ \mbox{\hyperlink{namespaceEigen_a13ec9832931270b80961236d30f6d2e3}{divup<Index>}}(num\_coeffs\_to\_reduce,\ blockDim.x\ *\ NumPerThread);}
\DoxyCodeLine{00491\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ num\_input\_blocks\ =\ input\_col\_blocks\ *\ num\_preserved\_coeffs;}
\DoxyCodeLine{00492\ }
\DoxyCodeLine{00493\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ num\_threads\ =\ blockDim.x\ *\ gridDim.x;}
\DoxyCodeLine{00494\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ thread\_id\ =\ blockIdx.x\ *\ blockDim.x\ +\ threadIdx.x;}
\DoxyCodeLine{00495\ }
\DoxyCodeLine{00496\ \ \ \textcolor{comment}{//\ Initialize\ the\ output\ values\ if\ they\ weren't\ initialized\ by\ the\ ReductionInitKernel}}
\DoxyCodeLine{00497\ \ \ \textcolor{keywordflow}{if}\ (gridDim.x\ ==\ 1)\ \{}
\DoxyCodeLine{00498\ \ \ \ \ \textcolor{keywordflow}{for}\ (\mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ =\ thread\_id;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ <\ num\_preserved\_coeffs;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ +=\ num\_threads)\ \{}
\DoxyCodeLine{00499\ \ \ \ \ \ \ output[\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}]\ =\ reducer.initialize();}
\DoxyCodeLine{00500\ \ \ \ \ \}}
\DoxyCodeLine{00501\ \ \ \ \ \_\_syncthreads();}
\DoxyCodeLine{00502\ \ \ \}}
\DoxyCodeLine{00503\ }
\DoxyCodeLine{00504\ \ \ \textcolor{keywordflow}{for}\ (\mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ =\ blockIdx.x;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ <\ num\_input\_blocks;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ +=\ gridDim.x)\ \{}
\DoxyCodeLine{00505\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ \mbox{\hyperlink{BlockMethods_8h_ace0220ddc85e95e756b362cda5bf17c9}{row}}\ =\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ /\ input\_col\_blocks;}
\DoxyCodeLine{00506\ }
\DoxyCodeLine{00507\ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{BlockMethods_8h_ace0220ddc85e95e756b362cda5bf17c9}{row}}\ <\ num\_preserved\_coeffs)\ \{}
\DoxyCodeLine{00508\ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ col\_block\ =\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ \%\ input\_col\_blocks;}
\DoxyCodeLine{00509\ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ col\_begin\ =\ col\_block\ *\ blockDim.x\ *\ NumPerThread\ +\ threadIdx.x;}
\DoxyCodeLine{00510\ }
\DoxyCodeLine{00511\ \ \ \ \ \ \ \mbox{\hyperlink{namespaceEigen_1_1Architecture_ae54c092bdb3a978b9aa8cc50dcafc13c}{Type}}\ reduced\_val\ =\ reducer.initialize();}
\DoxyCodeLine{00512\ }
\DoxyCodeLine{00513\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ j\ =\ 0;\ \mbox{\hyperlink{namespaceabsl_adb6bd4a9012b471ac01613aff8d4d81ba363b122c528f54df4a0446b6bab05515}{j}}\ <\ NumPerThread;\ \mbox{\hyperlink{namespaceabsl_adb6bd4a9012b471ac01613aff8d4d81ba363b122c528f54df4a0446b6bab05515}{j}}\ +=\ unroll\_times)\ \{}
\DoxyCodeLine{00514\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ last\_col\ =\ col\_begin\ +\ blockDim.x\ *\ (\mbox{\hyperlink{namespaceabsl_adb6bd4a9012b471ac01613aff8d4d81ba363b122c528f54df4a0446b6bab05515}{j}}\ +\ unroll\_times\ -\/\ 1);}
\DoxyCodeLine{00515\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (last\_col\ >=\ num\_coeffs\_to\_reduce)\ \{}
\DoxyCodeLine{00516\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ \mbox{\hyperlink{BlockMethods_8h_a00a58bf5d6022e451612db73ffbf4aef}{col}}\ =\ col\_begin\ +\ blockDim.x\ *\ j;\ \mbox{\hyperlink{BlockMethods_8h_a00a58bf5d6022e451612db73ffbf4aef}{col}}\ <\ num\_coeffs\_to\_reduce;\ \mbox{\hyperlink{BlockMethods_8h_a00a58bf5d6022e451612db73ffbf4aef}{col}}\ +=\ blockDim.x)\ \{}
\DoxyCodeLine{00517\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespaceEigen_1_1Architecture_ae54c092bdb3a978b9aa8cc50dcafc13c}{Type}}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2raw__hash__set__test_8cc_aa0ccb5ee6d882ee3605ff47745c6467b}{val}}\ =\ input.m\_impl.coeff(\mbox{\hyperlink{BlockMethods_8h_ace0220ddc85e95e756b362cda5bf17c9}{row}}\ *\ num\_coeffs\_to\_reduce\ +\ \mbox{\hyperlink{BlockMethods_8h_a00a58bf5d6022e451612db73ffbf4aef}{col}});}
\DoxyCodeLine{00518\ \ \ \ \ \ \ \ \ \ \ \ \ reducer.reduce(\mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2raw__hash__set__test_8cc_aa0ccb5ee6d882ee3605ff47745c6467b}{val}},\ \&reduced\_val);}
\DoxyCodeLine{00519\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00520\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00521\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00522\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Faster\ version\ of\ the\ loop\ with\ no\ branches\ after\ unrolling.}}
\DoxyCodeLine{00523\ \textcolor{preprocessor}{\#pragma\ unroll}}
\DoxyCodeLine{00524\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ k\ =\ 0;\ k\ <\ unroll\_times;\ ++k)\ \{}
\DoxyCodeLine{00525\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ \mbox{\hyperlink{BlockMethods_8h_a00a58bf5d6022e451612db73ffbf4aef}{col}}\ =\ col\_begin\ +\ blockDim.x\ *\ (\mbox{\hyperlink{namespaceabsl_adb6bd4a9012b471ac01613aff8d4d81ba363b122c528f54df4a0446b6bab05515}{j}}\ +\ k);}
\DoxyCodeLine{00526\ \ \ \ \ \ \ \ \ \ \ \ \ reducer.reduce(input.m\_impl.coeff(\mbox{\hyperlink{BlockMethods_8h_ace0220ddc85e95e756b362cda5bf17c9}{row}}\ *\ num\_coeffs\_to\_reduce\ +\ \mbox{\hyperlink{BlockMethods_8h_a00a58bf5d6022e451612db73ffbf4aef}{col}}),\ \&reduced\_val);}
\DoxyCodeLine{00527\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00528\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00529\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00530\ }
\DoxyCodeLine{00531\ \textcolor{preprocessor}{\#pragma\ unroll}}
\DoxyCodeLine{00532\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ offset\ =\ warpSize/2;\ offset\ >\ 0;\ offset\ /=\ 2)\ \{}
\DoxyCodeLine{00533\ \textcolor{preprocessor}{\ \ \ \ \ \ \#if\ defined(EIGEN\_HIPCC)}}
\DoxyCodeLine{00534\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ use\ std::is\_floating\_point\ to\ determine\ the\ type\ of\ reduced\_val\ }}
\DoxyCodeLine{00535\ \ \ \ \ \ \ \ \textcolor{comment}{//\ This\ is\ needed\ because\ when\ Type\ ==\ double,\ hipcc\ will\ give\ a\ "{}call\ to\ \_\_shfl\_down\ is\ ambguous"{}\ error\ }}
\DoxyCodeLine{00536\ \ \ \ \ \ \ \ \textcolor{comment}{//\ and\ list\ the\ float\ and\ int\ versions\ of\ \_\_shfl\_down\ as\ the\ candidate\ functions.\ }}
\DoxyCodeLine{00537\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (std::is\_floating\_point<Type>::value)\ \{}
\DoxyCodeLine{00538\ \ \ \ \ \ \ \ \ \ \ reducer.reduce(\_\_shfl\_down(\textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{float}\textcolor{keyword}{>}(reduced\_val),\ offset),\ \&reduced\_val);}
\DoxyCodeLine{00539\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00540\ \ \ \ \ \ \ \ \ \ \ reducer.reduce(\_\_shfl\_down(\textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{int}\textcolor{keyword}{>}(reduced\_val),\ offset),\ \&reduced\_val);}
\DoxyCodeLine{00541\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00542\ \textcolor{preprocessor}{\ \ \ \ \ \ \#elif\ defined(EIGEN\_CUDA\_SDK\_VER)\ \&\&\ EIGEN\_CUDA\_SDK\_VER\ <\ 90000}}
\DoxyCodeLine{00543\ \ \ \ \ \ \ \ \ reducer.reduce(\_\_shfl\_down(reduced\_val,\ offset),\ \&reduced\_val);}
\DoxyCodeLine{00544\ \textcolor{preprocessor}{\ \ \ \ \ \ \#else}}
\DoxyCodeLine{00545\ \ \ \ \ \ \ \ \ reducer.reduce(\_\_shfl\_down\_sync(0xFFFFFFFF,\ reduced\_val,\ offset),\ \&reduced\_val);}
\DoxyCodeLine{00546\ \textcolor{preprocessor}{\ \ \ \ \ \ \#endif}}
\DoxyCodeLine{00547\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00548\ }
\DoxyCodeLine{00549\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ ((threadIdx.x\ \&\ (warpSize\ -\/\ 1))\ ==\ 0)\ \{}
\DoxyCodeLine{00550\ \ \ \ \ \ \ \ \ atomicReduce(\&(output[\mbox{\hyperlink{BlockMethods_8h_ace0220ddc85e95e756b362cda5bf17c9}{row}}]),\ reduced\_val,\ reducer);}
\DoxyCodeLine{00551\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00552\ \ \ \ \ \}}
\DoxyCodeLine{00553\ \ \ \}}
\DoxyCodeLine{00554\ \textcolor{preprocessor}{\#else\ }\textcolor{comment}{//\ EIGEN\_CUDA\_ARCH\ >=\ 300}}
\DoxyCodeLine{00555\ \ \ gpu\_assert(0\ \&\&\ \textcolor{stringliteral}{"{}Shouldn't\ be\ called\ on\ unsupported\ device"{}});}
\DoxyCodeLine{00556\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ EIGEN\_CUDA\_ARCH\ >=\ 300}}
\DoxyCodeLine{00557\ \}}
\DoxyCodeLine{00558\ }
\DoxyCodeLine{00559\ \textcolor{preprocessor}{\#ifdef\ EIGEN\_HAS\_GPU\_FP16}}
\DoxyCodeLine{00560\ }
\DoxyCodeLine{00561\ \textcolor{keyword}{template}\ <\textcolor{keywordtype}{int}\ NumPerThread,\ \textcolor{keyword}{typename}\ Self,}
\DoxyCodeLine{00562\ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{typename}\ Reducer,\ \textcolor{keyword}{typename}\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}>}
\DoxyCodeLine{00563\ \_\_global\_\_\ \mbox{\hyperlink{Macros_8h_ab7c87492b7a80ed45d2e0377b40cdee5}{EIGEN\_HIP\_LAUNCH\_BOUNDS\_1024}}\ \textcolor{keywordtype}{void}\ InnerReductionKernelHalfFloat(Reducer\ reducer,\ \textcolor{keyword}{const}\ Self\ input,\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ num\_coeffs\_to\_reduce,\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ num\_preserved\_coeffs,}
\DoxyCodeLine{00564\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ half*\ output)\ \{}
\DoxyCodeLine{00565\ \ \ \mbox{\hyperlink{Macros_8h_acaa7ba89800cfe18d5fd6eed620aea9c}{eigen\_assert}}(blockDim.y\ ==\ 1);}
\DoxyCodeLine{00566\ \ \ \mbox{\hyperlink{Macros_8h_acaa7ba89800cfe18d5fd6eed620aea9c}{eigen\_assert}}(blockDim.z\ ==\ 1);}
\DoxyCodeLine{00567\ \ \ \mbox{\hyperlink{Macros_8h_acaa7ba89800cfe18d5fd6eed620aea9c}{eigen\_assert}}(gridDim.y\ ==\ 1);}
\DoxyCodeLine{00568\ \ \ \mbox{\hyperlink{Macros_8h_acaa7ba89800cfe18d5fd6eed620aea9c}{eigen\_assert}}(gridDim.z\ ==\ 1);}
\DoxyCodeLine{00569\ }
\DoxyCodeLine{00570\ \ \ \textcolor{keyword}{typedef}\ \textcolor{keyword}{typename}\ \mbox{\hyperlink{structEigen_1_1internal_1_1packet__traits_3_01Eigen_1_1half_01_4_a07d518ab7e1e56a34612ebd95c3f5c5f}{packet\_traits<Eigen::half>::type}}\ PacketType;}
\DoxyCodeLine{00571\ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ packet\_width\ =\ \mbox{\hyperlink{structEigen_1_1internal_1_1unpacket__traits_aa3c8daa4597ef6c42efb377d14f87dcba63cc10676eb13001d700f7bc4336f6ee}{unpacket\_traits<PacketType>::size}};}
\DoxyCodeLine{00572\ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ unroll\_times\ =\ 16\ /\ packet\_width;}
\DoxyCodeLine{00573\ \ \ \mbox{\hyperlink{Macros_8h_acaa7ba89800cfe18d5fd6eed620aea9c}{eigen\_assert}}(NumPerThread\ \%\ unroll\_times\ ==\ 0);}
\DoxyCodeLine{00574\ \ \ \mbox{\hyperlink{Macros_8h_acaa7ba89800cfe18d5fd6eed620aea9c}{eigen\_assert}}(unroll\_times\ \%\ 2\ ==\ 0);}
\DoxyCodeLine{00575\ }
\DoxyCodeLine{00576\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ input\_col\_blocks\ =\ \mbox{\hyperlink{namespaceEigen_a13ec9832931270b80961236d30f6d2e3}{divup<Index>}}(num\_coeffs\_to\_reduce,\ blockDim.x\ *\ NumPerThread\ *\ 2);}
\DoxyCodeLine{00577\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ num\_input\_blocks\ =\ \mbox{\hyperlink{namespaceEigen_a13ec9832931270b80961236d30f6d2e3}{divup<Index>}}(input\_col\_blocks\ *\ num\_preserved\_coeffs,\ 2);}
\DoxyCodeLine{00578\ }
\DoxyCodeLine{00579\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ num\_threads\ =\ blockDim.x\ *\ gridDim.x;}
\DoxyCodeLine{00580\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ thread\_id\ =\ blockIdx.x\ *\ blockDim.x\ +\ threadIdx.x;}
\DoxyCodeLine{00581\ }
\DoxyCodeLine{00582\ \ \ \textcolor{comment}{//\ Initialize\ the\ output\ values\ if\ they\ weren't\ initialized\ by\ the\ ReductionInitKernel}}
\DoxyCodeLine{00583\ \ \ \textcolor{keywordflow}{if}\ (gridDim.x\ ==\ 1)\ \{}
\DoxyCodeLine{00584\ \ \ \ \ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ =\ packet\_width\ *\ thread\_id;}
\DoxyCodeLine{00585\ \ \ \ \ \textcolor{keywordflow}{for}\ (;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ +\ packet\_width\ <=\ num\_preserved\_coeffs;}
\DoxyCodeLine{00586\ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ +=\ packet\_width\ *\ num\_threads)\ \{}
\DoxyCodeLine{00587\ \ \ \ \ \ \ PacketType*\ poutput\ =\ \textcolor{keyword}{reinterpret\_cast<}PacketType*\textcolor{keyword}{>}(output\ +\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}});}
\DoxyCodeLine{00588\ \ \ \ \ \ \ *poutput\ =\ reducer.template\ initializePacket<PacketType>();}
\DoxyCodeLine{00589\ \ \ \ \ \}}
\DoxyCodeLine{00590\ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ <\ num\_preserved\_coeffs)\ \{}
\DoxyCodeLine{00591\ \ \ \ \ \ \ output[\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}]\ =\ reducer.initialize();}
\DoxyCodeLine{00592\ \ \ \ \ \}}
\DoxyCodeLine{00593\ \ \ \ \ \_\_syncthreads();}
\DoxyCodeLine{00594\ \ \ \}}
\DoxyCodeLine{00595\ }
\DoxyCodeLine{00596\ \ \ \textcolor{keywordflow}{for}\ (\mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ =\ blockIdx.x;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ <\ num\_input\_blocks;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ +=\ gridDim.x)\ \{}
\DoxyCodeLine{00597\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ \mbox{\hyperlink{BlockMethods_8h_ace0220ddc85e95e756b362cda5bf17c9}{row}}\ =\ 2\ *\ (\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ /\ input\_col\_blocks);\ \ \textcolor{comment}{//\ everybody\ takes\ 2\ rows}}
\DoxyCodeLine{00598\ }
\DoxyCodeLine{00599\ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{BlockMethods_8h_ace0220ddc85e95e756b362cda5bf17c9}{row}}\ +\ 1\ <\ num\_preserved\_coeffs)\ \{}
\DoxyCodeLine{00600\ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ col\_block\ =\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ \%\ input\_col\_blocks;}
\DoxyCodeLine{00601\ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ col\_begin\ =}
\DoxyCodeLine{00602\ \ \ \ \ \ \ \ \ \ \ packet\_width\ *\ (col\_block\ *\ blockDim.x\ *\ NumPerThread\ +\ threadIdx.x);}
\DoxyCodeLine{00603\ }
\DoxyCodeLine{00604\ \ \ \ \ \ \ PacketType\ reduced\_val1\ =\ reducer.template\ initializePacket<PacketType>();}
\DoxyCodeLine{00605\ \ \ \ \ \ \ PacketType\ reduced\_val2\ =\ reducer.template\ initializePacket<PacketType>();}
\DoxyCodeLine{00606\ }
\DoxyCodeLine{00607\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ j\ =\ 0;\ \mbox{\hyperlink{namespaceabsl_adb6bd4a9012b471ac01613aff8d4d81ba363b122c528f54df4a0446b6bab05515}{j}}\ <\ NumPerThread;\ \mbox{\hyperlink{namespaceabsl_adb6bd4a9012b471ac01613aff8d4d81ba363b122c528f54df4a0446b6bab05515}{j}}\ +=\ unroll\_times)\ \{}
\DoxyCodeLine{00608\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ last\_col\ =}
\DoxyCodeLine{00609\ \ \ \ \ \ \ \ \ \ \ \ \ col\_begin\ +\ blockDim.x\ *\ (\mbox{\hyperlink{namespaceabsl_adb6bd4a9012b471ac01613aff8d4d81ba363b122c528f54df4a0446b6bab05515}{j}}\ +\ unroll\_times\ -\/\ 1)\ *\ packet\_width;}
\DoxyCodeLine{00610\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (last\_col\ >=\ num\_coeffs\_to\_reduce)\ \{}
\DoxyCodeLine{00611\ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ \mbox{\hyperlink{BlockMethods_8h_a00a58bf5d6022e451612db73ffbf4aef}{col}}\ =\ col\_begin\ +\ blockDim.x\ *\ \mbox{\hyperlink{namespaceabsl_adb6bd4a9012b471ac01613aff8d4d81ba363b122c528f54df4a0446b6bab05515}{j}};}
\DoxyCodeLine{00612\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (;\ \mbox{\hyperlink{BlockMethods_8h_a00a58bf5d6022e451612db73ffbf4aef}{col}}\ +\ packet\_width\ <=\ num\_coeffs\_to\_reduce;}
\DoxyCodeLine{00613\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{BlockMethods_8h_a00a58bf5d6022e451612db73ffbf4aef}{col}}\ +=\ blockDim.x)\ \{}
\DoxyCodeLine{00614\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ PacketType\ val1\ =\ input.m\_impl.template\ packet<Unaligned>(}
\DoxyCodeLine{00615\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{BlockMethods_8h_ace0220ddc85e95e756b362cda5bf17c9}{row}}\ *\ num\_coeffs\_to\_reduce\ +\ \mbox{\hyperlink{BlockMethods_8h_a00a58bf5d6022e451612db73ffbf4aef}{col}});}
\DoxyCodeLine{00616\ \ \ \ \ \ \ \ \ \ \ \ \ reducer.reducePacket(val1,\ \&reduced\_val1);}
\DoxyCodeLine{00617\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ PacketType\ val2\ =\ input.m\_impl.template\ packet<Unaligned>(}
\DoxyCodeLine{00618\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ (\mbox{\hyperlink{BlockMethods_8h_ace0220ddc85e95e756b362cda5bf17c9}{row}}\ +\ 1)\ *\ num\_coeffs\_to\_reduce\ +\ \mbox{\hyperlink{BlockMethods_8h_a00a58bf5d6022e451612db73ffbf4aef}{col}});}
\DoxyCodeLine{00619\ \ \ \ \ \ \ \ \ \ \ \ \ reducer.reducePacket(val2,\ \&reduced\_val2);}
\DoxyCodeLine{00620\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00621\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{BlockMethods_8h_a00a58bf5d6022e451612db73ffbf4aef}{col}}\ <\ num\_coeffs\_to\_reduce)\ \{}
\DoxyCodeLine{00622\ \ \ \ \ \ \ \ \ \ \ \ \ PacketType\ r1\ =\ reducer.template\ initializePacket<PacketType>();}
\DoxyCodeLine{00623\ \ \ \ \ \ \ \ \ \ \ \ \ PacketType\ r2\ =\ reducer.template\ initializePacket<PacketType>();}
\DoxyCodeLine{00624\ \ \ \ \ \ \ \ \ \ \ \ \ half2*\ hr1\ =\ \textcolor{keyword}{reinterpret\_cast<}half2*\textcolor{keyword}{>}(\&r1);}
\DoxyCodeLine{00625\ \ \ \ \ \ \ \ \ \ \ \ \ half2*\ hr2\ =\ \textcolor{keyword}{reinterpret\_cast<}half2*\textcolor{keyword}{>}(\&r2);}
\DoxyCodeLine{00626\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ (\mbox{\hyperlink{BlockMethods_8h_a00a58bf5d6022e451612db73ffbf4aef}{col}}\ +\ 1\ <\ num\_coeffs\_to\_reduce)\ \{}
\DoxyCodeLine{00627\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ *hr1\ =\ \_\_halves2half2(}
\DoxyCodeLine{00628\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ input.m\_impl.coeff(\mbox{\hyperlink{BlockMethods_8h_ace0220ddc85e95e756b362cda5bf17c9}{row}}\ *\ num\_coeffs\_to\_reduce\ +\ \mbox{\hyperlink{BlockMethods_8h_a00a58bf5d6022e451612db73ffbf4aef}{col}}),}
\DoxyCodeLine{00629\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ input.m\_impl.coeff(\mbox{\hyperlink{BlockMethods_8h_ace0220ddc85e95e756b362cda5bf17c9}{row}}\ *\ num\_coeffs\_to\_reduce\ +\ \mbox{\hyperlink{BlockMethods_8h_a00a58bf5d6022e451612db73ffbf4aef}{col}}\ +\ 1));}
\DoxyCodeLine{00630\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ *hr2\ =\ \_\_halves2half2(}
\DoxyCodeLine{00631\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ input.m\_impl.coeff((\mbox{\hyperlink{BlockMethods_8h_ace0220ddc85e95e756b362cda5bf17c9}{row}}\ +\ 1)\ *\ num\_coeffs\_to\_reduce\ +\ \mbox{\hyperlink{BlockMethods_8h_a00a58bf5d6022e451612db73ffbf4aef}{col}}),}
\DoxyCodeLine{00632\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ input.m\_impl.coeff((\mbox{\hyperlink{BlockMethods_8h_ace0220ddc85e95e756b362cda5bf17c9}{row}}\ +\ 1)\ *\ num\_coeffs\_to\_reduce\ +\ \mbox{\hyperlink{BlockMethods_8h_a00a58bf5d6022e451612db73ffbf4aef}{col}}\ +}
\DoxyCodeLine{00633\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 1));}
\DoxyCodeLine{00634\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ hr1++;}
\DoxyCodeLine{00635\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ hr2++;}
\DoxyCodeLine{00636\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{BlockMethods_8h_a00a58bf5d6022e451612db73ffbf4aef}{col}}\ +=\ 2;}
\DoxyCodeLine{00637\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00638\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{BlockMethods_8h_a00a58bf5d6022e451612db73ffbf4aef}{col}}\ <\ num\_coeffs\_to\_reduce)\ \{}
\DoxyCodeLine{00639\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Peel;}}
\DoxyCodeLine{00640\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ half\ last1\ =}
\DoxyCodeLine{00641\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ input.m\_impl.coeff(\mbox{\hyperlink{BlockMethods_8h_ace0220ddc85e95e756b362cda5bf17c9}{row}}\ *\ num\_coeffs\_to\_reduce\ +\ \mbox{\hyperlink{BlockMethods_8h_a00a58bf5d6022e451612db73ffbf4aef}{col}});}
\DoxyCodeLine{00642\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ *hr1\ =\ \_\_halves2half2(last1,\ reducer.initialize());}
\DoxyCodeLine{00643\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ half\ last2\ =}
\DoxyCodeLine{00644\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ input.m\_impl.coeff((\mbox{\hyperlink{BlockMethods_8h_ace0220ddc85e95e756b362cda5bf17c9}{row}}\ +\ 1)\ *\ num\_coeffs\_to\_reduce\ +\ \mbox{\hyperlink{BlockMethods_8h_a00a58bf5d6022e451612db73ffbf4aef}{col}});}
\DoxyCodeLine{00645\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ *hr2\ =\ \_\_halves2half2(last2,\ reducer.initialize());}
\DoxyCodeLine{00646\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00647\ \ \ \ \ \ \ \ \ \ \ \ \ reducer.reducePacket(r1,\ \&reduced\_val1);}
\DoxyCodeLine{00648\ \ \ \ \ \ \ \ \ \ \ \ \ reducer.reducePacket(r2,\ \&reduced\_val2);}
\DoxyCodeLine{00649\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00650\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00651\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00652\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Faster\ version\ of\ the\ loop\ with\ no\ branches\ after\ unrolling.}}
\DoxyCodeLine{00653\ \textcolor{preprocessor}{\#pragma\ unroll}}
\DoxyCodeLine{00654\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ k\ =\ 0;\ k\ <\ unroll\_times;\ ++k)\ \{}
\DoxyCodeLine{00655\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ \mbox{\hyperlink{BlockMethods_8h_a00a58bf5d6022e451612db73ffbf4aef}{col}}\ =\ col\_begin\ +\ blockDim.x\ *\ (\mbox{\hyperlink{namespaceabsl_adb6bd4a9012b471ac01613aff8d4d81ba363b122c528f54df4a0446b6bab05515}{j}}\ +\ k)\ *\ packet\_width;}
\DoxyCodeLine{00656\ \ \ \ \ \ \ \ \ \ \ \ \ reducer.reducePacket(input.m\_impl.template\ packet<Unaligned>(}
\DoxyCodeLine{00657\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{BlockMethods_8h_ace0220ddc85e95e756b362cda5bf17c9}{row}}\ *\ num\_coeffs\_to\_reduce\ +\ \mbox{\hyperlink{BlockMethods_8h_a00a58bf5d6022e451612db73ffbf4aef}{col}}),}
\DoxyCodeLine{00658\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \&reduced\_val1);}
\DoxyCodeLine{00659\ \ \ \ \ \ \ \ \ \ \ \ \ reducer.reducePacket(input.m\_impl.template\ packet<Unaligned>(}
\DoxyCodeLine{00660\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ (\mbox{\hyperlink{BlockMethods_8h_ace0220ddc85e95e756b362cda5bf17c9}{row}}\ +\ 1)\ *\ num\_coeffs\_to\_reduce\ +\ \mbox{\hyperlink{BlockMethods_8h_a00a58bf5d6022e451612db73ffbf4aef}{col}}),}
\DoxyCodeLine{00661\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \&reduced\_val2);}
\DoxyCodeLine{00662\ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00663\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00664\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00665\ }
\DoxyCodeLine{00666\ \textcolor{preprocessor}{\#pragma\ unroll}}
\DoxyCodeLine{00667\ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ offset\ =\ warpSize/2;\ offset\ >\ 0;\ offset\ /=\ 2)\ \{}
\DoxyCodeLine{00668\ \textcolor{preprocessor}{\ \ \ \ \ \ \#if\ defined(EIGEN\_HIPCC)}}
\DoxyCodeLine{00669\ \ \ \ \ \ \ \ \ PacketType\ r1;}
\DoxyCodeLine{00670\ \ \ \ \ \ \ \ \ PacketType\ r2;}
\DoxyCodeLine{00671\ \ \ \ \ \ \ \ \ half2*\ hr1\ =\ \textcolor{keyword}{reinterpret\_cast<}half2*\textcolor{keyword}{>}(\&r1);}
\DoxyCodeLine{00672\ \ \ \ \ \ \ \ \ half2*\ hr2\ =\ \textcolor{keyword}{reinterpret\_cast<}half2*\textcolor{keyword}{>}(\&r2);}
\DoxyCodeLine{00673\ \ \ \ \ \ \ \ \ half2*\ rv1\ =\ \textcolor{keyword}{reinterpret\_cast<}half2*\textcolor{keyword}{>}(\&reduced\_val1);}
\DoxyCodeLine{00674\ \ \ \ \ \ \ \ \ half2*\ rv2\ =\ \textcolor{keyword}{reinterpret\_cast<}half2*\textcolor{keyword}{>}(\&reduced\_val2);}
\DoxyCodeLine{00675\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ =\ 0;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ <\ packet\_width\ /\ 2;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}++)\ \{}
\DoxyCodeLine{00676\ \ \ \ \ \ \ \textcolor{comment}{//\ FIXME\ :\ remove\ this\ workaround\ once\ we\ have\ native\ half/half2\ support\ for\ \_\_shfl\_down}}
\DoxyCodeLine{00677\ \ \ \ \ \ \ \textcolor{keyword}{union\ }\{\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}};\ half2\ \mbox{\hyperlink{namespaceabsl_adb6bd4a9012b471ac01613aff8d4d81ba2510c39011c5be704182423e3a695e91}{h}};\ \}\ wka\_in1,\ wka\_out1;}
\DoxyCodeLine{00678\ \ \ \ \ \ \ wka\_in1.h\ =\ rv1[\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}];}
\DoxyCodeLine{00679\ \ \ \ \ \ \ wka\_out1.i\ =\ \_\_shfl\_down(wka\_in1.i,\ offset,\ warpSize);}
\DoxyCodeLine{00680\ \ \ \ \ \ \ hr1[\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}]\ =\ wka\_out1.h;}
\DoxyCodeLine{00681\ }
\DoxyCodeLine{00682\ \ \ \ \ \ \ \textcolor{keyword}{union\ }\{\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}};\ half2\ \mbox{\hyperlink{namespaceabsl_adb6bd4a9012b471ac01613aff8d4d81ba2510c39011c5be704182423e3a695e91}{h}};\ \}\ wka\_in2,\ wka\_out2;}
\DoxyCodeLine{00683\ \ \ \ \ \ \ wka\_in2.h\ =\ rv2[\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}];}
\DoxyCodeLine{00684\ \ \ \ \ \ \ wka\_out2.i\ =\ \_\_shfl\_down(wka\_in2.i,\ offset,\ warpSize);}
\DoxyCodeLine{00685\ \ \ \ \ \ \ hr2[\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}]\ =\ wka\_out2.h;}
\DoxyCodeLine{00686\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00687\ \ \ \ \ \ \ \ \ reducer.reducePacket(r1,\ \&reduced\_val1);}
\DoxyCodeLine{00688\ \ \ \ \ \ \ \ \ reducer.reducePacket(r2,\ \&reduced\_val2);}
\DoxyCodeLine{00689\ \textcolor{preprocessor}{\ \ \ \ \ \ \#elif\ defined(EIGEN\_CUDA\_SDK\_VER)\ \&\&\ EIGEN\_CUDA\_SDK\_VER\ <\ 90000}}
\DoxyCodeLine{00690\ \ \ \ \ \ \ \ \ PacketType\ r1;}
\DoxyCodeLine{00691\ \ \ \ \ \ \ \ \ PacketType\ r2;}
\DoxyCodeLine{00692\ \ \ \ \ \ \ \ \ half2*\ hr1\ =\ \textcolor{keyword}{reinterpret\_cast<}half2*\textcolor{keyword}{>}(\&r1);}
\DoxyCodeLine{00693\ \ \ \ \ \ \ \ \ half2*\ hr2\ =\ \textcolor{keyword}{reinterpret\_cast<}half2*\textcolor{keyword}{>}(\&r2);}
\DoxyCodeLine{00694\ \ \ \ \ \ \ \ \ half2*\ rv1\ =\ \textcolor{keyword}{reinterpret\_cast<}half2*\textcolor{keyword}{>}(\&reduced\_val1);}
\DoxyCodeLine{00695\ \ \ \ \ \ \ \ \ half2*\ rv2\ =\ \textcolor{keyword}{reinterpret\_cast<}half2*\textcolor{keyword}{>}(\&reduced\_val2);}
\DoxyCodeLine{00696\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ =\ 0;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ <\ packet\_width\ /\ 2;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}++)\ \{}
\DoxyCodeLine{00697\ \ \ \ \ \ \ \ \ \ \ hr1[\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}]\ =\ \_\_shfl\_down(rv1[\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}],\ offset,\ warpSize);}
\DoxyCodeLine{00698\ \ \ \ \ \ \ \ \ \ \ hr2[\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}]\ =\ \_\_shfl\_down(rv2[\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}],\ offset,\ warpSize);}
\DoxyCodeLine{00699\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00700\ \ \ \ \ \ \ \ \ reducer.reducePacket(r1,\ \&reduced\_val1);}
\DoxyCodeLine{00701\ \ \ \ \ \ \ \ \ reducer.reducePacket(r2,\ \&reduced\_val2);}
\DoxyCodeLine{00702\ \textcolor{preprocessor}{\ \ \ \ \ \ \#else}}
\DoxyCodeLine{00703\ \ \ \ \ \ \ \ \ PacketType\ r1;}
\DoxyCodeLine{00704\ \ \ \ \ \ \ \ \ PacketType\ r2;}
\DoxyCodeLine{00705\ \ \ \ \ \ \ \ \ half2*\ hr1\ =\ \textcolor{keyword}{reinterpret\_cast<}half2*\textcolor{keyword}{>}(\&r1);}
\DoxyCodeLine{00706\ \ \ \ \ \ \ \ \ half2*\ hr2\ =\ \textcolor{keyword}{reinterpret\_cast<}half2*\textcolor{keyword}{>}(\&r2);}
\DoxyCodeLine{00707\ \ \ \ \ \ \ \ \ half2*\ rr1\ =\ \textcolor{keyword}{reinterpret\_cast<}half2*\textcolor{keyword}{>}(\&reduced\_val1);}
\DoxyCodeLine{00708\ \ \ \ \ \ \ \ \ half2*\ rr2\ =\ \textcolor{keyword}{reinterpret\_cast<}half2*\textcolor{keyword}{>}(\&reduced\_val2);}
\DoxyCodeLine{00709\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ =\ 0;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ <\ packet\_width\ /\ 2;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}++)\ \{}
\DoxyCodeLine{00710\ \ \ \ \ \ \ \ \ \ \ hr1[\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}]\ =}
\DoxyCodeLine{00711\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \_\_shfl\_down\_sync(0xFFFFFFFF,\ rr1[\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}],\ (\textcolor{keywordtype}{unsigned})offset,\ warpSize);}
\DoxyCodeLine{00712\ \ \ \ \ \ \ \ \ \ \ hr2[\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}]\ =}
\DoxyCodeLine{00713\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \_\_shfl\_down\_sync(0xFFFFFFFF,\ rr2[\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}],\ (\textcolor{keywordtype}{unsigned})offset,\ warpSize);}
\DoxyCodeLine{00714\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00715\ \ \ \ \ \ \ \ \ reducer.reducePacket(r1,\ \&reduced\_val1);}
\DoxyCodeLine{00716\ \ \ \ \ \ \ \ \ reducer.reducePacket(r2,\ \&reduced\_val2);}
\DoxyCodeLine{00717\ }
\DoxyCodeLine{00718\ \textcolor{preprocessor}{\ \ \ \ \ \ \#endif}}
\DoxyCodeLine{00719\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00720\ \ \ \ \ \ \ half2*\ rv1\ =\ \textcolor{keyword}{reinterpret\_cast<}half2*\textcolor{keyword}{>}(\&reduced\_val1);}
\DoxyCodeLine{00721\ \ \ \ \ \ \ half2*\ rv2\ =\ \textcolor{keyword}{reinterpret\_cast<}half2*\textcolor{keyword}{>}(\&reduced\_val2);}
\DoxyCodeLine{00722\ \ \ \ \ \ \ half2\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2raw__hash__set__test_8cc_aa0ccb5ee6d882ee3605ff47745c6467b}{val}};}
\DoxyCodeLine{00723\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (packet\_width\ >\ 2)\ \{}
\DoxyCodeLine{00724\ \ \ \ \ \ \ \ \ reducer.reducePacket(rv1[2],\ rv1);}
\DoxyCodeLine{00725\ \ \ \ \ \ \ \ \ reducer.reducePacket(rv1[3],\ rv1\ +\ 1);}
\DoxyCodeLine{00726\ \ \ \ \ \ \ \ \ reducer.reducePacket(rv1[1],\ rv1);}
\DoxyCodeLine{00727\ \ \ \ \ \ \ \ \ reducer.reducePacket(rv2[2],\ rv2);}
\DoxyCodeLine{00728\ \ \ \ \ \ \ \ \ reducer.reducePacket(rv2[3],\ rv2\ +\ 1);}
\DoxyCodeLine{00729\ \ \ \ \ \ \ \ \ reducer.reducePacket(rv2[1],\ rv2);}
\DoxyCodeLine{00730\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00731\ \ \ \ \ \ \ half\ val1\ =\ \_\_low2half(*rv1);}
\DoxyCodeLine{00732\ \ \ \ \ \ \ reducer.reduce(\_\_high2half(*rv1),\ \&val1);}
\DoxyCodeLine{00733\ \ \ \ \ \ \ half\ val2\ =\ \_\_low2half(*rv2);}
\DoxyCodeLine{00734\ \ \ \ \ \ \ reducer.reduce(\_\_high2half(*rv2),\ \&val2);}
\DoxyCodeLine{00735\ \ \ \ \ \ \ \mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2raw__hash__set__test_8cc_aa0ccb5ee6d882ee3605ff47745c6467b}{val}}\ =\ \_\_halves2half2(val1,\ val2);}
\DoxyCodeLine{00736\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ ((threadIdx.x\ \&\ (warpSize\ -\/\ 1))\ ==\ 0)\ \{}
\DoxyCodeLine{00737\ \ \ \ \ \ \ \ \ half*\ loc\ =\ output\ +\ \mbox{\hyperlink{BlockMethods_8h_ace0220ddc85e95e756b362cda5bf17c9}{row}};}
\DoxyCodeLine{00738\ \ \ \ \ \ \ \ \ atomicReduce((half2*)loc,\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2raw__hash__set__test_8cc_aa0ccb5ee6d882ee3605ff47745c6467b}{val}},\ reducer);}
\DoxyCodeLine{00739\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00740\ \ \ \ \ \}}
\DoxyCodeLine{00741\ \ \ \}}
\DoxyCodeLine{00742\ \}}
\DoxyCodeLine{00743\ }
\DoxyCodeLine{00744\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ EIGEN\_HAS\_GPU\_FP16}}
\DoxyCodeLine{00745\ }
\DoxyCodeLine{00746\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ Self,\ \textcolor{keyword}{typename}\ Op,\ \textcolor{keyword}{typename}\ OutputType,\ \textcolor{keywordtype}{bool}\ PacketAccess,\ \textcolor{keyword}{typename}\ Enabled\ =\ \textcolor{keywordtype}{void}>}
\DoxyCodeLine{00747\ \textcolor{keyword}{struct\ }InnerReductionLauncher\ \{}
\DoxyCodeLine{00748\ \ \ \textcolor{keyword}{static}\ \mbox{\hyperlink{Macros_8h_a9efec3cfd22b9a33bead9c6718d128da}{EIGEN\_DEVICE\_FUNC}}\ \textcolor{keywordtype}{bool}\ run(\textcolor{keyword}{const}\ Self\&,\ Op\&,\ \textcolor{keyword}{const}\ GpuDevice\&,\ OutputType*,\ \textcolor{keyword}{typename}\ Self::Index,\ \textcolor{keyword}{typename}\ Self::Index)\ \{}
\DoxyCodeLine{00749\ \ \ \ \ gpu\_assert(\textcolor{keyword}{false}\ \&\&\ \textcolor{stringliteral}{"{}Should\ only\ be\ called\ to\ reduce\ doubles,\ floats\ and\ half\ floats\ on\ a\ gpu\ device"{}});}
\DoxyCodeLine{00750\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00751\ \ \ \}}
\DoxyCodeLine{00752\ \};}
\DoxyCodeLine{00753\ }
\DoxyCodeLine{00754\ \textcolor{comment}{//\ Specialization\ for\ float\ and\ double}}
\DoxyCodeLine{00755\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ Self,\ \textcolor{keyword}{typename}\ Op,\ \textcolor{keyword}{typename}\ OutputType,\ \textcolor{keywordtype}{bool}\ PacketAccess>}
\DoxyCodeLine{00756\ \textcolor{keyword}{struct\ }InnerReductionLauncher<}
\DoxyCodeLine{00757\ \ \ Self,\ Op,\ OutputType,\ PacketAccess,}
\DoxyCodeLine{00758\ \ \ typename\ \mbox{\hyperlink{namespaceinternal}{internal}}::enable\_if<}
\DoxyCodeLine{00759\ \ \ \ \ internal::is\_same<float,\ OutputType>::value\ ||}
\DoxyCodeLine{00760\ \ \ \ \ internal::is\_same<double,\ OutputType>::value,}
\DoxyCodeLine{00761\ \ \ void>::type>\ \{}
\DoxyCodeLine{00762\ \ \ \textcolor{keyword}{static}\ \textcolor{keywordtype}{bool}\ run(\textcolor{keyword}{const}\ Self\&\ self,\ Op\&\ reducer,\ \textcolor{keyword}{const}\ GpuDevice\&\ device,\ OutputType*\ output,\ \textcolor{keyword}{typename}\ Self::Index\ num\_coeffs\_to\_reduce,\ \textcolor{keyword}{typename}\ Self::Index\ num\_preserved\_vals)\ \{}
\DoxyCodeLine{00763\ \ \ \ \ \textcolor{keyword}{typedef}\ \textcolor{keyword}{typename}\ Self::Index\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}};}
\DoxyCodeLine{00764\ }
\DoxyCodeLine{00765\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ num\_coeffs\ =\ num\_coeffs\_to\_reduce\ *\ num\_preserved\_vals;}
\DoxyCodeLine{00766\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ block\_size\ =\ 256;}
\DoxyCodeLine{00767\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ num\_per\_thread\ =\ 128;}
\DoxyCodeLine{00768\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ dyn\_blocks\ =\ divup<int>(num\_coeffs,\ block\_size\ *\ num\_per\_thread);}
\DoxyCodeLine{00769\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ max\_blocks\ =\ device.getNumGpuMultiProcessors()\ *}
\DoxyCodeLine{00770\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ device.maxGpuThreadsPerMultiProcessor()\ /\ block\_size;}
\DoxyCodeLine{00771\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ num\_blocks\ =\ numext::mini<int>(max\_blocks,\ dyn\_blocks);}
\DoxyCodeLine{00772\ }
\DoxyCodeLine{00773\ \ \ \ \ \textcolor{keywordflow}{if}\ (num\_blocks\ >\ 1)\ \{}
\DoxyCodeLine{00774\ \ \ \ \ \ \ \textcolor{comment}{//\ We\ initialize\ the\ outputs\ outside\ the\ reduction\ kernel\ when\ we\ can't\ be\ sure\ that\ there}}
\DoxyCodeLine{00775\ \ \ \ \ \ \ \textcolor{comment}{//\ won't\ be\ a\ race\ conditions\ between\ multiple\ thread\ blocks.}}
\DoxyCodeLine{00776\ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ dyn\_blocks\ =\ divup<int>(num\_preserved\_vals,\ 1024);}
\DoxyCodeLine{00777\ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ max\_blocks\ =\ device.getNumGpuMultiProcessors()\ *}
\DoxyCodeLine{00778\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ device.maxGpuThreadsPerMultiProcessor()\ /\ 1024;}
\DoxyCodeLine{00779\ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ num\_blocks\ =\ numext::mini<int>(max\_blocks,\ dyn\_blocks);}
\DoxyCodeLine{00780\ \ \ \ \ \ \ LAUNCH\_GPU\_KERNEL((ReductionInitKernel<OutputType,\ Index>),}
\DoxyCodeLine{00781\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ num\_blocks,\ 1024,\ 0,\ device,\ reducer.initialize(),}
\DoxyCodeLine{00782\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ num\_preserved\_vals,\ output);}
\DoxyCodeLine{00783\ \ \ \ \ \}}
\DoxyCodeLine{00784\ }
\DoxyCodeLine{00785\ \ \ \ \ LAUNCH\_GPU\_KERNEL((InnerReductionKernel<num\_per\_thread,\ Self,\ Op,\ Index>),}
\DoxyCodeLine{00786\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ num\_blocks,\ block\_size,\ 0,\ device,\ reducer,\ self,\ num\_coeffs\_to\_reduce,\ num\_preserved\_vals,\ output);}
\DoxyCodeLine{00787\ }
\DoxyCodeLine{00788\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00789\ \ \ \}}
\DoxyCodeLine{00790\ \};}
\DoxyCodeLine{00791\ }
\DoxyCodeLine{00792\ \textcolor{preprocessor}{\#ifdef\ EIGEN\_HAS\_GPU\_FP16}}
\DoxyCodeLine{00793\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ Self,\ \textcolor{keyword}{typename}\ Op>}
\DoxyCodeLine{00794\ \textcolor{keyword}{struct\ }InnerReductionLauncher<Self,\ Op,\ \mbox{\hyperlink{namespaceEigen}{Eigen}}::half,\ false>\ \{}
\DoxyCodeLine{00795\ \ \ \textcolor{keyword}{static}\ \textcolor{keywordtype}{bool}\ run(\textcolor{keyword}{const}\ Self\&,\ Op\&,\ \textcolor{keyword}{const}\ GpuDevice\&,\ half*,\ \textcolor{keyword}{typename}\ Self::Index,\ \textcolor{keyword}{typename}\ Self::Index)\ \{}
\DoxyCodeLine{00796\ \ \ \ \ gpu\_assert(\textcolor{keyword}{false}\ \&\&\ \textcolor{stringliteral}{"{}Should\ not\ be\ called\ since\ there\ is\ no\ packet\ accessor"{}});}
\DoxyCodeLine{00797\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00798\ \ \ \}}
\DoxyCodeLine{00799\ \};}
\DoxyCodeLine{00800\ }
\DoxyCodeLine{00801\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ Self,\ \textcolor{keyword}{typename}\ Op>}
\DoxyCodeLine{00802\ \textcolor{keyword}{struct\ }InnerReductionLauncher<Self,\ Op,\ \mbox{\hyperlink{namespaceEigen}{Eigen}}::half,\ true>\ \{}
\DoxyCodeLine{00803\ \ \ \textcolor{keyword}{static}\ \textcolor{keywordtype}{bool}\ run(\textcolor{keyword}{const}\ Self\&\ self,\ Op\&\ reducer,\ \textcolor{keyword}{const}\ GpuDevice\&\ device,\ half*\ output,\ \textcolor{keyword}{typename}\ Self::Index\ num\_coeffs\_to\_reduce,\ \textcolor{keyword}{typename}\ Self::Index\ num\_preserved\_vals)\ \{}
\DoxyCodeLine{00804\ \ \ \ \ \textcolor{keyword}{typedef}\ \textcolor{keyword}{typename}\ Self::Index\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}};}
\DoxyCodeLine{00805\ }
\DoxyCodeLine{00806\ \ \ \ \ \textcolor{keywordflow}{if}\ (num\_preserved\_vals\ \%\ 2\ !=\ 0)\ \{}
\DoxyCodeLine{00807\ \ \ \ \ \ \ \textcolor{comment}{//\ Not\ supported\ yet,\ revert\ to\ the\ slower\ code\ path}}
\DoxyCodeLine{00808\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00809\ \ \ \ \ \}}
\DoxyCodeLine{00810\ }
\DoxyCodeLine{00811\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ num\_coeffs\ =\ num\_coeffs\_to\_reduce\ *\ num\_preserved\_vals;}
\DoxyCodeLine{00812\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ block\_size\ =\ \textcolor{comment}{/*256*/}128;}
\DoxyCodeLine{00813\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ num\_per\_thread\ =\ \textcolor{comment}{/*128*/}64;}
\DoxyCodeLine{00814\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ dyn\_blocks\ =\ divup<int>(num\_coeffs,\ block\_size\ *\ num\_per\_thread);}
\DoxyCodeLine{00815\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ max\_blocks\ =\ device.getNumGpuMultiProcessors()\ *}
\DoxyCodeLine{00816\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ device.maxGpuThreadsPerMultiProcessor()\ /\ block\_size;}
\DoxyCodeLine{00817\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ num\_blocks\ =\ numext::mini<int>(max\_blocks,\ dyn\_blocks);}
\DoxyCodeLine{00818\ }
\DoxyCodeLine{00819\ \ \ \ \ \textcolor{keywordflow}{if}\ (num\_blocks\ >\ 1)\ \{}
\DoxyCodeLine{00820\ \ \ \ \ \ \ \textcolor{comment}{//\ We\ initialize\ the\ outputs\ outside\ the\ reduction\ kernel\ when\ we\ can't\ be\ sure\ that\ there}}
\DoxyCodeLine{00821\ \ \ \ \ \ \ \textcolor{comment}{//\ won't\ be\ a\ race\ conditions\ between\ multiple\ thread\ blocks.}}
\DoxyCodeLine{00822\ \ \ \ \ \ \ LAUNCH\_GPU\_KERNEL((ReductionInitKernelHalfFloat<Self,\ Op,\ Index>),}
\DoxyCodeLine{00823\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 1,\ 1,\ 0,\ device,\ reducer,\ self,\ num\_preserved\_vals,\ output);}
\DoxyCodeLine{00824\ \ \ \ \ \}}
\DoxyCodeLine{00825\ }
\DoxyCodeLine{00826\ \ \ \ \ LAUNCH\_GPU\_KERNEL((InnerReductionKernelHalfFloat<num\_per\_thread,\ Self,\ Op,\ Index>),}
\DoxyCodeLine{00827\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ num\_blocks,\ block\_size,\ 0,\ device,\ reducer,\ self,\ num\_coeffs\_to\_reduce,\ num\_preserved\_vals,\ output);}
\DoxyCodeLine{00828\ }
\DoxyCodeLine{00829\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00830\ \ \ \}}
\DoxyCodeLine{00831\ \};}
\DoxyCodeLine{00832\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ EIGEN\_HAS\_GPU\_FP16}}
\DoxyCodeLine{00833\ }
\DoxyCodeLine{00834\ }
\DoxyCodeLine{00835\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ Self,\ \textcolor{keyword}{typename}\ Op>}
\DoxyCodeLine{00836\ \textcolor{keyword}{struct\ }InnerReducer<Self,\ Op,\ GpuDevice>\ \{}
\DoxyCodeLine{00837\ \ \ \textcolor{comment}{//\ Unfortunately\ nvidia\ doesn't\ support\ well\ exotic\ types\ such\ as\ complex,}}
\DoxyCodeLine{00838\ \ \ \textcolor{comment}{//\ so\ reduce\ the\ scope\ of\ the\ optimized\ version\ of\ the\ code\ to\ the\ simple\ case}}
\DoxyCodeLine{00839\ \ \ \textcolor{comment}{//\ of\ floats\ and\ half\ floats.}}
\DoxyCodeLine{00840\ \textcolor{preprocessor}{\#ifdef\ EIGEN\_HAS\_GPU\_FP16}}
\DoxyCodeLine{00841\ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{structEigen_1_1internal_1_1InnerReducer_aa157c28481202ce463fd531c4c12104c}{HasOptimizedImplementation}}\ =\ !Self::ReducerTraits::IsStateful\ \&\&}
\DoxyCodeLine{00842\ \ \ \ \ \ \ (\mbox{\hyperlink{structEigen_1_1internal_1_1is__same_a8fa0f921d1ad770160fe91916e363aaca5989163e8cfc8db2aa0f60d16e735921}{internal::is\_same<typename\ Self::CoeffReturnType,\ float>::value}}\ ||}
\DoxyCodeLine{00843\ \ \ \ \ \ \ \ \mbox{\hyperlink{structEigen_1_1internal_1_1is__same_a8fa0f921d1ad770160fe91916e363aaca5989163e8cfc8db2aa0f60d16e735921}{internal::is\_same<typename\ Self::CoeffReturnType,\ double>::value}}\ ||}
\DoxyCodeLine{00844\ \ \ \ \ \ \ \ (\mbox{\hyperlink{structEigen_1_1internal_1_1is__same_a8fa0f921d1ad770160fe91916e363aaca5989163e8cfc8db2aa0f60d16e735921}{internal::is\_same<typename\ Self::CoeffReturnType,\ Eigen::half>::value}}\ \&\&\ \mbox{\hyperlink{structEigen_1_1internal_1_1reducer__traits_abea8163d6b25b5f6470c936ea213dc43a182285e009d3b4550f2f97bdd19261d6}{reducer\_traits<Op,\ GpuDevice>::PacketAccess}}));}
\DoxyCodeLine{00845\ \textcolor{preprocessor}{\#else\ }\textcolor{comment}{//\ EIGEN\_HAS\_GPU\_FP16}}
\DoxyCodeLine{00846\ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{structEigen_1_1internal_1_1InnerReducer_aa157c28481202ce463fd531c4c12104c}{HasOptimizedImplementation}}\ =\ !Self::ReducerTraits::IsStateful\ \&\&}
\DoxyCodeLine{00847\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ (\mbox{\hyperlink{structEigen_1_1internal_1_1is__same_a8fa0f921d1ad770160fe91916e363aaca5989163e8cfc8db2aa0f60d16e735921}{internal::is\_same<typename\ Self::CoeffReturnType,\ float>::value}}\ ||}
\DoxyCodeLine{00848\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structEigen_1_1internal_1_1is__same_a8fa0f921d1ad770160fe91916e363aaca5989163e8cfc8db2aa0f60d16e735921}{internal::is\_same<typename\ Self::CoeffReturnType,\ double>::value}});}
\DoxyCodeLine{00849\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ EIGEN\_HAS\_GPU\_FP16}}
\DoxyCodeLine{00850\ }
\DoxyCodeLine{00851\ \ \ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ OutputType>}
\DoxyCodeLine{00852\ \ \ \textcolor{keyword}{static}\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{structEigen_1_1internal_1_1InnerReducer_ab0f80bf14245c83efc5e5616f2775a7e}{run}}(\textcolor{keyword}{const}\ Self\&\ self,\ Op\&\ reducer,\ \textcolor{keyword}{const}\ GpuDevice\&\ device,\ OutputType*\ output,\ \textcolor{keyword}{typename}\ Self::Index\ num\_coeffs\_to\_reduce,\ \textcolor{keyword}{typename}\ Self::Index\ num\_preserved\_vals)\ \{}
\DoxyCodeLine{00853\ \ \ \ \ gpu\_assert(\mbox{\hyperlink{structEigen_1_1internal_1_1InnerReducer_aa157c28481202ce463fd531c4c12104c}{HasOptimizedImplementation}}\ \&\&\ \textcolor{stringliteral}{"{}Should\ only\ be\ called\ on\ doubles,\ floats\ or\ half\ floats"{}});}
\DoxyCodeLine{00854\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ num\_coeffs\ =\ \mbox{\hyperlink{namespaceEigen_1_1internal_a3b99e338d92a91c8b3f89d32d0ca2c39}{array\_prod}}(self.m\_impl.dimensions());}
\DoxyCodeLine{00855\ \ \ \ \ \textcolor{comment}{//\ Don't\ crash\ when\ we're\ called\ with\ an\ input\ tensor\ of\ size\ 0.}}
\DoxyCodeLine{00856\ \ \ \ \ \textcolor{keywordflow}{if}\ (num\_coeffs\ ==\ 0)\ \{}
\DoxyCodeLine{00857\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00858\ \ \ \ \ \}}
\DoxyCodeLine{00859\ \ \ \ \ \textcolor{comment}{//\ It's\ faster\ to\ use\ the\ usual\ code.}}
\DoxyCodeLine{00860\ \ \ \ \ \textcolor{keywordflow}{if}\ (num\_coeffs\_to\_reduce\ <=\ 128)\ \{}
\DoxyCodeLine{00861\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00862\ \ \ \ \ \}}
\DoxyCodeLine{00863\ }
\DoxyCodeLine{00864\ \ \ \ \ \textcolor{keywordflow}{return}\ InnerReductionLauncher<Self,\ Op,\ OutputType,\ reducer\_traits<Op,\ GpuDevice>::PacketAccess>\mbox{\hyperlink{structEigen_1_1internal_1_1InnerReducer_ab0f80bf14245c83efc5e5616f2775a7e}{::run}}(self,\ reducer,\ device,\ output,\ num\_coeffs\_to\_reduce,\ num\_preserved\_vals);}
\DoxyCodeLine{00865\ \ \ \}}
\DoxyCodeLine{00866\ \};}
\DoxyCodeLine{00867\ }
\DoxyCodeLine{00868\ \textcolor{keyword}{template}\ <\textcolor{keywordtype}{int}\ NumPerThread,\ \textcolor{keyword}{typename}\ Self,}
\DoxyCodeLine{00869\ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{typename}\ Reducer,\ \textcolor{keyword}{typename}\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}>}
\DoxyCodeLine{00870\ \_\_global\_\_\ \mbox{\hyperlink{Macros_8h_ab7c87492b7a80ed45d2e0377b40cdee5}{EIGEN\_HIP\_LAUNCH\_BOUNDS\_1024}}\ \textcolor{keywordtype}{void}\ OuterReductionKernel(Reducer\ reducer,\ \textcolor{keyword}{const}\ Self\ input,\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ num\_coeffs\_to\_reduce,\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ num\_preserved\_coeffs,}
\DoxyCodeLine{00871\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{typename}\ Self::CoeffReturnType*\ output)\ \{}
\DoxyCodeLine{00872\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ num\_threads\ =\ blockDim.x\ *\ gridDim.x;}
\DoxyCodeLine{00873\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ thread\_id\ =\ blockIdx.x\ *\ blockDim.x\ +\ threadIdx.x;}
\DoxyCodeLine{00874\ \ \ \textcolor{comment}{//\ Initialize\ the\ output\ values\ if\ they\ weren't\ initialized\ by\ the\ ReductionInitKernel}}
\DoxyCodeLine{00875\ \ \ \textcolor{keywordflow}{if}\ (gridDim.x\ ==\ 1)\ \{}
\DoxyCodeLine{00876\ \ \ \ \ \textcolor{keywordflow}{for}\ (\mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ =\ thread\_id;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ <\ num\_preserved\_coeffs;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ +=\ num\_threads)\ \{}
\DoxyCodeLine{00877\ \ \ \ \ \ \ output[\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}]\ =\ reducer.initialize();}
\DoxyCodeLine{00878\ \ \ \ \ \}}
\DoxyCodeLine{00879\ \ \ \ \ \_\_syncthreads();}
\DoxyCodeLine{00880\ \ \ \}}
\DoxyCodeLine{00881\ }
\DoxyCodeLine{00882\ \ \ \textcolor{comment}{//\ Do\ the\ reduction.}}
\DoxyCodeLine{00883\ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ max\_iter\ =\ num\_preserved\_coeffs\ *\ \mbox{\hyperlink{namespaceEigen_a13ec9832931270b80961236d30f6d2e3}{divup<Index>}}(num\_coeffs\_to\_reduce,\ NumPerThread);}
\DoxyCodeLine{00884\ \ \ \textcolor{keywordflow}{for}\ (\mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ =\ thread\_id;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ <\ max\_iter;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ +=\ num\_threads)\ \{}
\DoxyCodeLine{00885\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ input\_col\ =\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ \%\ num\_preserved\_coeffs;}
\DoxyCodeLine{00886\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ input\_row\ =\ (\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ /\ num\_preserved\_coeffs)\ *\ NumPerThread;}
\DoxyCodeLine{00887\ \ \ \ \ \textcolor{keyword}{typename}\ Self::CoeffReturnType\ reduced\_val\ =\ reducer.initialize();}
\DoxyCodeLine{00888\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ max\_row\ =\ \mbox{\hyperlink{namespaceEigen_1_1numext_ab3b30bf0bcfa1ad91dbec75fabb3bea0}{numext::mini}}(input\_row\ +\ NumPerThread,\ num\_coeffs\_to\_reduce);}
\DoxyCodeLine{00889\ \ \ \ \ \textcolor{keywordflow}{for}\ (\mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ j\ =\ input\_row;\ \mbox{\hyperlink{namespaceabsl_adb6bd4a9012b471ac01613aff8d4d81ba363b122c528f54df4a0446b6bab05515}{j}}\ <\ max\_row;\ \mbox{\hyperlink{namespaceabsl_adb6bd4a9012b471ac01613aff8d4d81ba363b122c528f54df4a0446b6bab05515}{j}}++)\ \{}
\DoxyCodeLine{00890\ \ \ \ \ \ \ \textcolor{keyword}{typename}\ Self::CoeffReturnType\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2raw__hash__set__test_8cc_aa0ccb5ee6d882ee3605ff47745c6467b}{val}}\ =\ input.m\_impl.coeff(j\ *\ num\_preserved\_coeffs\ +\ input\_col);}
\DoxyCodeLine{00891\ \ \ \ \ \ \ reducer.reduce(\mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2raw__hash__set__test_8cc_aa0ccb5ee6d882ee3605ff47745c6467b}{val}},\ \&reduced\_val);}
\DoxyCodeLine{00892\ \ \ \ \ \}}
\DoxyCodeLine{00893\ \ \ \ \ atomicReduce(\&(output[input\_col]),\ reduced\_val,\ reducer);}
\DoxyCodeLine{00894\ \ \ \}}
\DoxyCodeLine{00895\ \}}
\DoxyCodeLine{00896\ }
\DoxyCodeLine{00897\ }
\DoxyCodeLine{00898\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ Self,\ \textcolor{keyword}{typename}\ Op>}
\DoxyCodeLine{00899\ \textcolor{keyword}{struct\ }OuterReducer<Self,\ Op,\ GpuDevice>\ \{}
\DoxyCodeLine{00900\ \ \ \textcolor{comment}{//\ Unfortunately\ nvidia\ doesn't\ support\ well\ exotic\ types\ such\ as\ complex,}}
\DoxyCodeLine{00901\ \ \ \textcolor{comment}{//\ so\ reduce\ the\ scope\ of\ the\ optimized\ version\ of\ the\ code\ to\ the\ simple\ case}}
\DoxyCodeLine{00902\ \ \ \textcolor{comment}{//\ of\ floats.}}
\DoxyCodeLine{00903\ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{structEigen_1_1internal_1_1OuterReducer_a6fab6aeec440dc8dfb1e274334ffcea4}{HasOptimizedImplementation}}\ =\ !Self::ReducerTraits::IsStateful\ \&\&}
\DoxyCodeLine{00904\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ (\mbox{\hyperlink{structEigen_1_1internal_1_1is__same_a8fa0f921d1ad770160fe91916e363aaca5989163e8cfc8db2aa0f60d16e735921}{internal::is\_same<typename\ Self::CoeffReturnType,\ float>::value}}\ ||}
\DoxyCodeLine{00905\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structEigen_1_1internal_1_1is__same_a8fa0f921d1ad770160fe91916e363aaca5989163e8cfc8db2aa0f60d16e735921}{internal::is\_same<typename\ Self::CoeffReturnType,\ double>::value}});}
\DoxyCodeLine{00906\ \ \ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ Device,\ \textcolor{keyword}{typename}\ OutputType>}
\DoxyCodeLine{00907\ \ \ \textcolor{keyword}{static}}
\DoxyCodeLine{00908\ \textcolor{preprocessor}{\ \ \ \ \#if\ !defined(EIGEN\_HIPCC)}}
\DoxyCodeLine{00909\ \ \ \ \ \textcolor{comment}{//\ FIXME\ :\ \ leaving\ this\ EIGEN\_DEVICE\_FUNC\ in,\ results\ in\ the\ following\ runtime\ error}}
\DoxyCodeLine{00910\ \ \ \ \ \textcolor{comment}{//\ \ \ \ \ \ \ \ \ \ (in\ the\ cxx11\_tensor\_reduction\_gpu\ test)}}
\DoxyCodeLine{00911\ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00912\ \ \ \ \ \textcolor{comment}{//\ terminate\ called\ after\ throwing\ an\ instance\ of\ 'std::runtime\_error'}}
\DoxyCodeLine{00913\ \ \ \ \ \textcolor{comment}{//\ \ \ what():\ \ No\ device\ code\ available\ for\ function:\ \_ZN5Eigen8internal20OuterReductionKernelIL...}}
\DoxyCodeLine{00914\ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00915\ \ \ \ \ \textcolor{comment}{//\ don't\ know\ why\ this\ happens\ (and\ why\ is\ it\ a\ runtime\ error\ instead\ of\ a\ compile\ time\ error)}}
\DoxyCodeLine{00916\ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00917\ \ \ \ \ \textcolor{comment}{//\ this\ will\ be\ fixed\ by\ HIP\ PR\#457}}
\DoxyCodeLine{00918\ \ \ \ \ \mbox{\hyperlink{Macros_8h_a9efec3cfd22b9a33bead9c6718d128da}{EIGEN\_DEVICE\_FUNC}}}
\DoxyCodeLine{00919\ \textcolor{preprocessor}{\ \ \ \ \#endif}}
\DoxyCodeLine{00920\ \ \ \ \ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{structEigen_1_1internal_1_1OuterReducer_a8136f58f94804c6134d1c4162c61820d}{run}}(\textcolor{keyword}{const}\ Self\&,\ Op\&,\ \textcolor{keyword}{const}\ Device\&,\ OutputType*,\ \textcolor{keyword}{typename}\ Self::Index,\ \textcolor{keyword}{typename}\ Self::Index)\ \{}
\DoxyCodeLine{00921\ \ \ \ \ gpu\_assert(\textcolor{keyword}{false}\ \&\&\ \textcolor{stringliteral}{"{}Should\ only\ be\ called\ to\ reduce\ doubles\ or\ floats\ on\ a\ gpu\ device"{}});}
\DoxyCodeLine{00922\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00923\ \ \ \}}
\DoxyCodeLine{00924\ }
\DoxyCodeLine{00925\ \ \ \textcolor{keyword}{static}\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{structEigen_1_1internal_1_1OuterReducer_a8136f58f94804c6134d1c4162c61820d}{run}}(\textcolor{keyword}{const}\ Self\&\ self,\ Op\&\ reducer,\ \textcolor{keyword}{const}\ GpuDevice\&\ device,\ \textcolor{keywordtype}{float}*\ output,\ \textcolor{keyword}{typename}\ Self::Index\ num\_coeffs\_to\_reduce,\ \textcolor{keyword}{typename}\ Self::Index\ num\_preserved\_vals)\ \{}
\DoxyCodeLine{00926\ \ \ \ \ \textcolor{keyword}{typedef}\ \textcolor{keyword}{typename}\ Self::Index\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}};}
\DoxyCodeLine{00927\ }
\DoxyCodeLine{00928\ \ \ \ \ \textcolor{comment}{//\ It's\ faster\ to\ use\ the\ usual\ code.}}
\DoxyCodeLine{00929\ \ \ \ \ \textcolor{keywordflow}{if}\ (num\_coeffs\_to\_reduce\ <=\ 32)\ \{}
\DoxyCodeLine{00930\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{00931\ \ \ \ \ \}}
\DoxyCodeLine{00932\ }
\DoxyCodeLine{00933\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{namespaceEigen_a62e77e0933482dafde8fe197d9a2cfde}{Index}}\ num\_coeffs\ =\ num\_coeffs\_to\_reduce\ *\ num\_preserved\_vals;}
\DoxyCodeLine{00934\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ block\_size\ =\ 256;}
\DoxyCodeLine{00935\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ num\_per\_thread\ =\ 16;}
\DoxyCodeLine{00936\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ dyn\_blocks\ =\ \mbox{\hyperlink{namespaceEigen_a13ec9832931270b80961236d30f6d2e3}{divup<int>}}(num\_coeffs,\ block\_size\ *\ num\_per\_thread);}
\DoxyCodeLine{00937\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ max\_blocks\ =\ device.getNumGpuMultiProcessors()\ *}
\DoxyCodeLine{00938\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ device.maxGpuThreadsPerMultiProcessor()\ /\ block\_size;}
\DoxyCodeLine{00939\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ num\_blocks\ =\ \mbox{\hyperlink{namespaceEigen_1_1numext_ab3b30bf0bcfa1ad91dbec75fabb3bea0}{numext::mini<int>}}(max\_blocks,\ dyn\_blocks);}
\DoxyCodeLine{00940\ }
\DoxyCodeLine{00941\ \ \ \ \ \textcolor{keywordflow}{if}\ (num\_blocks\ >\ 1)\ \{}
\DoxyCodeLine{00942\ \ \ \ \ \ \ \textcolor{comment}{//\ We\ initialize\ the\ outputs\ in\ the\ reduction\ kernel\ itself\ when\ we\ don't\ have\ to\ worry}}
\DoxyCodeLine{00943\ \ \ \ \ \ \ \textcolor{comment}{//\ about\ race\ conditions\ between\ multiple\ thread\ blocks.}}
\DoxyCodeLine{00944\ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ dyn\_blocks\ =\ \mbox{\hyperlink{namespaceEigen_a13ec9832931270b80961236d30f6d2e3}{divup<int>}}(num\_preserved\_vals,\ 1024);}
\DoxyCodeLine{00945\ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ max\_blocks\ =\ device.getNumGpuMultiProcessors()\ *}
\DoxyCodeLine{00946\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ device.maxGpuThreadsPerMultiProcessor()\ /\ 1024;}
\DoxyCodeLine{00947\ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ num\_blocks\ =\ \mbox{\hyperlink{namespaceEigen_1_1numext_ab3b30bf0bcfa1ad91dbec75fabb3bea0}{numext::mini<int>}}(max\_blocks,\ dyn\_blocks);}
\DoxyCodeLine{00948\ \ \ \ \ \ \ LAUNCH\_GPU\_KERNEL((ReductionInitKernel<float,\ Index>),}
\DoxyCodeLine{00949\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ num\_blocks,\ 1024,\ 0,\ device,\ reducer.initialize(),}
\DoxyCodeLine{00950\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ num\_preserved\_vals,\ output);}
\DoxyCodeLine{00951\ \ \ \ \ \}}
\DoxyCodeLine{00952\ }
\DoxyCodeLine{00953\ \ \ \ \ LAUNCH\_GPU\_KERNEL((OuterReductionKernel<num\_per\_thread,\ Self,\ Op,\ Index>),}
\DoxyCodeLine{00954\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ num\_blocks,\ block\_size,\ 0,\ device,\ reducer,\ self,\ num\_coeffs\_to\_reduce,\ num\_preserved\_vals,\ output);}
\DoxyCodeLine{00955\ }
\DoxyCodeLine{00956\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00957\ \ \ \}}
\DoxyCodeLine{00958\ \};}
\DoxyCodeLine{00959\ }
\DoxyCodeLine{00960\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ defined(EIGEN\_USE\_GPU)\ \&\&\ defined(EIGEN\_GPUCC)}}
\DoxyCodeLine{00961\ }
\DoxyCodeLine{00962\ }
\DoxyCodeLine{00963\ \}\ \textcolor{comment}{//\ end\ namespace\ internal}}
\DoxyCodeLine{00964\ \}\ \textcolor{comment}{//\ end\ namespace\ Eigen}}
\DoxyCodeLine{00965\ }
\DoxyCodeLine{00966\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ EIGEN\_CXX11\_TENSOR\_TENSOR\_REDUCTION\_GPU\_H}}

\end{DoxyCode}
