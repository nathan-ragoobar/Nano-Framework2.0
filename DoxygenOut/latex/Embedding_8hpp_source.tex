\doxysection{Embedding.\+hpp}
\hypertarget{Embedding_8hpp_source}{}\label{Embedding_8hpp_source}\index{nn/Embedding.hpp@{nn/Embedding.hpp}}
\mbox{\hyperlink{Embedding_8hpp}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{preprocessor}{\#ifndef\ LLM\_CPP\_\_EMBEDDING\_HPP\_}}
\DoxyCodeLine{00002\ \textcolor{preprocessor}{\#define\ LLM\_CPP\_\_EMBEDDING\_HPP\_}}
\DoxyCodeLine{00003\ }
\DoxyCodeLine{00004\ \textcolor{preprocessor}{\#include\ <memory>}}
\DoxyCodeLine{00005\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{tensor_2tensor__util_8hpp}{tensor/tensor\_util.hpp}}"{}}}
\DoxyCodeLine{00006\ \textcolor{preprocessor}{\#include\ "{}absl/log/check.h"{}}}
\DoxyCodeLine{00007\ \textcolor{preprocessor}{\#include\ "{}absl/types/span.h"{}}}
\DoxyCodeLine{00008\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{Parameter_8hpp}{Parameter.hpp}}"{}}}
\DoxyCodeLine{00009\ }
\DoxyCodeLine{00010\ }
\DoxyCodeLine{00011\ \textcolor{keyword}{namespace\ }\mbox{\hyperlink{namespacenn}{nn}}\ \{}
\DoxyCodeLine{00012\ }
\DoxyCodeLine{00013\ \textcolor{keyword}{struct\ }\mbox{\hyperlink{structnn_1_1Embedding}{Embedding}}\ \{}
\DoxyCodeLine{00014\ \ \ \mbox{\hyperlink{structnn_1_1Embedding_a63bb11f840116115c042f99771853944}{Embedding}}(\textcolor{keywordtype}{int}\ num\_embeddings,\ \textcolor{keywordtype}{int}\ embedding\_dim)}
\DoxyCodeLine{00015\ \ \ \ \ \ \ :\ \mbox{\hyperlink{structnn_1_1Embedding_a9aa76d7d0487450a2ca01c185b0375c1}{num\_embeddings\_}}(num\_embeddings),\ \mbox{\hyperlink{structnn_1_1Embedding_a20ec286e805f73e6c796263abc4cbd6e}{embedding\_dim\_}}(embedding\_dim)\ \{}
\DoxyCodeLine{00016\ \ \ \ \ \mbox{\hyperlink{structnn_1_1Embedding_a0e3855fe03f02d5bf6cd047fe476258a}{weight\_}}\ =}
\DoxyCodeLine{00017\ \ \ \ \ \ \ \ \ std::make\_unique<Parameter>(\mbox{\hyperlink{namespacenn_afadc7a301a4a916a264a59541a7cbfcfa619d8e532169cd16e25ef103f28e3213}{DT\_FLOAT}},\ num\_embeddings\ *\ embedding\_dim);}
\DoxyCodeLine{00018\ \ \ \ \ \mbox{\hyperlink{namespacenn_a7a0bfd75fc17c62ba9e681cd3d346efc}{NormalFill}}(\mbox{\hyperlink{structnn_1_1Embedding_a0e3855fe03f02d5bf6cd047fe476258a}{weight\_}}-\/>span<\textcolor{keywordtype}{float}>());}
\DoxyCodeLine{00019\ \ \ \}}
\DoxyCodeLine{00020\ }
\DoxyCodeLine{00021\ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{structnn_1_1Embedding_ae46671667b089b91f58428338b7097a4}{Forward}}(\mbox{\hyperlink{classabsl_1_1Span}{absl::Span<const\ int>}}\ idx,\ \mbox{\hyperlink{classabsl_1_1Span}{absl::Span<float>}}\ embedding)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00022\ \ \ \ \ \mbox{\hyperlink{abseil-cpp_2absl_2log_2check_8h_a7c0ce053b28d53aa4eaf3eb7fb71663b}{CHECK\_EQ}}(embedding.\mbox{\hyperlink{classabsl_1_1Span_a92186c247036e10dd12603c09f8b8797}{size}}(),\ idx.\mbox{\hyperlink{classabsl_1_1Span_a92186c247036e10dd12603c09f8b8797}{size}}()\ *\ \mbox{\hyperlink{structnn_1_1Embedding_a20ec286e805f73e6c796263abc4cbd6e}{embedding\_dim\_}});}
\DoxyCodeLine{00023\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ =\ 0;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ <\ idx.\mbox{\hyperlink{classabsl_1_1Span_a92186c247036e10dd12603c09f8b8797}{size}}();\ ++\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}})\ \{}
\DoxyCodeLine{00024\ \ \ \ \ \ \ \mbox{\hyperlink{abseil-cpp_2absl_2log_2check_8h_a4bd2e815ca2f702a4b6aa744b1ff3b82}{CHECK\_LT}}(idx[\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}],\ \mbox{\hyperlink{structnn_1_1Embedding_a9aa76d7d0487450a2ca01c185b0375c1}{num\_embeddings\_}});}
\DoxyCodeLine{00025\ \ \ \ \ \ \ \textcolor{keywordtype}{void}*\ dst\ =\ embedding.\mbox{\hyperlink{classabsl_1_1Span_ab73e4be6262f844714eb7c48225b605b}{data}}()\ +\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ *\ \mbox{\hyperlink{structnn_1_1Embedding_a20ec286e805f73e6c796263abc4cbd6e}{embedding\_dim\_}};}
\DoxyCodeLine{00026\ \ \ \ \ \ \ \textcolor{keywordtype}{void}*\ src\ =\ \mbox{\hyperlink{structnn_1_1Embedding_a0e3855fe03f02d5bf6cd047fe476258a}{weight\_}}-\/>data<\textcolor{keywordtype}{float}>()\ +\ idx[\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}]\ *\ \mbox{\hyperlink{structnn_1_1Embedding_a20ec286e805f73e6c796263abc4cbd6e}{embedding\_dim\_}};}
\DoxyCodeLine{00027\ \ \ \ \ \ \ g\_device.memcpy(dst,\ src,\ \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{float})\ *\ \mbox{\hyperlink{structnn_1_1Embedding_a20ec286e805f73e6c796263abc4cbd6e}{embedding\_dim\_}});}
\DoxyCodeLine{00028\ \ \ \ \ \}}
\DoxyCodeLine{00029\ \ \ \}}
\DoxyCodeLine{00030\ }
\DoxyCodeLine{00031\ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{structnn_1_1Embedding_a427a7f4f7e77b6904e6fa19b373ebc34}{Backward}}(\mbox{\hyperlink{classabsl_1_1Span}{absl::Span<const\ int>}}\ idx,}
\DoxyCodeLine{00032\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classabsl_1_1Span}{absl::Span<const\ float>}}\ grad\_embedding)\ \{}
\DoxyCodeLine{00033\ \ \ \ \ \mbox{\hyperlink{abseil-cpp_2absl_2log_2check_8h_a7c0ce053b28d53aa4eaf3eb7fb71663b}{CHECK\_EQ}}(grad\_embedding.\mbox{\hyperlink{classabsl_1_1Span_a92186c247036e10dd12603c09f8b8797}{size}}(),\ idx.\mbox{\hyperlink{classabsl_1_1Span_a92186c247036e10dd12603c09f8b8797}{size}}()\ *\ \mbox{\hyperlink{structnn_1_1Embedding_a20ec286e805f73e6c796263abc4cbd6e}{embedding\_dim\_}});}
\DoxyCodeLine{00034\ }
\DoxyCodeLine{00035\ \ \ \ \ \textcolor{comment}{//\ Lazily\ allocate\ the\ memory\ for\ gradients}}
\DoxyCodeLine{00036\ \ \ \ \ \mbox{\hyperlink{structnn_1_1Embedding_a0e3855fe03f02d5bf6cd047fe476258a}{weight\_}}-\/>LazyAllocateGradient();}
\DoxyCodeLine{00037\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ =\ 0;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ <\ idx.\mbox{\hyperlink{classabsl_1_1Span_a92186c247036e10dd12603c09f8b8797}{size}}();\ ++\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}})\ \{}
\DoxyCodeLine{00038\ \ \ \ \ \ \ \mbox{\hyperlink{abseil-cpp_2absl_2log_2check_8h_a4bd2e815ca2f702a4b6aa744b1ff3b82}{CHECK\_LT}}(idx[\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}],\ \mbox{\hyperlink{structnn_1_1Embedding_a9aa76d7d0487450a2ca01c185b0375c1}{num\_embeddings\_}});}
\DoxyCodeLine{00039\ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{float}*\ g\ =\ grad\_embedding.\mbox{\hyperlink{classabsl_1_1Span_ab73e4be6262f844714eb7c48225b605b}{data}}()\ +\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ *\ \mbox{\hyperlink{structnn_1_1Embedding_a20ec286e805f73e6c796263abc4cbd6e}{embedding\_dim\_}};}
\DoxyCodeLine{00040\ \ \ \ \ \ \ \textcolor{keywordtype}{float}*\ grad\ =\ \mbox{\hyperlink{structnn_1_1Embedding_a0e3855fe03f02d5bf6cd047fe476258a}{weight\_}}-\/>grad<\textcolor{keywordtype}{float}>()\ +\ idx[\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}]\ *\ \mbox{\hyperlink{structnn_1_1Embedding_a20ec286e805f73e6c796263abc4cbd6e}{embedding\_dim\_}};}
\DoxyCodeLine{00041\ \ \ \ \ \ \ \textcolor{keyword}{auto}\ g\_1d\ =\ \mbox{\hyperlink{structTTypes_aa53f19202b54ddd0fe543e2e7f771caf}{TTypes<float>::UnalignedConstFlat}}(g,\ \mbox{\hyperlink{structnn_1_1Embedding_a20ec286e805f73e6c796263abc4cbd6e}{embedding\_dim\_}});}
\DoxyCodeLine{00042\ \ \ \ \ \ \ \textcolor{keyword}{auto}\ grad\_1d\ =\ \mbox{\hyperlink{structTTypes_aea634ba279401433e58c5e59b008cf36}{TTypes<float>::UnalignedFlat}}(grad,\ \mbox{\hyperlink{structnn_1_1Embedding_a20ec286e805f73e6c796263abc4cbd6e}{embedding\_dim\_}});}
\DoxyCodeLine{00043\ \ \ \ \ \ \ grad\_1d.device(g\_device)\ +=\ g\_1d;}
\DoxyCodeLine{00044\ \ \ \ \ \}}
\DoxyCodeLine{00045\ \ \ \}}
\DoxyCodeLine{00046\ }
\DoxyCodeLine{00047\ \ \ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{structnn_1_1Embedding_a17a1666754ba09e03c9073abc89e27e8}{NumParameters}}()\textcolor{keyword}{\ const\ }\{\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{structnn_1_1Embedding_a9aa76d7d0487450a2ca01c185b0375c1}{num\_embeddings\_}}\ *\ \mbox{\hyperlink{structnn_1_1Embedding_a20ec286e805f73e6c796263abc4cbd6e}{embedding\_dim\_}};\ \}}
\DoxyCodeLine{00048\ }
\DoxyCodeLine{00049\ \ \ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{structnn_1_1Embedding_a0836507be6dea19c0289e580e2fb8973}{NumActivations}}()\textcolor{keyword}{\ const\ }\{\ \textcolor{keywordflow}{return}\ 0;\ \}}
\DoxyCodeLine{00050\ }
\DoxyCodeLine{00051\ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{structnn_1_1Embedding_a8669a3a9dadd00830d3d1d0b48a37789}{Parameters}}(std::vector<Parameter*>*\ parameters)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00052\ \ \ \ \ parameters-\/>push\_back(\mbox{\hyperlink{structnn_1_1Embedding_a0e3855fe03f02d5bf6cd047fe476258a}{weight\_}}.get());}
\DoxyCodeLine{00053\ \ \ \}}
\DoxyCodeLine{00054\ }
\DoxyCodeLine{00055\ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{structnn_1_1Embedding_a9aa76d7d0487450a2ca01c185b0375c1}{num\_embeddings\_}};}
\DoxyCodeLine{00056\ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{structnn_1_1Embedding_a20ec286e805f73e6c796263abc4cbd6e}{embedding\_dim\_}};}
\DoxyCodeLine{00057\ \ \ std::unique\_ptr<Parameter>\ \mbox{\hyperlink{structnn_1_1Embedding_a0e3855fe03f02d5bf6cd047fe476258a}{weight\_}};}
\DoxyCodeLine{00058\ \};}
\DoxyCodeLine{00059\ }
\DoxyCodeLine{00060\ \}\ \ \textcolor{comment}{//\ namespace\ nn}}
\DoxyCodeLine{00061\ }
\DoxyCodeLine{00062\ \textcolor{preprocessor}{\#endif\ \ }\textcolor{comment}{//\ LLM\_CPP\_\_NN\_HPP\_}}

\end{DoxyCode}
