\doxysection{gpt.\+hpp}
\hypertarget{nn_2gpt_8hpp_source}{}\label{nn_2gpt_8hpp_source}\index{nn/gpt.hpp@{nn/gpt.hpp}}
\mbox{\hyperlink{nn_2gpt_8hpp}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{preprocessor}{\#ifndef\ LLM\_CPP\_\_GPT\_HPP\_}}
\DoxyCodeLine{00002\ \textcolor{preprocessor}{\#define\ LLM\_CPP\_\_GPT\_HPP\_}}
\DoxyCodeLine{00003\ }
\DoxyCodeLine{00004\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{nn_2nn_8hpp}{nn.hpp}}"{}}}
\DoxyCodeLine{00005\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{MLP_8hpp}{MLP.hpp}}"{}}}
\DoxyCodeLine{00006\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{AttentionLayer_8hpp}{AttentionLayer.hpp}}"{}}}
\DoxyCodeLine{00007\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{Block_8hpp}{Block.hpp}}"{}}}
\DoxyCodeLine{00008\ }
\DoxyCodeLine{00009\ \textcolor{preprocessor}{\#ifdef\ EIGEN\_USE\_GPU}}
\DoxyCodeLine{00010\ \textcolor{preprocessor}{\#include\ "{}cuda\_profile\_util.hpp"{}}}
\DoxyCodeLine{00011\ \textcolor{preprocessor}{\#define\ PROFILE\_TRACE\_FN(prefix)\ NVTX\_RANGE\_FN(prefix)}}
\DoxyCodeLine{00012\ \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{00013\ \textcolor{preprocessor}{\#define\ PROFILE\_TRACE\_FN(prefix)}}
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00015\ }
\DoxyCodeLine{00016\ \textcolor{keyword}{namespace\ }\mbox{\hyperlink{namespacegpt}{gpt}}\ \{}
\DoxyCodeLine{00017\ }
\DoxyCodeLine{00018\ }
\DoxyCodeLine{00019\ }
\DoxyCodeLine{00020\ \textcolor{keyword}{struct\ }GPT\ \{}
\DoxyCodeLine{00021\ \ \ \textcolor{keyword}{using\ }\mbox{\hyperlink{structgpt_1_1GPT_aa06480989b06f1e40879f71d80eac146}{Type}}\ =\ \mbox{\hyperlink{dev_2cuda_2common_8h_a73bc90d2e378d172e206b528b3756c5a}{floatX}};}
\DoxyCodeLine{00022\ }
\DoxyCodeLine{00023\ \ \ \mbox{\hyperlink{structgpt_1_1GPT_ae7a053667800ff5c79cce1be6f8726b4}{GPT}}(\textcolor{keywordtype}{int}\ block\_size,\ \textcolor{keywordtype}{int}\ vocab\_size,\ \textcolor{keywordtype}{int}\ padded\_vocab\_size,\ \textcolor{keywordtype}{int}\ n\_layer,}
\DoxyCodeLine{00024\ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ n\_head,\ \textcolor{keywordtype}{int}\ n\_embed)}
\DoxyCodeLine{00025\ \ \ \ \ \ \ :\ \mbox{\hyperlink{structgpt_1_1GPT_aedaded26c34b9bc6ab7f81f82e42dee3}{block\_size\_}}(block\_size),}
\DoxyCodeLine{00026\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_a20f9d20710e9eb109d7697c43ea2972d}{vocab\_size\_}}(vocab\_size),}
\DoxyCodeLine{00027\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_ab6320386d6a92b9d0079f161f2c49c60}{padded\_vocab\_size\_}}(padded\_vocab\_size),}
\DoxyCodeLine{00028\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_a45a132e3d5c28a298d366b89afa2c48a}{n\_layer\_}}(n\_layer),}
\DoxyCodeLine{00029\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_aa0a22ab376126262bccf08316eb076a9}{n\_head\_}}(n\_head),}
\DoxyCodeLine{00030\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_a22dd2badb6ffdd821ff993dda16977e8}{n\_embed\_}}(n\_embed),}
\DoxyCodeLine{00031\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_a4fd542d25a63acde00f760b56d8904a0}{lm\_head\_}}(nullptr),}
\DoxyCodeLine{00032\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_a18157e410bed91a149243fea18be4ad7}{lm\_head\_grad\_}}(nullptr)\ \{}
\DoxyCodeLine{00033\ \ \ \ \ \mbox{\hyperlink{abseil-cpp_2absl_2log_2check_8h_a7e03ec13560fa94a8fea569960d7efc6}{CHECK\_GT}}(n\_layer,\ 0);}
\DoxyCodeLine{00034\ }
\DoxyCodeLine{00035\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_a1d33d297064a0067cf649803aad7d554}{wte\_}}\ =\ std::make\_unique<nn::Embedding>(padded\_vocab\_size,\ n\_embed);}
\DoxyCodeLine{00036\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_a81b3dd21d79017024bb0ee078d40e2de}{wpe\_}}\ =\ std::make\_unique<nn::Embedding>(block\_size,\ n\_embed);}
\DoxyCodeLine{00037\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ =\ 0;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ <\ n\_layer;\ ++\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}})\ \{}
\DoxyCodeLine{00038\ \ \ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_a3843d239a6a2fe0e12a5ff507ca05634}{h\_}}.emplace\_back(std::make\_unique<Block>(block\_size,\ n\_head,\ n\_embed));}
\DoxyCodeLine{00039\ \ \ \ \ \}}
\DoxyCodeLine{00040\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_af8622f274fd219c42682c4206bd4604f}{lnf\_}}\ =\ std::make\_unique<nn::LayerNorm>(n\_embed);}
\DoxyCodeLine{00041\ }
\DoxyCodeLine{00042\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_ab46fc21fad97de05f7c1a2446e64aac6}{lm\_head\_unused\_}}\ =\ std::make\_unique<nn::Linear>(n\_embed,\ vocab\_size);}
\DoxyCodeLine{00043\ \ \ \ \ \textcolor{comment}{//\ https://paperswithcode.com/method/weight-\/tying}}
\DoxyCodeLine{00044\ \ \ \ \ nn::g\_device.memcpy(\mbox{\hyperlink{structgpt_1_1GPT_a1d33d297064a0067cf649803aad7d554}{wte\_}}-\/>weight\_-\/>data<\mbox{\hyperlink{structgpt_1_1GPT_aa06480989b06f1e40879f71d80eac146}{Type}}>(),}
\DoxyCodeLine{00045\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_ab46fc21fad97de05f7c1a2446e64aac6}{lm\_head\_unused\_}}-\/>weight\_-\/>template\ \mbox{\hyperlink{abseil-cpp_2absl_2strings_2internal_2str__format_2float__conversion_8cc_adafb71d8f41ef4c3e3d3ccb46fe854c8}{data<Type>}}(),}
\DoxyCodeLine{00046\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{float})\ *\ vocab\_size\ *\ n\_embed);}
\DoxyCodeLine{00047\ \ \ \ \ nn::g\_device.memset(}
\DoxyCodeLine{00048\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_a1d33d297064a0067cf649803aad7d554}{wte\_}}-\/>weight\_-\/>data<\mbox{\hyperlink{structgpt_1_1GPT_aa06480989b06f1e40879f71d80eac146}{Type}}>()\ +\ vocab\_size\ *\ n\_embed,\ 0,}
\DoxyCodeLine{00049\ \ \ \ \ \ \ \ \ \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{float})\ *\ (padded\_vocab\_size\ -\/\ vocab\_size)\ *\ n\_embed);}
\DoxyCodeLine{00050\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_a4fd542d25a63acde00f760b56d8904a0}{lm\_head\_}}\ =\ \mbox{\hyperlink{structgpt_1_1GPT_a1d33d297064a0067cf649803aad7d554}{wte\_}}-\/>weight\_-\/>data<\mbox{\hyperlink{structgpt_1_1GPT_aa06480989b06f1e40879f71d80eac146}{Type}}>();}
\DoxyCodeLine{00051\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_a65a6ce0263d55fa9b5182c3a53035055}{softmax\_cross\_entropy\_}}\ =\ std::make\_unique<nn::SoftmaxCrossEntropy>();}
\DoxyCodeLine{00052\ }
\DoxyCodeLine{00053\ \ \ \ \ \textcolor{comment}{//\ activation}}
\DoxyCodeLine{00054\ \ \ \ \ \textcolor{keyword}{auto}\ dtype\ =\ \mbox{\hyperlink{structnn_1_1DataTypeToEnum}{nn::DataTypeToEnum<Type>::value}};}
\DoxyCodeLine{00055\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_aece01b5b72549c59be1d633ba1a5a511}{tok\_emb\_}}\ =\ std::make\_unique<nn::Activation>(dtype);\ \ \ \ \textcolor{comment}{//\ [B,\ T,\ C]}}
\DoxyCodeLine{00056\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_a2a90aeebc5b632203bf023f72b044ef5}{pos\_emb\_}}\ =\ std::make\_unique<nn::Activation>(dtype);\ \ \ \ \textcolor{comment}{//\ [T,\ C]}}
\DoxyCodeLine{00057\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_aeadbf840cc499afb9ee402defb27f893}{encoded\_}}\ =\ std::make\_unique<nn::Activation>(dtype);\ \ \ \ \textcolor{comment}{//\ [B,\ T,\ C]}}
\DoxyCodeLine{00058\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_a73a8d45df0332bba229766ebd5c3e749}{block\_y\_}}\ =\ std::make\_unique<nn::Activation>(dtype);\ \ \ \ \textcolor{comment}{//\ [L,\ B,\ T,\ C]}}
\DoxyCodeLine{00059\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_a14bf5e1fda2d671ecd3025e9e9e5f343}{lnf\_y\_}}\ =\ std::make\_unique<nn::Activation>(dtype);\ \ \ \ \ \ \textcolor{comment}{//\ [B*T,\ C]}}
\DoxyCodeLine{00060\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_a81d6413e95fec933746f12324da38c10}{lnf\_mean\_}}\ =\ std::make\_unique<nn::Activation>(dtype);\ \ \ \textcolor{comment}{//\ [B*T]}}
\DoxyCodeLine{00061\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_a31e5d5938dcd8e8af12dcbf68180ca11}{lnf\_rstd\_}}\ =\ std::make\_unique<nn::Activation>(dtype);\ \ \ \textcolor{comment}{//\ [B*T]}}
\DoxyCodeLine{00062\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_a8c2f6a7c1296bb3f0c3e876f1fde6b28}{scratch\_}}\ =\ std::make\_unique<nn::Activation>(dtype);\ \ \ \ \textcolor{comment}{//\ [B*T]}}
\DoxyCodeLine{00063\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_a2f01b9a7e23c86bec9e7d52b417ff857}{loss\_}}\ =\ std::make\_unique<nn::Activation>(dtype);\ \ \ \ \ \ \ \textcolor{comment}{//\ [B*T]}}
\DoxyCodeLine{00064\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_a669ccd15c28a2a6f964679f2a7c91d48}{loss\_mean\_}}\ =\ std::make\_unique<nn::Activation>(dtype);\ \ \textcolor{comment}{//\ [1]}}
\DoxyCodeLine{00065\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_aab4c44eb83493c9b26615e6926c2bada}{probs\_}}\ =\ std::make\_unique<nn::Activation>(dtype);\ \ \ \ \ \ \textcolor{comment}{//\ [B*T,\ vocab\_size]}}
\DoxyCodeLine{00066\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_a4453d7eb8ad5cc405dd5a459007e6e7a}{logits\_grad\_}}\ =}
\DoxyCodeLine{00067\ \ \ \ \ \ \ \ \ std::make\_unique<nn::Activation>(dtype);\ \ \textcolor{comment}{//\ [B*T,\ vocab\_size]}}
\DoxyCodeLine{00068\ \ \ \}}
\DoxyCodeLine{00069\ }
\DoxyCodeLine{00070\ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{structgpt_1_1GPT_a06d01499ec0f8bddd8d227222de12a01}{\_\_Forward}}(\textcolor{keyword}{typename}\ \mbox{\hyperlink{classEigen_1_1TensorMap}{TTypes<int>::ConstMatrix}}\ idx)\ \{}
\DoxyCodeLine{00071\ \ \ \ \ \mbox{\hyperlink{AttentionLayer_8hpp_a55d80b5525abdb6c4403e3c4052edb84}{PROFILE\_TRACE\_FN}}(\textcolor{stringliteral}{"{}GPT"{}});}
\DoxyCodeLine{00072\ }
\DoxyCodeLine{00073\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ B\ =\ idx.\mbox{\hyperlink{classEigen_1_1TensorMap_adfb930b8289836aad40d64171bde46a1}{dimension}}(0),\ T\ =\ idx.\mbox{\hyperlink{classEigen_1_1TensorMap_adfb930b8289836aad40d64171bde46a1}{dimension}}(1),\ \mbox{\hyperlink{abseil-cpp_2absl_2hash_2internal_2city__test_8cc_ac54ae397901fe700628cafadea3c5208}{C}}\ =\ \mbox{\hyperlink{structgpt_1_1GPT_a22dd2badb6ffdd821ff993dda16977e8}{n\_embed\_}},}
\DoxyCodeLine{00074\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ L\ =\ \mbox{\hyperlink{structgpt_1_1GPT_a45a132e3d5c28a298d366b89afa2c48a}{n\_layer\_}};}
\DoxyCodeLine{00075\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ BT\ =\ B\ *\ T,\ TC\ =\ T\ *\ \mbox{\hyperlink{abseil-cpp_2absl_2hash_2internal_2city__test_8cc_ac54ae397901fe700628cafadea3c5208}{C}};}
\DoxyCodeLine{00076\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ BTC\ =\ BT\ *\ \mbox{\hyperlink{abseil-cpp_2absl_2hash_2internal_2city__test_8cc_ac54ae397901fe700628cafadea3c5208}{C}};}
\DoxyCodeLine{00077\ }
\DoxyCodeLine{00078\ \ \ \ \ \mbox{\hyperlink{abseil-cpp_2absl_2log_2check_8h_ae4db23f10f5d4aad6d735f5a74cd6f8c}{CHECK\_LE}}(T,\ \mbox{\hyperlink{structgpt_1_1GPT_aedaded26c34b9bc6ab7f81f82e42dee3}{block\_size\_}})\ <<\ \textcolor{stringliteral}{"{}Cannot\ forward\ sequence\ of\ length\ "{}}\ <<\ T}
\DoxyCodeLine{00079\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{},\ block\ size\ is\ only\ "{}}\ <<\ \mbox{\hyperlink{structgpt_1_1GPT_aedaded26c34b9bc6ab7f81f82e42dee3}{block\_size\_}};}
\DoxyCodeLine{00080\ \ \ \ \ std::vector<int>\ pos(T);}
\DoxyCodeLine{00081\ \ \ \ \ std::iota(pos.begin(),\ pos.end(),\ 0);}
\DoxyCodeLine{00082\ }
\DoxyCodeLine{00083\ \ \ \ \ \textcolor{comment}{//\ Lazily\ allocate\ memory}}
\DoxyCodeLine{00084\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_aece01b5b72549c59be1d633ba1a5a511}{tok\_emb\_}}-\/>LazyAllocate(B\ *\ T\ *\ \mbox{\hyperlink{abseil-cpp_2absl_2hash_2internal_2city__test_8cc_ac54ae397901fe700628cafadea3c5208}{C}});}
\DoxyCodeLine{00085\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_a2a90aeebc5b632203bf023f72b044ef5}{pos\_emb\_}}-\/>LazyAllocate(T\ *\ \mbox{\hyperlink{abseil-cpp_2absl_2hash_2internal_2city__test_8cc_ac54ae397901fe700628cafadea3c5208}{C}});}
\DoxyCodeLine{00086\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_aeadbf840cc499afb9ee402defb27f893}{encoded\_}}-\/>LazyAllocate(B\ *\ T\ *\ \mbox{\hyperlink{abseil-cpp_2absl_2hash_2internal_2city__test_8cc_ac54ae397901fe700628cafadea3c5208}{C}});}
\DoxyCodeLine{00087\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_a73a8d45df0332bba229766ebd5c3e749}{block\_y\_}}-\/>LazyAllocate(L\ *\ B\ *\ T\ *\ \mbox{\hyperlink{abseil-cpp_2absl_2hash_2internal_2city__test_8cc_ac54ae397901fe700628cafadea3c5208}{C}});}
\DoxyCodeLine{00088\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_a14bf5e1fda2d671ecd3025e9e9e5f343}{lnf\_y\_}}-\/>LazyAllocate(BT\ *\ \mbox{\hyperlink{abseil-cpp_2absl_2hash_2internal_2city__test_8cc_ac54ae397901fe700628cafadea3c5208}{C}});}
\DoxyCodeLine{00089\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_a81d6413e95fec933746f12324da38c10}{lnf\_mean\_}}-\/>LazyAllocate(BT);}
\DoxyCodeLine{00090\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_a31e5d5938dcd8e8af12dcbf68180ca11}{lnf\_rstd\_}}-\/>LazyAllocate(BT);}
\DoxyCodeLine{00091\ }
\DoxyCodeLine{00092\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_a1d33d297064a0067cf649803aad7d554}{wte\_}}-\/>Forward(idx,}
\DoxyCodeLine{00093\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespaceabsl_a847c920a695241def319364f9dbc3de2}{absl::MakeSpan}}(\mbox{\hyperlink{structgpt_1_1GPT_aece01b5b72549c59be1d633ba1a5a511}{tok\_emb\_}}-\/>data<\mbox{\hyperlink{structgpt_1_1GPT_aa06480989b06f1e40879f71d80eac146}{Type}}>(),\ \mbox{\hyperlink{structgpt_1_1GPT_aece01b5b72549c59be1d633ba1a5a511}{tok\_emb\_}}-\/>size()));}
\DoxyCodeLine{00094\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_a81b3dd21d79017024bb0ee078d40e2de}{wpe\_}}-\/>Forward(pos,}
\DoxyCodeLine{00095\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespaceabsl_a847c920a695241def319364f9dbc3de2}{absl::MakeSpan}}(\mbox{\hyperlink{structgpt_1_1GPT_a2a90aeebc5b632203bf023f72b044ef5}{pos\_emb\_}}-\/>data<\mbox{\hyperlink{structgpt_1_1GPT_aa06480989b06f1e40879f71d80eac146}{Type}}>(),\ \mbox{\hyperlink{structgpt_1_1GPT_a2a90aeebc5b632203bf023f72b044ef5}{pos\_emb\_}}-\/>size()));}
\DoxyCodeLine{00096\ }
\DoxyCodeLine{00097\ \ \ \ \ \textcolor{keyword}{auto}\ tok\_emb\ =\ \mbox{\hyperlink{structgpt_1_1GPT_aece01b5b72549c59be1d633ba1a5a511}{tok\_emb\_}}-\/>matrix<\mbox{\hyperlink{structgpt_1_1GPT_aa06480989b06f1e40879f71d80eac146}{Type}}>(B,\ TC);}
\DoxyCodeLine{00098\ \ \ \ \ \textcolor{keyword}{auto}\ pos\_emb\ =\ \mbox{\hyperlink{structgpt_1_1GPT_a2a90aeebc5b632203bf023f72b044ef5}{pos\_emb\_}}-\/>flat<\mbox{\hyperlink{structgpt_1_1GPT_aa06480989b06f1e40879f71d80eac146}{Type}}>();}
\DoxyCodeLine{00099\ \ \ \ \ \textcolor{keyword}{auto}\ encoded\ =\ \mbox{\hyperlink{structgpt_1_1GPT_aeadbf840cc499afb9ee402defb27f893}{encoded\_}}-\/>matrix<\mbox{\hyperlink{structgpt_1_1GPT_aa06480989b06f1e40879f71d80eac146}{Type}}>(B,\ TC);}
\DoxyCodeLine{00100\ \ \ \ \ \mbox{\hyperlink{classEigen_1_1array}{Eigen::array<Eigen::Index,\ 2>}}\ batch\_by\_one\ =\ \{B,\ 1\};}
\DoxyCodeLine{00101\ \ \ \ \ \mbox{\hyperlink{classEigen_1_1array}{Eigen::array<Eigen::Index,\ 2>}}\ one\_by\_class\ =\ \{1,\ TC\};}
\DoxyCodeLine{00102\ \ \ \ \ encoded.device(nn::g\_device)\ =}
\DoxyCodeLine{00103\ \ \ \ \ \ \ \ \ tok\_emb\ +\ pos\_emb.reshape(one\_by\_class).broadcast(batch\_by\_one);}
\DoxyCodeLine{00104\ }
\DoxyCodeLine{00105\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ l\ =\ 0;\ l\ <\ \mbox{\hyperlink{structgpt_1_1GPT_a45a132e3d5c28a298d366b89afa2c48a}{n\_layer\_}};\ ++l)\ \{}
\DoxyCodeLine{00106\ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keyword}{auto}\&\ \mbox{\hyperlink{eigen_2Eigen_2src_2plugins_2BlockMethods_8h_ad90ae68615512ea2a9c7056ef1b34f13}{block}}\ =\ \mbox{\hyperlink{structgpt_1_1GPT_a3843d239a6a2fe0e12a5ff507ca05634}{h\_}}[l];}
\DoxyCodeLine{00107\ \ \ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_aa06480989b06f1e40879f71d80eac146}{Type}}*\ x\ =\ l\ ==\ 0\ ?\ \mbox{\hyperlink{structgpt_1_1GPT_aeadbf840cc499afb9ee402defb27f893}{encoded\_}}-\/>data<\mbox{\hyperlink{structgpt_1_1GPT_aa06480989b06f1e40879f71d80eac146}{Type}}>()}
\DoxyCodeLine{00108\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ :\ \mbox{\hyperlink{structgpt_1_1GPT_a73a8d45df0332bba229766ebd5c3e749}{block\_y\_}}-\/>data<\mbox{\hyperlink{structgpt_1_1GPT_aa06480989b06f1e40879f71d80eac146}{Type}}>()\ +\ (l\ -\/\ 1)\ *\ BTC;}
\DoxyCodeLine{00109\ \ \ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_aa06480989b06f1e40879f71d80eac146}{Type}}*\ y\ =\ \mbox{\hyperlink{structgpt_1_1GPT_a73a8d45df0332bba229766ebd5c3e749}{block\_y\_}}-\/>data<\mbox{\hyperlink{structgpt_1_1GPT_aa06480989b06f1e40879f71d80eac146}{Type}}>()\ +\ l\ *\ BTC;}
\DoxyCodeLine{00110\ \ \ \ \ \ \ \textcolor{keyword}{auto}\ block\_x\_3d\ =\ \mbox{\hyperlink{OriginalStuff_2tensor__util_8hpp_a83376511964dada7d9134ac8a54a4c99}{MakeConst3DTensor}}(x,\ B,\ T,\ \mbox{\hyperlink{abseil-cpp_2absl_2hash_2internal_2city__test_8cc_ac54ae397901fe700628cafadea3c5208}{C}});}
\DoxyCodeLine{00111\ \ \ \ \ \ \ \textcolor{keyword}{auto}\ block\_y\_3d\ =\ \mbox{\hyperlink{OriginalStuff_2tensor__util_8hpp_a3bde9957ede93fa72beb44296e6ce586}{Make3DTensor}}(y,\ B,\ T,\ \mbox{\hyperlink{abseil-cpp_2absl_2hash_2internal_2city__test_8cc_ac54ae397901fe700628cafadea3c5208}{C}});}
\DoxyCodeLine{00112\ \ \ \ \ \ \ \mbox{\hyperlink{eigen_2Eigen_2src_2plugins_2BlockMethods_8h_ad90ae68615512ea2a9c7056ef1b34f13}{block}}-\/>Forward(block\_x\_3d,\ block\_y\_3d);}
\DoxyCodeLine{00113\ \ \ \ \ \}}
\DoxyCodeLine{00114\ }
\DoxyCodeLine{00115\ \ \ \ \ \textcolor{keyword}{auto}\ block\_out\_2d\ =}
\DoxyCodeLine{00116\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{OriginalStuff_2tensor__util_8hpp_ae8e963613cb1e2fe5d606c04433078fe}{MakeConstMatrix}}(\mbox{\hyperlink{structgpt_1_1GPT_a73a8d45df0332bba229766ebd5c3e749}{block\_y\_}}-\/>data<\mbox{\hyperlink{structgpt_1_1GPT_aa06480989b06f1e40879f71d80eac146}{Type}}>()\ +\ (L\ -\/\ 1)\ *\ BTC,\ BT,\ \mbox{\hyperlink{abseil-cpp_2absl_2hash_2internal_2city__test_8cc_ac54ae397901fe700628cafadea3c5208}{C}});}
\DoxyCodeLine{00117\ \ \ \ \ \textcolor{keyword}{auto}\ lnf\_y\ =\ \mbox{\hyperlink{OriginalStuff_2tensor__util_8hpp_a30c79fba785f603a86fa02252305fbed}{MakeMatrix}}(\mbox{\hyperlink{structgpt_1_1GPT_a14bf5e1fda2d671ecd3025e9e9e5f343}{lnf\_y\_}}-\/>data<\mbox{\hyperlink{structgpt_1_1GPT_aa06480989b06f1e40879f71d80eac146}{Type}}>(),\ BT,\ \mbox{\hyperlink{abseil-cpp_2absl_2hash_2internal_2city__test_8cc_ac54ae397901fe700628cafadea3c5208}{C}});}
\DoxyCodeLine{00118\ \ \ \ \ \textcolor{keyword}{auto}\ lnf\_mean\ =\ \mbox{\hyperlink{OriginalStuff_2tensor__util_8hpp_a9a087a9b5b6b2f4a06af705501667b9b}{MakeFlat}}(\mbox{\hyperlink{structgpt_1_1GPT_a81d6413e95fec933746f12324da38c10}{lnf\_mean\_}}-\/>data<\mbox{\hyperlink{structgpt_1_1GPT_aa06480989b06f1e40879f71d80eac146}{Type}}>(),\ BT);}
\DoxyCodeLine{00119\ \ \ \ \ \textcolor{keyword}{auto}\ lnf\_rstd\ =\ \mbox{\hyperlink{OriginalStuff_2tensor__util_8hpp_a9a087a9b5b6b2f4a06af705501667b9b}{MakeFlat}}(\mbox{\hyperlink{structgpt_1_1GPT_a31e5d5938dcd8e8af12dcbf68180ca11}{lnf\_rstd\_}}-\/>data<\mbox{\hyperlink{structgpt_1_1GPT_aa06480989b06f1e40879f71d80eac146}{Type}}>(),\ BT);}
\DoxyCodeLine{00120\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_af8622f274fd219c42682c4206bd4604f}{lnf\_}}-\/>Forward(block\_out\_2d,\ lnf\_y,\ lnf\_mean,\ lnf\_rstd);}
\DoxyCodeLine{00121\ \ \ \}}
\DoxyCodeLine{00122\ }
\DoxyCodeLine{00123\ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{structgpt_1_1GPT_a492f106e75a21efdbf569b19a2c15cf2}{Forward}}(\textcolor{keyword}{typename}\ \mbox{\hyperlink{classEigen_1_1TensorMap}{TTypes<int>::ConstMatrix}}\ idx,}
\DoxyCodeLine{00124\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{typename}\ \mbox{\hyperlink{classEigen_1_1TensorMap}{TTypes<Type,\ 3>::Tensor}}\ logits)\ \{}
\DoxyCodeLine{00125\ \ \ \ \ \mbox{\hyperlink{AttentionLayer_8hpp_a55d80b5525abdb6c4403e3c4052edb84}{PROFILE\_TRACE\_FN}}(\textcolor{stringliteral}{"{}GPT"{}});}
\DoxyCodeLine{00126\ }
\DoxyCodeLine{00127\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ B\ =\ idx.\mbox{\hyperlink{classEigen_1_1TensorMap_adfb930b8289836aad40d64171bde46a1}{dimension}}(0),\ T\ =\ idx.\mbox{\hyperlink{classEigen_1_1TensorMap_adfb930b8289836aad40d64171bde46a1}{dimension}}(1),\ \mbox{\hyperlink{abseil-cpp_2absl_2hash_2internal_2city__test_8cc_ac54ae397901fe700628cafadea3c5208}{C}}\ =\ \mbox{\hyperlink{structgpt_1_1GPT_a22dd2badb6ffdd821ff993dda16977e8}{n\_embed\_}};}
\DoxyCodeLine{00128\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ BT\ =\ B\ *\ T;}
\DoxyCodeLine{00129\ \ \ \ \ \mbox{\hyperlink{abseil-cpp_2absl_2log_2check_8h_a3e1cfef60e774a81f30eaddf26a3a274}{CHECK}}(logits.\mbox{\hyperlink{classEigen_1_1TensorMap_adfb930b8289836aad40d64171bde46a1}{dimension}}(0)\ ==\ B\ \&\&\ logits.\mbox{\hyperlink{classEigen_1_1TensorMap_adfb930b8289836aad40d64171bde46a1}{dimension}}(1)\ ==\ T\ \&\&}
\DoxyCodeLine{00130\ \ \ \ \ \ \ \ \ \ \ logits.\mbox{\hyperlink{classEigen_1_1TensorMap_adfb930b8289836aad40d64171bde46a1}{dimension}}(2)\ ==\ \mbox{\hyperlink{structgpt_1_1GPT_a20f9d20710e9eb109d7697c43ea2972d}{vocab\_size\_}})}
\DoxyCodeLine{00131\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}B:\ "{}}\ <<\ B\ <<\ \textcolor{stringliteral}{"{},\ T:\ "{}}\ <<\ T\ <<\ \textcolor{stringliteral}{"{},\ vocab\_size:\ "{}}\ <<\ \mbox{\hyperlink{structgpt_1_1GPT_a20f9d20710e9eb109d7697c43ea2972d}{vocab\_size\_}};}
\DoxyCodeLine{00132\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_a06d01499ec0f8bddd8d227222de12a01}{\_\_Forward}}(idx);}
\DoxyCodeLine{00133\ }
\DoxyCodeLine{00134\ \ \ \ \ \textcolor{comment}{//\ OPTIMIZE:}}
\DoxyCodeLine{00135\ \ \ \ \ \textcolor{comment}{//\ inference-\/time\ mini-\/optimization:\ only\ forward\ the\ lm\_head\ on\ the\ very}}
\DoxyCodeLine{00136\ \ \ \ \ \textcolor{comment}{//\ last\ position}}
\DoxyCodeLine{00137\ \ \ \ \ \textcolor{comment}{//\ \ \ \ auto\ lnf\_y\_3d\ =\ Eigen::TensorMap<nn::Tensor3D>(lnf\_y\_.data(),\ B,\ T,}}
\DoxyCodeLine{00138\ \ \ \ \ \textcolor{comment}{//\ \ \ \ C);\ nn::Tensor2D\ lnf\_y\_last\_t\ =\ lnf\_y\_3d.chip(T\ -\/\ 1,\ 1);}}
\DoxyCodeLine{00139\ \ \ \ \ \textcolor{keyword}{auto}\ lnf\_y\ =\ \mbox{\hyperlink{OriginalStuff_2tensor__util_8hpp_a30c79fba785f603a86fa02252305fbed}{MakeMatrix}}(\mbox{\hyperlink{structgpt_1_1GPT_a14bf5e1fda2d671ecd3025e9e9e5f343}{lnf\_y\_}}-\/>data<\mbox{\hyperlink{structgpt_1_1GPT_aa06480989b06f1e40879f71d80eac146}{Type}}>(),\ BT,\ \mbox{\hyperlink{abseil-cpp_2absl_2hash_2internal_2city__test_8cc_ac54ae397901fe700628cafadea3c5208}{C}});}
\DoxyCodeLine{00140\ \ \ \ \ \textcolor{keyword}{auto}\ lm\_head\ =\ \mbox{\hyperlink{OriginalStuff_2tensor__util_8hpp_a30c79fba785f603a86fa02252305fbed}{MakeMatrix}}(\mbox{\hyperlink{structgpt_1_1GPT_a4fd542d25a63acde00f760b56d8904a0}{lm\_head\_}},\ \mbox{\hyperlink{structgpt_1_1GPT_a20f9d20710e9eb109d7697c43ea2972d}{vocab\_size\_}},\ \mbox{\hyperlink{abseil-cpp_2absl_2hash_2internal_2city__test_8cc_ac54ae397901fe700628cafadea3c5208}{C}});}
\DoxyCodeLine{00141\ \ \ \ \ \textcolor{keyword}{auto}\ logits\_2d\ =\ \mbox{\hyperlink{OriginalStuff_2tensor__util_8hpp_a30c79fba785f603a86fa02252305fbed}{MakeMatrix}}(logits.\mbox{\hyperlink{classEigen_1_1TensorMap_a735ad83edfacfcb9173e59ed861e6bbf}{data}}(),\ BT,\ \mbox{\hyperlink{structgpt_1_1GPT_a20f9d20710e9eb109d7697c43ea2972d}{vocab\_size\_}});}
\DoxyCodeLine{00142\ \ \ \ \ \textcolor{comment}{//\ \ \ \ nn::MatMul::Forward(lnf\_y,\ lm\_head,\ logits\_2d);}}
\DoxyCodeLine{00143\ \ \ \ \ \mbox{\hyperlink{classEigen_1_1array}{Eigen::array<Eigen::IndexPair<int>}},\ 1>\ product\_dims\ =\ \{}
\DoxyCodeLine{00144\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structEigen_1_1IndexPair}{Eigen::IndexPair<int>}}(1,\ 1)\};}
\DoxyCodeLine{00145\ \ \ \ \ logits\_2d.device(nn::g\_device)\ =\ lnf\_y.contract(lm\_head,\ product\_dims);}
\DoxyCodeLine{00146\ \ \ \}}
\DoxyCodeLine{00147\ }
\DoxyCodeLine{00148\ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{structgpt_1_1GPT_a03798a4e5c90de157e2dec98c7e15da8}{SoftmaxForwardCPU}}(\textcolor{keyword}{typename}\ \mbox{\hyperlink{classEigen_1_1TensorMap}{TTypes<Type>::ConstMatrix}}\ logits,}
\DoxyCodeLine{00149\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classabsl_1_1Span}{absl::Span<const\ int>}}\ targets,\ \textcolor{keywordtype}{float}*\ loss)\ \{}
\DoxyCodeLine{00150\ \ \ \ \ \mbox{\hyperlink{AttentionLayer_8hpp_a55d80b5525abdb6c4403e3c4052edb84}{PROFILE\_TRACE\_FN}}(\textcolor{stringliteral}{"{}GPT"{}});}
\DoxyCodeLine{00151\ }
\DoxyCodeLine{00152\ \ \ \ \ \textcolor{keywordtype}{int}\ BT\ =\ logits.\mbox{\hyperlink{classEigen_1_1TensorMap_adfb930b8289836aad40d64171bde46a1}{dimension}}(0);}
\DoxyCodeLine{00153\ \ \ \ \ \mbox{\hyperlink{abseil-cpp_2absl_2log_2check_8h_a7c0ce053b28d53aa4eaf3eb7fb71663b}{CHECK\_EQ}}(BT,\ targets.\mbox{\hyperlink{classabsl_1_1Span_a92186c247036e10dd12603c09f8b8797}{size}}());}
\DoxyCodeLine{00154\ \ \ \ \ \mbox{\hyperlink{abseil-cpp_2absl_2log_2check_8h_a7c0ce053b28d53aa4eaf3eb7fb71663b}{CHECK\_EQ}}(\mbox{\hyperlink{structgpt_1_1GPT_a20f9d20710e9eb109d7697c43ea2972d}{vocab\_size\_}},\ logits.\mbox{\hyperlink{classEigen_1_1TensorMap_adfb930b8289836aad40d64171bde46a1}{dimension}}(1));}
\DoxyCodeLine{00155\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_aab4c44eb83493c9b26615e6926c2bada}{probs\_}}-\/>LazyAllocate(BT\ *\ \mbox{\hyperlink{structgpt_1_1GPT_a20f9d20710e9eb109d7697c43ea2972d}{vocab\_size\_}});}
\DoxyCodeLine{00156\ \ \ \ \ \textcolor{keyword}{auto}\ probs\_2d\ =\ \mbox{\hyperlink{OriginalStuff_2tensor__util_8hpp_a30c79fba785f603a86fa02252305fbed}{MakeMatrix}}(\mbox{\hyperlink{structgpt_1_1GPT_aab4c44eb83493c9b26615e6926c2bada}{probs\_}}-\/>data<\mbox{\hyperlink{structgpt_1_1GPT_aa06480989b06f1e40879f71d80eac146}{Type}}>(),\ BT,\ \mbox{\hyperlink{structgpt_1_1GPT_a20f9d20710e9eb109d7697c43ea2972d}{vocab\_size\_}});}
\DoxyCodeLine{00157\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_a65a6ce0263d55fa9b5182c3a53035055}{softmax\_cross\_entropy\_}}-\/>Forward(logits,\ targets,\ probs\_2d,\ loss);}
\DoxyCodeLine{00158\ \ \ \}}
\DoxyCodeLine{00159\ }
\DoxyCodeLine{00160\ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{structgpt_1_1GPT_a0e741148d5e7c561aced3f14589eeb92}{SoftmaxForwardGPU}}(\textcolor{keyword}{typename}\ \mbox{\hyperlink{classEigen_1_1TensorMap}{TTypes<Type>::ConstMatrix}}\ logits,}
\DoxyCodeLine{00161\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{typename}\ \mbox{\hyperlink{classEigen_1_1TensorMap}{TTypes<Type>::ConstMatrix}}\ labels,}
\DoxyCodeLine{00162\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{float}*\ loss)\ \{}
\DoxyCodeLine{00163\ \ \ \ \ \mbox{\hyperlink{AttentionLayer_8hpp_a55d80b5525abdb6c4403e3c4052edb84}{PROFILE\_TRACE\_FN}}(\textcolor{stringliteral}{"{}GPT"{}});}
\DoxyCodeLine{00164\ }
\DoxyCodeLine{00165\ \ \ \ \ \textcolor{keywordtype}{int}\ BT\ =\ logits.\mbox{\hyperlink{classEigen_1_1TensorMap_adfb930b8289836aad40d64171bde46a1}{dimension}}(0);}
\DoxyCodeLine{00166\ \ \ \ \ \mbox{\hyperlink{abseil-cpp_2absl_2log_2check_8h_a7c0ce053b28d53aa4eaf3eb7fb71663b}{CHECK\_EQ}}(BT,\ labels.\mbox{\hyperlink{classEigen_1_1TensorMap_adfb930b8289836aad40d64171bde46a1}{dimension}}(0));}
\DoxyCodeLine{00167\ \ \ \ \ \mbox{\hyperlink{abseil-cpp_2absl_2log_2check_8h_a7c0ce053b28d53aa4eaf3eb7fb71663b}{CHECK\_EQ}}(\mbox{\hyperlink{structgpt_1_1GPT_a20f9d20710e9eb109d7697c43ea2972d}{vocab\_size\_}},\ logits.\mbox{\hyperlink{classEigen_1_1TensorMap_adfb930b8289836aad40d64171bde46a1}{dimension}}(1));}
\DoxyCodeLine{00168\ \ \ \ \ \mbox{\hyperlink{abseil-cpp_2absl_2log_2check_8h_a7c0ce053b28d53aa4eaf3eb7fb71663b}{CHECK\_EQ}}(\mbox{\hyperlink{structgpt_1_1GPT_a20f9d20710e9eb109d7697c43ea2972d}{vocab\_size\_}},\ labels.\mbox{\hyperlink{classEigen_1_1TensorMap_adfb930b8289836aad40d64171bde46a1}{dimension}}(1));}
\DoxyCodeLine{00169\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_a8c2f6a7c1296bb3f0c3e876f1fde6b28}{scratch\_}}-\/>LazyAllocate(BT);}
\DoxyCodeLine{00170\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_a2f01b9a7e23c86bec9e7d52b417ff857}{loss\_}}-\/>LazyAllocate(BT);}
\DoxyCodeLine{00171\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_a669ccd15c28a2a6f964679f2a7c91d48}{loss\_mean\_}}-\/>LazyAllocate(1);}
\DoxyCodeLine{00172\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_a4453d7eb8ad5cc405dd5a459007e6e7a}{logits\_grad\_}}-\/>LazyAllocate(BT\ *\ \mbox{\hyperlink{structgpt_1_1GPT_a20f9d20710e9eb109d7697c43ea2972d}{vocab\_size\_}});}
\DoxyCodeLine{00173\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_a4453d7eb8ad5cc405dd5a459007e6e7a}{logits\_grad\_}}-\/>ZeroData();}
\DoxyCodeLine{00174\ \ \ \ \ \textcolor{keyword}{auto}\ logits\_grad\ =\ \mbox{\hyperlink{OriginalStuff_2tensor__util_8hpp_a30c79fba785f603a86fa02252305fbed}{MakeMatrix}}(\mbox{\hyperlink{structgpt_1_1GPT_a4453d7eb8ad5cc405dd5a459007e6e7a}{logits\_grad\_}}-\/>data<\mbox{\hyperlink{structgpt_1_1GPT_aa06480989b06f1e40879f71d80eac146}{Type}}>(),\ BT,\ \mbox{\hyperlink{structgpt_1_1GPT_a20f9d20710e9eb109d7697c43ea2972d}{vocab\_size\_}});}
\DoxyCodeLine{00175\ \ \ \ \ \mbox{\hyperlink{structnn_1_1SoftmaxCrossEntropy_a7688dce4252afd47dbb64a0b5717ea2c}{nn::SoftmaxCrossEntropy::ForwardAndBackward}}(}
\DoxyCodeLine{00176\ \ \ \ \ \ \ \ \ logits,\ labels,\ \mbox{\hyperlink{structgpt_1_1GPT_a8c2f6a7c1296bb3f0c3e876f1fde6b28}{scratch\_}}-\/>template\ flat<Type>(),}
\DoxyCodeLine{00177\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_a2f01b9a7e23c86bec9e7d52b417ff857}{loss\_}}-\/>template\ flat<Type>(),\ logits\_grad);}
\DoxyCodeLine{00178\ \ \ \ \ logits\_grad.device(nn::g\_device)\ =\ logits\_grad\ *\ (1.0f\ /\ BT);}
\DoxyCodeLine{00179\ }
\DoxyCodeLine{00180\ \textcolor{preprocessor}{\#ifdef\ EIGEN\_USE\_GPU}}
\DoxyCodeLine{00181\ \ \ \ \ \mbox{\hyperlink{classEigen_1_1TensorMap}{TTypes<Type>::UnalignedScalar}}\ loss\_mean(\mbox{\hyperlink{structgpt_1_1GPT_a669ccd15c28a2a6f964679f2a7c91d48}{loss\_mean\_}}-\/>data<\mbox{\hyperlink{structgpt_1_1GPT_aa06480989b06f1e40879f71d80eac146}{Type}}>());}
\DoxyCodeLine{00182\ \ \ \ \ loss\_mean.device(nn::g\_device)\ =\ \mbox{\hyperlink{structgpt_1_1GPT_a2f01b9a7e23c86bec9e7d52b417ff857}{loss\_}}-\/>template\ flat<Type>().mean();}
\DoxyCodeLine{00183\ \ \ \ \ nn::g\_device.memcpyDeviceToHost(loss,\ loss\_mean.data(),\ \textcolor{keyword}{sizeof}(\mbox{\hyperlink{structgpt_1_1GPT_aa06480989b06f1e40879f71d80eac146}{Type}}));}
\DoxyCodeLine{00184\ \ \ \ \ nn::g\_device.synchronize();}
\DoxyCodeLine{00185\ \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{00186\ \ \ \ \ \mbox{\hyperlink{abseil-cpp_2absl_2log_2log_8h_accad43a85d781d53381cd53a9894b6ae}{LOG}}(FATAL)\ <<\ \textcolor{stringliteral}{"{}Never\ reach\ here!!!"{}};}
\DoxyCodeLine{00187\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00188\ \ \ \ \ \textcolor{comment}{//\ \ \ \ TTypes<float>::Scalar\ loss\_scalar(loss);}}
\DoxyCodeLine{00189\ \ \ \ \ \textcolor{comment}{//\ \ \ \ loss\_scalar.device(nn::g\_device)\ =\ loss\_-\/>template}}
\DoxyCodeLine{00190\ \ \ \ \ \textcolor{comment}{//\ \ \ \ flat<Type>().mean();}}
\DoxyCodeLine{00191\ \ \ \}}
\DoxyCodeLine{00192\ }
\DoxyCodeLine{00193\ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{structgpt_1_1GPT_a78fe35b7abdbd4c7ab0c6881c8596e1c}{ForwardCPU}}(\textcolor{keyword}{typename}\ \mbox{\hyperlink{classEigen_1_1TensorMap}{TTypes<int>::ConstMatrix}}\ idx,}
\DoxyCodeLine{00194\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{typename}\ \mbox{\hyperlink{classEigen_1_1TensorMap}{TTypes<int>::ConstMatrix}}\ targets,}
\DoxyCodeLine{00195\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{typename}\ \mbox{\hyperlink{classEigen_1_1TensorMap}{TTypes<Type,\ 3>::Tensor}}\ logits,\ \textcolor{keywordtype}{float}*\ loss)\ \{}
\DoxyCodeLine{00196\ \ \ \ \ \mbox{\hyperlink{AttentionLayer_8hpp_a55d80b5525abdb6c4403e3c4052edb84}{PROFILE\_TRACE\_FN}}(\textcolor{stringliteral}{"{}GPT"{}});}
\DoxyCodeLine{00197\ }
\DoxyCodeLine{00198\ \ \ \ \ \textcolor{comment}{//\ idx:\ [B,\ T],\ targets:\ [B,\ T]}}
\DoxyCodeLine{00199\ \ \ \ \ \textcolor{comment}{//\ logits:\ [B,\ T,\ vocab\_size]}}
\DoxyCodeLine{00200\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ B\ =\ idx.\mbox{\hyperlink{classEigen_1_1TensorMap_adfb930b8289836aad40d64171bde46a1}{dimension}}(0),\ T\ =\ idx.\mbox{\hyperlink{classEigen_1_1TensorMap_adfb930b8289836aad40d64171bde46a1}{dimension}}(1),\ \mbox{\hyperlink{abseil-cpp_2absl_2hash_2internal_2city__test_8cc_ac54ae397901fe700628cafadea3c5208}{C}}\ =\ \mbox{\hyperlink{structgpt_1_1GPT_a22dd2badb6ffdd821ff993dda16977e8}{n\_embed\_}};}
\DoxyCodeLine{00201\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ BT\ =\ B\ *\ T;}
\DoxyCodeLine{00202\ \ \ \ \ \mbox{\hyperlink{abseil-cpp_2absl_2log_2check_8h_a3e1cfef60e774a81f30eaddf26a3a274}{CHECK}}(targets.\mbox{\hyperlink{classEigen_1_1TensorMap_adfb930b8289836aad40d64171bde46a1}{dimension}}(0)\ ==\ B\ \&\&\ targets.\mbox{\hyperlink{classEigen_1_1TensorMap_adfb930b8289836aad40d64171bde46a1}{dimension}}(1)\ ==\ T);}
\DoxyCodeLine{00203\ \ \ \ \ \mbox{\hyperlink{abseil-cpp_2absl_2log_2check_8h_a3e1cfef60e774a81f30eaddf26a3a274}{CHECK}}(logits.\mbox{\hyperlink{classEigen_1_1TensorMap_adfb930b8289836aad40d64171bde46a1}{dimension}}(0)\ ==\ B\ \&\&\ logits.\mbox{\hyperlink{classEigen_1_1TensorMap_adfb930b8289836aad40d64171bde46a1}{dimension}}(1)\ ==\ T\ \&\&}
\DoxyCodeLine{00204\ \ \ \ \ \ \ \ \ \ \ logits.\mbox{\hyperlink{classEigen_1_1TensorMap_adfb930b8289836aad40d64171bde46a1}{dimension}}(2)\ ==\ \mbox{\hyperlink{structgpt_1_1GPT_a20f9d20710e9eb109d7697c43ea2972d}{vocab\_size\_}})}
\DoxyCodeLine{00205\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}B:\ "{}}\ <<\ B\ <<\ \textcolor{stringliteral}{"{},\ T:\ "{}}\ <<\ T\ <<\ \textcolor{stringliteral}{"{},\ vocab\_size:\ "{}}\ <<\ \mbox{\hyperlink{structgpt_1_1GPT_a20f9d20710e9eb109d7697c43ea2972d}{vocab\_size\_}};}
\DoxyCodeLine{00206\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_a06d01499ec0f8bddd8d227222de12a01}{\_\_Forward}}(idx);}
\DoxyCodeLine{00207\ }
\DoxyCodeLine{00208\ \ \ \ \ \textcolor{keyword}{auto}\ lnf\_y\ =\ \mbox{\hyperlink{OriginalStuff_2tensor__util_8hpp_a30c79fba785f603a86fa02252305fbed}{MakeMatrix}}(\mbox{\hyperlink{structgpt_1_1GPT_a14bf5e1fda2d671ecd3025e9e9e5f343}{lnf\_y\_}}-\/>data<\mbox{\hyperlink{structgpt_1_1GPT_aa06480989b06f1e40879f71d80eac146}{Type}}>(),\ BT,\ \mbox{\hyperlink{abseil-cpp_2absl_2hash_2internal_2city__test_8cc_ac54ae397901fe700628cafadea3c5208}{C}});}
\DoxyCodeLine{00209\ \ \ \ \ \textcolor{keyword}{auto}\ lm\_head\ =\ \mbox{\hyperlink{OriginalStuff_2tensor__util_8hpp_a30c79fba785f603a86fa02252305fbed}{MakeMatrix}}(\mbox{\hyperlink{structgpt_1_1GPT_a4fd542d25a63acde00f760b56d8904a0}{lm\_head\_}},\ \mbox{\hyperlink{structgpt_1_1GPT_a20f9d20710e9eb109d7697c43ea2972d}{vocab\_size\_}},\ \mbox{\hyperlink{structgpt_1_1GPT_a22dd2badb6ffdd821ff993dda16977e8}{n\_embed\_}});}
\DoxyCodeLine{00210\ \ \ \ \ \textcolor{keyword}{auto}\ logits\_2d\ =\ \mbox{\hyperlink{OriginalStuff_2tensor__util_8hpp_a30c79fba785f603a86fa02252305fbed}{MakeMatrix}}(logits.\mbox{\hyperlink{classEigen_1_1TensorMap_a735ad83edfacfcb9173e59ed861e6bbf}{data}}(),\ BT,\ \mbox{\hyperlink{structgpt_1_1GPT_a20f9d20710e9eb109d7697c43ea2972d}{vocab\_size\_}});}
\DoxyCodeLine{00211\ \ \ \ \ \textcolor{keyword}{auto}\ probs\_2d\ =\ \mbox{\hyperlink{OriginalStuff_2tensor__util_8hpp_a30c79fba785f603a86fa02252305fbed}{MakeMatrix}}(\mbox{\hyperlink{structgpt_1_1GPT_aab4c44eb83493c9b26615e6926c2bada}{probs\_}}-\/>data<\mbox{\hyperlink{structgpt_1_1GPT_aa06480989b06f1e40879f71d80eac146}{Type}}>(),\ BT,\ \mbox{\hyperlink{structgpt_1_1GPT_a20f9d20710e9eb109d7697c43ea2972d}{vocab\_size\_}});}
\DoxyCodeLine{00212\ }
\DoxyCodeLine{00213\ \ \ \ \ \textcolor{comment}{//\ [BT,\ C]\ x\ [C,\ vocab\_size]\ -\/>\ [BT,\ vocab\_size]}}
\DoxyCodeLine{00214\ \ \ \ \ \mbox{\hyperlink{classEigen_1_1array}{Eigen::array<Eigen::IndexPair<int>}},\ 1>\ product\_dims\ =\ \{}
\DoxyCodeLine{00215\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structEigen_1_1IndexPair}{Eigen::IndexPair<int>}}(1,\ 1)\};}
\DoxyCodeLine{00216\ \ \ \ \ logits\_2d.device(nn::g\_device)\ =\ lnf\_y.contract(lm\_head,\ product\_dims);}
\DoxyCodeLine{00217\ }
\DoxyCodeLine{00218\ \ \ \ \ \textcolor{keyword}{auto}\ logits\_2d\_const\ =\ \mbox{\hyperlink{OriginalStuff_2tensor__util_8hpp_ae8e963613cb1e2fe5d606c04433078fe}{MakeConstMatrix}}(logits.\mbox{\hyperlink{classEigen_1_1TensorMap_a735ad83edfacfcb9173e59ed861e6bbf}{data}}(),\ BT,\ \mbox{\hyperlink{structgpt_1_1GPT_a20f9d20710e9eb109d7697c43ea2972d}{vocab\_size\_}});}
\DoxyCodeLine{00219\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_a03798a4e5c90de157e2dec98c7e15da8}{SoftmaxForwardCPU}}(logits\_2d\_const,\ targets,\ loss);}
\DoxyCodeLine{00220\ \ \ \}}
\DoxyCodeLine{00221\ }
\DoxyCodeLine{00222\ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{structgpt_1_1GPT_a960be052dca6f5133e9f934c62788663}{ForwardGPU}}(\textcolor{keyword}{typename}\ \mbox{\hyperlink{classEigen_1_1TensorMap}{TTypes<int>::ConstMatrix}}\ idx,}
\DoxyCodeLine{00223\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{typename}\ \mbox{\hyperlink{classEigen_1_1TensorMap}{TTypes<Type,\ 3>::ConstTensor}}\ labels,}
\DoxyCodeLine{00224\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{typename}\ \mbox{\hyperlink{classEigen_1_1TensorMap}{TTypes<Type,\ 3>::Tensor}}\ logits,\ \textcolor{keywordtype}{float}*\ loss)\ \{}
\DoxyCodeLine{00225\ \ \ \ \ \mbox{\hyperlink{AttentionLayer_8hpp_a55d80b5525abdb6c4403e3c4052edb84}{PROFILE\_TRACE\_FN}}(\textcolor{stringliteral}{"{}GPT"{}});}
\DoxyCodeLine{00226\ }
\DoxyCodeLine{00227\ \ \ \ \ \textcolor{comment}{//\ idx:\ [B,\ T],\ targets:\ [B,\ T]}}
\DoxyCodeLine{00228\ \ \ \ \ \textcolor{comment}{//\ logits:\ [B,\ T,\ vocab\_size]}}
\DoxyCodeLine{00229\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ B\ =\ idx.\mbox{\hyperlink{classEigen_1_1TensorMap_adfb930b8289836aad40d64171bde46a1}{dimension}}(0),\ T\ =\ idx.\mbox{\hyperlink{classEigen_1_1TensorMap_adfb930b8289836aad40d64171bde46a1}{dimension}}(1),\ \mbox{\hyperlink{abseil-cpp_2absl_2hash_2internal_2city__test_8cc_ac54ae397901fe700628cafadea3c5208}{C}}\ =\ \mbox{\hyperlink{structgpt_1_1GPT_a22dd2badb6ffdd821ff993dda16977e8}{n\_embed\_}};}
\DoxyCodeLine{00230\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ BT\ =\ B\ *\ T;}
\DoxyCodeLine{00231\ \ \ \ \ \mbox{\hyperlink{abseil-cpp_2absl_2log_2check_8h_a3e1cfef60e774a81f30eaddf26a3a274}{CHECK}}(labels.\mbox{\hyperlink{classEigen_1_1TensorMap_adfb930b8289836aad40d64171bde46a1}{dimension}}(0)\ ==\ B\ \&\&\ labels.\mbox{\hyperlink{classEigen_1_1TensorMap_adfb930b8289836aad40d64171bde46a1}{dimension}}(1)\ ==\ T\ \&\&}
\DoxyCodeLine{00232\ \ \ \ \ \ \ \ \ \ \ labels.\mbox{\hyperlink{classEigen_1_1TensorMap_adfb930b8289836aad40d64171bde46a1}{dimension}}(2)\ ==\ \mbox{\hyperlink{structgpt_1_1GPT_a20f9d20710e9eb109d7697c43ea2972d}{vocab\_size\_}});}
\DoxyCodeLine{00233\ \ \ \ \ \mbox{\hyperlink{abseil-cpp_2absl_2log_2check_8h_a3e1cfef60e774a81f30eaddf26a3a274}{CHECK}}(logits.\mbox{\hyperlink{classEigen_1_1TensorMap_adfb930b8289836aad40d64171bde46a1}{dimension}}(0)\ ==\ B\ \&\&\ logits.\mbox{\hyperlink{classEigen_1_1TensorMap_adfb930b8289836aad40d64171bde46a1}{dimension}}(1)\ ==\ T\ \&\&}
\DoxyCodeLine{00234\ \ \ \ \ \ \ \ \ \ \ logits.\mbox{\hyperlink{classEigen_1_1TensorMap_adfb930b8289836aad40d64171bde46a1}{dimension}}(2)\ ==\ \mbox{\hyperlink{structgpt_1_1GPT_a20f9d20710e9eb109d7697c43ea2972d}{vocab\_size\_}})}
\DoxyCodeLine{00235\ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}B:\ "{}}\ <<\ B\ <<\ \textcolor{stringliteral}{"{},\ T:\ "{}}\ <<\ T\ <<\ \textcolor{stringliteral}{"{},\ vocab\_size:\ "{}}\ <<\ \mbox{\hyperlink{structgpt_1_1GPT_a20f9d20710e9eb109d7697c43ea2972d}{vocab\_size\_}};}
\DoxyCodeLine{00236\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_a06d01499ec0f8bddd8d227222de12a01}{\_\_Forward}}(idx);}
\DoxyCodeLine{00237\ }
\DoxyCodeLine{00238\ \ \ \ \ \textcolor{keyword}{auto}\ lnf\_y\ =\ \mbox{\hyperlink{OriginalStuff_2tensor__util_8hpp_a30c79fba785f603a86fa02252305fbed}{MakeMatrix}}(\mbox{\hyperlink{structgpt_1_1GPT_a14bf5e1fda2d671ecd3025e9e9e5f343}{lnf\_y\_}}-\/>data<\mbox{\hyperlink{structgpt_1_1GPT_aa06480989b06f1e40879f71d80eac146}{Type}}>(),\ BT,\ \mbox{\hyperlink{abseil-cpp_2absl_2hash_2internal_2city__test_8cc_ac54ae397901fe700628cafadea3c5208}{C}});}
\DoxyCodeLine{00239\ \ \ \ \ \textcolor{keyword}{auto}\ lm\_head\ =\ \mbox{\hyperlink{OriginalStuff_2tensor__util_8hpp_a30c79fba785f603a86fa02252305fbed}{MakeMatrix}}(\mbox{\hyperlink{structgpt_1_1GPT_a4fd542d25a63acde00f760b56d8904a0}{lm\_head\_}},\ \mbox{\hyperlink{structgpt_1_1GPT_a20f9d20710e9eb109d7697c43ea2972d}{vocab\_size\_}},\ \mbox{\hyperlink{structgpt_1_1GPT_a22dd2badb6ffdd821ff993dda16977e8}{n\_embed\_}});}
\DoxyCodeLine{00240\ \ \ \ \ \textcolor{keyword}{auto}\ logits\_2d\ =\ \mbox{\hyperlink{OriginalStuff_2tensor__util_8hpp_a30c79fba785f603a86fa02252305fbed}{MakeMatrix}}(logits.\mbox{\hyperlink{classEigen_1_1TensorMap_a735ad83edfacfcb9173e59ed861e6bbf}{data}}(),\ BT,\ \mbox{\hyperlink{structgpt_1_1GPT_a20f9d20710e9eb109d7697c43ea2972d}{vocab\_size\_}});}
\DoxyCodeLine{00241\ }
\DoxyCodeLine{00242\ \ \ \ \ \textcolor{comment}{//\ [BT,\ C]\ x\ [C,\ vocab\_size]\ -\/>\ [BT,\ vocab\_size]}}
\DoxyCodeLine{00243\ \ \ \ \ \mbox{\hyperlink{classEigen_1_1array}{Eigen::array<Eigen::IndexPair<int>}},\ 1>\ product\_dims\ =\ \{}
\DoxyCodeLine{00244\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structEigen_1_1IndexPair}{Eigen::IndexPair<int>}}(1,\ 1)\};}
\DoxyCodeLine{00245\ \ \ \ \ logits\_2d.device(nn::g\_device)\ =\ lnf\_y.contract(lm\_head,\ product\_dims);}
\DoxyCodeLine{00246\ }
\DoxyCodeLine{00247\ \ \ \ \ \textcolor{keyword}{auto}\ logits\_2d\_const\ =\ \mbox{\hyperlink{OriginalStuff_2tensor__util_8hpp_ae8e963613cb1e2fe5d606c04433078fe}{MakeConstMatrix}}(logits.\mbox{\hyperlink{classEigen_1_1TensorMap_a735ad83edfacfcb9173e59ed861e6bbf}{data}}(),\ BT,\ \mbox{\hyperlink{structgpt_1_1GPT_a20f9d20710e9eb109d7697c43ea2972d}{vocab\_size\_}});}
\DoxyCodeLine{00248\ \ \ \ \ \textcolor{keyword}{auto}\ labels\_2d\_const\ =\ \mbox{\hyperlink{OriginalStuff_2tensor__util_8hpp_ae8e963613cb1e2fe5d606c04433078fe}{MakeConstMatrix}}(labels.\mbox{\hyperlink{classEigen_1_1TensorMap_a735ad83edfacfcb9173e59ed861e6bbf}{data}}(),\ BT,\ \mbox{\hyperlink{structgpt_1_1GPT_a20f9d20710e9eb109d7697c43ea2972d}{vocab\_size\_}});}
\DoxyCodeLine{00249\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_a0e741148d5e7c561aced3f14589eeb92}{SoftmaxForwardGPU}}(logits\_2d\_const,\ labels\_2d\_const,\ loss);}
\DoxyCodeLine{00250\ \ \ \}}
\DoxyCodeLine{00251\ }
\DoxyCodeLine{00252\ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{structgpt_1_1GPT_a9dc6ae9537d4673a7b475351079c0391}{SoftmaxBackwardCPU}}(\mbox{\hyperlink{classabsl_1_1Span}{absl::Span<const\ int>}}\ targets)\ \{}
\DoxyCodeLine{00253\ \ \ \ \ \mbox{\hyperlink{AttentionLayer_8hpp_a55d80b5525abdb6c4403e3c4052edb84}{PROFILE\_TRACE\_FN}}(\textcolor{stringliteral}{"{}GPT"{}});}
\DoxyCodeLine{00254\ }
\DoxyCodeLine{00255\ \ \ \ \ \textcolor{keywordtype}{int}\ BT\ =\ targets.\mbox{\hyperlink{classabsl_1_1Span_a92186c247036e10dd12603c09f8b8797}{size}}();}
\DoxyCodeLine{00256\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_a4453d7eb8ad5cc405dd5a459007e6e7a}{logits\_grad\_}}-\/>LazyAllocate(BT\ *\ \mbox{\hyperlink{structgpt_1_1GPT_a20f9d20710e9eb109d7697c43ea2972d}{vocab\_size\_}});}
\DoxyCodeLine{00257\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_a4453d7eb8ad5cc405dd5a459007e6e7a}{logits\_grad\_}}-\/>ZeroData();}
\DoxyCodeLine{00258\ \ \ \ \ \textcolor{keyword}{auto}\ probs\_2d\ =\ \mbox{\hyperlink{OriginalStuff_2tensor__util_8hpp_ae8e963613cb1e2fe5d606c04433078fe}{MakeConstMatrix}}(\mbox{\hyperlink{structgpt_1_1GPT_aab4c44eb83493c9b26615e6926c2bada}{probs\_}}-\/>data<\mbox{\hyperlink{structgpt_1_1GPT_aa06480989b06f1e40879f71d80eac146}{Type}}>(),\ BT,\ \mbox{\hyperlink{structgpt_1_1GPT_a20f9d20710e9eb109d7697c43ea2972d}{vocab\_size\_}});}
\DoxyCodeLine{00259\ \ \ \ \ \textcolor{keyword}{auto}\ logits\_grad\_2d\ =}
\DoxyCodeLine{00260\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{OriginalStuff_2tensor__util_8hpp_a30c79fba785f603a86fa02252305fbed}{MakeMatrix}}(\mbox{\hyperlink{structgpt_1_1GPT_a4453d7eb8ad5cc405dd5a459007e6e7a}{logits\_grad\_}}-\/>data<\mbox{\hyperlink{structgpt_1_1GPT_aa06480989b06f1e40879f71d80eac146}{Type}}>(),\ BT,\ \mbox{\hyperlink{structgpt_1_1GPT_a20f9d20710e9eb109d7697c43ea2972d}{vocab\_size\_}});}
\DoxyCodeLine{00261\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_a65a6ce0263d55fa9b5182c3a53035055}{softmax\_cross\_entropy\_}}-\/>Backward(probs\_2d,\ targets,\ logits\_grad\_2d);}
\DoxyCodeLine{00262\ \ \ \}}
\DoxyCodeLine{00263\ }
\DoxyCodeLine{00264\ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{structgpt_1_1GPT_af8e1ec33f50a7d068910fc9deb982121}{BackwardCPU}}(\textcolor{keyword}{typename}\ \mbox{\hyperlink{classEigen_1_1TensorMap}{TTypes<int>::ConstMatrix}}\ idx,}
\DoxyCodeLine{00265\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{typename}\ \mbox{\hyperlink{classEigen_1_1TensorMap}{TTypes<int>::ConstMatrix}}\ targets)\ \{}
\DoxyCodeLine{00266\ \ \ \ \ \mbox{\hyperlink{AttentionLayer_8hpp_a55d80b5525abdb6c4403e3c4052edb84}{PROFILE\_TRACE\_FN}}(\textcolor{stringliteral}{"{}GPT"{}});}
\DoxyCodeLine{00267\ }
\DoxyCodeLine{00268\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_a9dc6ae9537d4673a7b475351079c0391}{SoftmaxBackwardCPU}}(targets);}
\DoxyCodeLine{00269\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_ac21af1ba4a8d175e088bedd7bebbba6c}{BackwardGPU}}(idx);}
\DoxyCodeLine{00270\ \ \ \}}
\DoxyCodeLine{00271\ }
\DoxyCodeLine{00272\ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{structgpt_1_1GPT_ac21af1ba4a8d175e088bedd7bebbba6c}{BackwardGPU}}(\textcolor{keyword}{typename}\ \mbox{\hyperlink{classEigen_1_1TensorMap}{TTypes<int>::ConstMatrix}}\ idx)\ \{}
\DoxyCodeLine{00273\ \ \ \ \ \mbox{\hyperlink{AttentionLayer_8hpp_a55d80b5525abdb6c4403e3c4052edb84}{PROFILE\_TRACE\_FN}}(\textcolor{stringliteral}{"{}GPT"{}});}
\DoxyCodeLine{00274\ }
\DoxyCodeLine{00275\ \ \ \ \ \textcolor{comment}{//\ idx:\ [B,\ T],\ targets:\ [B,\ T]}}
\DoxyCodeLine{00276\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ B\ =\ idx.\mbox{\hyperlink{classEigen_1_1TensorMap_adfb930b8289836aad40d64171bde46a1}{dimension}}(0),\ T\ =\ idx.\mbox{\hyperlink{classEigen_1_1TensorMap_adfb930b8289836aad40d64171bde46a1}{dimension}}(1),\ \mbox{\hyperlink{abseil-cpp_2absl_2hash_2internal_2city__test_8cc_ac54ae397901fe700628cafadea3c5208}{C}}\ =\ \mbox{\hyperlink{structgpt_1_1GPT_a22dd2badb6ffdd821ff993dda16977e8}{n\_embed\_}},}
\DoxyCodeLine{00277\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ L\ =\ \mbox{\hyperlink{structgpt_1_1GPT_a45a132e3d5c28a298d366b89afa2c48a}{n\_layer\_}};}
\DoxyCodeLine{00278\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ BT\ =\ B\ *\ T,\ TC\ =\ T\ *\ \mbox{\hyperlink{abseil-cpp_2absl_2hash_2internal_2city__test_8cc_ac54ae397901fe700628cafadea3c5208}{C}};}
\DoxyCodeLine{00279\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ BTC\ =\ BT\ *\ \mbox{\hyperlink{abseil-cpp_2absl_2hash_2internal_2city__test_8cc_ac54ae397901fe700628cafadea3c5208}{C}};}
\DoxyCodeLine{00280\ }
\DoxyCodeLine{00281\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_a1d33d297064a0067cf649803aad7d554}{wte\_}}-\/>weight\_-\/>LazyAllocateGradient();}
\DoxyCodeLine{00282\ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{structgpt_1_1GPT_a18157e410bed91a149243fea18be4ad7}{lm\_head\_grad\_}}\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00283\ \ \ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_a18157e410bed91a149243fea18be4ad7}{lm\_head\_grad\_}}\ =\ \mbox{\hyperlink{structgpt_1_1GPT_a1d33d297064a0067cf649803aad7d554}{wte\_}}-\/>weight\_-\/>grad<\mbox{\hyperlink{structgpt_1_1GPT_aa06480989b06f1e40879f71d80eac146}{Type}}>();}
\DoxyCodeLine{00284\ \ \ \ \ \}}
\DoxyCodeLine{00285\ }
\DoxyCodeLine{00286\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_aece01b5b72549c59be1d633ba1a5a511}{tok\_emb\_}}-\/>LazyAllocateGradient();}
\DoxyCodeLine{00287\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_a2a90aeebc5b632203bf023f72b044ef5}{pos\_emb\_}}-\/>LazyAllocateGradient();}
\DoxyCodeLine{00288\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_aeadbf840cc499afb9ee402defb27f893}{encoded\_}}-\/>LazyAllocateGradient();}
\DoxyCodeLine{00289\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_a73a8d45df0332bba229766ebd5c3e749}{block\_y\_}}-\/>LazyAllocateGradient();}
\DoxyCodeLine{00290\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_a14bf5e1fda2d671ecd3025e9e9e5f343}{lnf\_y\_}}-\/>LazyAllocateGradient();}
\DoxyCodeLine{00291\ }
\DoxyCodeLine{00292\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_aece01b5b72549c59be1d633ba1a5a511}{tok\_emb\_}}-\/>ZeroGrad();}
\DoxyCodeLine{00293\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_a2a90aeebc5b632203bf023f72b044ef5}{pos\_emb\_}}-\/>ZeroGrad();}
\DoxyCodeLine{00294\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_aeadbf840cc499afb9ee402defb27f893}{encoded\_}}-\/>ZeroGrad();}
\DoxyCodeLine{00295\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_a73a8d45df0332bba229766ebd5c3e749}{block\_y\_}}-\/>ZeroGrad();}
\DoxyCodeLine{00296\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_a14bf5e1fda2d671ecd3025e9e9e5f343}{lnf\_y\_}}-\/>ZeroGrad();}
\DoxyCodeLine{00297\ }
\DoxyCodeLine{00298\ \ \ \ \ \textcolor{comment}{//\ backward\ lm\_head}}
\DoxyCodeLine{00299\ \ \ \ \ \textcolor{keyword}{auto}\ logits\_grad\_2d\ =}
\DoxyCodeLine{00300\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{OriginalStuff_2tensor__util_8hpp_a30c79fba785f603a86fa02252305fbed}{MakeMatrix}}(\mbox{\hyperlink{structgpt_1_1GPT_a4453d7eb8ad5cc405dd5a459007e6e7a}{logits\_grad\_}}-\/>data<\mbox{\hyperlink{structgpt_1_1GPT_aa06480989b06f1e40879f71d80eac146}{Type}}>(),\ BT,\ \mbox{\hyperlink{structgpt_1_1GPT_a20f9d20710e9eb109d7697c43ea2972d}{vocab\_size\_}});}
\DoxyCodeLine{00301\ \ \ \ \ \textcolor{keyword}{auto}\ lnf\_y\ =\ \mbox{\hyperlink{OriginalStuff_2tensor__util_8hpp_a30c79fba785f603a86fa02252305fbed}{MakeMatrix}}(\mbox{\hyperlink{structgpt_1_1GPT_a14bf5e1fda2d671ecd3025e9e9e5f343}{lnf\_y\_}}-\/>data<\mbox{\hyperlink{structgpt_1_1GPT_aa06480989b06f1e40879f71d80eac146}{Type}}>(),\ BT,\ \mbox{\hyperlink{abseil-cpp_2absl_2hash_2internal_2city__test_8cc_ac54ae397901fe700628cafadea3c5208}{C}});}
\DoxyCodeLine{00302\ \ \ \ \ \textcolor{keyword}{auto}\ lnf\_y\_grad\ =\ \mbox{\hyperlink{OriginalStuff_2tensor__util_8hpp_a30c79fba785f603a86fa02252305fbed}{MakeMatrix}}(\mbox{\hyperlink{structgpt_1_1GPT_a14bf5e1fda2d671ecd3025e9e9e5f343}{lnf\_y\_}}-\/>grad<\mbox{\hyperlink{structgpt_1_1GPT_aa06480989b06f1e40879f71d80eac146}{Type}}>(),\ BT,\ \mbox{\hyperlink{abseil-cpp_2absl_2hash_2internal_2city__test_8cc_ac54ae397901fe700628cafadea3c5208}{C}});}
\DoxyCodeLine{00303\ \ \ \ \ \textcolor{keyword}{auto}\ lm\_head\ =\ \mbox{\hyperlink{OriginalStuff_2tensor__util_8hpp_a30c79fba785f603a86fa02252305fbed}{MakeMatrix}}(\mbox{\hyperlink{structgpt_1_1GPT_a4fd542d25a63acde00f760b56d8904a0}{lm\_head\_}},\ \mbox{\hyperlink{structgpt_1_1GPT_a20f9d20710e9eb109d7697c43ea2972d}{vocab\_size\_}},\ \mbox{\hyperlink{abseil-cpp_2absl_2hash_2internal_2city__test_8cc_ac54ae397901fe700628cafadea3c5208}{C}});}
\DoxyCodeLine{00304\ \ \ \ \ \textcolor{keyword}{auto}\ lm\_head\_grad\ =\ \mbox{\hyperlink{OriginalStuff_2tensor__util_8hpp_a30c79fba785f603a86fa02252305fbed}{MakeMatrix}}(\mbox{\hyperlink{structgpt_1_1GPT_a18157e410bed91a149243fea18be4ad7}{lm\_head\_grad\_}},\ \mbox{\hyperlink{structgpt_1_1GPT_a20f9d20710e9eb109d7697c43ea2972d}{vocab\_size\_}},\ \mbox{\hyperlink{abseil-cpp_2absl_2hash_2internal_2city__test_8cc_ac54ae397901fe700628cafadea3c5208}{C}});}
\DoxyCodeLine{00305\ \ \ \ \ \mbox{\hyperlink{classEigen_1_1array}{Eigen::array<Eigen::IndexPair<int>}},\ 1>\ product\_dims\ =\ \{}
\DoxyCodeLine{00306\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structEigen_1_1IndexPair}{Eigen::IndexPair<int>}}(1,\ 0)\};}
\DoxyCodeLine{00307\ \ \ \ \ \mbox{\hyperlink{classEigen_1_1array}{Eigen::array<Eigen::IndexPair<int>}},\ 1>\ product\_dims2\ =\ \{}
\DoxyCodeLine{00308\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structEigen_1_1IndexPair}{Eigen::IndexPair<int>}}(0,\ 0)\};}
\DoxyCodeLine{00309\ \ \ \ \ lnf\_y\_grad.device(nn::g\_device)\ +=\ logits\_grad\_2d.contract(}
\DoxyCodeLine{00310\ \ \ \ \ \ \ \ \ lm\_head,\ product\_dims);\ \ \textcolor{comment}{//\ [BT,\ vocab\_size]\ x\ [vocab\_size,\ C]}}
\DoxyCodeLine{00311\ \ \ \ \ lm\_head\_grad.device(nn::g\_device)\ +=\ logits\_grad\_2d.contract(}
\DoxyCodeLine{00312\ \ \ \ \ \ \ \ \ lnf\_y,\ product\_dims2);\ \ \textcolor{comment}{//\ [vocab\_size,\ BT]\ x\ [BT,\ C]}}
\DoxyCodeLine{00313\ }
\DoxyCodeLine{00314\ \ \ \ \ \textcolor{comment}{//\ backward\ LNF}}
\DoxyCodeLine{00315\ \ \ \ \ \textcolor{keyword}{auto}\ block\_out\_2d\ =}
\DoxyCodeLine{00316\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{OriginalStuff_2tensor__util_8hpp_ae8e963613cb1e2fe5d606c04433078fe}{MakeConstMatrix}}(\mbox{\hyperlink{structgpt_1_1GPT_a73a8d45df0332bba229766ebd5c3e749}{block\_y\_}}-\/>data<\mbox{\hyperlink{structgpt_1_1GPT_aa06480989b06f1e40879f71d80eac146}{Type}}>()\ +\ (L\ -\/\ 1)\ *\ BTC,\ BT,\ \mbox{\hyperlink{abseil-cpp_2absl_2hash_2internal_2city__test_8cc_ac54ae397901fe700628cafadea3c5208}{C}});}
\DoxyCodeLine{00317\ \ \ \ \ \textcolor{keyword}{auto}\ block\_out\_grad\_2d\ =}
\DoxyCodeLine{00318\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{OriginalStuff_2tensor__util_8hpp_a30c79fba785f603a86fa02252305fbed}{MakeMatrix}}(\mbox{\hyperlink{structgpt_1_1GPT_a73a8d45df0332bba229766ebd5c3e749}{block\_y\_}}-\/>grad<\mbox{\hyperlink{structgpt_1_1GPT_aa06480989b06f1e40879f71d80eac146}{Type}}>()\ +\ (L\ -\/\ 1)\ *\ BTC,\ BT,\ \mbox{\hyperlink{abseil-cpp_2absl_2hash_2internal_2city__test_8cc_ac54ae397901fe700628cafadea3c5208}{C}});}
\DoxyCodeLine{00319\ \ \ \ \ \textcolor{keyword}{auto}\ lnf\_mean\ =\ \mbox{\hyperlink{OriginalStuff_2tensor__util_8hpp_a21ac3a103525fe44360b799a17466f7c}{MakeConstFlat}}(\mbox{\hyperlink{structgpt_1_1GPT_a81d6413e95fec933746f12324da38c10}{lnf\_mean\_}}-\/>data<\mbox{\hyperlink{structgpt_1_1GPT_aa06480989b06f1e40879f71d80eac146}{Type}}>(),\ BT);}
\DoxyCodeLine{00320\ \ \ \ \ \textcolor{keyword}{auto}\ lnf\_rstd\ =\ \mbox{\hyperlink{OriginalStuff_2tensor__util_8hpp_a21ac3a103525fe44360b799a17466f7c}{MakeConstFlat}}(\mbox{\hyperlink{structgpt_1_1GPT_a31e5d5938dcd8e8af12dcbf68180ca11}{lnf\_rstd\_}}-\/>data<\mbox{\hyperlink{structgpt_1_1GPT_aa06480989b06f1e40879f71d80eac146}{Type}}>(),\ BT);}
\DoxyCodeLine{00321\ \ \ \ \ \textcolor{keyword}{auto}\ lnf\_y\_grad\_2d\ =\ \mbox{\hyperlink{OriginalStuff_2tensor__util_8hpp_ae8e963613cb1e2fe5d606c04433078fe}{MakeConstMatrix}}(\mbox{\hyperlink{structgpt_1_1GPT_a14bf5e1fda2d671ecd3025e9e9e5f343}{lnf\_y\_}}-\/>grad<\mbox{\hyperlink{structgpt_1_1GPT_aa06480989b06f1e40879f71d80eac146}{Type}}>(),\ BT,\ \mbox{\hyperlink{abseil-cpp_2absl_2hash_2internal_2city__test_8cc_ac54ae397901fe700628cafadea3c5208}{C}});}
\DoxyCodeLine{00322\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_af8622f274fd219c42682c4206bd4604f}{lnf\_}}-\/>Backward(block\_out\_2d,\ lnf\_y\_grad\_2d,\ lnf\_mean,\ lnf\_rstd,}
\DoxyCodeLine{00323\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ block\_out\_grad\_2d);}
\DoxyCodeLine{00324\ }
\DoxyCodeLine{00325\ \ \ \ \ \textcolor{comment}{//\ backward\ blocks}}
\DoxyCodeLine{00326\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ l\ =\ \mbox{\hyperlink{structgpt_1_1GPT_a45a132e3d5c28a298d366b89afa2c48a}{n\_layer\_}}\ -\/\ 1;\ l\ >=\ 0;\ -\/-\/l)\ \{}
\DoxyCodeLine{00327\ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keyword}{auto}\&\ \mbox{\hyperlink{eigen_2Eigen_2src_2plugins_2BlockMethods_8h_ad90ae68615512ea2a9c7056ef1b34f13}{block}}\ =\ \mbox{\hyperlink{structgpt_1_1GPT_a3843d239a6a2fe0e12a5ff507ca05634}{h\_}}[l];}
\DoxyCodeLine{00328\ \ \ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_aa06480989b06f1e40879f71d80eac146}{Type}}*\ x\ =\ l\ ==\ 0\ ?\ \mbox{\hyperlink{structgpt_1_1GPT_aeadbf840cc499afb9ee402defb27f893}{encoded\_}}-\/>data<\mbox{\hyperlink{structgpt_1_1GPT_aa06480989b06f1e40879f71d80eac146}{Type}}>()}
\DoxyCodeLine{00329\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ :\ \mbox{\hyperlink{structgpt_1_1GPT_a73a8d45df0332bba229766ebd5c3e749}{block\_y\_}}-\/>data<\mbox{\hyperlink{structgpt_1_1GPT_aa06480989b06f1e40879f71d80eac146}{Type}}>()\ +\ (l\ -\/\ 1)\ *\ BTC;}
\DoxyCodeLine{00330\ \ \ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_aa06480989b06f1e40879f71d80eac146}{Type}}*\ x\_grad\ =\ l\ ==\ 0\ ?\ \mbox{\hyperlink{structgpt_1_1GPT_aeadbf840cc499afb9ee402defb27f893}{encoded\_}}-\/>grad<\mbox{\hyperlink{structgpt_1_1GPT_aa06480989b06f1e40879f71d80eac146}{Type}}>()}
\DoxyCodeLine{00331\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ :\ \mbox{\hyperlink{structgpt_1_1GPT_a73a8d45df0332bba229766ebd5c3e749}{block\_y\_}}-\/>grad<\mbox{\hyperlink{structgpt_1_1GPT_aa06480989b06f1e40879f71d80eac146}{Type}}>()\ +\ (l\ -\/\ 1)\ *\ BTC;}
\DoxyCodeLine{00332\ \ \ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_aa06480989b06f1e40879f71d80eac146}{Type}}*\ y\_grad\ =\ \mbox{\hyperlink{structgpt_1_1GPT_a73a8d45df0332bba229766ebd5c3e749}{block\_y\_}}-\/>grad<\mbox{\hyperlink{structgpt_1_1GPT_aa06480989b06f1e40879f71d80eac146}{Type}}>()\ +\ l\ *\ BTC;}
\DoxyCodeLine{00333\ \ \ \ \ \ \ \textcolor{keyword}{auto}\ block\_x\_3d\ =\ \mbox{\hyperlink{OriginalStuff_2tensor__util_8hpp_a83376511964dada7d9134ac8a54a4c99}{MakeConst3DTensor}}(x,\ B,\ T,\ \mbox{\hyperlink{abseil-cpp_2absl_2hash_2internal_2city__test_8cc_ac54ae397901fe700628cafadea3c5208}{C}});}
\DoxyCodeLine{00334\ \ \ \ \ \ \ \textcolor{keyword}{auto}\ block\_x\_grad\_3d\ =\ \mbox{\hyperlink{OriginalStuff_2tensor__util_8hpp_a3bde9957ede93fa72beb44296e6ce586}{Make3DTensor}}(x\_grad,\ B,\ T,\ \mbox{\hyperlink{abseil-cpp_2absl_2hash_2internal_2city__test_8cc_ac54ae397901fe700628cafadea3c5208}{C}});}
\DoxyCodeLine{00335\ \ \ \ \ \ \ \textcolor{keyword}{auto}\ block\_y\_grad\_3d\ =\ \mbox{\hyperlink{OriginalStuff_2tensor__util_8hpp_a83376511964dada7d9134ac8a54a4c99}{MakeConst3DTensor}}(y\_grad,\ B,\ T,\ \mbox{\hyperlink{abseil-cpp_2absl_2hash_2internal_2city__test_8cc_ac54ae397901fe700628cafadea3c5208}{C}});}
\DoxyCodeLine{00336\ \ \ \ \ \ \ \mbox{\hyperlink{eigen_2Eigen_2src_2plugins_2BlockMethods_8h_ad90ae68615512ea2a9c7056ef1b34f13}{block}}-\/>Backward(block\_x\_3d,\ block\_y\_grad\_3d,\ block\_x\_grad\_3d);}
\DoxyCodeLine{00337\ \ \ \ \ \}}
\DoxyCodeLine{00338\ }
\DoxyCodeLine{00339\ \ \ \ \ \textcolor{comment}{//\ backward\ tok\_emb,\ pos\_emb}}
\DoxyCodeLine{00340\ \ \ \ \ \textcolor{keyword}{auto}\ encoded\_grad\ =\ \mbox{\hyperlink{structgpt_1_1GPT_aeadbf840cc499afb9ee402defb27f893}{encoded\_}}-\/>matrix\_grad<\mbox{\hyperlink{structgpt_1_1GPT_aa06480989b06f1e40879f71d80eac146}{Type}}>(B,\ TC);}
\DoxyCodeLine{00341\ \ \ \ \ \textcolor{keyword}{auto}\ tok\_emb\_grad\ =\ \mbox{\hyperlink{structgpt_1_1GPT_aece01b5b72549c59be1d633ba1a5a511}{tok\_emb\_}}-\/>matrix\_grad<\mbox{\hyperlink{structgpt_1_1GPT_aa06480989b06f1e40879f71d80eac146}{Type}}>(B,\ TC);}
\DoxyCodeLine{00342\ \ \ \ \ \textcolor{keyword}{auto}\ pos\_emb\_grad\ =\ \mbox{\hyperlink{structgpt_1_1GPT_a2a90aeebc5b632203bf023f72b044ef5}{pos\_emb\_}}-\/>flat\_grad<\mbox{\hyperlink{structgpt_1_1GPT_aa06480989b06f1e40879f71d80eac146}{Type}}>();}
\DoxyCodeLine{00343\ \ \ \ \ \mbox{\hyperlink{classEigen_1_1array}{Eigen::array<Eigen::Index,\ 1>}}\ along\_batch\ =\ \{0\};}
\DoxyCodeLine{00344\ \ \ \ \ tok\_emb\_grad.device(nn::g\_device)\ =\ encoded\_grad;}
\DoxyCodeLine{00345\ \ \ \ \ pos\_emb\_grad.device(nn::g\_device)\ =\ tok\_emb\_grad.sum(along\_batch);}
\DoxyCodeLine{00346\ }
\DoxyCodeLine{00347\ \ \ \ \ \textcolor{comment}{//\ backward\ wte,\ wpe}}
\DoxyCodeLine{00348\ \ \ \ \ std::vector<int>\ pos(T);}
\DoxyCodeLine{00349\ \ \ \ \ std::iota(pos.begin(),\ pos.end(),\ 0);}
\DoxyCodeLine{00350\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_a1d33d297064a0067cf649803aad7d554}{wte\_}}-\/>Backward(idx,\ tok\_emb\_grad);}
\DoxyCodeLine{00351\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_a81b3dd21d79017024bb0ee078d40e2de}{wpe\_}}-\/>Backward(pos,\ pos\_emb\_grad);}
\DoxyCodeLine{00352\ \ \ \}}
\DoxyCodeLine{00353\ }
\DoxyCodeLine{00354\ \ \ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{structgpt_1_1GPT_ac72a9176635dc436b44761ae36705a76}{NumParameters}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00355\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ num\_parameters\ =\ 0;}
\DoxyCodeLine{00356\ \ \ \ \ num\_parameters\ +=\ \mbox{\hyperlink{structgpt_1_1GPT_a1d33d297064a0067cf649803aad7d554}{wte\_}}-\/>NumParameters();}
\DoxyCodeLine{00357\ \ \ \ \ num\_parameters\ +=\ \mbox{\hyperlink{structgpt_1_1GPT_a81b3dd21d79017024bb0ee078d40e2de}{wpe\_}}-\/>NumParameters();}
\DoxyCodeLine{00358\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keyword}{const}\ \textcolor{keyword}{auto}\&\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2layout__test_8cc_ad66453096871179e6c6effe0df4b483b}{b}}\ :\ \mbox{\hyperlink{structgpt_1_1GPT_a3843d239a6a2fe0e12a5ff507ca05634}{h\_}})\ \{}
\DoxyCodeLine{00359\ \ \ \ \ \ \ num\_parameters\ +=\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2layout__test_8cc_ad66453096871179e6c6effe0df4b483b}{b}}-\/>NumParameters();}
\DoxyCodeLine{00360\ \ \ \ \ \}}
\DoxyCodeLine{00361\ \ \ \ \ num\_parameters\ +=\ \mbox{\hyperlink{structgpt_1_1GPT_af8622f274fd219c42682c4206bd4604f}{lnf\_}}-\/>NumParameters();}
\DoxyCodeLine{00362\ \ \ \ \ \textcolor{keywordflow}{return}\ num\_parameters;}
\DoxyCodeLine{00363\ \ \ \}}
\DoxyCodeLine{00364\ }
\DoxyCodeLine{00365\ \ \ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{structgpt_1_1GPT_a8588c63954708791205cbe8e4ef2d961}{NumActivations}}()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00366\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ num\_activations\ =\ 0;}
\DoxyCodeLine{00367\ \ \ \ \ num\_activations\ +=\ \mbox{\hyperlink{structgpt_1_1GPT_a1d33d297064a0067cf649803aad7d554}{wte\_}}-\/>NumActivations();}
\DoxyCodeLine{00368\ \ \ \ \ num\_activations\ +=\ \mbox{\hyperlink{structgpt_1_1GPT_a81b3dd21d79017024bb0ee078d40e2de}{wpe\_}}-\/>NumActivations();}
\DoxyCodeLine{00369\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keyword}{const}\ \textcolor{keyword}{auto}\&\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2layout__test_8cc_ad66453096871179e6c6effe0df4b483b}{b}}\ :\ \mbox{\hyperlink{structgpt_1_1GPT_a3843d239a6a2fe0e12a5ff507ca05634}{h\_}})\ \{}
\DoxyCodeLine{00370\ \ \ \ \ \ \ num\_activations\ +=\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2layout__test_8cc_ad66453096871179e6c6effe0df4b483b}{b}}-\/>NumActivations();}
\DoxyCodeLine{00371\ \ \ \ \ \}}
\DoxyCodeLine{00372\ \ \ \ \ num\_activations\ +=\ \mbox{\hyperlink{structgpt_1_1GPT_af8622f274fd219c42682c4206bd4604f}{lnf\_}}-\/>NumActivations();}
\DoxyCodeLine{00373\ \ \ \ \ num\_activations\ +=\ \mbox{\hyperlink{structgpt_1_1GPT_aece01b5b72549c59be1d633ba1a5a511}{tok\_emb\_}}-\/>size();}
\DoxyCodeLine{00374\ \ \ \ \ num\_activations\ +=\ \mbox{\hyperlink{structgpt_1_1GPT_a2a90aeebc5b632203bf023f72b044ef5}{pos\_emb\_}}-\/>size();}
\DoxyCodeLine{00375\ \ \ \ \ num\_activations\ +=\ \mbox{\hyperlink{structgpt_1_1GPT_aeadbf840cc499afb9ee402defb27f893}{encoded\_}}-\/>size();}
\DoxyCodeLine{00376\ \ \ \ \ num\_activations\ +=\ \mbox{\hyperlink{structgpt_1_1GPT_a73a8d45df0332bba229766ebd5c3e749}{block\_y\_}}-\/>size();}
\DoxyCodeLine{00377\ \ \ \ \ num\_activations\ +=\ \mbox{\hyperlink{structgpt_1_1GPT_a14bf5e1fda2d671ecd3025e9e9e5f343}{lnf\_y\_}}-\/>size();}
\DoxyCodeLine{00378\ \ \ \ \ num\_activations\ +=\ \mbox{\hyperlink{structgpt_1_1GPT_a81d6413e95fec933746f12324da38c10}{lnf\_mean\_}}-\/>size();}
\DoxyCodeLine{00379\ \ \ \ \ num\_activations\ +=\ \mbox{\hyperlink{structgpt_1_1GPT_a31e5d5938dcd8e8af12dcbf68180ca11}{lnf\_rstd\_}}-\/>size();}
\DoxyCodeLine{00380\ \textcolor{preprocessor}{\#ifdef\ EIGEN\_USE\_GPU}}
\DoxyCodeLine{00381\ \ \ \ \ num\_activations\ +=\ \mbox{\hyperlink{structgpt_1_1GPT_a8c2f6a7c1296bb3f0c3e876f1fde6b28}{scratch\_}}-\/>size();}
\DoxyCodeLine{00382\ \ \ \ \ num\_activations\ +=\ \mbox{\hyperlink{structgpt_1_1GPT_a2f01b9a7e23c86bec9e7d52b417ff857}{loss\_}}-\/>size();}
\DoxyCodeLine{00383\ \ \ \ \ num\_activations\ +=\ \mbox{\hyperlink{structgpt_1_1GPT_a669ccd15c28a2a6f964679f2a7c91d48}{loss\_mean\_}}-\/>size();}
\DoxyCodeLine{00384\ \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{00385\ \ \ \ \ num\_activations\ +=\ \mbox{\hyperlink{structgpt_1_1GPT_aab4c44eb83493c9b26615e6926c2bada}{probs\_}}-\/>size();}
\DoxyCodeLine{00386\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00387\ \ \ \ \ num\_activations\ +=\ \mbox{\hyperlink{structgpt_1_1GPT_a4453d7eb8ad5cc405dd5a459007e6e7a}{logits\_grad\_}}-\/>size();}
\DoxyCodeLine{00388\ \ \ \ \ \textcolor{keywordflow}{return}\ num\_activations;}
\DoxyCodeLine{00389\ \ \ \}}
\DoxyCodeLine{00390\ }
\DoxyCodeLine{00391\ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{structgpt_1_1GPT_aa8b7d024876c1407b55da1edc56bbce1}{Parameters}}(std::vector<nn::Parameter*>*\ parameters)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00392\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_a1d33d297064a0067cf649803aad7d554}{wte\_}}-\/>Parameters(parameters);}
\DoxyCodeLine{00393\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_a81b3dd21d79017024bb0ee078d40e2de}{wpe\_}}-\/>Parameters(parameters);}
\DoxyCodeLine{00394\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keyword}{const}\ \textcolor{keyword}{auto}\&\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2layout__test_8cc_ad66453096871179e6c6effe0df4b483b}{b}}\ :\ \mbox{\hyperlink{structgpt_1_1GPT_a3843d239a6a2fe0e12a5ff507ca05634}{h\_}})\ \{}
\DoxyCodeLine{00395\ \ \ \ \ \ \ \mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2layout__test_8cc_ad66453096871179e6c6effe0df4b483b}{b}}-\/>Parameters(parameters);}
\DoxyCodeLine{00396\ \ \ \ \ \}}
\DoxyCodeLine{00397\ \ \ \ \ \mbox{\hyperlink{structgpt_1_1GPT_af8622f274fd219c42682c4206bd4604f}{lnf\_}}-\/>Parameters(parameters);}
\DoxyCodeLine{00398\ \ \ \}}
\DoxyCodeLine{00399\ }
\DoxyCodeLine{00400\ \ \textcolor{keyword}{public}:}
\DoxyCodeLine{00401\ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{structgpt_1_1GPT_aedaded26c34b9bc6ab7f81f82e42dee3}{block\_size\_}};}
\DoxyCodeLine{00402\ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{structgpt_1_1GPT_a20f9d20710e9eb109d7697c43ea2972d}{vocab\_size\_}};}
\DoxyCodeLine{00403\ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{structgpt_1_1GPT_ab6320386d6a92b9d0079f161f2c49c60}{padded\_vocab\_size\_}};}
\DoxyCodeLine{00404\ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{structgpt_1_1GPT_a45a132e3d5c28a298d366b89afa2c48a}{n\_layer\_}};}
\DoxyCodeLine{00405\ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{structgpt_1_1GPT_a22dd2badb6ffdd821ff993dda16977e8}{n\_embed\_}};}
\DoxyCodeLine{00406\ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{structgpt_1_1GPT_aa0a22ab376126262bccf08316eb076a9}{n\_head\_}};}
\DoxyCodeLine{00407\ }
\DoxyCodeLine{00408\ \ \ \textcolor{comment}{//\ transformer}}
\DoxyCodeLine{00409\ \ \ std::unique\_ptr<nn::Embedding>\ \mbox{\hyperlink{structgpt_1_1GPT_a1d33d297064a0067cf649803aad7d554}{wte\_}};}
\DoxyCodeLine{00410\ \ \ std::unique\_ptr<nn::Embedding>\ \mbox{\hyperlink{structgpt_1_1GPT_a81b3dd21d79017024bb0ee078d40e2de}{wpe\_}};}
\DoxyCodeLine{00411\ \ \ std::vector<std::unique\_ptr<Block>>\ \mbox{\hyperlink{structgpt_1_1GPT_a3843d239a6a2fe0e12a5ff507ca05634}{h\_}};}
\DoxyCodeLine{00412\ \ \ std::unique\_ptr<nn::LayerNorm>\ \mbox{\hyperlink{structgpt_1_1GPT_af8622f274fd219c42682c4206bd4604f}{lnf\_}};}
\DoxyCodeLine{00413\ \ \ std::unique\_ptr<nn::SoftmaxCrossEntropy>\ \mbox{\hyperlink{structgpt_1_1GPT_a65a6ce0263d55fa9b5182c3a53035055}{softmax\_cross\_entropy\_}};}
\DoxyCodeLine{00414\ }
\DoxyCodeLine{00415\ \ \ \textcolor{comment}{//\ head}}
\DoxyCodeLine{00416\ \ \ std::unique\_ptr<nn::Linear>\ \mbox{\hyperlink{structgpt_1_1GPT_ab46fc21fad97de05f7c1a2446e64aac6}{lm\_head\_unused\_}};}
\DoxyCodeLine{00417\ \ \ \mbox{\hyperlink{structgpt_1_1GPT_aa06480989b06f1e40879f71d80eac146}{Type}}\ *\mbox{\hyperlink{structgpt_1_1GPT_a4fd542d25a63acde00f760b56d8904a0}{lm\_head\_}},\ *\mbox{\hyperlink{structgpt_1_1GPT_a18157e410bed91a149243fea18be4ad7}{lm\_head\_grad\_}};\ \ \textcolor{comment}{//\ [vocal\_size,\ C]}}
\DoxyCodeLine{00418\ }
\DoxyCodeLine{00419\ \ \ \textcolor{comment}{//\ activation\ tensors\ and\ gradients}}
\DoxyCodeLine{00420\ \ \ std::unique\_ptr<nn::Activation>\ \mbox{\hyperlink{structgpt_1_1GPT_aece01b5b72549c59be1d633ba1a5a511}{tok\_emb\_}};\ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ [B,\ T,\ C]}}
\DoxyCodeLine{00421\ \ \ std::unique\_ptr<nn::Activation>\ \mbox{\hyperlink{structgpt_1_1GPT_a2a90aeebc5b632203bf023f72b044ef5}{pos\_emb\_}};\ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ [T,\ C]}}
\DoxyCodeLine{00422\ \ \ std::unique\_ptr<nn::Activation>\ \mbox{\hyperlink{structgpt_1_1GPT_aeadbf840cc499afb9ee402defb27f893}{encoded\_}};\ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ [B,\ T,\ C]}}
\DoxyCodeLine{00423\ \ \ std::unique\_ptr<nn::Activation>\ \mbox{\hyperlink{structgpt_1_1GPT_a73a8d45df0332bba229766ebd5c3e749}{block\_y\_}};\ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ [L,\ B,\ T,\ C]}}
\DoxyCodeLine{00424\ \ \ std::unique\_ptr<nn::Activation>\ \mbox{\hyperlink{structgpt_1_1GPT_a14bf5e1fda2d671ecd3025e9e9e5f343}{lnf\_y\_}};\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ [B*T,\ C]}}
\DoxyCodeLine{00425\ \ \ std::unique\_ptr<nn::Activation>\ \mbox{\hyperlink{structgpt_1_1GPT_a81d6413e95fec933746f12324da38c10}{lnf\_mean\_}},\ \mbox{\hyperlink{structgpt_1_1GPT_a31e5d5938dcd8e8af12dcbf68180ca11}{lnf\_rstd\_}};\ \ \textcolor{comment}{//\ [B*T]}}
\DoxyCodeLine{00426\ \ \ std::unique\_ptr<nn::Activation>\ \mbox{\hyperlink{structgpt_1_1GPT_aab4c44eb83493c9b26615e6926c2bada}{probs\_}};\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ [B*T,\ vocab\_size]}}
\DoxyCodeLine{00427\ \ \ std::unique\_ptr<nn::Activation>\ \mbox{\hyperlink{structgpt_1_1GPT_a8c2f6a7c1296bb3f0c3e876f1fde6b28}{scratch\_}};\ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ [B*T]}}
\DoxyCodeLine{00428\ \ \ std::unique\_ptr<nn::Activation>\ \mbox{\hyperlink{structgpt_1_1GPT_a2f01b9a7e23c86bec9e7d52b417ff857}{loss\_}};\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ [B*T]}}
\DoxyCodeLine{00429\ \ \ std::unique\_ptr<nn::Activation>\ \mbox{\hyperlink{structgpt_1_1GPT_a669ccd15c28a2a6f964679f2a7c91d48}{loss\_mean\_}};\ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ [1]}}
\DoxyCodeLine{00430\ \ \ std::unique\_ptr<nn::Activation>\ \mbox{\hyperlink{structgpt_1_1GPT_a4453d7eb8ad5cc405dd5a459007e6e7a}{logits\_grad\_}};\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ [B*T,\ vocab\_size]}}
\DoxyCodeLine{00431\ \};}
\DoxyCodeLine{00432\ }
\DoxyCodeLine{00433\ \}\ \ \textcolor{comment}{//\ namespace\ gpt}}
\DoxyCodeLine{00434\ }
\DoxyCodeLine{00435\ \textcolor{preprocessor}{\#endif\ \ }\textcolor{comment}{//\ LLM\_CPP\_\_GPT\_HPP\_}}

\end{DoxyCode}
