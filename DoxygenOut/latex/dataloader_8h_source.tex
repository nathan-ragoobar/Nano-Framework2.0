\doxysection{dataloader.\+h}
\hypertarget{dataloader_8h_source}{}\label{dataloader_8h_source}\index{llmc/dataloader.h@{llmc/dataloader.h}}
\mbox{\hyperlink{dataloader_8h}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{comment}{/*}}
\DoxyCodeLine{00002\ \textcolor{comment}{Implements:}}
\DoxyCodeLine{00003\ \textcolor{comment}{-\/\ DataLoader\ for\ model\ training.\ Reads\ and\ serves\ data\ shards.}}
\DoxyCodeLine{00004\ \textcolor{comment}{-\/\ EvalLoader\ for\ multiple-\/choice\ evaluation\ datasets,\ e.g.\ HellaSwag.}}
\DoxyCodeLine{00005\ \textcolor{comment}{*/}}
\DoxyCodeLine{00006\ \textcolor{preprocessor}{\#ifndef\ DATALOADER\_H}}
\DoxyCodeLine{00007\ \textcolor{preprocessor}{\#define\ DATALOADER\_H}}
\DoxyCodeLine{00008\ }
\DoxyCodeLine{00009\ \textcolor{preprocessor}{\#include\ <stdio.h>}}
\DoxyCodeLine{00010\ \textcolor{preprocessor}{\#include\ <stdlib.h>}}
\DoxyCodeLine{00011\ \textcolor{preprocessor}{\#include\ <stddef.h>}}
\DoxyCodeLine{00012\ \textcolor{preprocessor}{\#include\ <stdint.h>}}
\DoxyCodeLine{00013\ \textcolor{preprocessor}{\#include\ <assert.h>}}
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ <string.h>}}
\DoxyCodeLine{00015\ \textcolor{comment}{//\ defines:\ fopenCheck,\ freadCheck,\ fcloseCheck,\ fseekCheck}}
\DoxyCodeLine{00016\ \textcolor{comment}{//\ defines:\ mallocCheck}}
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{utils_8h}{utils.h}}"{}}}
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{rand_8h}{rand.h}}"{}}}
\DoxyCodeLine{00019\ }
\DoxyCodeLine{00020\ \textcolor{comment}{//\ -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{00021\ \textcolor{comment}{//\ implementation\ of\ glob\ for\ Windows\ is\ in\ dev/unistd.h}}
\DoxyCodeLine{00022\ \textcolor{preprocessor}{\#ifndef\ \_WIN32}}
\DoxyCodeLine{00023\ \textcolor{preprocessor}{\#include\ <glob.h>}}
\DoxyCodeLine{00024\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00025\ \textcolor{comment}{//\ -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{00026\ \textcolor{comment}{//\ Distributed\ Data\ Loader}}
\DoxyCodeLine{00027\ \textcolor{preprocessor}{\#define\ HEADER\_SIZE\ 256}}
\DoxyCodeLine{00028\ }
\DoxyCodeLine{00029\ \textcolor{keyword}{typedef}\ \textcolor{keyword}{struct\ }\{}
\DoxyCodeLine{00030\ \ \ \ \ \textcolor{comment}{//\ variables\ related\ to\ distributed\ training}}
\DoxyCodeLine{00031\ \ \ \ \ \textcolor{comment}{//\ each\ process/worker\ has\ to\ access\ different\ parts\ of\ the\ data}}
\DoxyCodeLine{00032\ \ \ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{structDataLoader_af452253ebc477bfdd7bec90d37ca42d1}{process\_rank}};}
\DoxyCodeLine{00033\ \ \ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{structDataLoader_ac838423b62a575a38fd52863e674984b}{num\_processes}};}
\DoxyCodeLine{00034\ \ \ \ \ \textcolor{comment}{//\ batch\ and\ token\ information}}
\DoxyCodeLine{00035\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{structDataLoader_a3cf90dc304aca48ea04ae320a3058fa1}{B}};}
\DoxyCodeLine{00036\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{structDataLoader_a78497c10f1776ac80a8e8b1db5f625ed}{T}};}
\DoxyCodeLine{00037\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{structDataLoader_a46db9928324b5dfcb6f57ed49232fbcf}{num\_tokens}};\ \textcolor{comment}{//\ total\ number\ of\ tokens}}
\DoxyCodeLine{00038\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{structDataLoader_a8949677b4594ec0f95ad4da1d916ca06}{shard\_num\_samples}};\ \ \textcolor{comment}{//\ total\ number\ of\ samples\ in\ the\ current\ shard\ per\ process}}
\DoxyCodeLine{00039\ \ \ \ \ \textcolor{comment}{//\ shards\ and\ current\ position}}
\DoxyCodeLine{00040\ \ \ \ \ \mbox{\hyperlink{structglob__t}{glob\_t}}\ \mbox{\hyperlink{structDataLoader_afae827721797302163cf68deebe0b79e}{glob\_result}};\ \textcolor{comment}{//\ stores\ the\ result\ of\ glob,\ for\ all\ shards\ we\ want\ to\ iterate}}
\DoxyCodeLine{00041\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{structDataLoader_a278db1212b380c38165639883fae3ae0}{current\_shard\_idx}};\ \textcolor{comment}{//\ the\ current\ shard\ we\ are\ reading\ from}}
\DoxyCodeLine{00042\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{structDataLoader_a7cc34e3ea9ce0b6c84cc0be3b408e6a3}{current\_sample\_idx}};\ \textcolor{comment}{//\ the\ current\ sample\ we\ are\ reading\ from}}
\DoxyCodeLine{00043\ \ \ \ \ \textcolor{comment}{//\ file\ handle}}
\DoxyCodeLine{00044\ \ \ \ \ FILE*\ \mbox{\hyperlink{structDataLoader_a877ed4895bc221a296d8ee3251a18455}{tokens\_file}};}
\DoxyCodeLine{00045\ \ \ \ \ \textcolor{comment}{//\ data\ buffers}}
\DoxyCodeLine{00046\ \ \ \ \ uint16\_t*\ \mbox{\hyperlink{structDataLoader_a102d2e37ae57b1eada10276401fe9488}{buffer}};\ \textcolor{comment}{//\ we\ fread\ data\ from\ file\ into\ this\ buffer}}
\DoxyCodeLine{00047\ \ \ \ \ \textcolor{keywordtype}{int}*\ \mbox{\hyperlink{structDataLoader_addb81ffafbdf852bd69b9a259ab1a811}{inputs}};\ \ \textcolor{comment}{//\ input\ tokens\ into\ transformer}}
\DoxyCodeLine{00048\ \ \ \ \ \textcolor{keywordtype}{int}*\ \mbox{\hyperlink{structDataLoader_acd7a7e28f774e675beb63b6805d5820a}{targets}};\ \textcolor{comment}{//\ target\ tokens\ for\ the\ transformer}}
\DoxyCodeLine{00049\ \ \ \ \ \textcolor{comment}{//\ random\ shuffle\ related\ variables}}
\DoxyCodeLine{00050\ \ \ \ \ \mbox{\hyperlink{structmt19937__state}{mt19937\_state}}\ \mbox{\hyperlink{structDataLoader_a6c015456e9da430129711cd1182ba0d7}{shuffle\_rng}};}
\DoxyCodeLine{00051\ \ \ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{structDataLoader_a3173c188e5f09e5ef655be5c586e866c}{should\_shuffle}};}
\DoxyCodeLine{00052\ \ \ \ \ \textcolor{keywordtype}{int}*\ \mbox{\hyperlink{structDataLoader_acdf036d26535a9ce4a47afe81708bf9e}{shard\_indices}};}
\DoxyCodeLine{00053\ \ \ \ \ \textcolor{keywordtype}{int}*\ \mbox{\hyperlink{structDataLoader_a5f4f74dcb7add8d6c2fef15126e72b26}{intra\_shard\_indices}};}
\DoxyCodeLine{00054\ \ \ \ \ \textcolor{comment}{//\ sizes\ in\ bytes}}
\DoxyCodeLine{00055\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{structDataLoader_aa45f820d91771ee23a12f27f83de7144}{total\_batch\_size\_bytes}};\ \ \textcolor{comment}{//\ total\ across\ all\ processes}}
\DoxyCodeLine{00056\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{structDataLoader_aa414c5a381d1153520ba382c611c11ed}{local\_batch\_offset\_bytes}};\ \ \textcolor{comment}{//\ inner-\/sample\ offset\ for\ this\ process}}
\DoxyCodeLine{00057\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{structDataLoader_ac9d6078b92d09daa8252a3e994d41be3}{header\_bytes}};\ \ \textcolor{comment}{//\ header\ size\ in\ bytes}}
\DoxyCodeLine{00058\ \ \ \ \ int64\_t\ \mbox{\hyperlink{structDataLoader_a832cac3db83274c1feaa946826c32fee}{file\_size\_bytes}};}
\DoxyCodeLine{00059\ \}\ \mbox{\hyperlink{structDataLoader}{DataLoader}};}
\DoxyCodeLine{00060\ }
\DoxyCodeLine{00061\ int64\_t\ \mbox{\hyperlink{dataloader_8h_a7ae273eccfc903dd524292275416b9f0}{dataloader\_load\_shard\_}}(\mbox{\hyperlink{structDataLoader}{DataLoader}}\ *loader,\ \textcolor{keywordtype}{int}\ shard\_index)\ \{}
\DoxyCodeLine{00062\ \ \ \ \ \textcolor{keywordflow}{if}\ (loader-\/>\mbox{\hyperlink{structDataLoader_a3173c188e5f09e5ef655be5c586e866c}{should\_shuffle}})\ \{}
\DoxyCodeLine{00063\ \ \ \ \ \ \ \ \ shard\_index\ =\ loader-\/>\mbox{\hyperlink{structDataLoader_acdf036d26535a9ce4a47afe81708bf9e}{shard\_indices}}[shard\_index];}
\DoxyCodeLine{00064\ \ \ \ \ \}}
\DoxyCodeLine{00065\ \ \ \ \ \textcolor{comment}{//\ use\ the\ first\ glob\ match\ as\ the\ filename\ for\ now}}
\DoxyCodeLine{00066\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}*\ filename\ =\ loader-\/>\mbox{\hyperlink{structDataLoader_afae827721797302163cf68deebe0b79e}{glob\_result}}.\mbox{\hyperlink{structglob__t_abd9ba3e5bd7a4767af2cd3dd98a2a64f}{gl\_pathv}}[shard\_index];}
\DoxyCodeLine{00067\ \ \ \ \ \textcolor{comment}{//\ open\ the\ input\ file\ for\ reading.\ also\ only\ a\ single\ file\ can\ be\ opened\ at\ a\ time}}
\DoxyCodeLine{00068\ \ \ \ \ \textcolor{keywordflow}{if}\ (loader-\/>\mbox{\hyperlink{structDataLoader_a877ed4895bc221a296d8ee3251a18455}{tokens\_file}}\ !=\ NULL)\ \{}
\DoxyCodeLine{00069\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{utils_8h_ae094d98ede0500b8f5acba043487a5c1}{fcloseCheck}}(loader-\/>\mbox{\hyperlink{structDataLoader_a877ed4895bc221a296d8ee3251a18455}{tokens\_file}});}
\DoxyCodeLine{00070\ \ \ \ \ \}}
\DoxyCodeLine{00071\ \ \ \ \ loader-\/>\mbox{\hyperlink{structDataLoader_a877ed4895bc221a296d8ee3251a18455}{tokens\_file}}\ =\ \mbox{\hyperlink{utils_8h_a4d8fc8875786ef36e2c339e79f8b250b}{fopenCheck}}(filename,\ \textcolor{stringliteral}{"{}rb"{}});}
\DoxyCodeLine{00072\ \ \ \ \ \textcolor{comment}{//\ validate\ the\ header}}
\DoxyCodeLine{00073\ \ \ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{abseil-cpp_2absl_2base_2internal_2low__level__alloc_8cc_a85861428b812bc81bc5362c43c423cbd}{header}}[\mbox{\hyperlink{dataloader_8h_a49999be01380f41cc0d0f1f1406fb277}{HEADER\_SIZE}}];}
\DoxyCodeLine{00074\ \ \ \ \ \mbox{\hyperlink{utils_8h_aeaeb423fa1a9bddb0cf4c1e0120b09ee}{freadCheck}}(\mbox{\hyperlink{abseil-cpp_2absl_2base_2internal_2low__level__alloc_8cc_a85861428b812bc81bc5362c43c423cbd}{header}},\ \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{int}),\ \mbox{\hyperlink{dataloader_8h_a49999be01380f41cc0d0f1f1406fb277}{HEADER\_SIZE}},\ loader-\/>\mbox{\hyperlink{structDataLoader_a877ed4895bc221a296d8ee3251a18455}{tokens\_file}});}
\DoxyCodeLine{00075\ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{abseil-cpp_2absl_2base_2internal_2low__level__alloc_8cc_a85861428b812bc81bc5362c43c423cbd}{header}}[0]\ !=\ 20240520)\ \{}
\DoxyCodeLine{00076\ \ \ \ \ \ \ \ \ printf(\textcolor{stringliteral}{"{}Bad\ magic\ in\ the\ data\ file\(\backslash\)n"{}});}
\DoxyCodeLine{00077\ \ \ \ \ \ \ \ \ printf(\textcolor{stringliteral}{"{}-\/-\/-\/>\ HINT:\ Are\ you\ passing\ in\ a\ correct\ file?\(\backslash\)n"{}});}
\DoxyCodeLine{00078\ \ \ \ \ \ \ \ \ printf(\textcolor{stringliteral}{"{}-\/-\/-\/>\ HINT:\ The\ data\ encoding\ may\ have\ changed,\ re-\/run\ data\ prepro\ or\ refer\ again\ to\ README.\(\backslash\)n"{}});}
\DoxyCodeLine{00079\ \ \ \ \ \ \ \ \ exit(EXIT\_FAILURE);}
\DoxyCodeLine{00080\ \ \ \ \ \}}
\DoxyCodeLine{00081\ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{abseil-cpp_2absl_2base_2internal_2low__level__alloc_8cc_a85861428b812bc81bc5362c43c423cbd}{header}}[1]\ !=\ 1)\ \{\ printf(\textcolor{stringliteral}{"{}Bad\ version\ in\ data\ file\(\backslash\)n"{}});\ exit(EXIT\_FAILURE);\ \}}
\DoxyCodeLine{00082\ \ \ \ \ int64\_t\ ntok\ =\ \mbox{\hyperlink{abseil-cpp_2absl_2base_2internal_2low__level__alloc_8cc_a85861428b812bc81bc5362c43c423cbd}{header}}[2];\ \textcolor{comment}{//\ number\ of\ tokens\ in\ the\ file}}
\DoxyCodeLine{00083\ \ \ \ \ assert(ntok\ >\ 0);\ \textcolor{comment}{//\ we\ expect\ some\ tokens\ in\ the\ file.\ this\ should\ never\ trip,\ right?}}
\DoxyCodeLine{00084\ \ \ \ \ \textcolor{comment}{//\ determine\ the\ file\ size\ and\ make\ sure\ it\ is\ consistent\ with\ the\ number\ of\ tokens}}
\DoxyCodeLine{00085\ \ \ \ \ \mbox{\hyperlink{utils_8h_ae1d2c0807b921b9544a6d253ccb7aadf}{fseekCheck}}(loader-\/>\mbox{\hyperlink{structDataLoader_a877ed4895bc221a296d8ee3251a18455}{tokens\_file}},\ 0,\ SEEK\_END);\ \textcolor{comment}{//\ seek\ to\ end\ of\ file}}
\DoxyCodeLine{00086\ \ \ \ \ loader-\/>\mbox{\hyperlink{structDataLoader_a832cac3db83274c1feaa946826c32fee}{file\_size\_bytes}}\ =\ ftell(loader-\/>\mbox{\hyperlink{structDataLoader_a877ed4895bc221a296d8ee3251a18455}{tokens\_file}});\ \textcolor{comment}{//\ read\ the\ offset,\ i.e.\ file\ size}}
\DoxyCodeLine{00087\ \ \ \ \ \mbox{\hyperlink{utils_8h_ae1d2c0807b921b9544a6d253ccb7aadf}{fseekCheck}}(loader-\/>\mbox{\hyperlink{structDataLoader_a877ed4895bc221a296d8ee3251a18455}{tokens\_file}},\ 0,\ SEEK\_SET);\ \textcolor{comment}{//\ seek\ back\ to\ the\ beginning}}
\DoxyCodeLine{00088\ \ \ \ \ \textcolor{comment}{//\ we\ expect\ ntok\ in\ the\ file\ to\ be\ consistent\ with\ filesize,\ assert\ that\ is\ the\ case}}
\DoxyCodeLine{00089\ \ \ \ \ int64\_t\ expected\_file\_size\ =\ \mbox{\hyperlink{dataloader_8h_a49999be01380f41cc0d0f1f1406fb277}{HEADER\_SIZE}}\ *\ \textcolor{keyword}{sizeof}(int)\ +\ ntok\ *\ \textcolor{keyword}{sizeof}(uint16\_t);}
\DoxyCodeLine{00090\ \ \ \ \ \textcolor{keywordflow}{if}\ (loader-\/>\mbox{\hyperlink{structDataLoader_a832cac3db83274c1feaa946826c32fee}{file\_size\_bytes}}\ !=\ expected\_file\_size)\ \{}
\DoxyCodeLine{00091\ \ \ \ \ \ \ \ \ printf(\textcolor{stringliteral}{"{}Error:\ file\ size\ is\ not\ as\ expected\(\backslash\)n"{}});}
\DoxyCodeLine{00092\ \ \ \ \ \ \ \ \ exit(EXIT\_FAILURE);}
\DoxyCodeLine{00093\ \ \ \ \ \}}
\DoxyCodeLine{00094\ \ \ \ \ \textcolor{comment}{//\ -\/1\ uint16\_t\ due\ to\ us\ taking\ B*T+1\ tokens\ but\ moving\ by\ B*T\ tokens}}
\DoxyCodeLine{00095\ \ \ \ \ loader-\/>\mbox{\hyperlink{structDataLoader_a8949677b4594ec0f95ad4da1d916ca06}{shard\_num\_samples}}\ =\ (ntok\ *\ \textcolor{keyword}{sizeof}(uint16\_t)\ -\/\ \textcolor{keyword}{sizeof}(uint16\_t))\ /\ loader-\/>\mbox{\hyperlink{structDataLoader_aa45f820d91771ee23a12f27f83de7144}{total\_batch\_size\_bytes}};}
\DoxyCodeLine{00096\ \ \ \ \ \textcolor{keywordflow}{return}\ ntok;}
\DoxyCodeLine{00097\ \}}
\DoxyCodeLine{00098\ }
\DoxyCodeLine{00099\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{dataloader_8h_a9e916c128dcf2f87c8736d3611f5f9f8}{prepare\_intra\_shard\_indices\_}}(\mbox{\hyperlink{structDataLoader}{DataLoader}}\ *loader)\ \{}
\DoxyCodeLine{00100\ \ \ \ \ \textcolor{comment}{//\ shuffle\ the\ examples\ inside\ the\ shards}}
\DoxyCodeLine{00101\ \ \ \ \ \textcolor{keywordflow}{if}\ (loader-\/>\mbox{\hyperlink{structDataLoader_a5f4f74dcb7add8d6c2fef15126e72b26}{intra\_shard\_indices}}\ !=\ NULL)\ \{}
\DoxyCodeLine{00102\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ in\ case\ shards\ have\ different\ number\ of\ samples\ /\ sizes}}
\DoxyCodeLine{00103\ \ \ \ \ \ \ \ \ free(loader-\/>\mbox{\hyperlink{structDataLoader_a5f4f74dcb7add8d6c2fef15126e72b26}{intra\_shard\_indices}});}
\DoxyCodeLine{00104\ \ \ \ \ \}}
\DoxyCodeLine{00105\ \ \ \ \ loader-\/>\mbox{\hyperlink{structDataLoader_a5f4f74dcb7add8d6c2fef15126e72b26}{intra\_shard\_indices}}\ =\ (\textcolor{keywordtype}{int}*)\mbox{\hyperlink{utils_8h_a4be764aabd56cde98ff89be72c51a128}{mallocCheck}}(loader-\/>\mbox{\hyperlink{structDataLoader_a8949677b4594ec0f95ad4da1d916ca06}{shard\_num\_samples}}\ *\ \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{int}));}
\DoxyCodeLine{00106\ \ \ \ \ \mbox{\hyperlink{rand_8h_a482d97a202658d17d5a9617b7f881890}{init\_identity\_permutation}}(loader-\/>\mbox{\hyperlink{structDataLoader_a5f4f74dcb7add8d6c2fef15126e72b26}{intra\_shard\_indices}},\ (\textcolor{keywordtype}{int})\ loader-\/>\mbox{\hyperlink{structDataLoader_a8949677b4594ec0f95ad4da1d916ca06}{shard\_num\_samples}});}
\DoxyCodeLine{00107\ \ \ \ \ \mbox{\hyperlink{rand_8h_a43def54c41aa25f3bfc5180bfa09c7fc}{random\_permutation}}(loader-\/>\mbox{\hyperlink{structDataLoader_a5f4f74dcb7add8d6c2fef15126e72b26}{intra\_shard\_indices}},\ (\textcolor{keywordtype}{int})\ loader-\/>\mbox{\hyperlink{structDataLoader_a8949677b4594ec0f95ad4da1d916ca06}{shard\_num\_samples}},\ \&loader-\/>\mbox{\hyperlink{structDataLoader_a6c015456e9da430129711cd1182ba0d7}{shuffle\_rng}});}
\DoxyCodeLine{00108\ \}}
\DoxyCodeLine{00109\ }
\DoxyCodeLine{00110\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{dataloader_8h_a1bb9a04805e319b0d5bbed3c1dd73013}{dataloader\_reset}}(\mbox{\hyperlink{structDataLoader}{DataLoader}}\ *loader)\ \{}
\DoxyCodeLine{00111\ \ \ \ \ loader-\/>\mbox{\hyperlink{structDataLoader_a278db1212b380c38165639883fae3ae0}{current\_shard\_idx}}\ =\ 0;}
\DoxyCodeLine{00112\ \ \ \ \ loader-\/>\mbox{\hyperlink{structDataLoader_a7cc34e3ea9ce0b6c84cc0be3b408e6a3}{current\_sample\_idx}}\ =\ 0;}
\DoxyCodeLine{00113\ }
\DoxyCodeLine{00114\ \ \ \ \ \textcolor{keywordflow}{if}\ (loader-\/>\mbox{\hyperlink{structDataLoader_a3173c188e5f09e5ef655be5c586e866c}{should\_shuffle}})\ \{\ \ \textcolor{comment}{//\ shuffle\ the\ shards}}
\DoxyCodeLine{00115\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{rand_8h_a43def54c41aa25f3bfc5180bfa09c7fc}{random\_permutation}}(loader-\/>\mbox{\hyperlink{structDataLoader_acdf036d26535a9ce4a47afe81708bf9e}{shard\_indices}},\ (\textcolor{keywordtype}{int})\ loader-\/>\mbox{\hyperlink{structDataLoader_afae827721797302163cf68deebe0b79e}{glob\_result}}.\mbox{\hyperlink{structglob__t_a69dc492f370a9793f06c11e3eb12f199}{gl\_pathc}},\ \&loader-\/>\mbox{\hyperlink{structDataLoader_a6c015456e9da430129711cd1182ba0d7}{shuffle\_rng}});}
\DoxyCodeLine{00116\ \ \ \ \ \}}
\DoxyCodeLine{00117\ }
\DoxyCodeLine{00118\ \ \ \ \ \mbox{\hyperlink{dataloader_8h_a7ae273eccfc903dd524292275416b9f0}{dataloader\_load\_shard\_}}(loader,\ (\textcolor{keywordtype}{int})\ loader-\/>\mbox{\hyperlink{structDataLoader_a278db1212b380c38165639883fae3ae0}{current\_shard\_idx}});}
\DoxyCodeLine{00119\ }
\DoxyCodeLine{00120\ \ \ \ \ \textcolor{keywordflow}{if}\ (loader-\/>\mbox{\hyperlink{structDataLoader_a3173c188e5f09e5ef655be5c586e866c}{should\_shuffle}})\ \{}
\DoxyCodeLine{00121\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{dataloader_8h_a9e916c128dcf2f87c8736d3611f5f9f8}{prepare\_intra\_shard\_indices\_}}(loader);}
\DoxyCodeLine{00122\ \ \ \ \ \}}
\DoxyCodeLine{00123\ \}}
\DoxyCodeLine{00124\ }
\DoxyCodeLine{00125\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{dataloader_8h_a2e8a7fa2c138687c2abad68e000ff35b}{dataloader\_advance\_}}(\mbox{\hyperlink{structDataLoader}{DataLoader}}\ *loader)\ \{}
\DoxyCodeLine{00126\ \ \ \ \ \textcolor{keywordflow}{if}\ (loader-\/>\mbox{\hyperlink{structDataLoader_a278db1212b380c38165639883fae3ae0}{current\_shard\_idx}}\ ==\ loader-\/>\mbox{\hyperlink{structDataLoader_afae827721797302163cf68deebe0b79e}{glob\_result}}.\mbox{\hyperlink{structglob__t_a69dc492f370a9793f06c11e3eb12f199}{gl\_pathc}}\ -\/\ 1)\ \{}
\DoxyCodeLine{00127\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ if\ we\ are\ at\ the\ last\ shard,\ we\ reset\ the\ loader\ and\ start\ a\ new\ epoch}}
\DoxyCodeLine{00128\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{dataloader_8h_a1bb9a04805e319b0d5bbed3c1dd73013}{dataloader\_reset}}(loader);}
\DoxyCodeLine{00129\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00130\ \ \ \ \ \}}
\DoxyCodeLine{00131\ }
\DoxyCodeLine{00132\ \ \ \ \ \textcolor{comment}{//\ advance\ the\ loader\ by\ loading\ the\ next\ data\ shard\ and\ resetting\ the\ position}}
\DoxyCodeLine{00133\ \ \ \ \ loader-\/>\mbox{\hyperlink{structDataLoader_a278db1212b380c38165639883fae3ae0}{current\_shard\_idx}}\ =\ (loader-\/>\mbox{\hyperlink{structDataLoader_a278db1212b380c38165639883fae3ae0}{current\_shard\_idx}}\ +\ 1)\ \%\ loader-\/>\mbox{\hyperlink{structDataLoader_afae827721797302163cf68deebe0b79e}{glob\_result}}.\mbox{\hyperlink{structglob__t_a69dc492f370a9793f06c11e3eb12f199}{gl\_pathc}};}
\DoxyCodeLine{00134\ \ \ \ \ loader-\/>\mbox{\hyperlink{structDataLoader_a7cc34e3ea9ce0b6c84cc0be3b408e6a3}{current\_sample\_idx}}\ =\ 0;}
\DoxyCodeLine{00135\ \ \ \ \ \mbox{\hyperlink{dataloader_8h_a7ae273eccfc903dd524292275416b9f0}{dataloader\_load\_shard\_}}(loader,\ (\textcolor{keywordtype}{int})\ loader-\/>\mbox{\hyperlink{structDataLoader_a278db1212b380c38165639883fae3ae0}{current\_shard\_idx}});}
\DoxyCodeLine{00136\ }
\DoxyCodeLine{00137\ \ \ \ \ \textcolor{keywordflow}{if}\ (loader-\/>\mbox{\hyperlink{structDataLoader_a3173c188e5f09e5ef655be5c586e866c}{should\_shuffle}})\ \{}
\DoxyCodeLine{00138\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{dataloader_8h_a9e916c128dcf2f87c8736d3611f5f9f8}{prepare\_intra\_shard\_indices\_}}(loader);}
\DoxyCodeLine{00139\ \ \ \ \ \}}
\DoxyCodeLine{00140\ \}}
\DoxyCodeLine{00141\ }
\DoxyCodeLine{00142\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{dataloader_8h_a9fdb25afa79e8163aa5b67e493ba5e06}{dataloader\_init}}(\mbox{\hyperlink{structDataLoader}{DataLoader}}\ *loader,}
\DoxyCodeLine{00143\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}*\ filename\_pattern,}
\DoxyCodeLine{00144\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{size\_t}\ B,}
\DoxyCodeLine{00145\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{size\_t}\ T,}
\DoxyCodeLine{00146\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ process\_rank,}
\DoxyCodeLine{00147\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ num\_processes,}
\DoxyCodeLine{00148\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ should\_shuffle)\ \{}
\DoxyCodeLine{00149\ \ \ \ \ loader-\/>\mbox{\hyperlink{structDataLoader_af452253ebc477bfdd7bec90d37ca42d1}{process\_rank}}\ =\ process\_rank;}
\DoxyCodeLine{00150\ \ \ \ \ loader-\/>\mbox{\hyperlink{structDataLoader_ac838423b62a575a38fd52863e674984b}{num\_processes}}\ =\ num\_processes;}
\DoxyCodeLine{00151\ \ \ \ \ loader-\/>\mbox{\hyperlink{structDataLoader_a3cf90dc304aca48ea04ae320a3058fa1}{B}}\ =\ B;}
\DoxyCodeLine{00152\ \ \ \ \ loader-\/>\mbox{\hyperlink{structDataLoader_a78497c10f1776ac80a8e8b1db5f625ed}{T}}\ =\ T;}
\DoxyCodeLine{00153\ \ \ \ \ loader-\/>\mbox{\hyperlink{structDataLoader_a877ed4895bc221a296d8ee3251a18455}{tokens\_file}}\ =\ NULL;}
\DoxyCodeLine{00154\ \ \ \ \ loader-\/>\mbox{\hyperlink{structDataLoader_a3173c188e5f09e5ef655be5c586e866c}{should\_shuffle}}\ =\ should\_shuffle;}
\DoxyCodeLine{00155\ \ \ \ \ loader-\/>\mbox{\hyperlink{structDataLoader_ac9d6078b92d09daa8252a3e994d41be3}{header\_bytes}}\ =\ \mbox{\hyperlink{dataloader_8h_a49999be01380f41cc0d0f1f1406fb277}{HEADER\_SIZE}}\ *\ \textcolor{keyword}{sizeof}(int);}
\DoxyCodeLine{00156\ \ \ \ \ loader-\/>\mbox{\hyperlink{structDataLoader_aa45f820d91771ee23a12f27f83de7144}{total\_batch\_size\_bytes}}\ =\ ((loader-\/>\mbox{\hyperlink{structDataLoader_ac838423b62a575a38fd52863e674984b}{num\_processes}}\ *\ (loader-\/>\mbox{\hyperlink{structDataLoader_a3cf90dc304aca48ea04ae320a3058fa1}{B}}\ *\ loader-\/>\mbox{\hyperlink{structDataLoader_a78497c10f1776ac80a8e8b1db5f625ed}{T}}))\ *\ \textcolor{keyword}{sizeof}(uint16\_t));}
\DoxyCodeLine{00157\ \ \ \ \ loader-\/>\mbox{\hyperlink{structDataLoader_aa414c5a381d1153520ba382c611c11ed}{local\_batch\_offset\_bytes}}\ =\ loader-\/>\mbox{\hyperlink{structDataLoader_af452253ebc477bfdd7bec90d37ca42d1}{process\_rank}}\ *\ loader-\/>\mbox{\hyperlink{structDataLoader_a3cf90dc304aca48ea04ae320a3058fa1}{B}}\ *\ loader-\/>\mbox{\hyperlink{structDataLoader_a78497c10f1776ac80a8e8b1db5f625ed}{T}}\ *\ \textcolor{keyword}{sizeof}(uint16\_t);}
\DoxyCodeLine{00158\ }
\DoxyCodeLine{00159\ \ \ \ \ \textcolor{comment}{//\ glob\ to\ get\ the\ list\ of\ files\ matching\ the\ pattern,\ these\ are\ our\ data\ shards}}
\DoxyCodeLine{00160\ \ \ \ \ \textcolor{keywordtype}{int}\ glob\_status\ =\ \mbox{\hyperlink{unistd_8h_a27d024aa0a7573e3454274b5583cb4ad}{glob}}(filename\_pattern,\ 0,\ NULL,\ \&loader-\/>\mbox{\hyperlink{structDataLoader_afae827721797302163cf68deebe0b79e}{glob\_result}});}
\DoxyCodeLine{00161\ \ \ \ \ \textcolor{keywordflow}{if}\ (glob\_status\ !=\ 0)\ \{}
\DoxyCodeLine{00162\ \ \ \ \ \ \ \ \ printf(\textcolor{stringliteral}{"{}Error:\ failed\ to\ glob\ pattern:\ \%s\(\backslash\)n"{}},\ filename\_pattern);}
\DoxyCodeLine{00163\ \ \ \ \ \ \ \ \ exit(EXIT\_FAILURE);}
\DoxyCodeLine{00164\ \ \ \ \ \}}
\DoxyCodeLine{00165\ \ \ \ \ \textcolor{keywordflow}{if}\ (loader-\/>\mbox{\hyperlink{structDataLoader_afae827721797302163cf68deebe0b79e}{glob\_result}}.\mbox{\hyperlink{structglob__t_a69dc492f370a9793f06c11e3eb12f199}{gl\_pathc}}\ ==\ 0)\ \{}
\DoxyCodeLine{00166\ \ \ \ \ \ \ \ \ printf(\textcolor{stringliteral}{"{}Error:\ no\ files\ found\ matching\ the\ pattern:\ \%s\(\backslash\)n"{}},\ filename\_pattern);}
\DoxyCodeLine{00167\ \ \ \ \ \ \ \ \ exit(EXIT\_FAILURE);}
\DoxyCodeLine{00168\ \ \ \ \ \}}
\DoxyCodeLine{00169\ }
\DoxyCodeLine{00170\ \ \ \ \ \textcolor{keywordflow}{if}\ (should\_shuffle)\ \{}
\DoxyCodeLine{00171\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structmt19937__state}{mt19937\_state}}\ shuffle\_rng;}
\DoxyCodeLine{00172\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{rand_8h_ab64d400dcc18bac40a0c38b316caa406}{manual\_seed}}(\&shuffle\_rng,\ 42\ +\ process\_rank);}
\DoxyCodeLine{00173\ \ \ \ \ \ \ \ \ loader-\/>\mbox{\hyperlink{structDataLoader_a6c015456e9da430129711cd1182ba0d7}{shuffle\_rng}}\ =\ shuffle\_rng;}
\DoxyCodeLine{00174\ \ \ \ \ \ \ \ \ loader-\/>\mbox{\hyperlink{structDataLoader_acdf036d26535a9ce4a47afe81708bf9e}{shard\_indices}}\ =\ (\textcolor{keywordtype}{int}*)\mbox{\hyperlink{utils_8h_a4be764aabd56cde98ff89be72c51a128}{mallocCheck}}(loader-\/>\mbox{\hyperlink{structDataLoader_afae827721797302163cf68deebe0b79e}{glob\_result}}.\mbox{\hyperlink{structglob__t_a69dc492f370a9793f06c11e3eb12f199}{gl\_pathc}}\ *\ \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{int}));}
\DoxyCodeLine{00175\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{rand_8h_a482d97a202658d17d5a9617b7f881890}{init\_identity\_permutation}}(loader-\/>\mbox{\hyperlink{structDataLoader_acdf036d26535a9ce4a47afe81708bf9e}{shard\_indices}},\ (\textcolor{keywordtype}{int})\ loader-\/>\mbox{\hyperlink{structDataLoader_afae827721797302163cf68deebe0b79e}{glob\_result}}.\mbox{\hyperlink{structglob__t_a69dc492f370a9793f06c11e3eb12f199}{gl\_pathc}});}
\DoxyCodeLine{00176\ \ \ \ \ \ \ \ \ loader-\/>\mbox{\hyperlink{structDataLoader_a5f4f74dcb7add8d6c2fef15126e72b26}{intra\_shard\_indices}}\ =\ NULL;\ \ \textcolor{comment}{//\ dynamically\ allocated\ allowing\ different\ shard\ sizes}}
\DoxyCodeLine{00177\ \ \ \ \ \}}
\DoxyCodeLine{00178\ }
\DoxyCodeLine{00179\ \ \ \ \ \textcolor{comment}{//\ inspect\ and\ validate\ all\ shards\ so\ we\ don't\ get\ any\ runtime\ errors\ later}}
\DoxyCodeLine{00180\ \ \ \ \ \textcolor{comment}{//\ if\ too\ slow\ /\ too\ many\ shards,\ may\ wish\ to\ revisit\ later}}
\DoxyCodeLine{00181\ \ \ \ \ int64\_t\ ntok\_total\ =\ 0;}
\DoxyCodeLine{00182\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ shard\_index\ =\ 0;\ shard\_index\ <\ loader-\/>\mbox{\hyperlink{structDataLoader_afae827721797302163cf68deebe0b79e}{glob\_result}}.\mbox{\hyperlink{structglob__t_a69dc492f370a9793f06c11e3eb12f199}{gl\_pathc}};\ shard\_index++)\ \{}
\DoxyCodeLine{00183\ \ \ \ \ \ \ \ \ int64\_t\ shard\_ntok\ =\ \mbox{\hyperlink{dataloader_8h_a7ae273eccfc903dd524292275416b9f0}{dataloader\_load\_shard\_}}(loader,\ shard\_index);}
\DoxyCodeLine{00184\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ we\ need\ at\ least\ one\ batch/shard,\ the\ way\ things\ are\ written\ right\ now.}}
\DoxyCodeLine{00185\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ can\ be\ relaxed\ a\ lot\ later.}}
\DoxyCodeLine{00186\ \ \ \ \ \ \ \ \ assert(shard\_ntok\ >=\ (int64\_t)\ (num\_processes\ *\ B\ *\ T\ +\ 1));}
\DoxyCodeLine{00187\ \ \ \ \ \ \ \ \ ntok\_total\ +=\ shard\_ntok;}
\DoxyCodeLine{00188\ \ \ \ \ \}}
\DoxyCodeLine{00189\ \ \ \ \ \textcolor{comment}{//\ debugging\ prints}}
\DoxyCodeLine{00190\ \ \ \ \ \textcolor{comment}{//\ printf("{}DataLoader:\ filename\_pattern:\ \%s\(\backslash\)n"{},\ filename\_pattern);}}
\DoxyCodeLine{00191\ \ \ \ \ \textcolor{comment}{//\ printf("{}DataLoader:\ Found\ \%ld\ tokens\ across\ \%zu\ shards\(\backslash\)n"{},\ ntok\_total,\ loader-\/>glob\_result.gl\_pathc);}}
\DoxyCodeLine{00192\ }
\DoxyCodeLine{00193\ \ \ \ \ \textcolor{comment}{//\ allocate\ all\ the\ space\ we'll\ need}}
\DoxyCodeLine{00194\ \ \ \ \ loader-\/>\mbox{\hyperlink{structDataLoader_a102d2e37ae57b1eada10276401fe9488}{buffer}}\ =\ (uint16\_t*)\mbox{\hyperlink{utils_8h_a4be764aabd56cde98ff89be72c51a128}{mallocCheck}}((B\ *\ T\ +\ 1)\ *\ \textcolor{keyword}{sizeof}(uint16\_t));}
\DoxyCodeLine{00195\ \ \ \ \ loader-\/>\mbox{\hyperlink{structDataLoader_addb81ffafbdf852bd69b9a259ab1a811}{inputs}}\ =\ (\textcolor{keywordtype}{int}*)\mbox{\hyperlink{utils_8h_a4be764aabd56cde98ff89be72c51a128}{mallocCheck}}(B\ *\ T\ *\ \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{int}));}
\DoxyCodeLine{00196\ \ \ \ \ loader-\/>\mbox{\hyperlink{structDataLoader_acd7a7e28f774e675beb63b6805d5820a}{targets}}\ =\ (\textcolor{keywordtype}{int}*)\mbox{\hyperlink{utils_8h_a4be764aabd56cde98ff89be72c51a128}{mallocCheck}}(B\ *\ T\ *\ \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{int}));}
\DoxyCodeLine{00197\ \ \ \ \ loader-\/>\mbox{\hyperlink{structDataLoader_a46db9928324b5dfcb6f57ed49232fbcf}{num\_tokens}}\ =\ ntok\_total;}
\DoxyCodeLine{00198\ }
\DoxyCodeLine{00199\ \ \ \ \ \textcolor{comment}{//\ reset\ the\ loader,\ to\ initialize\ it}}
\DoxyCodeLine{00200\ \ \ \ \ \mbox{\hyperlink{dataloader_8h_a1bb9a04805e319b0d5bbed3c1dd73013}{dataloader\_reset}}(loader);}
\DoxyCodeLine{00201\ \}}
\DoxyCodeLine{00202\ }
\DoxyCodeLine{00203\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{dataloader_8h_add89b6b93e264e898de5f477a000b046}{dataloader\_load\_batch}}(\mbox{\hyperlink{structDataLoader}{DataLoader}}*\ loader)\ \{}
\DoxyCodeLine{00204\ \ \ \ \ assert(!loader-\/>\mbox{\hyperlink{structDataLoader_a3173c188e5f09e5ef655be5c586e866c}{should\_shuffle}}\ ||\ (loader-\/>\mbox{\hyperlink{structDataLoader_a3173c188e5f09e5ef655be5c586e866c}{should\_shuffle}}\ \&\&\ loader-\/>\mbox{\hyperlink{structDataLoader_a5f4f74dcb7add8d6c2fef15126e72b26}{intra\_shard\_indices}}\ !=\ NULL));}
\DoxyCodeLine{00205\ \ \ \ \ assert(loader-\/>\mbox{\hyperlink{structDataLoader_a7cc34e3ea9ce0b6c84cc0be3b408e6a3}{current\_sample\_idx}}\ <\ loader-\/>\mbox{\hyperlink{structDataLoader_a8949677b4594ec0f95ad4da1d916ca06}{shard\_num\_samples}});}
\DoxyCodeLine{00206\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ idx\ =\ loader-\/>\mbox{\hyperlink{structDataLoader_a3173c188e5f09e5ef655be5c586e866c}{should\_shuffle}}\ ?\ loader-\/>\mbox{\hyperlink{structDataLoader_a5f4f74dcb7add8d6c2fef15126e72b26}{intra\_shard\_indices}}[loader-\/>\mbox{\hyperlink{structDataLoader_a7cc34e3ea9ce0b6c84cc0be3b408e6a3}{current\_sample\_idx}}]\ :\ loader-\/>\mbox{\hyperlink{structDataLoader_a7cc34e3ea9ce0b6c84cc0be3b408e6a3}{current\_sample\_idx}};}
\DoxyCodeLine{00207\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ global\_batch\_offset\_bytes\ =\ idx\ *\ loader-\/>\mbox{\hyperlink{structDataLoader_aa45f820d91771ee23a12f27f83de7144}{total\_batch\_size\_bytes}};}
\DoxyCodeLine{00208\ \ \ \ \ int64\_t\ current\_offset\ =\ loader-\/>\mbox{\hyperlink{structDataLoader_ac9d6078b92d09daa8252a3e994d41be3}{header\_bytes}}\ +\ global\_batch\_offset\_bytes\ +\ loader-\/>\mbox{\hyperlink{structDataLoader_aa414c5a381d1153520ba382c611c11ed}{local\_batch\_offset\_bytes}};}
\DoxyCodeLine{00209\ }
\DoxyCodeLine{00210\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ B\ =\ loader-\/>\mbox{\hyperlink{structDataLoader_a3cf90dc304aca48ea04ae320a3058fa1}{B}};}
\DoxyCodeLine{00211\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ T\ =\ loader-\/>\mbox{\hyperlink{structDataLoader_a78497c10f1776ac80a8e8b1db5f625ed}{T}};}
\DoxyCodeLine{00212\ \ \ \ \ \textcolor{comment}{//\ read\ B*T+1\ uint16\_t\ tokens\ from\ the\ file\ into\ buffer}}
\DoxyCodeLine{00213\ \ \ \ \ \mbox{\hyperlink{utils_8h_ae1d2c0807b921b9544a6d253ccb7aadf}{fseekCheck}}(loader-\/>\mbox{\hyperlink{structDataLoader_a877ed4895bc221a296d8ee3251a18455}{tokens\_file}},\ (\textcolor{keywordtype}{int})\ current\_offset,\ SEEK\_SET);}
\DoxyCodeLine{00214\ \ \ \ \ \mbox{\hyperlink{utils_8h_aeaeb423fa1a9bddb0cf4c1e0120b09ee}{freadCheck}}(loader-\/>\mbox{\hyperlink{structDataLoader_a102d2e37ae57b1eada10276401fe9488}{buffer}},\ \textcolor{keyword}{sizeof}(uint16\_t),\ B*T+1,\ loader-\/>\mbox{\hyperlink{structDataLoader_a877ed4895bc221a296d8ee3251a18455}{tokens\_file}});}
\DoxyCodeLine{00215\ \ \ \ \ \textcolor{comment}{//\ decode\ the\ buffer\ into\ inputs\ and\ targets\ (cast\ to\ int)}}
\DoxyCodeLine{00216\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ =\ 0;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ <\ B*T;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}++)\ \{}
\DoxyCodeLine{00217\ \ \ \ \ \ \ \ \ loader-\/>\mbox{\hyperlink{structDataLoader_addb81ffafbdf852bd69b9a259ab1a811}{inputs}}[\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}]\ =\ (int)loader-\/>\mbox{\hyperlink{structDataLoader_a102d2e37ae57b1eada10276401fe9488}{buffer}}[\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}];}
\DoxyCodeLine{00218\ \ \ \ \ \ \ \ \ loader-\/>\mbox{\hyperlink{structDataLoader_acd7a7e28f774e675beb63b6805d5820a}{targets}}[\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}]\ =\ (int)loader-\/>\mbox{\hyperlink{structDataLoader_a102d2e37ae57b1eada10276401fe9488}{buffer}}[\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}+1];}
\DoxyCodeLine{00219\ \ \ \ \ \}}
\DoxyCodeLine{00220\ \}}
\DoxyCodeLine{00221\ }
\DoxyCodeLine{00222\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{dataloader_8h_a6300495030ba02d811f9bd0ff26731d5}{dataloader\_next\_batch}}(\mbox{\hyperlink{structDataLoader}{DataLoader}}\ *loader)\ \{}
\DoxyCodeLine{00223\ \ \ \ \ \textcolor{comment}{//\ if\ the\ next\ batch\ would\ go\ past\ the\ end\ of\ the\ file,\ advance\ the\ loader}}
\DoxyCodeLine{00224\ \ \ \ \ \textcolor{keywordflow}{if}\ (loader-\/>\mbox{\hyperlink{structDataLoader_a7cc34e3ea9ce0b6c84cc0be3b408e6a3}{current\_sample\_idx}}\ >=\ loader-\/>\mbox{\hyperlink{structDataLoader_a8949677b4594ec0f95ad4da1d916ca06}{shard\_num\_samples}})\ \{}
\DoxyCodeLine{00225\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{dataloader_8h_a2e8a7fa2c138687c2abad68e000ff35b}{dataloader\_advance\_}}(loader);}
\DoxyCodeLine{00226\ \ \ \ \ \}}
\DoxyCodeLine{00227\ \ \ \ \ \mbox{\hyperlink{dataloader_8h_add89b6b93e264e898de5f477a000b046}{dataloader\_load\_batch}}(loader);}
\DoxyCodeLine{00228\ \ \ \ \ loader-\/>\mbox{\hyperlink{structDataLoader_a7cc34e3ea9ce0b6c84cc0be3b408e6a3}{current\_sample\_idx}}\ +=\ 1;}
\DoxyCodeLine{00229\ \}}
\DoxyCodeLine{00230\ }
\DoxyCodeLine{00231\ }
\DoxyCodeLine{00232\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{dataloader_8h_a04d62812b4a689bae6ae2758fdc173c3}{dataloader\_resume}}(\mbox{\hyperlink{structDataLoader}{DataLoader}}\ *loader,\ \textcolor{keywordtype}{size\_t}\ current\_shard\_idx,\ \textcolor{keywordtype}{size\_t}\ current\_sample\_idx)\ \{}
\DoxyCodeLine{00233\ \ \ \ \ \textcolor{comment}{//\ used\ during\ model\ resumption\ (-\/y\ 1)\ flag}}
\DoxyCodeLine{00234\ \ \ \ \ loader-\/>\mbox{\hyperlink{structDataLoader_a278db1212b380c38165639883fae3ae0}{current\_shard\_idx}}\ =\ current\_shard\_idx;}
\DoxyCodeLine{00235\ \ \ \ \ loader-\/>\mbox{\hyperlink{structDataLoader_a7cc34e3ea9ce0b6c84cc0be3b408e6a3}{current\_sample\_idx}}\ =\ current\_sample\_idx;}
\DoxyCodeLine{00236\ \ \ \ \ \mbox{\hyperlink{dataloader_8h_a7ae273eccfc903dd524292275416b9f0}{dataloader\_load\_shard\_}}(loader,\ (\textcolor{keywordtype}{int})\ loader-\/>\mbox{\hyperlink{structDataLoader_a278db1212b380c38165639883fae3ae0}{current\_shard\_idx}});}
\DoxyCodeLine{00237\ \}}
\DoxyCodeLine{00238\ }
\DoxyCodeLine{00239\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{dataloader_8h_ac091f9e8c14a9a7526ebc2e620b4a2d2}{dataloader\_free}}(\mbox{\hyperlink{structDataLoader}{DataLoader}}\ *loader)\ \{}
\DoxyCodeLine{00240\ \ \ \ \ free(loader-\/>\mbox{\hyperlink{structDataLoader_a102d2e37ae57b1eada10276401fe9488}{buffer}});}
\DoxyCodeLine{00241\ \ \ \ \ free(loader-\/>\mbox{\hyperlink{structDataLoader_addb81ffafbdf852bd69b9a259ab1a811}{inputs}});}
\DoxyCodeLine{00242\ \ \ \ \ free(loader-\/>\mbox{\hyperlink{structDataLoader_acd7a7e28f774e675beb63b6805d5820a}{targets}});}
\DoxyCodeLine{00243\ \ \ \ \ \textcolor{keywordflow}{if}\ (loader-\/>\mbox{\hyperlink{structDataLoader_a3173c188e5f09e5ef655be5c586e866c}{should\_shuffle}})\ \{}
\DoxyCodeLine{00244\ \ \ \ \ \ \ \ \ free(loader-\/>\mbox{\hyperlink{structDataLoader_acdf036d26535a9ce4a47afe81708bf9e}{shard\_indices}});}
\DoxyCodeLine{00245\ \ \ \ \ \ \ \ \ free(loader-\/>\mbox{\hyperlink{structDataLoader_a5f4f74dcb7add8d6c2fef15126e72b26}{intra\_shard\_indices}});}
\DoxyCodeLine{00246\ \ \ \ \ \}}
\DoxyCodeLine{00247\ \ \ \ \ \mbox{\hyperlink{utils_8h_ae094d98ede0500b8f5acba043487a5c1}{fcloseCheck}}(loader-\/>\mbox{\hyperlink{structDataLoader_a877ed4895bc221a296d8ee3251a18455}{tokens\_file}});}
\DoxyCodeLine{00248\ \ \ \ \ \mbox{\hyperlink{unistd_8h_a6c3709ad9d7a7e8112402130713bcfbe}{globfree}}(\&loader-\/>\mbox{\hyperlink{structDataLoader_afae827721797302163cf68deebe0b79e}{glob\_result}});}
\DoxyCodeLine{00249\ \}}
\DoxyCodeLine{00250\ }
\DoxyCodeLine{00251\ \textcolor{comment}{//\ -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{00252\ \textcolor{comment}{//\ Distributed\ Eval\ Loader}}
\DoxyCodeLine{00253\ \textcolor{comment}{//\ Many\ evals\ (like)\ HellaSwag\ and\ MMLU\ are\ multiple-\/choice}}
\DoxyCodeLine{00254\ \textcolor{comment}{//\ where\ there\ are\ 4\ possible\ continuations\ and\ a\ label\ for\ the\ correct\ one}}
\DoxyCodeLine{00255\ \textcolor{comment}{//\ We\ want\ to\ load\ and\ serve\ these\ style\ of\ evals}}
\DoxyCodeLine{00256\ \textcolor{comment}{/*}}
\DoxyCodeLine{00257\ \textcolor{comment}{Copy\ pasting\ the\ section\ on\ the\ eval\ datafile\ format,\ from\ data\_common.py:}}
\DoxyCodeLine{00258\ \textcolor{comment}{-\/\ First\ comes\ a\ header\ with\ 256\ int32s}}
\DoxyCodeLine{00259\ \textcolor{comment}{-\/\ The\ examples\ follow,\ each\ example\ is\ a\ stream\ of\ uint16\_t:}}
\DoxyCodeLine{00260\ \textcolor{comment}{\ \ \ \ -\/\ <START\_EXAMPLE>\ delimiter\ of\ 2**16-\/1,\ i.e.\ 65,535}}
\DoxyCodeLine{00261\ \textcolor{comment}{\ \ \ \ -\/\ <EXAMPLE\_BYTES>,\ bytes\ encoding\ this\ example,\ allowing\ efficient\ skip\ to\ next}}
\DoxyCodeLine{00262\ \textcolor{comment}{\ \ \ \ -\/\ <EXAMPLE\_INDEX>,\ the\ index\ of\ the\ example\ in\ the\ dataset}}
\DoxyCodeLine{00263\ \textcolor{comment}{\ \ \ \ -\/\ <LABEL>,\ the\ index\ of\ the\ correct\ completion}}
\DoxyCodeLine{00264\ \textcolor{comment}{\ \ \ \ -\/\ <NUM\_COMPLETIONS>,\ indicating\ the\ number\ of\ completions\ (usually\ 4)}}
\DoxyCodeLine{00265\ \textcolor{comment}{\ \ \ \ -\/\ <NUM><CONTEXT\_TOKENS>,\ where\ <NUM>\ is\ the\ number\ of\ tokens\ in\ the\ context}}
\DoxyCodeLine{00266\ \textcolor{comment}{\ \ \ \ -\/\ <NUM><COMPLETION\_TOKENS>,\ repeated\ NUM\_COMPLETIONS\ times}}
\DoxyCodeLine{00267\ \textcolor{comment}{*/}}
\DoxyCodeLine{00268\ }
\DoxyCodeLine{00269\ \textcolor{comment}{//\ for\ now,\ could\ relax\ later}}
\DoxyCodeLine{00270\ \textcolor{preprocessor}{\#define\ ASSUMED\_NUM\_COMPLETIONS\ 4}}
\DoxyCodeLine{00271\ \textcolor{comment}{//\ helper\ macro\ for\ ceildiv}}
\DoxyCodeLine{00272\ \textcolor{preprocessor}{\#define\ CEIL\_DIV(M,\ N)\ (((M)\ +\ (N)-\/1)\ /\ (N))}}
\DoxyCodeLine{00273\ }
\DoxyCodeLine{00274\ \textcolor{keyword}{typedef}\ \textcolor{keyword}{struct\ }\{}
\DoxyCodeLine{00275\ \ \ \ \ \textcolor{comment}{//\ variables\ related\ to\ distributed\ training}}
\DoxyCodeLine{00276\ \ \ \ \ \textcolor{comment}{//\ each\ process/worker\ has\ to\ access\ different\ parts\ of\ the\ data}}
\DoxyCodeLine{00277\ \ \ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{structEvalLoader_a30e28f9b79d6cabcd80368f0f8b39b49}{process\_rank}};}
\DoxyCodeLine{00278\ \ \ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{structEvalLoader_a94a0f671e3a1b26f286d46d1dc710836}{num\_processes}};}
\DoxyCodeLine{00279\ \ \ \ \ \textcolor{comment}{//\ hyperparameters.\ use\ size\_t\ to\ prevent\ overflow}}
\DoxyCodeLine{00280\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{structEvalLoader_ad579b719803160112290db168b777a04}{B}};\ \textcolor{comment}{//\ (micro)\ batch\ size\ dimension\ of\ the\ tensor\ that\ feeds\ into\ the\ model}}
\DoxyCodeLine{00281\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ \mbox{\hyperlink{structEvalLoader_a67b6ddaeae707ccce4ada1e1f48ea12e}{T}};\ \textcolor{comment}{//\ maximum\ context\ length\ of\ the\ model}}
\DoxyCodeLine{00282\ \ \ \ \ \textcolor{comment}{//\ input\ handling\ and\ its\ state}}
\DoxyCodeLine{00283\ \ \ \ \ FILE*\ \mbox{\hyperlink{structEvalLoader_ab28c4ad3ddee127e21943bcbbdac95d3}{eval\_file}};}
\DoxyCodeLine{00284\ \ \ \ \ uint16\_t*\ \mbox{\hyperlink{structEvalLoader_a454c2532ac07fdcd73a6b1265ec51bcb}{buffer}};\ \textcolor{comment}{//\ we\ fread\ data\ from\ file\ into\ this\ buffer}}
\DoxyCodeLine{00285\ \ \ \ \ \textcolor{comment}{//\ public\ variables\ that\ could\ be\ accessed\ from\ outside}}
\DoxyCodeLine{00286\ \ \ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{structEvalLoader_ab33c0d5b7b666eb7b70f807c6ebeaac4}{num\_examples}};\ \textcolor{comment}{//\ in\ total\ across\ all\ processes}}
\DoxyCodeLine{00287\ \ \ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{structEvalLoader_a69f7834edb6f9978a5fd3a26630292b3}{num\_batches}};\ \textcolor{comment}{//\ to\ process\ the\ entire\ dataset\ across\ all\ processes}}
\DoxyCodeLine{00288\ \ \ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{structEvalLoader_ae2f8afee493f2a45454adc9a06aee891}{start\_example\_index}};\ \textcolor{comment}{//\ the\ assignment\ of\ work\ for\ this\ process,\ start}}
\DoxyCodeLine{00289\ \ \ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{structEvalLoader_a8baa5911e8d7eab5c268a27f1892a8ba}{end\_example\_index}};\ \textcolor{comment}{//\ and\ end.\ start\ is\ inclusive,\ end\ is\ exclusive}}
\DoxyCodeLine{00290\ \ \ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{structEvalLoader_a1e9b1cda56452af5565871e7fdfc79cb}{current\_example\_index}};\ \textcolor{comment}{//\ the\ next\ example\ we\ would\ read}}
\DoxyCodeLine{00291\ \ \ \ \ \textcolor{keywordtype}{int}*\ \mbox{\hyperlink{structEvalLoader_a6e56d7109b86f129a8848f743acf35a1}{inputs}};\ \ \textcolor{comment}{//\ input\ tokens\ into\ transformer}}
\DoxyCodeLine{00292\ \ \ \ \ \textcolor{keywordtype}{int}*\ \mbox{\hyperlink{structEvalLoader_a2cd5289c023df521565f38ee1b5cb234}{targets}};\ \textcolor{comment}{//\ target\ tokens\ for\ the\ transformer}}
\DoxyCodeLine{00293\ \ \ \ \ \textcolor{keywordtype}{char}*\ \mbox{\hyperlink{structEvalLoader_a73f28d99f2aef1906d16be4fdf2babec}{mask}};\ \textcolor{comment}{//\ mask=1\ at\ all\ completion\ token\ locations}}
\DoxyCodeLine{00294\ \ \ \ \ \textcolor{keywordtype}{int}*\ \mbox{\hyperlink{structEvalLoader_a72aaf84fc68642983b87dee8258e3c83}{label}};\ \textcolor{comment}{//\ the\ correct\ completion\ labels}}
\DoxyCodeLine{00295\ \ \ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{structEvalLoader_ad0da94627133c01534f083fde935cfac}{num\_completions}};\ \textcolor{comment}{//\ number\ of\ completions\ for\ this\ example}}
\DoxyCodeLine{00296\ \}\ \mbox{\hyperlink{structEvalLoader}{EvalLoader}};}
\DoxyCodeLine{00297\ }
\DoxyCodeLine{00298\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{dataloader_8h_a40bca5416aafd6d46d735aeef34df87c}{evalloader\_reset}}(\mbox{\hyperlink{structEvalLoader}{EvalLoader}}\ *loader)\ \{}
\DoxyCodeLine{00299\ \ \ \ \ \textcolor{comment}{//\ we\ have\ to\ be\ careful\ that\ each\ process\ starts\ at\ the\ correct\ offset.}}
\DoxyCodeLine{00300\ \ \ \ \ \textcolor{comment}{//\ For\ example\ if\ there\ are\ N\ examples\ in\ the\ file\ and\ 4\ processes,}}
\DoxyCodeLine{00301\ \ \ \ \ \textcolor{comment}{//\ then\ process\ 0\ should\ start\ at\ 0,\ process\ 1\ at\ N/4,\ process\ 2\ at\ N/2,\ etc.}}
\DoxyCodeLine{00302\ \ \ \ \ \textcolor{comment}{//\ determine\ how\ much\ work\ there\ is\ for\ all\ processes}}
\DoxyCodeLine{00303\ \ \ \ \ \textcolor{keywordtype}{int}\ examples\_per\_process\ =\ \mbox{\hyperlink{dataloader_8h_a4645971e0da4d11758b0704499d22fb8}{CEIL\_DIV}}(loader-\/>\mbox{\hyperlink{structEvalLoader_ab33c0d5b7b666eb7b70f807c6ebeaac4}{num\_examples}},\ loader-\/>\mbox{\hyperlink{structEvalLoader_a94a0f671e3a1b26f286d46d1dc710836}{num\_processes}});}
\DoxyCodeLine{00304\ \ \ \ \ \textcolor{keywordtype}{int}\ can\_fit\_examples\ =\ (int)\ (loader-\/>\mbox{\hyperlink{structEvalLoader_ad579b719803160112290db168b777a04}{B}}\ /\ \mbox{\hyperlink{dataloader_8h_aa3387b958497b888fb833ab6404c68e3}{ASSUMED\_NUM\_COMPLETIONS}});}
\DoxyCodeLine{00305\ \ \ \ \ \textcolor{keywordflow}{if}\ (can\_fit\_examples\ ==\ 0)\ \{}
\DoxyCodeLine{00306\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ this\ could\ be\ fixed\ in\ the\ future,\ but\ for\ now\ keeping\ it\ simple\ and\ throw\ error\ when\ B\ too\ low}}
\DoxyCodeLine{00307\ \ \ \ \ \ \ \ \ printf(\textcolor{stringliteral}{"{}HellaSwag\ EvalLoader:\ batch\ size\ \%zu\ is\ <\ \%d\(\backslash\)n"{}},\ loader-\/>\mbox{\hyperlink{structEvalLoader_ad579b719803160112290db168b777a04}{B}},\ \mbox{\hyperlink{dataloader_8h_aa3387b958497b888fb833ab6404c68e3}{ASSUMED\_NUM\_COMPLETIONS}});}
\DoxyCodeLine{00308\ \ \ \ \ \ \ \ \ printf(\textcolor{stringliteral}{"{}-\/-\/-\/>\ HINT:\ Disable\ HellaSwag\ eval\ with\ -\/h\ 0,\ or\ increase\ batch\ size\ with\ -\/b\(\backslash\)n"{}});}
\DoxyCodeLine{00309\ \ \ \ \ \ \ \ \ exit(EXIT\_FAILURE);}
\DoxyCodeLine{00310\ \ \ \ \ \}}
\DoxyCodeLine{00311\ \ \ \ \ loader-\/>\mbox{\hyperlink{structEvalLoader_a69f7834edb6f9978a5fd3a26630292b3}{num\_batches}}\ =\ \mbox{\hyperlink{dataloader_8h_a4645971e0da4d11758b0704499d22fb8}{CEIL\_DIV}}(examples\_per\_process,\ can\_fit\_examples);}
\DoxyCodeLine{00312\ \ \ \ \ \textcolor{comment}{//\ determine\ the\ start\ and\ end\ example\ indices\ for\ this\ process}}
\DoxyCodeLine{00313\ \ \ \ \ loader-\/>\mbox{\hyperlink{structEvalLoader_ae2f8afee493f2a45454adc9a06aee891}{start\_example\_index}}\ =\ examples\_per\_process\ *\ loader-\/>\mbox{\hyperlink{structEvalLoader_a30e28f9b79d6cabcd80368f0f8b39b49}{process\_rank}};}
\DoxyCodeLine{00314\ \ \ \ \ loader-\/>\mbox{\hyperlink{structEvalLoader_a8baa5911e8d7eab5c268a27f1892a8ba}{end\_example\_index}}\ =\ examples\_per\_process\ *\ (loader-\/>\mbox{\hyperlink{structEvalLoader_a30e28f9b79d6cabcd80368f0f8b39b49}{process\_rank}}\ +\ 1);}
\DoxyCodeLine{00315\ \ \ \ \ \textcolor{comment}{//\ crop\ the\ end\ example\ index\ to\ the\ total\ number\ of\ examples}}
\DoxyCodeLine{00316\ \ \ \ \ \textcolor{keywordflow}{if}\ (loader-\/>\mbox{\hyperlink{structEvalLoader_a8baa5911e8d7eab5c268a27f1892a8ba}{end\_example\_index}}\ >\ loader-\/>\mbox{\hyperlink{structEvalLoader_ab33c0d5b7b666eb7b70f807c6ebeaac4}{num\_examples}})\ \{}
\DoxyCodeLine{00317\ \ \ \ \ \ \ \ \ loader-\/>\mbox{\hyperlink{structEvalLoader_a8baa5911e8d7eab5c268a27f1892a8ba}{end\_example\_index}}\ =\ loader-\/>\mbox{\hyperlink{structEvalLoader_ab33c0d5b7b666eb7b70f807c6ebeaac4}{num\_examples}};}
\DoxyCodeLine{00318\ \ \ \ \ \}}
\DoxyCodeLine{00319\ \ \ \ \ \textcolor{comment}{//\ now\ seek\ through\ the\ file\ to\ the\ start\ of\ that\ example}}
\DoxyCodeLine{00320\ \ \ \ \ \textcolor{comment}{//\ utilize\ <EXAMPLE\_BYTES>\ for\ efficiency}}
\DoxyCodeLine{00321\ \ \ \ \ int64\_t\ header\_bytes\ =\ \mbox{\hyperlink{dataloader_8h_a49999be01380f41cc0d0f1f1406fb277}{HEADER\_SIZE}}\ *\ \textcolor{keyword}{sizeof}(int);}
\DoxyCodeLine{00322\ \ \ \ \ \mbox{\hyperlink{utils_8h_ae1d2c0807b921b9544a6d253ccb7aadf}{fseekCheck}}(loader-\/>\mbox{\hyperlink{structEvalLoader_ab28c4ad3ddee127e21943bcbbdac95d3}{eval\_file}},\ (\textcolor{keywordtype}{int})\ header\_bytes,\ SEEK\_SET);}
\DoxyCodeLine{00323\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ =\ 0;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ <\ loader-\/>\mbox{\hyperlink{structEvalLoader_ae2f8afee493f2a45454adc9a06aee891}{start\_example\_index}};\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}++)\ \{}
\DoxyCodeLine{00324\ \ \ \ \ \ \ \ \ uint16\_t\ example\_header[3];}
\DoxyCodeLine{00325\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ read\ 3\ uint16\_t\ values:\ <START\_EXAMPLE>,\ <EXAMPLE\_BYTES>,\ <EXAMPLE\_INDEX>}}
\DoxyCodeLine{00326\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{utils_8h_aeaeb423fa1a9bddb0cf4c1e0120b09ee}{freadCheck}}(\&example\_header[0],\ \textcolor{keyword}{sizeof}(uint16\_t),\ 3,\ loader-\/>\mbox{\hyperlink{structEvalLoader_ab28c4ad3ddee127e21943bcbbdac95d3}{eval\_file}});}
\DoxyCodeLine{00327\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ validate\ the\ <START\_EXAMPLE>\ delimiter}}
\DoxyCodeLine{00328\ \ \ \ \ \ \ \ \ assert(example\_header[0]\ ==\ 65535);\ \textcolor{comment}{//\ <START\_EXAMPLE>\ delimiter}}
\DoxyCodeLine{00329\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ validate\ the\ <EXAMPLE\_INDEX>}}
\DoxyCodeLine{00330\ \ \ \ \ \ \ \ \ assert(example\_header[2]\ ==\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}});\ \textcolor{comment}{//\ <EXAMPLE\_INDEX>\ should\ match\ the\ loop\ index}}
\DoxyCodeLine{00331\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ skip\ to\ the\ next\ example,\ keeping\ in\ mind\ that\ we\ already\ read\ the\ header}}
\DoxyCodeLine{00332\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{size\_t}\ remaining\_bytes\ =\ example\_header[1]\ -\/\ \textcolor{keyword}{sizeof}(uint16\_t)\ *\ 3;}
\DoxyCodeLine{00333\ \ \ \ \ \ \ \ \ assert(remaining\_bytes\ >\ 0);\ \textcolor{comment}{//\ we\ expect\ some\ bytes\ in\ the\ example}}
\DoxyCodeLine{00334\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{utils_8h_ae1d2c0807b921b9544a6d253ccb7aadf}{fseekCheck}}(loader-\/>\mbox{\hyperlink{structEvalLoader_ab28c4ad3ddee127e21943bcbbdac95d3}{eval\_file}},\ (\textcolor{keywordtype}{int})\ remaining\_bytes,\ SEEK\_CUR);}
\DoxyCodeLine{00335\ \ \ \ \ \}}
\DoxyCodeLine{00336\ \ \ \ \ \textcolor{comment}{//\ now\ we\ are\ at\ the\ start\ of\ the\ example\ we\ want\ to\ start\ at,\ pointing\ at\ <START\_EXAMPLE>}}
\DoxyCodeLine{00337\ \ \ \ \ loader-\/>\mbox{\hyperlink{structEvalLoader_a1e9b1cda56452af5565871e7fdfc79cb}{current\_example\_index}}\ =\ loader-\/>\mbox{\hyperlink{structEvalLoader_ae2f8afee493f2a45454adc9a06aee891}{start\_example\_index}};}
\DoxyCodeLine{00338\ \}}
\DoxyCodeLine{00339\ }
\DoxyCodeLine{00340\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{dataloader_8h_a2fade634ac0d3ac6ceaeb97240addbd6}{evalloader\_init}}(\mbox{\hyperlink{structEvalLoader}{EvalLoader}}\ *loader,}
\DoxyCodeLine{00341\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}*\ filename,}
\DoxyCodeLine{00342\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{size\_t}\ B,}
\DoxyCodeLine{00343\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{size\_t}\ T,}
\DoxyCodeLine{00344\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ process\_rank,}
\DoxyCodeLine{00345\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ num\_processes)\ \{}
\DoxyCodeLine{00346\ \ \ \ \ loader-\/>\mbox{\hyperlink{structEvalLoader_a30e28f9b79d6cabcd80368f0f8b39b49}{process\_rank}}\ =\ process\_rank;}
\DoxyCodeLine{00347\ \ \ \ \ loader-\/>\mbox{\hyperlink{structEvalLoader_a94a0f671e3a1b26f286d46d1dc710836}{num\_processes}}\ =\ num\_processes;}
\DoxyCodeLine{00348\ \ \ \ \ loader-\/>\mbox{\hyperlink{structEvalLoader_ad579b719803160112290db168b777a04}{B}}\ =\ B;}
\DoxyCodeLine{00349\ \ \ \ \ loader-\/>\mbox{\hyperlink{structEvalLoader_a67b6ddaeae707ccce4ada1e1f48ea12e}{T}}\ =\ T;}
\DoxyCodeLine{00350\ }
\DoxyCodeLine{00351\ \ \ \ \ \textcolor{comment}{//\ open\ the\ file\ and\ validate\ the\ header}}
\DoxyCodeLine{00352\ \ \ \ \ loader-\/>\mbox{\hyperlink{structEvalLoader_ab28c4ad3ddee127e21943bcbbdac95d3}{eval\_file}}\ =\ \mbox{\hyperlink{utils_8h_a4d8fc8875786ef36e2c339e79f8b250b}{fopenCheck}}(filename,\ \textcolor{stringliteral}{"{}rb"{}});}
\DoxyCodeLine{00353\ \ \ \ \ \textcolor{comment}{//\ validate\ the\ header}}
\DoxyCodeLine{00354\ \ \ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{abseil-cpp_2absl_2base_2internal_2low__level__alloc_8cc_a85861428b812bc81bc5362c43c423cbd}{header}}[\mbox{\hyperlink{dataloader_8h_a49999be01380f41cc0d0f1f1406fb277}{HEADER\_SIZE}}];}
\DoxyCodeLine{00355\ \ \ \ \ \mbox{\hyperlink{utils_8h_aeaeb423fa1a9bddb0cf4c1e0120b09ee}{freadCheck}}(\mbox{\hyperlink{abseil-cpp_2absl_2base_2internal_2low__level__alloc_8cc_a85861428b812bc81bc5362c43c423cbd}{header}},\ \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{int}),\ \mbox{\hyperlink{dataloader_8h_a49999be01380f41cc0d0f1f1406fb277}{HEADER\_SIZE}},\ loader-\/>\mbox{\hyperlink{structEvalLoader_ab28c4ad3ddee127e21943bcbbdac95d3}{eval\_file}});}
\DoxyCodeLine{00356\ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{abseil-cpp_2absl_2base_2internal_2low__level__alloc_8cc_a85861428b812bc81bc5362c43c423cbd}{header}}[0]\ !=\ 20240522)\ \{\ printf(\textcolor{stringliteral}{"{}Bad\ magic\ in\ eval\ file\(\backslash\)n"{}});\ exit(EXIT\_FAILURE);\ \}}
\DoxyCodeLine{00357\ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{abseil-cpp_2absl_2base_2internal_2low__level__alloc_8cc_a85861428b812bc81bc5362c43c423cbd}{header}}[1]\ !=\ 1)\ \{\ printf(\textcolor{stringliteral}{"{}Bad\ version\ in\ data\ file\(\backslash\)n"{}});\ exit(EXIT\_FAILURE);\ \}}
\DoxyCodeLine{00358\ \ \ \ \ loader-\/>\mbox{\hyperlink{structEvalLoader_ab33c0d5b7b666eb7b70f807c6ebeaac4}{num\_examples}}\ =\ \mbox{\hyperlink{abseil-cpp_2absl_2base_2internal_2low__level__alloc_8cc_a85861428b812bc81bc5362c43c423cbd}{header}}[2];\ \textcolor{comment}{//\ number\ of\ examples\ in\ the\ file}}
\DoxyCodeLine{00359\ \ \ \ \ assert(loader-\/>\mbox{\hyperlink{structEvalLoader_ab33c0d5b7b666eb7b70f807c6ebeaac4}{num\_examples}}\ >=\ num\_processes);\ \textcolor{comment}{//\ avoid\ headaches\ for\ now}}
\DoxyCodeLine{00360\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ longest\_example\_bytes\ =\ \mbox{\hyperlink{abseil-cpp_2absl_2base_2internal_2low__level__alloc_8cc_a85861428b812bc81bc5362c43c423cbd}{header}}[3];\ \textcolor{comment}{//\ longest\ example\ in\ the\ file}}
\DoxyCodeLine{00361\ \ \ \ \ \textcolor{comment}{//\ basic\ sensibility\ check\ we\ could\ relax\ later.\ but\ roughly\ each\ example}}
\DoxyCodeLine{00362\ \ \ \ \ \textcolor{comment}{//\ contains\ the\ prompt\ (or\ "{}context"{})\ and\ 4\ completions,\ all\ of\ these\ have\ to\ be}}
\DoxyCodeLine{00363\ \ \ \ \ \textcolor{comment}{//\ up\ to\ T\ tokens,\ and\ their\ tokens\ are\ uint16\_t\ (so\ 2\ bytes/token).}}
\DoxyCodeLine{00364\ \ \ \ \ \textcolor{comment}{//\ There's\ a\ few\ more\ things\ in\ each\ example\ but\ they\ are\ minor.}}
\DoxyCodeLine{00365\ \ \ \ \ \textcolor{comment}{//\ So\ longest\ example\ should\ be\ roughly\ this.\ Just\ trying\ to\ make\ sure\ it's\ sensible.}}
\DoxyCodeLine{00366\ \ \ \ \ assert(longest\_example\_bytes\ >\ 0\ \&\&\ longest\_example\_bytes\ <\ (1+\mbox{\hyperlink{dataloader_8h_aa3387b958497b888fb833ab6404c68e3}{ASSUMED\_NUM\_COMPLETIONS}})*T*2);}
\DoxyCodeLine{00367\ }
\DoxyCodeLine{00368\ \ \ \ \ \textcolor{comment}{//\ allocate\ all\ the\ space\ we'll\ need}}
\DoxyCodeLine{00369\ \ \ \ \ \textcolor{keywordtype}{int}\ can\_fit\_examples\ =\ (int)\ (B\ /\ \mbox{\hyperlink{dataloader_8h_aa3387b958497b888fb833ab6404c68e3}{ASSUMED\_NUM\_COMPLETIONS}});}
\DoxyCodeLine{00370\ \ \ \ \ loader-\/>\mbox{\hyperlink{structEvalLoader_a454c2532ac07fdcd73a6b1265ec51bcb}{buffer}}\ =\ (uint16\_t*)\mbox{\hyperlink{utils_8h_a4be764aabd56cde98ff89be72c51a128}{mallocCheck}}(longest\_example\_bytes);}
\DoxyCodeLine{00371\ \ \ \ \ loader-\/>\mbox{\hyperlink{structEvalLoader_a6e56d7109b86f129a8848f743acf35a1}{inputs}}\ =\ (\textcolor{keywordtype}{int}*)calloc(B\ *\ T,\ \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{int}));}
\DoxyCodeLine{00372\ \ \ \ \ loader-\/>\mbox{\hyperlink{structEvalLoader_a2cd5289c023df521565f38ee1b5cb234}{targets}}\ =\ (\textcolor{keywordtype}{int}*)calloc(B\ *\ T,\ \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{int}));}
\DoxyCodeLine{00373\ \ \ \ \ loader-\/>\mbox{\hyperlink{structEvalLoader_a73f28d99f2aef1906d16be4fdf2babec}{mask}}\ =\ (\textcolor{keywordtype}{char}*)\mbox{\hyperlink{utils_8h_a4be764aabd56cde98ff89be72c51a128}{mallocCheck}}(B\ *\ T\ *\ \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{char}));}
\DoxyCodeLine{00374\ \ \ \ \ loader-\/>\mbox{\hyperlink{structEvalLoader_a72aaf84fc68642983b87dee8258e3c83}{label}}\ =\ (\textcolor{keywordtype}{int}*)\mbox{\hyperlink{utils_8h_a4be764aabd56cde98ff89be72c51a128}{mallocCheck}}(can\_fit\_examples\ *\ \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{int}));}
\DoxyCodeLine{00375\ }
\DoxyCodeLine{00376\ \ \ \ \ \textcolor{comment}{//\ reset\ the\ loader,\ to\ initialize\ it}}
\DoxyCodeLine{00377\ \ \ \ \ \mbox{\hyperlink{dataloader_8h_a40bca5416aafd6d46d735aeef34df87c}{evalloader\_reset}}(loader);}
\DoxyCodeLine{00378\ \}}
\DoxyCodeLine{00379\ }
\DoxyCodeLine{00380\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{dataloader_8h_a9e0334904dedabeb702dae0ee8a94697}{evalloader\_next\_example\_}}(\mbox{\hyperlink{structEvalLoader}{EvalLoader}}\ *loader,\ \textcolor{keywordtype}{int}\ example\_batch\_index)\ \{}
\DoxyCodeLine{00381\ \ \ \ \ \textcolor{comment}{//\ this\ function\ populates\ the\ inputs,\ targets,\ mask,\ and\ label\ fields\ for\ one\ example}}
\DoxyCodeLine{00382\ \ \ \ \ \textcolor{comment}{//\ because\ every\ (B,T)\ tensor\ can\ fit\ multiple\ examples\ and\ we\ want\ to\ take\ advantage,}}
\DoxyCodeLine{00383\ \ \ \ \ \textcolor{comment}{//\ we\ also\ pass\ in\ the\ example\_batch\_index\ to\ indicate\ which\ example\ in\ the\ batch\ we\ are\ loading}}
\DoxyCodeLine{00384\ \ \ \ \ \textcolor{comment}{//\ and\ each\ example\ takes\ up\ ASSUMED\_NUM\_COMPLETIONS\ rows\ in\ the\ batch}}
\DoxyCodeLine{00385\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ B\ =\ loader-\/>\mbox{\hyperlink{structEvalLoader_ad579b719803160112290db168b777a04}{B}};}
\DoxyCodeLine{00386\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ T\ =\ loader-\/>\mbox{\hyperlink{structEvalLoader_a67b6ddaeae707ccce4ada1e1f48ea12e}{T}};}
\DoxyCodeLine{00387\ \ \ \ \ \textcolor{keywordtype}{int}\ batch\_dim\_offset\ =\ example\_batch\_index\ *\ \mbox{\hyperlink{dataloader_8h_aa3387b958497b888fb833ab6404c68e3}{ASSUMED\_NUM\_COMPLETIONS}};}
\DoxyCodeLine{00388\ \ \ \ \ \textcolor{comment}{//\ read\ the\ current\ example\ header}}
\DoxyCodeLine{00389\ \ \ \ \ uint16\_t\ example\_header[3];}
\DoxyCodeLine{00390\ \ \ \ \ \mbox{\hyperlink{utils_8h_aeaeb423fa1a9bddb0cf4c1e0120b09ee}{freadCheck}}(\&example\_header[0],\ \textcolor{keyword}{sizeof}(uint16\_t),\ 3,\ loader-\/>\mbox{\hyperlink{structEvalLoader_ab28c4ad3ddee127e21943bcbbdac95d3}{eval\_file}});}
\DoxyCodeLine{00391\ \ \ \ \ \textcolor{comment}{//\ validate\ the\ <START\_EXAMPLE>\ delimiter}}
\DoxyCodeLine{00392\ \ \ \ \ assert(example\_header[0]\ ==\ 65535);\ \textcolor{comment}{//\ <START\_EXAMPLE>\ delimiter}}
\DoxyCodeLine{00393\ \ \ \ \ \textcolor{comment}{//\ validate\ the\ <EXAMPLE\_INDEX>}}
\DoxyCodeLine{00394\ \ \ \ \ assert(example\_header[2]\ ==\ loader-\/>\mbox{\hyperlink{structEvalLoader_a1e9b1cda56452af5565871e7fdfc79cb}{current\_example\_index}});\ \textcolor{comment}{//\ <EXAMPLE\_INDEX>\ should\ match\ the\ loop\ index}}
\DoxyCodeLine{00395\ \ \ \ \ assert(example\_header[2]\ >=\ loader-\/>\mbox{\hyperlink{structEvalLoader_ae2f8afee493f2a45454adc9a06aee891}{start\_example\_index}}\ \&\&\ example\_header[2]\ <\ loader-\/>\mbox{\hyperlink{structEvalLoader_a8baa5911e8d7eab5c268a27f1892a8ba}{end\_example\_index}});}
\DoxyCodeLine{00396\ \ \ \ \ \textcolor{comment}{//\ read\ the\ rest\ of\ the\ example\ (we\ have\ space\ for\ 3\ more\ uint16\_t\ values\ in\ buffer,\ it's\ ok)}}
\DoxyCodeLine{00397\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ example\_bytes\ =\ example\_header[1]\ -\/\ \textcolor{keyword}{sizeof}(uint16\_t)\ *\ 3;}
\DoxyCodeLine{00398\ \ \ \ \ \textcolor{comment}{//\ read\ example\_bytes\ into\ buffer.\ careful\ that\ this\ is\ actually\ in\ the\ units\ of\ bytes}}
\DoxyCodeLine{00399\ \ \ \ \ \mbox{\hyperlink{utils_8h_aeaeb423fa1a9bddb0cf4c1e0120b09ee}{freadCheck}}(loader-\/>\mbox{\hyperlink{structEvalLoader_a454c2532ac07fdcd73a6b1265ec51bcb}{buffer}},\ \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{char}),\ example\_bytes,\ loader-\/>\mbox{\hyperlink{structEvalLoader_ab28c4ad3ddee127e21943bcbbdac95d3}{eval\_file}});}
\DoxyCodeLine{00400\ \ \ \ \ \textcolor{comment}{//\ process\ the\ example\ label}}
\DoxyCodeLine{00401\ \ \ \ \ \textcolor{keywordtype}{int}\ label\ =\ (int)loader-\/>\mbox{\hyperlink{structEvalLoader_a454c2532ac07fdcd73a6b1265ec51bcb}{buffer}}[0];}
\DoxyCodeLine{00402\ \ \ \ \ \textcolor{keywordtype}{int}\ can\_fit\_examples\ =\ (int)\ (loader-\/>\mbox{\hyperlink{structEvalLoader_ad579b719803160112290db168b777a04}{B}}\ /\ \mbox{\hyperlink{dataloader_8h_aa3387b958497b888fb833ab6404c68e3}{ASSUMED\_NUM\_COMPLETIONS}});}
\DoxyCodeLine{00403\ \ \ \ \ assert(label\ >=\ 0\ \&\&\ label\ <\ \mbox{\hyperlink{dataloader_8h_aa3387b958497b888fb833ab6404c68e3}{ASSUMED\_NUM\_COMPLETIONS}});\ \textcolor{comment}{//\ we\ expect\ the\ label\ to\ be\ in\ [0,\ 4)\ for\ right\ now}}
\DoxyCodeLine{00404\ \ \ \ \ assert(example\_batch\_index\ >=\ 0\ \&\&\ example\_batch\_index\ <\ can\_fit\_examples);}
\DoxyCodeLine{00405\ \ \ \ \ loader-\/>\mbox{\hyperlink{structEvalLoader_a72aaf84fc68642983b87dee8258e3c83}{label}}[example\_batch\_index]\ =\ label;\ \textcolor{comment}{//\ store\ for\ output}}
\DoxyCodeLine{00406\ \ \ \ \ \textcolor{comment}{//\ process\ the\ number\ of\ completions}}
\DoxyCodeLine{00407\ \ \ \ \ \textcolor{keywordtype}{int}\ num\_completions\ =\ (int)loader-\/>\mbox{\hyperlink{structEvalLoader_a454c2532ac07fdcd73a6b1265ec51bcb}{buffer}}[1];}
\DoxyCodeLine{00408\ \ \ \ \ assert(num\_completions\ ==\ \mbox{\hyperlink{dataloader_8h_aa3387b958497b888fb833ab6404c68e3}{ASSUMED\_NUM\_COMPLETIONS}});\ \textcolor{comment}{//\ we\ expect\ 4\ completions\ for\ now}}
\DoxyCodeLine{00409\ \ \ \ \ assert(batch\_dim\_offset\ +\ num\_completions\ <=\ B);\ \textcolor{comment}{//\ we\ expect\ to\ fit\ in\ the\ batch}}
\DoxyCodeLine{00410\ \ \ \ \ loader-\/>\mbox{\hyperlink{structEvalLoader_ad0da94627133c01534f083fde935cfac}{num\_completions}}\ =\ num\_completions;\ \textcolor{comment}{//\ store\ for\ output}}
\DoxyCodeLine{00411\ \ \ \ \ \textcolor{comment}{//\ process\ the\ context}}
\DoxyCodeLine{00412\ \ \ \ \ \textcolor{comment}{//\ the\ context\ is\ shared\ for\ all\ completions,\ so\ we\ insert\ it\ into\ all\ data\ rows\ equally}}
\DoxyCodeLine{00413\ \ \ \ \ \textcolor{keywordtype}{int}\ context\_length\ =\ (int)loader-\/>\mbox{\hyperlink{structEvalLoader_a454c2532ac07fdcd73a6b1265ec51bcb}{buffer}}[2];}
\DoxyCodeLine{00414\ \ \ \ \ uint16\_t\ *context\_tokens\_start\ =\ \&loader-\/>\mbox{\hyperlink{structEvalLoader_a454c2532ac07fdcd73a6b1265ec51bcb}{buffer}}[3];\ \textcolor{comment}{//\ where\ the\ tokens\ start}}
\DoxyCodeLine{00415\ \ \ \ \ assert(context\_length\ >\ 0\ \&\&\ context\_length\ <\ T);\ \textcolor{comment}{//\ context\ is\ non-\/empty\ and\ up\ to\ T}}
\DoxyCodeLine{00416\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2layout__test_8cc_ad66453096871179e6c6effe0df4b483b}{b}}\ =\ 0;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2layout__test_8cc_ad66453096871179e6c6effe0df4b483b}{b}}\ <\ num\_completions;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2layout__test_8cc_ad66453096871179e6c6effe0df4b483b}{b}}++)\ \{}
\DoxyCodeLine{00417\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ =\ 0;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ <\ context\_length;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}++)\ \{}
\DoxyCodeLine{00418\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ boff\ =\ batch\_dim\_offset\ +\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2layout__test_8cc_ad66453096871179e6c6effe0df4b483b}{b}};}
\DoxyCodeLine{00419\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ tok\_cur\ =\ (int)context\_tokens\_start[\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}];}
\DoxyCodeLine{00420\ \ \ \ \ \ \ \ \ \ \ \ \ loader-\/>\mbox{\hyperlink{structEvalLoader_a6e56d7109b86f129a8848f743acf35a1}{inputs}}[boff\ *\ T\ +\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}]\ =\ tok\_cur;}
\DoxyCodeLine{00421\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00422\ \ \ \ \ \}}
\DoxyCodeLine{00423\ \ \ \ \ \textcolor{comment}{//\ process\ the\ completions,\ insert\ them\ in\ their\ row,\ right\ after\ the\ (shared)\ context}}
\DoxyCodeLine{00424\ \ \ \ \ uint16\_t\ *completions\_iter\ =\ loader-\/>\mbox{\hyperlink{structEvalLoader_a454c2532ac07fdcd73a6b1265ec51bcb}{buffer}}\ +\ 3\ +\ context\_length;}
\DoxyCodeLine{00425\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ c\ =\ 0;\ c\ <\ num\_completions;\ c++)\ \{}
\DoxyCodeLine{00426\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ coff\ =\ batch\_dim\_offset\ +\ c;}
\DoxyCodeLine{00427\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ completion\_length\ =\ (int)completions\_iter[0];}
\DoxyCodeLine{00428\ \ \ \ \ \ \ \ \ uint16\_t\ *completion\_tokens\_start\ =\ completions\_iter\ +\ 1;}
\DoxyCodeLine{00429\ \ \ \ \ \ \ \ \ assert(completion\_length\ >\ 0\ \&\&\ context\_length\ +\ completion\_length\ <\ T);\ \textcolor{comment}{//\ things\ fit?}}
\DoxyCodeLine{00430\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ =\ 0;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ <\ completion\_length;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}++)\ \{}
\DoxyCodeLine{00431\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ tok\_cur\ =\ (int)completion\_tokens\_start[\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}];}
\DoxyCodeLine{00432\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ at\ inputs,\ the\ completions\ simply\ follow\ the\ context}}
\DoxyCodeLine{00433\ \ \ \ \ \ \ \ \ \ \ \ \ loader-\/>\mbox{\hyperlink{structEvalLoader_a6e56d7109b86f129a8848f743acf35a1}{inputs}}[coff\ *\ T\ +\ context\_length\ +\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}]\ =\ tok\_cur;}
\DoxyCodeLine{00434\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ at\ targets\ things\ start\ to\ get\ tricky}}
\DoxyCodeLine{00435\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ we\ expect\ the\ last\ context\ token\ to\ predict\ the\ first\ completion\ token}}
\DoxyCodeLine{00436\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ and\ then\ onwards\ from\ there.}}
\DoxyCodeLine{00437\ \ \ \ \ \ \ \ \ \ \ \ \ loader-\/>\mbox{\hyperlink{structEvalLoader_a2cd5289c023df521565f38ee1b5cb234}{targets}}[coff\ *\ T\ +\ context\_length\ +\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ -\/\ 1]\ =\ tok\_cur;}
\DoxyCodeLine{00438\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ and\ at\ these\ positions,\ we\ want\ to\ set\ mask=1,\ because\ these\ are\ the}}
\DoxyCodeLine{00439\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ positions\ where\ we\ want\ to\ average\ the\ loss,\ in\ each\ row,\ to\ determine}}
\DoxyCodeLine{00440\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ its\ overall\ probability\ of\ following\ the\ context.}}
\DoxyCodeLine{00441\ \ \ \ \ \ \ \ \ \ \ \ \ loader-\/>\mbox{\hyperlink{structEvalLoader_a73f28d99f2aef1906d16be4fdf2babec}{mask}}[coff\ *\ T\ +\ context\_length\ +\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ -\/\ 1]\ =\ 1;}
\DoxyCodeLine{00442\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00443\ \ \ \ \ \ \ \ \ completions\_iter\ +=\ 1\ +\ completion\_length;\ \textcolor{comment}{//\ move\ to\ the\ next\ completion}}
\DoxyCodeLine{00444\ \ \ \ \ \}}
\DoxyCodeLine{00445\ \ \ \ \ \textcolor{comment}{//\ advance\ the\ current\ example\ to\ point\ to\ the\ next\ one\ we'd\ load}}
\DoxyCodeLine{00446\ \ \ \ \ loader-\/>\mbox{\hyperlink{structEvalLoader_a1e9b1cda56452af5565871e7fdfc79cb}{current\_example\_index}}\ +=\ 1;}
\DoxyCodeLine{00447\ \}}
\DoxyCodeLine{00448\ }
\DoxyCodeLine{00449\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{dataloader_8h_a392a6a0c30ef60a3d0aaa50bf0d19b8d}{evalloader\_next\_batch}}(\mbox{\hyperlink{structEvalLoader}{EvalLoader}}\ *loader)\ \{}
\DoxyCodeLine{00450\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ B\ =\ loader-\/>\mbox{\hyperlink{structEvalLoader_ad579b719803160112290db168b777a04}{B}};}
\DoxyCodeLine{00451\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ T\ =\ loader-\/>\mbox{\hyperlink{structEvalLoader_a67b6ddaeae707ccce4ada1e1f48ea12e}{T}};}
\DoxyCodeLine{00452\ \ \ \ \ \textcolor{comment}{//\ init\ mask\ to\ zeros,\ no\ need\ to\ do\ it\ for\ inputs\ \&\ targets,\ the\ values\ where\ the\ mask}}
\DoxyCodeLine{00453\ \ \ \ \ \textcolor{comment}{//\ is\ set\ will\ be\ correctly\ overwritten\ every\ time.}}
\DoxyCodeLine{00454\ \ \ \ \ memset(loader-\/>\mbox{\hyperlink{structEvalLoader_a73f28d99f2aef1906d16be4fdf2babec}{mask}},\ 0,\ B\ *\ T\ *\ \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{char}));}
\DoxyCodeLine{00455\ \ \ \ \ \textcolor{comment}{//\ ok\ here\ is\ the\ problem\ we\ are\ solving}}
\DoxyCodeLine{00456\ \ \ \ \ \textcolor{comment}{//\ we\ have\ a\ batch\ dimension\ of\ B,\ which\ we\ want\ to\ take\ full\ advantage\ of}}
\DoxyCodeLine{00457\ \ \ \ \ \textcolor{comment}{//\ each\ example\ has\ some\ number\ of\ completions\ (usually\ 4)}}
\DoxyCodeLine{00458\ \ \ \ \ \textcolor{comment}{//\ so\ we\ want\ to\ pack\ as\ many\ examples\ into\ rows\ of\ B\ as\ we\ can\ fit}}
\DoxyCodeLine{00459\ \ \ \ \ \textcolor{keywordtype}{int}\ can\_fit\_examples\ =\ (int)\ (B\ /\ \mbox{\hyperlink{dataloader_8h_aa3387b958497b888fb833ab6404c68e3}{ASSUMED\_NUM\_COMPLETIONS}});\ \textcolor{comment}{//\ how\ many\ examples\ can\ we\ fit\ in\ the\ batch?}}
\DoxyCodeLine{00460\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ =\ 0;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ <\ can\_fit\_examples;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}++)\ \{}
\DoxyCodeLine{00461\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (loader-\/>\mbox{\hyperlink{structEvalLoader_a1e9b1cda56452af5565871e7fdfc79cb}{current\_example\_index}}\ >=\ loader-\/>\mbox{\hyperlink{structEvalLoader_a8baa5911e8d7eab5c268a27f1892a8ba}{end\_example\_index}})\ \{}
\DoxyCodeLine{00462\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};\ \textcolor{comment}{//\ this\ process\ has\ exhausted\ its\ work,\ noop\ from\ here\ on}}
\DoxyCodeLine{00463\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00464\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{dataloader_8h_a9e0334904dedabeb702dae0ee8a94697}{evalloader\_next\_example\_}}(loader,\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}});}
\DoxyCodeLine{00465\ \ \ \ \ \}}
\DoxyCodeLine{00466\ \}}
\DoxyCodeLine{00467\ }
\DoxyCodeLine{00468\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{dataloader_8h_a9ea1f92fefa8217f53b1d1e3571bfa54}{evalloader\_stat\_losses}}(\mbox{\hyperlink{structEvalLoader}{EvalLoader}}\ *loader,\ \textcolor{keywordtype}{float}*\ losses)\ \{}
\DoxyCodeLine{00469\ \ \ \ \ \textcolor{comment}{//\ compute\ statistics\ of\ losses\ (B*T)\ resulting\ from\ a\ forward\ pass}}
\DoxyCodeLine{00470\ \ \ \ \ \textcolor{comment}{//\ on\ a\ batch\ that\ was\ constructed\ from\ EvalLoader}}
\DoxyCodeLine{00471\ \ \ \ \ \textcolor{comment}{//\ putting\ this\ functionality\ here\ because\ it\ is\ tightly\ coupled}}
\DoxyCodeLine{00472\ \ \ \ \ \textcolor{comment}{//\ with\ how\ we\ construct\ and\ represent\ the\ data\ batches.}}
\DoxyCodeLine{00473\ \ \ \ \ \textcolor{comment}{//\ returns\ the\ number\ of\ correct\ examples\ in\ this\ batch.}}
\DoxyCodeLine{00474\ \ \ \ \ \textcolor{keywordtype}{int}\ correct\ =\ 0;}
\DoxyCodeLine{00475\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ B\ =\ loader-\/>\mbox{\hyperlink{structEvalLoader_ad579b719803160112290db168b777a04}{B}};}
\DoxyCodeLine{00476\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ T\ =\ loader-\/>\mbox{\hyperlink{structEvalLoader_a67b6ddaeae707ccce4ada1e1f48ea12e}{T}};}
\DoxyCodeLine{00477\ \ \ \ \ \textcolor{comment}{//\ iterate\ the\ examples\ in\ this\ batch}}
\DoxyCodeLine{00478\ \ \ \ \ \textcolor{keywordtype}{int}\ can\_fit\_examples\ =\ (int)\ (B\ /\ \mbox{\hyperlink{dataloader_8h_aa3387b958497b888fb833ab6404c68e3}{ASSUMED\_NUM\_COMPLETIONS}});}
\DoxyCodeLine{00479\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ =\ 0;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ <\ can\_fit\_examples;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}++)\ \{}
\DoxyCodeLine{00480\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{float}\ min\_loss\ =\ 0.0f;}
\DoxyCodeLine{00481\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ min\_loss\_index\ =\ -\/1;}
\DoxyCodeLine{00482\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{char}\ active\ =\ 0;\ \textcolor{comment}{//\ is\ this\ example\ active\ or\ fully\ empty?}}
\DoxyCodeLine{00483\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ iterate\ the\ completions\ in\ this\ example}}
\DoxyCodeLine{00484\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2layout__test_8cc_ad66453096871179e6c6effe0df4b483b}{b}}\ =\ 0;\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2layout__test_8cc_ad66453096871179e6c6effe0df4b483b}{b}}\ <\ \mbox{\hyperlink{dataloader_8h_aa3387b958497b888fb833ab6404c68e3}{ASSUMED\_NUM\_COMPLETIONS}};\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2layout__test_8cc_ad66453096871179e6c6effe0df4b483b}{b}}++)\ \{}
\DoxyCodeLine{00485\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ boff\ =\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}\ *\ \mbox{\hyperlink{dataloader_8h_aa3387b958497b888fb833ab6404c68e3}{ASSUMED\_NUM\_COMPLETIONS}}\ +\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2layout__test_8cc_ad66453096871179e6c6effe0df4b483b}{b}};}
\DoxyCodeLine{00486\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ evaluate\ the\ quality\ of\ this\ completion}}
\DoxyCodeLine{00487\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ its\ quality\ is\ simply\ the\ average\ loss\ over\ the\ tokens}}
\DoxyCodeLine{00488\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{float}\ average\_loss\ =\ 0.0f;}
\DoxyCodeLine{00489\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2raw__hash__set__test_8cc_ad43c3812e6d13e0518d9f8b8f463ffcf}{count}}\ =\ 0;}
\DoxyCodeLine{00490\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ t\ =\ 0;\ t\ <\ T;\ t++)\ \{}
\DoxyCodeLine{00491\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{char}\ mask\ =\ loader-\/>\mbox{\hyperlink{structEvalLoader_a73f28d99f2aef1906d16be4fdf2babec}{mask}}[boff\ *\ T\ +\ t];}
\DoxyCodeLine{00492\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (mask\ ==\ 1)\ \{}
\DoxyCodeLine{00493\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ active\ =\ 1;}
\DoxyCodeLine{00494\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ average\_loss\ +=\ losses[boff\ *\ T\ +\ t];}
\DoxyCodeLine{00495\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2raw__hash__set__test_8cc_ad43c3812e6d13e0518d9f8b8f463ffcf}{count}}++;}
\DoxyCodeLine{00496\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00497\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00498\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2raw__hash__set__test_8cc_ad43c3812e6d13e0518d9f8b8f463ffcf}{count}}\ >\ 0)\ \{\ average\_loss\ /=\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2raw__hash__set__test_8cc_ad43c3812e6d13e0518d9f8b8f463ffcf}{count}};\ \}}
\DoxyCodeLine{00499\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2layout__test_8cc_ad66453096871179e6c6effe0df4b483b}{b}}\ ==\ 0\ ||\ average\_loss\ <\ min\_loss)\ \{}
\DoxyCodeLine{00500\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ min\_loss\ =\ average\_loss;}
\DoxyCodeLine{00501\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ min\_loss\_index\ =\ \mbox{\hyperlink{abseil-cpp_2absl_2container_2internal_2layout__test_8cc_ad66453096871179e6c6effe0df4b483b}{b}};}
\DoxyCodeLine{00502\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00503\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00504\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (active\ \&\&\ (min\_loss\_index\ ==\ loader-\/>\mbox{\hyperlink{structEvalLoader_a72aaf84fc68642983b87dee8258e3c83}{label}}[\mbox{\hyperlink{abseil-cpp_2absl_2container_2btree__benchmark_8cc_a717c50cfde3924051c279a89096afd3d}{i}}]))\ \{}
\DoxyCodeLine{00505\ \ \ \ \ \ \ \ \ \ \ \ \ correct\ +=\ 1;}
\DoxyCodeLine{00506\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00507\ \ \ \ \ \}}
\DoxyCodeLine{00508\ \ \ \ \ \textcolor{keywordflow}{return}\ correct;}
\DoxyCodeLine{00509\ \}}
\DoxyCodeLine{00510\ }
\DoxyCodeLine{00511\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{dataloader_8h_acc220bfd8bfc554eae908bb06721724f}{evalloader\_free}}(\mbox{\hyperlink{structEvalLoader}{EvalLoader}}\ *loader)\ \{}
\DoxyCodeLine{00512\ \ \ \ \ free(loader-\/>\mbox{\hyperlink{structEvalLoader_a454c2532ac07fdcd73a6b1265ec51bcb}{buffer}});}
\DoxyCodeLine{00513\ \ \ \ \ free(loader-\/>\mbox{\hyperlink{structEvalLoader_a6e56d7109b86f129a8848f743acf35a1}{inputs}});}
\DoxyCodeLine{00514\ \ \ \ \ free(loader-\/>\mbox{\hyperlink{structEvalLoader_a2cd5289c023df521565f38ee1b5cb234}{targets}});}
\DoxyCodeLine{00515\ \ \ \ \ free(loader-\/>\mbox{\hyperlink{structEvalLoader_a73f28d99f2aef1906d16be4fdf2babec}{mask}});}
\DoxyCodeLine{00516\ \ \ \ \ free(loader-\/>\mbox{\hyperlink{structEvalLoader_a72aaf84fc68642983b87dee8258e3c83}{label}});}
\DoxyCodeLine{00517\ \ \ \ \ \mbox{\hyperlink{utils_8h_ae094d98ede0500b8f5acba043487a5c1}{fcloseCheck}}(loader-\/>\mbox{\hyperlink{structEvalLoader_ab28c4ad3ddee127e21943bcbbdac95d3}{eval\_file}});}
\DoxyCodeLine{00518\ \}}
\DoxyCodeLine{00519\ }
\DoxyCodeLine{00520\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{//\ DATALOADER\_H}}

\end{DoxyCode}
